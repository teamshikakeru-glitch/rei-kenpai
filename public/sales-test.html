<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rei å–¶æ¥­ãƒ†ã‚¹ãƒˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --color-bg: #f8f9fa;
      --color-white: #ffffff;
      --color-primary: #2d5a47;
      --color-primary-light: #3d7a5f;
      --color-primary-pale: #e8f0ec;
      --color-accent: #c9a962;
      --color-text: #2c2c2c;
      --color-text-light: #5a5a5a;
      --color-text-muted: #8a8a8a;
      --color-border: #e5e2dd;
      --color-error: #dc3545;
      --color-success: #28a745;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans JP', sans-serif; background: var(--color-bg); color: var(--color-text); line-height: 1.8; min-height: 100vh; }
    .header { background: var(--color-white); border-bottom: 1px solid var(--color-border); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 900px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 0.5rem; }
    .logo-symbol { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); }
    .logo-text { font-size: 0.9rem; color: var(--color-text-light); }
    .progress-info { display: flex; align-items: center; gap: 1rem; font-size: 0.85rem; color: var(--color-text-light); }
    .progress-bar { width: 200px; height: 8px; background: var(--color-border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--color-primary); border-radius: 4px; transition: width 0.3s ease; }
    .container { max-width: 900px; margin: 0 auto; padding: 2rem; }
    .start-screen { background: var(--color-white); border-radius: 16px; padding: 3rem; text-align: center; box-shadow: var(--shadow-soft); }
    .start-screen h1 { font-size: 1.8rem; font-weight: 700; color: var(--color-primary); margin-bottom: 1rem; }
    .start-screen p { color: var(--color-text-light); margin-bottom: 2rem; }
    .test-info { background: var(--color-primary-pale); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; text-align: left; }
    .test-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; color: var(--color-primary); }
    .test-info ul { list-style: none; font-size: 0.9rem; }
    .test-info li { padding: 0.5rem 0; border-bottom: 1px solid rgba(45, 90, 71, 0.1); display: flex; justify-content: space-between; }
    .test-info li:last-child { border-bottom: none; }
    .name-input-section { margin-bottom: 2rem; }
    .name-input-section label { display: block; font-weight: 500; margin-bottom: 0.5rem; text-align: left; }
    .name-input { width: 100%; max-width: 300px; padding: 0.8rem 1rem; font-size: 1rem; border: 2px solid var(--color-border); border-radius: 8px; transition: border-color 0.3s; }
    .name-input:focus { outline: none; border-color: var(--color-primary); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 1rem 2.5rem; font-family: inherit; font-size: 1rem; font-weight: 600; border: none; border-radius: 100px; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: var(--color-primary); color: var(--color-white); }
    .btn-primary:hover { background: var(--color-primary-light); transform: translateY(-2px); box-shadow: var(--shadow-medium); }
    .btn-primary:disabled { background: var(--color-text-muted); cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--color-white); color: var(--color-primary); border: 2px solid var(--color-primary); }
    .btn-secondary:hover { background: var(--color-primary-pale); }
    .question-card { background: var(--color-white); border-radius: 16px; padding: 2rem; box-shadow: var(--shadow-soft); margin-bottom: 1.5rem; }
    .question-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
    .question-number { background: var(--color-primary); color: var(--color-white); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem; }
    .question-category { font-size: 0.8rem; color: var(--color-text-muted); background: var(--color-bg); padding: 0.3rem 0.8rem; border-radius: 100px; }
    .question-text { font-size: 1.1rem; font-weight: 500; margin-bottom: 1.5rem; line-height: 1.7; }
    .options { display: flex; flex-direction: column; gap: 0.75rem; }
    .option { display: flex; align-items: flex-start; gap: 1rem; padding: 1rem 1.25rem; background: var(--color-bg); border: 2px solid transparent; border-radius: 12px; cursor: pointer; transition: all 0.2s ease; }
    .option:hover { background: var(--color-primary-pale); }
    .option.selected { background: var(--color-primary-pale); border-color: var(--color-primary); }
    .option input { display: none; }
    .option-marker { width: 24px; height: 24px; border: 2px solid var(--color-border); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s ease; font-size: 0.8rem; font-weight: 600; color: var(--color-text-muted); }
    .option.selected .option-marker { background: var(--color-primary); border-color: var(--color-primary); color: var(--color-white); }
    .option-text { flex: 1; font-size: 0.95rem; }
    .option.multi .option-marker { border-radius: 4px; }
    .text-input { width: 100%; padding: 1rem; font-family: inherit; font-size: 1rem; border: 2px solid var(--color-border); border-radius: 12px; resize: vertical; min-height: 60px; transition: border-color 0.3s; }
    .text-input:focus { outline: none; border-color: var(--color-primary); }
    .text-input.large { min-height: 150px; }
    .char-count { text-align: right; font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.5rem; }
    .char-count.over { color: var(--color-error); }
    .navigation { display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }
    .nav-info { font-size: 0.9rem; color: var(--color-text-muted); }
    .nav-buttons { display: flex; gap: 1rem; }
    .section-divider { background: var(--color-primary); color: var(--color-white); border-radius: 16px; padding: 2rem; text-align: center; margin-bottom: 1.5rem; }
    .section-divider h2 { font-size: 1.4rem; margin-bottom: 0.5rem; }
    .section-divider p { opacity: 0.9; font-size: 0.95rem; }
    .result-screen { background: var(--color-white); border-radius: 16px; padding: 3rem; box-shadow: var(--shadow-soft); }
    .result-header { text-align: center; margin-bottom: 2rem; }
    .result-icon { font-size: 4rem; margin-bottom: 1rem; }
    .result-title { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; }
    .result-title.pass { color: var(--color-success); }
    .result-title.fail { color: var(--color-error); }
    .result-subtitle { color: var(--color-text-light); }
    .score-card { background: var(--color-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
    .score-total { text-align: center; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); margin-bottom: 1.5rem; }
    .score-number { font-size: 3rem; font-weight: 700; color: var(--color-primary); }
    .score-max { font-size: 1.2rem; color: var(--color-text-muted); }
    .score-breakdown { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
    .score-item { text-align: center; }
    .score-item-label { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 0.25rem; }
    .score-item-value { font-size: 1.2rem; font-weight: 600; color: var(--color-text); }
    .review-section { margin-top: 2rem; }
    .review-section h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-primary); }
    .review-item { background: var(--color-bg); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; }
    .review-item.correct { border-left: 4px solid var(--color-success); }
    .review-item.incorrect { border-left: 4px solid var(--color-error); }
    .review-question { font-weight: 500; margin-bottom: 0.75rem; }
    .review-answer { font-size: 0.9rem; color: var(--color-text-light); }
    .review-answer span { display: block; margin-top: 0.25rem; }
    .your-answer { color: var(--color-text); }
    .correct-answer { color: var(--color-success); font-weight: 500; }
    .ai-feedback { background: var(--color-primary-pale); border-radius: 8px; padding: 1rem; margin-top: 1rem; font-size: 0.9rem; }
    .ai-feedback-label { font-weight: 600; color: var(--color-primary); margin-bottom: 0.5rem; }
    .hidden { display: none; }
    .loading { text-align: center; padding: 3rem; }
    .loading-spinner { width: 50px; height: 50px; border: 4px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-message { background: #fee; border: 1px solid var(--color-error); color: var(--color-error); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; }
    @media (max-width: 768px) {
      .container { padding: 1rem; }
      .header { padding: 1rem; }
      .progress-bar { width: 100px; }
      .question-card { padding: 1.5rem; }
      .score-breakdown { grid-template-columns: 1fr; }
      .nav-buttons { flex-direction: column; width: 100%; }
      .nav-buttons .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <span class="logo-symbol">ç¤¼</span>
        <span class="logo-text">å–¶æ¥­ãƒ†ã‚¹ãƒˆ</span>
      </div>
      <div class="progress-info hidden" id="progressInfo">
        <span id="progressText">å•é¡Œ 0 / 25</span>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="startScreen" class="start-screen">
      <h1>ğŸ“ Rei å–¶æ¥­ãƒ†ã‚¹ãƒˆ</h1>
      <p>ã“ã®ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã™ã‚‹ã¨ã€å¼Šç¤¾å–¶æ¥­ãƒãƒ³ã¨ã—ã¦æ´»å‹•ã§ãã¾ã™ã€‚</p>
      
      <div class="test-info">
        <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ¦‚è¦</h3>
        <ul>
          <li><span>ç¬¬1éƒ¨</span><span>ã‚·ã‚¹ãƒ†ãƒ ç†è§£ãƒ†ã‚¹ãƒˆï¼ˆ20å•ï¼‰</span></li>
          <li><span>ç¬¬2éƒ¨</span><span>æƒ³å®šè³ªå•å¯¾å¿œãƒ†ã‚¹ãƒˆï¼ˆ5å•ï¼‰</span></li>
          <li><span>åˆæ ¼ãƒ©ã‚¤ãƒ³</span><span>80ç‚¹ä»¥ä¸Š / 100ç‚¹</span></li>
          <li><span>ç›®å®‰æ™‚é–“</span><span>ç´„30ã€œ45åˆ†</span></li>
        </ul>
      </div>

      <div class="name-input-section">
        <label for="userName">ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</label>
        <input type="text" id="userName" class="name-input" placeholder="å±±ç”° å¤ªéƒ">
      </div>

      <button class="btn btn-primary" id="startBtn">
        ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ â†’
      </button>
    </div>

    <div id="questionContainer" class="hidden"></div>
    <div id="resultScreen" class="hidden"></div>
  </div>

  <script>
    // Supabaseè¨­å®š
    const SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';
    
    let supabaseClient = null;
    try {
      supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (e) {
      console.error('SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
    }

    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    const questions = [
      { id: 1, section: 1, category: "ç†å¿µãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ", type: "single", question: "ReiãŒè§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹èª²é¡Œã¨ã—ã¦ã€æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["é¦™å…¸ã®é›»å­æ±ºæ¸ˆåŒ–ã«ã‚ˆã‚‹æ¥­å‹™åŠ¹ç‡åŒ–", "è·é›¢ã‚„ä»•äº‹ã§å‚åˆ—ã§ããªã„äººã®æƒ³ã„ãŒå±Šã‹ãªã„å•é¡Œ", "è‘¬å„€è²»ç”¨ã®å‰Šæ¸›", "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è‘¬å„€ã®æ™®åŠ"], correct: 1, points: 2 },
      { id: 2, section: 1, category: "ç†å¿µãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ", type: "single", question: "Reiã®é–‹ç™ºç†å¿µã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["è‘¬å„€ã®ä¾¡å€¤ã¯å‚åˆ—è€…æ•°ã§æ±ºã¾ã‚‹", "è‘¬å„€ã®ä¾¡å€¤ã¯è²»ç”¨ã®å¤§ãã•ã§æ±ºã¾ã‚‹", "è‘¬å„€ã®ä¾¡å€¤ã¯ã€Œã©ã‚Œã ã‘æƒ³ã‚ã‚Œã¦ã„ã‚‹ã‹ã€ã§æ±ºã¾ã‚‹", "è‘¬å„€ã®ä¾¡å€¤ã¯å½¢å¼ã®è±ªè¯ã•ã§æ±ºã¾ã‚‹"], correct: 2, points: 2 },
      { id: 3, section: 1, category: "ç†å¿µãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ", type: "single", question: "ReiãŒã€ŒçŒ®æ¯ã€ã¨ã„ã†å½¢ã‚’é¸ã‚“ã ç†ç”±ã¨ã—ã¦ã€æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["æ±ºæ¸ˆæ‰‹æ•°æ–™ãŒå®‰ã„ã‹ã‚‰", "æƒ³ã„ãŒä¸€ç•ªã¾ã£ã™ãå±Šãå½¢ã ã‹ã‚‰", "ä»–ç¤¾ãŒã‚„ã£ã¦ã„ãªã„ã‹ã‚‰", "è‘¬å„€ç¤¾ã®è¦æœ›ãŒå¤šã‹ã£ãŸã‹ã‚‰"], correct: 1, points: 2 },
      { id: 4, section: 1, category: "ç†å¿µãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ", type: "text", question: "ä»¥ä¸‹ã®æ–‡ç« ã®ç©ºæ¬„ã«å…¥ã‚‹è¨€è‘‰ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚\n\nã€Œè‘¬å„€ã®ä¾¡å€¤ã¯ã€ãã“ã«ã„ãŸã‹ã©ã†ã‹ã€ã§ã¯ãªãã€ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ã€ã§æ±ºã¾ã‚‹ã€", correctKeywords: ["ã©ã‚Œã ã‘æƒ³ã‚ã‚Œã¦ã„ã‚‹ã‹", "æƒ³ã‚ã‚Œã¦ã„ã‚‹ã‹", "ã©ã‚Œã ã‘æƒ³ã‚ã‚Œã¦ã„ã‚‹"], points: 2, maxLength: 30 },
      { id: 5, section: 1, category: "ç†å¿µãƒ»ã‚³ãƒ³ã‚»ãƒ—ãƒˆ", type: "text", question: "ReiãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹è€ƒãˆæ–¹ã«ã¤ã„ã¦ã€30æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", maxLength: 30, rubric: "å‚åˆ—ã§ããªã„äººã®æƒ³ã„ã‚‚å¤§åˆ‡ã«ã™ã‚‹ã€è·é›¢ãŒã‚ã£ã¦ã‚‚æƒ³ã„ã¯å±Šã‘ã‚‰ã‚Œã‚‹ã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°æ­£è§£", points: 2 },
      { id: 6, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "single", question: "çŒ®æ¯ã®æµã‚Œã¨ã—ã¦æ­£ã—ã„é †ç•ªã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["URLå…±æœ‰ â†’ ãƒšãƒ¼ã‚¸ä½œæˆ â†’ é€é‡‘ â†’ éºæ—ç¢ºèª", "ãƒšãƒ¼ã‚¸ä½œæˆ â†’ URLå…±æœ‰ â†’ é€é‡‘ â†’ éºæ—ç¢ºèª", "é€é‡‘ â†’ ãƒšãƒ¼ã‚¸ä½œæˆ â†’ URLå…±æœ‰ â†’ éºæ—ç¢ºèª", "ãƒšãƒ¼ã‚¸ä½œæˆ â†’ é€é‡‘ â†’ URLå…±æœ‰ â†’ éºæ—ç¢ºèª"], correct: 1, points: 2 },
      { id: 7, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "multi", question: "è‘¬å„€ç¤¾ç®¡ç†ç”»é¢ã§ã§ãã‚‹ã“ã¨ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ã€‚", options: ["çŒ®æ¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ", "çŒ®æ¯é‡‘é¡ã®ç·é¡ç¢ºèª", "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š", "ä»–ç¤¾ã®çŒ®æ¯ãƒ‡ãƒ¼ã‚¿ã®é–²è¦§"], correct: [0, 1, 2], points: 2 },
      { id: 8, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "multi", question: "ã”éºæ—ãŒãƒãƒ¼ã‚¿ãƒ«ã§ç¢ºèªã§ãã‚‹æƒ…å ±ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ã€‚", options: ["çŒ®æ¯ã®ç·é¡", "çŒ®æ¯è€…ã®ãŠåå‰", "çŒ®æ¯è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "ä»–ã®è‘¬å„€ã®çŒ®æ¯æƒ…å ±"], correct: [0, 1, 2], points: 2 },
      { id: 9, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "single", question: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¨ã—ã¦ã€ReiãŒå®Ÿè£…ã—ã¦ã„ã‚‹ä»•çµ„ã¿ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["è‘¬å„€ç¤¾ã”ã¨ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿åˆ†é›¢", "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·", "Aã¨Bã®ä¸¡æ–¹", "ç‰¹åˆ¥ãªå¯¾ç­–ã¯ã—ã¦ã„ãªã„"], correct: 2, points: 2 },
      { id: 10, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "single", question: "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["èª°ã§ã‚‚è‡ªç”±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹", "è‘¬å„€ç¤¾ãŒè¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹", "ã”éºæ—ã®é¡”èªè¨¼ãŒå¿…è¦", "è‘¬å„€ç¤¾çµŒç”±ã§ã®ã¿é–²è¦§å¯èƒ½"], correct: 1, points: 2 },
      { id: 11, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "multi", question: "çŒ®æ¯ãƒšãƒ¼ã‚¸ã§é€é‡‘è€…ãŒå…¥åŠ›ã™ã‚‹æƒ…å ±ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ã€‚", options: ["ãŠåå‰", "é‡‘é¡", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "éŠ€è¡Œå£åº§ç•ªå·"], correct: [0, 1, 2], points: 2 },
      { id: 12, section: 1, category: "æ©Ÿèƒ½ãƒ»ä»•çµ„ã¿", type: "text", question: "Reiã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã«ã¤ã„ã¦ã€50æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚ï¼ˆè‘¬å„€ç¤¾é–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã«ã¤ã„ã¦è§¦ã‚Œã‚‹ã“ã¨ï¼‰", maxLength: 50, rubric: "è‘¬å„€ç¤¾ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«åˆ†é›¢ã•ã‚Œã¦ã„ã‚‹ã€ä»–ç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°æ­£è§£", points: 2 },
      { id: 13, section: 1, category: "æ–™é‡‘ãƒ»å°å…¥", type: "single", question: "ã”éºæ—ã¸ã®é‚„å…ƒç‡ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["70.0%", "80.0%", "88.4%", "95.0%"], correct: 2, points: 2 },
      { id: 14, section: 1, category: "æ–™é‡‘ãƒ»å°å…¥", type: "single", question: "è‘¬å„€ç¤¾æ§˜ã®åˆæœŸå°å…¥è²»ç”¨ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["ç„¡æ–™", "100ä¸‡å††", "500ä¸‡å††", "æœˆé¡åˆ¶ã®ã¿"], correct: 2, points: 2 },
      { id: 15, section: 1, category: "æ–™é‡‘ãƒ»å°å…¥", type: "single", question: "åˆæœŸå°å…¥å¾Œã®æœˆé¡è²»ç”¨ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["æœˆé¡5ä¸‡å††", "æœˆé¡10ä¸‡å††", "ç„¡æ–™", "çŒ®æ¯ä»¶æ•°ã«å¿œã˜ã¦å¤‰å‹•"], correct: 2, points: 2 },
      { id: 16, section: 1, category: "æ–™é‡‘ãƒ»å°å…¥", type: "single", question: "1ä»¶ã®çŒ®æ¯ã‚ãŸã‚Šã®æ‰‹æ•°æ–™ç‡ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["5.0%", "8.0%", "11.6%", "15.0%"], correct: 2, points: 2 },
      { id: 17, section: 1, category: "æ–™é‡‘ãƒ»å°å…¥", type: "single", question: "å°å…¥ã¾ã§ã®æœŸé–“ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["ç”³ã—è¾¼ã¿ã‹ã‚‰1ãƒ¶æœˆå¾Œ", "ç”³ã—è¾¼ã¿ã‹ã‚‰2é€±é–“å¾Œ", "å…¥é‡‘ç¢ºèªå¾Œã€å³æ—¥åˆ©ç”¨å¯èƒ½", "ç ”ä¿®å®Œäº†å¾Œï¼ˆç´„1é€±é–“ï¼‰"], correct: 2, points: 2 },
      { id: 18, section: 1, category: "å–¶æ¥­ä¸Šã®å¼·ã¿", type: "single", question: "Reiã®å°å…¥ã«ãŠã‘ã‚‹è‘¬å„€ç¤¾æ§˜å´ã®ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€æœ€ã‚‚é‡è¦ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", options: ["ã‚¹ã‚¿ãƒƒãƒ•ã®å·¥æ•°ãŒå¢—ãˆãªã„ï¼ˆç°¡å˜ã«é‹ç”¨ã§ãã‚‹ï¼‰", "åºƒå‘Šå®£ä¼ãŒã§ãã‚‹", "è‘¬å„€è²»ç”¨ã‚’å€¤ä¸Šã’ã§ãã‚‹", "ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šæ¸›ã§ãã‚‹"], correct: 0, points: 2 },
      { id: 19, section: 1, category: "å–¶æ¥­ä¸Šã®å¼·ã¿", type: "text", question: "ã€Œã‚¹ã‚¿ãƒƒãƒ•ã®å·¥æ•°ãŒå¢—ãˆãªã„ã€ã¨ã¯å…·ä½“çš„ã«ã©ã†ã„ã†ã“ã¨ã‹ã€50æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", maxLength: 50, rubric: "æ“ä½œãŒç°¡å˜ã€è¤‡é›‘ãªä½œæ¥­ãŒä¸è¦ã€æ—¢å­˜æ¥­å‹™ã®è² æ‹…ã«ãªã‚‰ãªã„ã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°æ­£è§£", points: 2 },
      { id: 20, section: 1, category: "å–¶æ¥­ä¸Šã®å¼·ã¿", type: "text", question: "Reiã‚’å°å…¥ã™ã‚‹ã“ã¨ã§è‘¬å„€ç¤¾æ§˜ãŒé¡§å®¢ã«æä¾›ã§ãã‚‹æ–°ã—ã„ä¾¡å€¤ã«ã¤ã„ã¦ã€50æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", maxLength: 50, rubric: "é æ–¹ã®äººã®æƒ³ã„ã‚’å±Šã‘ã‚‰ã‚Œã‚‹ã€å‚åˆ—ã§ããªã„äººã‚‚å¼”æ„ã‚’ç¤ºã›ã‚‹ã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°æ­£è§£", points: 2 },
      { id: 21, section: 2, category: "æƒ³å®šè³ªå•å¯¾å¿œ", type: "essay", question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼š\n\nã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ãŠé‡‘ã‚’é›†ã‚ã‚‹ã®ã¯ã€ãªã‚“ã ã‹ä¸è¬¹æ…ãªæ°—ãŒã™ã‚‹ã®ã§ã™ãŒâ€¦ã€\n\nã“ã®è³ªå•ã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ã«å›ç­”ã—ã¾ã™ã‹ï¼Ÿ", maxLength: 200, rubric: "ãŠæ°—æŒã¡ã¸ã®å…±æ„Ÿã€Reiã®ç†å¿µï¼ˆæƒ³ã„ã‚’å±Šã‘ã‚‹æ‰‹æ®µï¼‰ã®èª¬æ˜ã€å¾“æ¥ã®é¦™å…¸ã¨ã®é¡ä¼¼æ€§ã€é æ–¹ã®æ–¹ã®æƒ³ã„ã‚’å¤§åˆ‡ã«ã™ã‚‹è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°é«˜è©•ä¾¡", points: 12 },
      { id: 22, section: 2, category: "æƒ³å®šè³ªå•å¯¾å¿œ", type: "essay", question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼š\n\nã€Œé«˜é½¢ã®æ–¹ãŒå¤šã„ã®ã§ã€ã‚¹ãƒãƒ›æ“ä½œãŒã§ãã‚‹ã‹å¿ƒé…ã§ã™ã€\n\nã“ã®è³ªå•ã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ã«å›ç­”ã—ã¾ã™ã‹ï¼Ÿ", maxLength: 200, rubric: "é€é‡‘ã™ã‚‹å´ã¯æ¯”è¼ƒçš„è‹¥ã„ä¸–ä»£ãŒå¤šã„ç‚¹ã€æ“ä½œã®ç°¡å˜ã•ã€ã”éºæ—ã¯é–²è¦§ã®ã¿ã§ç°¡å˜ã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°é«˜è©•ä¾¡", points: 12 },
      { id: 23, section: 2, category: "æƒ³å®šè³ªå•å¯¾å¿œ", type: "essay", question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼š\n\nã€ŒåˆæœŸè²»ç”¨500ä¸‡å††ã¯é«˜ã„ã¨æ„Ÿã˜ã¾ã™ã€‚ãªãœã“ã®é‡‘é¡ãªã®ã§ã™ã‹ï¼Ÿã€\n\nã“ã®è³ªå•ã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ã«å›ç­”ã—ã¾ã™ã‹ï¼Ÿ", maxLength: 200, rubric: "åˆæœŸè²»ç”¨å¾Œã¯æœˆé¡ç„¡æ–™ã®èª¬æ˜ã€é•·æœŸçš„ãªã‚³ã‚¹ãƒˆãƒ¡ãƒªãƒƒãƒˆã€ã‚·ã‚¹ãƒ†ãƒ ã®ä¾¡å€¤ãƒ»å“è³ªã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°é«˜è©•ä¾¡", points: 12 },
      { id: 24, section: 2, category: "æƒ³å®šè³ªå•å¯¾å¿œ", type: "essay", question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼š\n\nã€Œã†ã¡ã¯å¾“æ¥ã®ã‚„ã‚Šæ–¹ã§ååˆ†ã§ã™ã€‚ã‚ã–ã‚ã–æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’å…¥ã‚Œã‚‹å¿…è¦ã¯ãªã„ã®ã§ã¯ï¼Ÿã€\n\nã“ã®è³ªå•ã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ã«å›ç­”ã—ã¾ã™ã‹ï¼Ÿ", maxLength: 200, rubric: "å¾“æ¥ã®ã‚„ã‚Šæ–¹ã‚’å¦å®šã—ãªã„å§¿å‹¢ã€å‚åˆ—ã§ããªã„æ–¹ã¸ã®æ–°ã—ã„é¸æŠè‚¢ã€é¡§å®¢æº€è¶³åº¦å‘ä¸Šã€ã¨ã„ã†è¶£æ—¨ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°é«˜è©•ä¾¡", points: 12 },
      { id: 25, section: 2, category: "æƒ³å®šè³ªå•å¯¾å¿œ", type: "essay", question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼š\n\nã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯æœ¬å½“ã«å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿå€‹äººæƒ…å ±ã®æ¼æ´©ãŒå¿ƒé…ã§ã™ã€\n\nã“ã®è³ªå•ã«å¯¾ã—ã¦ã€ã©ã®ã‚ˆã†ã«å›ç­”ã—ã¾ã™ã‹ï¼Ÿ", maxLength: 200, rubric: "è‘¬å„€ç¤¾é–“ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·ã€Stripeã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ã¨ã„ã†å…·ä½“çš„ãªå¯¾ç­–ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°é«˜è©•ä¾¡", points: 12 }
    ];

    // çŠ¶æ…‹ç®¡ç†
    let currentQuestion = 0;
    let answers = {};
    let userName = "";
    let testStartTime = null;

    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
    document.addEventListener('DOMContentLoaded', function() {
      // é–‹å§‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      document.getElementById('startBtn').addEventListener('click', startTest);
      
      // Enterã‚­ãƒ¼ã§ã‚‚ãƒ†ã‚¹ãƒˆé–‹å§‹
      document.getElementById('userName').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          startTest();
        }
      });
    });

    // ãƒ†ã‚¹ãƒˆé–‹å§‹
    function startTest() {
      userName = document.getElementById('userName').value.trim();
      if (!userName) {
        alert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        document.getElementById('userName').focus();
        return;
      }
      
      testStartTime = new Date();
      document.getElementById('startScreen').classList.add('hidden');
      document.getElementById('progressInfo').classList.remove('hidden');
      showQuestion(0);
    }

    // å•é¡Œè¡¨ç¤º
    function showQuestion(index) {
      currentQuestion = index;
      const q = questions[index];
      const container = document.getElementById('questionContainer');
      container.classList.remove('hidden');

      document.getElementById('progressText').textContent = `å•é¡Œ ${index + 1} / ${questions.length}`;
      document.getElementById('progressFill').style.width = `${((index + 1) / questions.length) * 100}%`;

      let sectionDivider = '';
      if (index === 0) {
        sectionDivider = `<div class="section-divider"><h2>ç¬¬1éƒ¨ï¼šã‚·ã‚¹ãƒ†ãƒ ç†è§£ãƒ†ã‚¹ãƒˆ</h2><p>é¸æŠå¼ãƒ»è¨˜è¿°å¼ å…¨20å•</p></div>`;
      } else if (index === 20) {
        sectionDivider = `<div class="section-divider"><h2>ç¬¬2éƒ¨ï¼šæƒ³å®šè³ªå•å¯¾å¿œãƒ†ã‚¹ãƒˆ</h2><p>è¨˜è¿°å¼ å…¨5å•ï¼ˆAIæ¡ç‚¹ï¼‰</p></div>`;
      }

      let questionHTML = sectionDivider + `
        <div class="question-card">
          <div class="question-header">
            <div class="question-number">${index + 1}</div>
            <span class="question-category">${q.category}</span>
          </div>
          <div class="question-text">${q.question.replace(/\n/g, '<br>')}</div>
          ${renderAnswerInput(q)}
        </div>
        <div class="navigation">
          <div class="nav-info">${index + 1} / ${questions.length} å•</div>
          <div class="nav-buttons">
            ${index > 0 ? '<button class="btn btn-secondary" id="prevBtn">â† å‰ã¸</button>' : ''}
            ${index < questions.length - 1 
              ? '<button class="btn btn-primary" id="nextBtn">æ¬¡ã¸ â†’</button>'
              : '<button class="btn btn-primary" id="submitBtn">æ¡ç‚¹ã™ã‚‹ â†’</button>'
            }
          </div>
        </div>
      `;

      container.innerHTML = questionHTML;
      
      // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      if (index > 0) {
        document.getElementById('prevBtn').addEventListener('click', prevQuestion);
      }
      if (index < questions.length - 1) {
        document.getElementById('nextBtn').addEventListener('click', nextQuestion);
      } else {
        document.getElementById('submitBtn').addEventListener('click', submitTest);
      }
      
      // é¸æŠè‚¢ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      setupOptionEvents(q);
      restoreAnswer(q);
    }

    function renderAnswerInput(q) {
      if (q.type === 'single') {
        return `<div class="options">${q.options.map((opt, i) => `
          <div class="option" data-qid="${q.id}" data-idx="${i}">
            <span class="option-marker">${String.fromCharCode(65 + i)}</span>
            <span class="option-text">${opt}</span>
          </div>`).join('')}</div>`;
      } else if (q.type === 'multi') {
        return `<div class="options">${q.options.map((opt, i) => `
          <div class="option multi" data-qid="${q.id}" data-idx="${i}">
            <span class="option-marker">${String.fromCharCode(65 + i)}</span>
            <span class="option-text">${opt}</span>
          </div>`).join('')}</div>
          <p style="font-size: 0.85rem; color: var(--color-text-muted); margin-top: 0.75rem;">â€»è¤‡æ•°é¸æŠå¯</p>`;
      } else if (q.type === 'text') {
        return `<textarea class="text-input" id="textAnswer${q.id}" placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" maxlength="${(q.maxLength || 100) + 20}"></textarea>
          <div class="char-count" id="charCount${q.id}">0 / ${q.maxLength || 100}æ–‡å­—</div>`;
      } else if (q.type === 'essay') {
        return `<textarea class="text-input large" id="textAnswer${q.id}" placeholder="å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ${q.maxLength}æ–‡å­—ä»¥å†…ï¼‰" maxlength="${q.maxLength + 50}"></textarea>
          <div class="char-count" id="charCount${q.id}">0 / ${q.maxLength}æ–‡å­—</div>`;
      }
    }

    function setupOptionEvents(q) {
      if (q.type === 'single') {
        document.querySelectorAll(`[data-qid="${q.id}"]`).forEach(option => {
          option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const idx = parseInt(this.dataset.idx);
            selectOption(q.id, idx);
          });
        });
      } else if (q.type === 'multi') {
        document.querySelectorAll(`[data-qid="${q.id}"]`).forEach(option => {
          option.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const idx = parseInt(this.dataset.idx);
            toggleMultiOption(q.id, idx);
          });
        });
      } else if (q.type === 'text' || q.type === 'essay') {
        const textarea = document.getElementById(`textAnswer${q.id}`);
        if (textarea) {
          textarea.addEventListener('input', function() {
            saveTextAnswer(q.id, this.value, q.maxLength || 100);
          });
        }
      }
    }

    function selectOption(qId, optionIndex) {
      answers[qId] = optionIndex;
      document.querySelectorAll(`[data-qid="${qId}"]`).forEach((opt, i) => {
        opt.classList.toggle('selected', i === optionIndex);
      });
    }

    function toggleMultiOption(qId, optionIndex) {
      if (!answers[qId]) answers[qId] = [];
      const idx = answers[qId].indexOf(optionIndex);
      if (idx > -1) {
        answers[qId].splice(idx, 1);
      } else {
        answers[qId].push(optionIndex);
      }
      document.querySelectorAll(`[data-qid="${qId}"]`)[optionIndex].classList.toggle('selected');
    }

    function saveTextAnswer(qId, value, maxLength) {
      answers[qId] = value;
      const charCount = document.getElementById(`charCount${qId}`);
      if (charCount) {
        charCount.textContent = `${value.length} / ${maxLength}æ–‡å­—`;
        charCount.classList.toggle('over', value.length > maxLength);
      }
    }

    function restoreAnswer(q) {
      if (answers[q.id] === undefined) return;
      if (q.type === 'single') {
        const options = document.querySelectorAll(`[data-qid="${q.id}"]`);
        if (options[answers[q.id]]) options[answers[q.id]].classList.add('selected');
      } else if (q.type === 'multi') {
        const options = document.querySelectorAll(`[data-qid="${q.id}"]`);
        answers[q.id].forEach(i => { if (options[i]) options[i].classList.add('selected'); });
      } else if (q.type === 'text' || q.type === 'essay') {
        const textarea = document.getElementById(`textAnswer${q.id}`);
        if (textarea) {
          textarea.value = answers[q.id];
          saveTextAnswer(q.id, answers[q.id], q.maxLength || 100);
        }
      }
    }

    function nextQuestion() {
      if (currentQuestion < questions.length - 1) {
        showQuestion(currentQuestion + 1);
        window.scrollTo(0, 0);
      }
    }

    function prevQuestion() {
      if (currentQuestion > 0) {
        showQuestion(currentQuestion - 1);
        window.scrollTo(0, 0);
      }
    }

    // ãƒ†ã‚¹ãƒˆæå‡º
    function submitTest() {
      let unanswered = [];
      questions.forEach((q, i) => {
        if (answers[q.id] === undefined || 
            (Array.isArray(answers[q.id]) && answers[q.id].length === 0) ||
            (typeof answers[q.id] === 'string' && answers[q.id].trim() === '')) {
          unanswered.push(i + 1);
        }
      });

      if (unanswered.length > 0) {
        if (!confirm(`å•${unanswered.join(', ')}ãŒæœªå›ç­”ã§ã™ã€‚ã“ã®ã¾ã¾æ¡ç‚¹ã—ã¾ã™ã‹ï¼Ÿ`)) {
          return;
        }
      }

      showLoading();
      setTimeout(() => calculateResults(), 1500);
    }

    function showLoading() {
      document.getElementById('questionContainer').innerHTML = `<div class="loading"><div class="loading-spinner"></div><p>æ¡ç‚¹ä¸­ã§ã™...</p></div>`;
    }

    // æ¡ç‚¹å‡¦ç†
    function calculateResults() {
      let section1SelectScore = 0, section1SelectTotal = 0;
      let section1TextScore = 0, section1TextTotal = 0;
      let section2Score = 0, section2Total = 0;

      const results = questions.map(q => {
        let isCorrect = false, score = 0, feedback = '';

        if (q.type === 'single') {
          isCorrect = answers[q.id] === q.correct;
          score = isCorrect ? q.points : 0;
          section1SelectTotal += q.points;
          section1SelectScore += score;
        } else if (q.type === 'multi') {
          const userAnswer = answers[q.id] || [];
          const correctSet = new Set(q.correct);
          const userSet = new Set(userAnswer);
          isCorrect = correctSet.size === userSet.size && [...correctSet].every(x => userSet.has(x));
          score = isCorrect ? q.points : 0;
          section1SelectTotal += q.points;
          section1SelectScore += score;
        } else if (q.type === 'text') {
          const userAnswer = (answers[q.id] || '').trim();
          if (q.correctKeywords) {
            isCorrect = q.correctKeywords.some(kw => userAnswer.includes(kw));
            score = isCorrect ? q.points : 0;
          } else {
            score = userAnswer.length > 5 ? q.points : 0;
            isCorrect = score > 0;
          }
          section1TextTotal += q.points;
          section1TextScore += score;
        } else if (q.type === 'essay') {
          const userAnswer = (answers[q.id] || '').trim();
          const result = scoreEssay(q.id, userAnswer);
          score = result.score;
          feedback = result.feedback;
          isCorrect = score >= q.points * 0.7;
          section2Total += q.points;
          section2Score += score;
        }

        return { question: q, userAnswer: answers[q.id], isCorrect, score, feedback };
      });

      const totalScore = section1SelectScore + section1TextScore + section2Score;
      const maxScore = section1SelectTotal + section1TextTotal + section2Total;
      const passed = totalScore >= 80;
      const duration = Math.round((new Date() - testStartTime) / 60000);

      const testData = { userName, totalScore, maxScore, section1SelectScore, section1SelectTotal, section1TextScore, section1TextTotal, section2Score, section2Total, passed, results, duration };

      saveToSupabase(testData);
    }

    function scoreEssay(qId, answer) {
      if (!answer || answer.length < 20) {
        return { score: 0, feedback: 'å›ç­”ãŒçŸ­ã™ãã¾ã™ã€‚ã‚ˆã‚Šå…·ä½“çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚' };
      }
      const keywords = {
        21: ['æƒ³ã„', 'å±Š', 'ä¸è¬¹æ…', 'é¦™å…¸', 'é æ–¹', 'å‚åˆ—', 'æ°—æŒã¡', 'å¤§åˆ‡'],
        22: ['ç°¡å˜', 'è‹¥ã„', 'é€é‡‘', 'é–²è¦§', 'æ“ä½œ', 'ã‚·ãƒ³ãƒ—ãƒ«', 'ä¸–ä»£'],
        23: ['æœˆé¡', 'ç„¡æ–™', 'é•·æœŸ', 'ã‚³ã‚¹ãƒˆ', 'åˆæœŸ', 'ãƒ¡ãƒªãƒƒãƒˆ', 'å“è³ª'],
        24: ['é¸æŠè‚¢', 'å¦å®š', 'å¾“æ¥', 'å‚åˆ—ã§ããªã„', 'æ–°ã—ã„', 'ä¾¡å€¤', 'æº€è¶³'],
        25: ['åˆ†é›¢', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£', 'Stripe', 'ä¿è­·', 'ãƒ‡ãƒ¼ã‚¿', 'ä»–ç¤¾']
      };
      const qKeywords = keywords[qId] || keywords[21];
      let matchCount = 0;
      qKeywords.forEach(kw => { if (answer.includes(kw)) matchCount++; });
      const ratio = matchCount / qKeywords.length;
      let score, feedback;
      if (ratio >= 0.5 && answer.length >= 80) { score = 12; feedback = 'ç´ æ™´ã‚‰ã—ã„å›ç­”ã§ã™ã€‚é‡è¦ãªãƒã‚¤ãƒ³ãƒˆãŒç¶²ç¾…ã•ã‚Œã¦ã„ã¾ã™ã€‚'; }
      else if (ratio >= 0.3 && answer.length >= 50) { score = 9; feedback = 'è‰¯ã„å›ç­”ã§ã™ãŒã€ã‚‚ã†å°‘ã—å…·ä½“çš„ãªèª¬æ˜ãŒã‚ã‚‹ã¨ã‚ˆã‚Šè‰¯ããªã‚Šã¾ã™ã€‚'; }
      else if (ratio >= 0.2 || answer.length >= 40) { score = 6; feedback = 'åŸºæœ¬çš„ãªå†…å®¹ã¯å«ã¾ã‚Œã¦ã„ã¾ã™ãŒã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚'; }
      else { score = 3; feedback = 'å›ç­”å†…å®¹ãŒä¸ååˆ†ã§ã™ã€‚Reiã®ç†å¿µã‚„ç‰¹å¾´ã‚’è¸ã¾ãˆãŸèª¬æ˜ãŒå¿…è¦ã§ã™ã€‚'; }
      return { score, feedback };
    }

    // Supabaseä¿å­˜
    async function saveToSupabase(data) {
      try {
        if (!supabaseClient) throw new Error('SupabaseæœªåˆæœŸåŒ–');
        
        const { data: attempt, error: attemptError } = await supabaseClient
          .from('sales_test_attempts')
          .insert({
            user_name: data.userName,
            total_score: data.totalScore,
            section1_select_score: data.section1SelectScore,
            section1_text_score: data.section1TextScore,
            section2_score: data.section2Score,
            max_score: data.maxScore,
            passed: data.passed,
            duration_minutes: data.duration
          })
          .select()
          .single();

        if (attemptError) throw attemptError;

        const answersToInsert = data.results.map(r => ({
          attempt_id: attempt.id,
          question_id: r.question.id,
          question_category: r.question.category,
          question_type: r.question.type,
          answer: formatAnswerForDB(r.question, r.userAnswer),
          score: r.score,
          max_score: r.question.points,
          is_correct: r.isCorrect,
          ai_feedback: r.feedback || null
        }));

        await supabaseClient.from('sales_test_answers').insert(answersToInsert);
        showResults(data);
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showResults(data, 'çµæœã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ãƒ†ã‚¹ãƒˆçµæœã¯è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚');
      }
    }

    function formatAnswerForDB(q, answer) {
      if (answer === undefined || answer === null) return '';
      if (q.type === 'single') return String(answer);
      if (q.type === 'multi') return JSON.stringify(answer);
      return String(answer);
    }

    // çµæœè¡¨ç¤º
    function showResults(data, errorMessage = null) {
      document.getElementById('questionContainer').classList.add('hidden');
      const resultScreen = document.getElementById('resultScreen');
      resultScreen.classList.remove('hidden');

      resultScreen.innerHTML = `
        ${errorMessage ? `<div class="error-message">${errorMessage}</div>` : ''}
        <div class="result-header">
          <div class="result-icon">${data.passed ? 'ğŸ‰' : 'ğŸ“š'}</div>
          <h1 class="result-title ${data.passed ? 'pass' : 'fail'}">${data.passed ? 'åˆæ ¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼' : 'æ®‹å¿µã€ä¸åˆæ ¼ã§ã™'}</h1>
          <p class="result-subtitle">${data.userName}ã•ã‚“ã®çµæœï¼ˆæ‰€è¦æ™‚é–“ï¼šç´„${data.duration}åˆ†ï¼‰</p>
          ${data.passed ? '<p style="color: var(--color-success); margin-top: 0.5rem;">å¼Šç¤¾å–¶æ¥­ãƒãƒ³ã¨ã—ã¦æ´»å‹•ã§ãã¾ã™</p>' : '<p style="color: var(--color-text-muted); margin-top: 0.5rem;">å†åº¦å­¦ç¿’ã—ã¦æŒ‘æˆ¦ã—ã¦ãã ã•ã„</p>'}
        </div>
        <div class="score-card">
          <div class="score-total"><span class="score-number">${data.totalScore}</span><span class="score-max"> / ${data.maxScore}ç‚¹</span></div>
          <div class="score-breakdown">
            <div class="score-item"><div class="score-item-label">ç¬¬1éƒ¨ é¸æŠå¼</div><div class="score-item-value">${data.section1SelectScore} / ${data.section1SelectTotal}</div></div>
            <div class="score-item"><div class="score-item-label">ç¬¬1éƒ¨ è¨˜è¿°å¼</div><div class="score-item-value">${data.section1TextScore} / ${data.section1TextTotal}</div></div>
            <div class="score-item"><div class="score-item-label">ç¬¬2éƒ¨</div><div class="score-item-value">${data.section2Score} / ${data.section2Total}</div></div>
          </div>
        </div>
        <div class="review-section">
          <h3>ğŸ“ å›ç­”ã®æŒ¯ã‚Šè¿”ã‚Š</h3>
          ${data.results.map((r, i) => `
            <div class="review-item ${r.isCorrect ? 'correct' : 'incorrect'}">
              <div class="review-question">å•${i + 1}. ${r.question.question.split('\n')[0]}</div>
              <div class="review-answer">
                <span class="your-answer">ã‚ãªãŸã®å›ç­”: ${formatAnswer(r.question, r.userAnswer)}</span>
                ${r.question.type === 'single' || r.question.type === 'multi' ? `<span class="correct-answer">æ­£è§£: ${formatCorrectAnswer(r.question)}</span>` : ''}
                <span>å¾—ç‚¹: ${r.score} / ${r.question.points}ç‚¹</span>
              </div>
              ${r.feedback ? `<div class="ai-feedback"><div class="ai-feedback-label">ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</div>${r.feedback}</div>` : ''}
            </div>
          `).join('')}
        </div>
        <div style="text-align: center; margin-top: 2rem;">
          <button class="btn btn-primary" id="retryBtn">ã‚‚ã†ä¸€åº¦å—é¨“ã™ã‚‹</button>
        </div>
      `;

      document.getElementById('retryBtn').addEventListener('click', () => location.reload());
      window.scrollTo(0, 0);
    }

    function formatAnswer(q, answer) {
      if (answer === undefined || answer === null || answer === '') return 'æœªå›ç­”';
      if (q.type === 'single') return `${String.fromCharCode(65 + answer)}. ${q.options[answer]}`;
      if (q.type === 'multi') return answer.length ? answer.map(i => String.fromCharCode(65 + i)).join(', ') : 'æœªå›ç­”';
      return answer.length > 50 ? answer.substring(0, 50) + '...' : answer;
    }

    function formatCorrectAnswer(q) {
      if (q.type === 'single') return `${String.fromCharCode(65 + q.correct)}. ${q.options[q.correct]}`;
      if (q.type === 'multi') return q.correct.map(i => String.fromCharCode(65 + i)).join(', ');
      return '';
    }
  </script>
</body>
</html>