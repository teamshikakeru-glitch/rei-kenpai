<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rei å–¶æ¥­ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #1a1f2e; color: #e0e0e0; line-height: 1.5; min-height: 100vh; }
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .login-card { background: #252b3d; border-radius: 16px; padding: 2.5rem; width: 90%; max-width: 400px; text-align: center; }
    .login-logo { font-size: 3rem; color: #c9a962; margin-bottom: 1rem; }
    .login-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; }
    .login-sub { font-size: 0.9rem; color: #8a8a9a; margin-bottom: 1.5rem; }
    .form-input { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; border: 2px solid #3d4559; border-radius: 8px; background: #1a1f2e; color: white; margin-bottom: 1rem; }
    .form-input:focus { outline: none; border-color: #c9a962; }
    .btn { display: block; width: 100%; padding: 0.85rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; }
    .btn-gold { background: #c9a962; color: #1a1f2e; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #3d4559; color: #e0e0e0; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8rem; width: auto; display: inline-block; }
    .error-box { background: #5c2a2a; color: #ff8a8a; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: none; }
    #mainApp { display: none; }
    .header { background: #252b3d; padding: 1rem 1.5rem; border-bottom: 1px solid #3d4559; display: flex; align-items: center; justify-content: space-between; }
    .header-logo { font-size: 1.2rem; font-weight: 700; color: #c9a962; }
    .header-logout { background: #3d4559; color: #e0e0e0; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; }
    .layout { display: flex; min-height: calc(100vh - 60px); }
    .sidebar { width: 200px; background: #252b3d; border-right: 1px solid #3d4559; padding: 1rem 0; }
    .nav-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1.25rem; color: #8a8a9a; font-size: 0.9rem; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
    .nav-item:hover { background: #2d3548; color: #e0e0e0; }
    .nav-item.active { background: #3d4559; color: #c9a962; }
    .nav-badge { margin-left: auto; background: #dc3545; color: white; font-size: 0.7rem; padding: 0.15rem 0.5rem; border-radius: 100px; }
    .main-content { flex: 1; padding: 1.5rem; overflow-y: auto; }
    .page { display: none; }
    .page.active { display: block; }
    .page-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: #c9a962; }
    .card { background: #252b3d; border-radius: 12px; margin-bottom: 1rem; overflow: hidden; }
    .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid #3d4559; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; }
    .card-title { font-size: 0.95rem; font-weight: 600; }
    .card-body { padding: 1rem 1.25rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: #252b3d; border-radius: 12px; padding: 1.25rem; border-left: 4px solid #3d4559; }
    .stat-card.info { border-left-color: #17a2b8; }
    .stat-card.warning { border-left-color: #ffc107; }
    .stat-card.success { border-left-color: #28a745; }
    .stat-card.alert { border-left-color: #dc3545; }
    .stat-card.gold { border-left-color: #c9a962; }
    .stat-label { font-size: 0.8rem; color: #8a8a9a; }
    .stat-value { font-size: 1.75rem; font-weight: 700; }
    .stat-value.small { font-size: 1.3rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #3d4559; font-size: 0.85rem; }
    th { color: #8a8a9a; font-size: 0.75rem; }
    tr:hover td { background: #2d3548; }
    .badge { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 100px; font-size: 0.7rem; font-weight: 600; }
    .badge-yellow { background: #ffc107; color: #1a1f2e; }
    .badge-green { background: #28a745; color: white; }
    .badge-red { background: #dc3545; color: white; }
    .badge-gray { background: #6c757d; color: white; }
    .badge-blue { background: #17a2b8; color: white; }
    .badge-orange { background: #fd7e14; color: white; }
    .modal-bg { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-bg.show { display: flex; }
    .modal-box { background: #252b3d; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; }
    .modal-head { padding: 1.25rem; border-bottom: 1px solid #3d4559; display: flex; align-items: center; justify-content: space-between; }
    .modal-head h3 { font-size: 1.1rem; color: #c9a962; }
    .modal-close { width: 32px; height: 32px; border: none; background: #3d4559; border-radius: 50%; color: white; font-size: 1.2rem; cursor: pointer; }
    .modal-content { padding: 1.25rem; max-height: 70vh; overflow-y: auto; }
    .modal-foot { padding: 1rem 1.25rem; border-top: 1px solid #3d4559; display: flex; gap: 0.75rem; justify-content: flex-end; }
    .modal-foot .btn { width: auto; }
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.85rem; color: #8a8a9a; margin-bottom: 0.4rem; }
    .form-input-dark { width: 100%; padding: 0.7rem; font-size: 0.95rem; border: 1px solid #3d4559; border-radius: 8px; background: #1a1f2e; color: white; }
    .form-input-dark:focus { outline: none; border-color: #c9a962; }
    .list-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid #3d4559; }
    .list-item:hover { background: #2d3548; }
    .list-item:last-child { border-bottom: none; }
    .empty { text-align: center; padding: 2rem; color: #8a8a9a; }
    .region-stats { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .region-stat { background: #3d4559; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.8rem; }
    .region-stat strong { color: #c9a962; }
    .expense-summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .expense-summary-card { background: #1a1f2e; border-radius: 10px; padding: 1rem; text-align: center; }
    .expense-summary-label { font-size: 0.75rem; color: #8a8a9a; margin-bottom: 0.25rem; }
    .expense-summary-value { font-size: 1.4rem; font-weight: 700; color: #c9a962; }
    .expense-summary-value.pending { color: #ffc107; }
    .expense-summary-value.approved { color: #28a745; }
    .expense-summary-value.rejected { color: #dc3545; }
    @media (max-width: 768px) { .sidebar { display: none; } }
    
    /* ç®¡ç†ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .admin-calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      background: #1a1f2e;
      color: #e0e0e0;
      min-height: 50px;
    }
    .admin-calendar-day:hover { background: #2d3548; }
    .admin-calendar-day.other-month { color: #5a5a6a; background: transparent; }
    .admin-calendar-day.today { background: #c9a962; color: #1a1f2e; font-weight: 700; }
    .admin-calendar-day.selected { border: 2px solid #c9a962; }
    .admin-calendar-day .schedule-count {
      position: absolute;
      bottom: 4px;
      font-size: 0.65rem;
      background: #28a745;
      color: white;
      padding: 0 4px;
      border-radius: 4px;
    }
    .admin-calendar-day.today .schedule-count { background: #1a1f2e; color: #c9a962; }
    .admin-calendar-header {
      text-align: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: #8a8a9a;
      padding: 0.5rem 0;
    }
    .admin-calendar-header.sun { color: #dc3545; }
    .admin-calendar-header.sat { color: #17a2b8; }
  </style>
</head>
<body>
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">ç¤¼</div>
    <div class="login-title">å–¶æ¥­ç®¡ç†</div>
    <div class="login-sub">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <div class="error-box" id="loginError">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div>
    <input type="password" class="form-input" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn btn-gold" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>
<div id="mainApp">
  <header class="header">
    <div class="header-logo">ç¤¼ å–¶æ¥­ç®¡ç†</div>
    <button class="header-logout" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>
  <div class="layout">
    <aside class="sidebar">
      <button class="nav-item active" data-page="dashboard"><span>ğŸ“Š</span><span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span></button>
      <button class="nav-item" data-page="goals"><span>ğŸ¯</span><span>ç›®æ¨™ç®¡ç†</span></button>
      <button class="nav-item" data-page="funerals"><span>ğŸ¢</span><span>è‘¬å„€ç¤¾ç®¡ç†</span></button>
      <button class="nav-item" data-page="expenses"><span>ğŸ’°</span><span>çµŒè²»ç”³è«‹</span><span class="nav-badge" id="expenseBadge" style="display:none;">0</span></button>
      <button class="nav-item" data-page="members"><span>ğŸ‘¥</span><span>ãƒ¡ãƒ³ãƒãƒ¼</span></button>
      <button class="nav-item" data-page="todos"><span>ğŸ“‹</span><span>TODOæŒ‡ç¤º</span></button>
      <button class="nav-item" data-page="posts"><span>ğŸ’¬</span><span>æ²ç¤ºæ¿</span></button>
      <button class="nav-item" data-page="schedules"><span>ğŸ“…</span><span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span></button>
      <div style="border-top:1px solid #3d4559; margin:1rem 0;"></div>
      <div style="padding:0.5rem 1.25rem; font-size:0.7rem; color:#8a8a9a; text-transform:uppercase;">å¤–éƒ¨ãƒªãƒ³ã‚¯</div>
      <a href="sales-test-admin.html" target="_blank" class="nav-item" style="text-decoration:none;"><span>ğŸ“</span><span>ãƒ†ã‚¹ãƒˆç®¡ç†</span></a>
      <a href="/admin" target="_blank" class="nav-item" style="text-decoration:none;"><span>ğŸ™</span><span>çŒ®æ¯ç®¡ç†</span></a>
    </aside>
    <main class="main-content">
      <div class="page active" id="page-dashboard">
        <h1 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="stats-grid">
          <div class="stat-card info"><div class="stat-label">è‘¬å„€ç¤¾ ç·æ•°</div><div class="stat-value" id="statTotal">0</div></div>
          <div class="stat-card warning"><div class="stat-label">å•†è«‡ä¸­</div><div class="stat-value" id="statNego">0</div></div>
          <div class="stat-card success"><div class="stat-label">æˆç´„</div><div class="stat-value" id="statClosed">0</div></div>
          <div class="stat-card alert"><div class="stat-label">çµŒè²»ï¼ˆæœªå‡¦ç†ï¼‰</div><div class="stat-value" id="statPending">0</div></div>
          <div class="stat-card gold"><div class="stat-label">çµŒè²»åˆè¨ˆï¼ˆæ‰¿èªæ¸ˆï¼‰</div><div class="stat-value small" id="statExpenseTotal">Â¥0</div></div>
        </div>
        <div class="card"><div class="card-header"><span class="card-title">ğŸ“ ã‚¨ãƒªã‚¢åˆ¥</span></div><div class="card-body"><div class="region-stats" id="regionStats"></div></div></div>
        <div class="card"><div class="card-header"><span class="card-title">ğŸ“ˆ ãƒ¡ãƒ³ãƒãƒ¼åˆ¥</span></div><div class="card-body" style="padding:0;"><table><thead><tr><th>åå‰</th><th>æ‹…å½“</th><th>å•†è«‡ä¸­</th><th>æˆç´„</th></tr></thead><tbody id="memberStatsTable"></tbody></table></div></div>
      </div>
      
      <!-- ç›®æ¨™ç®¡ç†ãƒšãƒ¼ã‚¸ -->
      <div class="page" id="page-goals">
        <h1 class="page-title">ğŸ¯ ç›®æ¨™ç®¡ç†</h1>
        
        <!-- KPIè¨­è¨ˆã®èª¬æ˜ -->
        <div class="card" style="background:linear-gradient(135deg, #252b3d, #2d3548); border-left:4px solid #c9a962;">
          <div class="card-body">
            <div style="display:flex; align-items:center; gap:1rem; flex-wrap:wrap;">
              <div style="font-size:2rem;">ğŸ“</div>
              <div style="flex:1; min-width:200px;">
                <div style="font-weight:600; color:#c9a962; margin-bottom:0.25rem;">KPIè¨­è¨ˆï¼ˆè»¢æ›ç‡ï¼‰</div>
                <div style="font-size:0.85rem; color:#8a8a9a;">
                  Î²ï¼ˆã‚¢ãƒâ†’å•†è«‡ï¼‰= 70% ï½œ Î³ï¼ˆå•†è«‡â†’è¦‹è¾¼ã¿ï¼‰= 50% ï½œ Î´ï¼ˆè¦‹è¾¼ã¿â†’å—æ³¨ï¼‰= 10%
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- å…¨ä½“ã‚µãƒãƒªãƒ¼ -->
        <div class="stats-grid" style="margin-top:1rem;">
          <div class="stat-card success">
            <div class="stat-label">ä»Šæœˆã®å—æ³¨ï¼ˆãƒãƒ¼ãƒ è¨ˆï¼‰</div>
            <div class="stat-value" id="goalTeamClosed">0</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-label">è¦‹è¾¼ã¿ï¼ˆãƒãƒ¼ãƒ è¨ˆï¼‰</div>
            <div class="stat-value" id="goalTeamProspect">0</div>
          </div>
          <div class="stat-card info">
            <div class="stat-label">å•†è«‡ï¼ˆãƒãƒ¼ãƒ è¨ˆï¼‰</div>
            <div class="stat-value" id="goalTeamNego">0</div>
          </div>
          <div class="stat-card gold">
            <div class="stat-label">ã‚¢ãƒï¼ˆãƒãƒ¼ãƒ è¨ˆï¼‰</div>
            <div class="stat-value" id="goalTeamAppo">0</div>
          </div>
        </div>
        
        <!-- ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ç›®æ¨™ä¸€è¦§ -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ æœˆé–“ç›®æ¨™ãƒ»é€²æ—</span>
            <select class="form-input-dark" id="goalMonthFilter" style="width:auto; padding:0.4rem;"></select>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>åå‰</th>
                  <th style="text-align:center;">å—æ³¨ç›®æ¨™</th>
                  <th style="text-align:center;">å—æ³¨å®Ÿç¸¾</th>
                  <th style="text-align:center;">è¦‹è¾¼ã¿</th>
                  <th style="text-align:center;">å•†è«‡</th>
                  <th style="text-align:center;">ã‚¢ãƒ</th>
                  <th style="text-align:center;">é”æˆç‡</th>
                  <th>æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="goalMemberTable"></tbody>
            </table>
          </div>
        </div>
        
        <!-- ãƒ¡ãƒ³ãƒãƒ¼åˆ¥è©³ç´°ã‚«ãƒ¼ãƒ‰ -->
        <div id="goalMemberCards"></div>
      </div>
      <div class="page" id="page-funerals">
        <h1 class="page-title">ğŸ¢ è‘¬å„€ç¤¾ç®¡ç†ï¼ˆ<span id="funeralCount">0</span>ç¤¾ï¼‰</h1>
        <div class="card">
          <div class="card-header">
            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
              <select class="form-input-dark" id="filterRegion" style="width:auto;padding:0.4rem;"><option value="">å…¨ã‚¨ãƒªã‚¢</option></select>
              <select class="form-input-dark" id="filterPref" style="width:auto;padding:0.4rem;"><option value="">å…¨éƒ½é“åºœçœŒ</option></select>
              <select class="form-input-dark" id="filterTemp" style="width:auto;padding:0.4rem;"><option value="">å…¨æ„Ÿåº¦</option><option value="ç†±ã„">ğŸ”¥ç†±ã„</option><option value="æ¸©ã‹ã„">â˜€ï¸æ¸©ã‹ã„</option><option value="æ™®é€š">ğŸ˜æ™®é€š</option><option value="å†·ãŸã„">â„ï¸å†·ãŸã„</option></select>
            </div>
            <button class="btn btn-sm btn-gold" onclick="openFuneralModal()">+ è¿½åŠ </button>
          </div>
          <div style="overflow-x:auto;"><table><thead><tr><th>è‘¬å„€ç¤¾å</th><th>ã‚¨ãƒªã‚¢</th><th>éƒ½é“åºœçœŒ</th><th>æ„Ÿåº¦</th><th>æ‹…å½“</th><th>çŠ¶æ…‹</th><th></th></tr></thead><tbody id="funeralTable"></tbody></table></div>
        </div>
      </div>
      <div class="page" id="page-expenses">
        <h1 class="page-title">ğŸ’° çµŒè²»ç”³è«‹</h1>
        
        <!-- çµŒè²»ã‚µãƒãƒªãƒ¼ -->
        <div class="expense-summary" id="expenseSummary">
          <div class="expense-summary-card">
            <div class="expense-summary-label">ç”³è«‹ä¸­</div>
            <div class="expense-summary-value pending" id="expPending">Â¥0</div>
          </div>
          <div class="expense-summary-card">
            <div class="expense-summary-label">æ‰¿èªæ¸ˆ</div>
            <div class="expense-summary-value approved" id="expApproved">Â¥0</div>
          </div>
          <div class="expense-summary-card">
            <div class="expense-summary-label">å´ä¸‹</div>
            <div class="expense-summary-value rejected" id="expRejected">Â¥0</div>
          </div>
          <div class="expense-summary-card">
            <div class="expense-summary-label">ç·ç”³è«‹é¡</div>
            <div class="expense-summary-value" id="expTotal">Â¥0</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">ç”³è«‹ä¸€è¦§</span>
            <select class="form-input-dark" id="expenseFilter" style="width:auto;padding:0.4rem;">
              <option value="ç”³è«‹ä¸­">ç”³è«‹ä¸­</option>
              <option value="æ‰¿èª">æ‰¿èªæ¸ˆ</option>
              <option value="å´ä¸‹">å´ä¸‹</option>
              <option value="">ã™ã¹ã¦</option>
            </select>
          </div>
          <div id="expensesList"></div>
        </div>
        
        <!-- çµŒè²»å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">ğŸ“‹ çµŒè²»å±¥æ­´ï¼ˆå…¨ä»¶ï¼‰</span>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>ç”³è«‹è€…</th>
                  <th>ã‚«ãƒ†ã‚´ãƒª</th>
                  <th>å†…å®¹</th>
                  <th>é‡‘é¡</th>
                  <th>çŠ¶æ…‹</th>
                  <th>ç”³è«‹æ—¥æ™‚</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="expenseHistoryTable"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="page" id="page-members"><h1 class="page-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼</h1><div class="card"><div id="membersList"></div></div></div>
      <div class="page" id="page-todos"><h1 class="page-title">ğŸ“‹ TODOæŒ‡ç¤º</h1><div class="card"><div class="card-header"><span class="card-title">ä¸€è¦§</span><button class="btn btn-sm btn-gold" onclick="openTodoModal()">+ æ–°è¦</button></div><div id="todosList"></div></div></div>
      <div class="page" id="page-posts"><h1 class="page-title">ğŸ’¬ æ²ç¤ºæ¿</h1><div class="card"><div class="card-header"><span class="card-title">æŠ•ç¨¿</span><button class="btn btn-sm btn-gold" onclick="openPostModal()">+ æŠ•ç¨¿</button></div><div id="postsList"></div></div></div>
      
      <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç† -->
      <div class="page" id="page-schedules">
        <h1 class="page-title">ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h1>
        
        <!-- ãƒ¡ãƒ³ãƒãƒ¼ç¨¼åƒçŠ¶æ³ -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ç¨¼åƒçŠ¶æ³ï¼ˆä»Šæœˆï¼‰</span>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>åå‰</th>
                  <th>äºˆå®šæ•°</th>
                  <th>å®Œäº†</th>
                  <th>æœªå®Œäº†</th>
                  <th>ç›´è¿‘ã®äºˆå®š</th>
                  <th>æœ€çµ‚æ´»å‹•</th>
                </tr>
              </thead>
              <tbody id="memberActivityTable"></tbody>
            </table>
          </div>
        </div>
        
        <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
        <div class="card">
          <div class="card-header">
            <button class="btn btn-sm btn-secondary" onclick="changeAdminMonth(-1)">â—€</button>
            <span class="card-title" id="adminCalendarTitle">2026å¹´1æœˆ</span>
            <button class="btn btn-sm btn-secondary" onclick="changeAdminMonth(1)">â–¶</button>
          </div>
          <div class="card-body" style="padding:0.5rem;">
            <div id="adminCalendarGrid" style="display:grid; grid-template-columns:repeat(7,1fr); gap:2px;"></div>
          </div>
        </div>
        
        <!-- é¸æŠæ—¥ã®äºˆå®š -->
        <div class="card">
          <div class="card-header">
            <span class="card-title" id="adminSelectedDateTitle">äºˆå®šä¸€è¦§</span>
            <select class="form-input-dark" id="scheduleMemberFilter" style="width:auto; padding:0.4rem;">
              <option value="">å…¨ãƒ¡ãƒ³ãƒãƒ¼</option>
            </select>
          </div>
          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th>æ—¥ä»˜</th>
                  <th>ãƒ¡ãƒ³ãƒãƒ¼</th>
                  <th>è¨ªå•å…ˆ</th>
                  <th>ãƒ¡ãƒ¢</th>
                  <th>çŠ¶æ…‹</th>
                </tr>
              </thead>
              <tbody id="scheduleListTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>
<div class="modal-bg" id="funeralModal"><div class="modal-box"><div class="modal-head"><h3 id="funeralModalTitle">è‘¬å„€ç¤¾ã‚’è¿½åŠ </h3><button class="modal-close" onclick="closeModal('funeralModal')">&times;</button></div><div class="modal-content"><input type="hidden" id="funeralId"><div class="form-group"><label class="form-label">è‘¬å„€ç¤¾å *</label><input type="text" class="form-input-dark" id="fName"></div><div class="form-group"><label class="form-label">éƒ½é“åºœçœŒ *</label><select class="form-input-dark" id="fPref" onchange="updateRegionFromPref()"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select></div><input type="hidden" id="fRegion"><div class="form-group"><label class="form-label">ä½æ‰€</label><input type="text" class="form-input-dark" id="fAddress"></div><div class="form-group"><label class="form-label">é›»è©±ç•ªå·</label><input type="tel" class="form-input-dark" id="fPhone"></div><div class="form-group"><label class="form-label">æ„Ÿåº¦</label><select class="form-input-dark" id="fTemp"><option value="æœªè¨­å®š">æœªè¨­å®š</option><option value="ç†±ã„">ğŸ”¥ç†±ã„</option><option value="æ¸©ã‹ã„">â˜€ï¸æ¸©ã‹ã„</option><option value="æ™®é€š">ğŸ˜æ™®é€š</option><option value="å†·ãŸã„">â„ï¸å†·ãŸã„</option></select></div><div class="form-group"><label class="form-label">ãƒ¡ãƒ¢</label><textarea class="form-input-dark" id="fNotes" rows="2"></textarea></div></div><div class="modal-foot"><button class="btn btn-secondary" onclick="closeModal('funeralModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-gold" onclick="saveFuneral()">ä¿å­˜</button></div></div></div>
<div class="modal-bg" id="todoModal"><div class="modal-box"><div class="modal-head"><h3 id="todoModalTitle">TODOæŒ‡ç¤º</h3><button class="modal-close" onclick="closeModal('todoModal')">&times;</button></div><div class="modal-content"><input type="hidden" id="todoId"><div class="form-group"><label class="form-label">æ‹…å½“è€… *</label><select class="form-input-dark" id="todoMember"></select></div><div class="form-group"><label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label><input type="text" class="form-input-dark" id="todoTitle"></div><div class="form-group"><label class="form-label">è©³ç´°</label><textarea class="form-input-dark" id="todoDesc" rows="2"></textarea></div><div class="form-group"><label class="form-label">æœŸé™</label><input type="date" class="form-input-dark" id="todoDue"></div><div class="form-group" id="todoStatusGroup" style="display:none;"><label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label><select class="form-input-dark" id="todoStatus"><option value="æœªç€æ‰‹">æœªç€æ‰‹</option><option value="ç¢ºèªæ¸ˆã¿">ç¢ºèªæ¸ˆã¿</option><option value="å–çµ„ä¸­">å–çµ„ä¸­</option><option value="å®Œäº†">å®Œäº†</option></select></div></div><div class="modal-foot"><button class="btn btn-secondary" onclick="closeModal('todoModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-gold" onclick="saveTodo()">ä¿å­˜</button></div></div></div>
<div class="modal-bg" id="postModal"><div class="modal-box"><div class="modal-head"><h3>æŠ•ç¨¿</h3><button class="modal-close" onclick="closeModal('postModal')">&times;</button></div><div class="modal-content"><div class="form-group"><label class="form-label">å†…å®¹ *</label><textarea class="form-input-dark" id="postContent" rows="3"></textarea></div></div><div class="modal-foot"><button class="btn btn-secondary" onclick="closeModal('postModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-gold" onclick="savePost()">æŠ•ç¨¿</button></div></div></div>
<div class="modal-bg" id="memberModal"><div class="modal-box"><div class="modal-head"><h3 id="memberModalTitle">ãƒ¡ãƒ³ãƒãƒ¼</h3><button class="modal-close" onclick="closeModal('memberModal')">&times;</button></div><div class="modal-content"><div id="memberDetail"></div><hr style="border:none;border-top:1px solid #3d4559;margin:1rem 0;"><textarea class="form-input-dark" id="memberMessage" rows="2" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..."></textarea><button class="btn btn-sm btn-gold" onclick="sendNotification()" style="margin-top:0.5rem;">é€ä¿¡</button></div><div class="modal-foot"><button class="btn btn-secondary" onclick="closeModal('memberModal')">é–‰ã˜ã‚‹</button></div></div></div>
<div class="modal-bg" id="goalEditModal"><div class="modal-box"><div class="modal-head"><h3>ğŸ¯ ç›®æ¨™ã‚’è¨­å®š</h3><button class="modal-close" onclick="closeModal('goalEditModal')">&times;</button></div><div class="modal-content"><input type="hidden" id="goalEditMemberId"><input type="hidden" id="goalEditId"><div style="background:#1a1f2e; padding:0.75rem; border-radius:8px; margin-bottom:1rem;"><div style="font-size:0.8rem; color:#8a8a9a;">å¯¾è±¡ãƒ¡ãƒ³ãƒãƒ¼</div><div style="font-weight:600; color:#c9a962;" id="goalEditMemberName">-</div></div><div class="form-group"><label class="form-label">ğŸ† æœˆé–“å—æ³¨ç›®æ¨™ï¼ˆç¤¾ï¼‰</label><input type="number" class="form-input-dark" id="goalEditClosed" placeholder="ä¾‹ï¼š5" oninput="calcGoalPreview()"><div style="font-size:0.75rem; color:#8a8a9a; margin-top:0.25rem;">ã“ã®æ•°å­—ã‹ã‚‰å¿…è¦ãªã‚¢ãƒæ•°ã‚’è‡ªå‹•é€†ç®—ã—ã¾ã™</div></div><div id="goalEditPreview" style="background:#1a1f2e; padding:1rem; border-radius:8px; margin-top:1rem; display:none;"><div style="font-weight:600; margin-bottom:0.5rem; color:#c9a962;">ğŸ“Š å¿…è¦æ•°ã®é€†ç®—</div><div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; font-size:0.9rem;"><div style="color:#8a8a9a;">è¦‹è¾¼ã¿æ•°:</div><div id="goalPreviewProspect">-</div><div style="color:#8a8a9a;">å•†è«‡æ•°:</div><div id="goalPreviewNego">-</div><div style="color:#8a8a9a;">ã‚¢ãƒæ•°:</div><div style="color:#28a745; font-weight:600;" id="goalPreviewAppo">-</div></div><hr style="border:none;border-top:1px solid #3d4559;margin:0.75rem 0;"><div style="display:grid; grid-template-columns:1fr 1fr; gap:0.5rem; font-size:0.85rem; color:#8a8a9a;"><div>é€±ã‚ãŸã‚Š:</div><div id="goalPreviewWeekly">-</div><div>æ—¥ã‚ãŸã‚Š:</div><div id="goalPreviewDaily">-</div></div></div></div><div class="modal-foot"><button class="btn btn-secondary" onclick="closeModal('goalEditModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn btn-gold" onclick="saveGoalEdit()">ä¿å­˜</button></div></div></div>
<script>
var supabase,members=[],prospects=[],expenses=[],todos=[],posts=[],schedules=[],goals=[],selectedMemberId=null,adminCalendarDate=new Date(),adminSelectedDate=null;
var ADMIN_PASS='1123';
var SUPABASE_URL='https://osyysvompcfuadlnuojs.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';
var REGIONS={'åŒ—æµ·é“':['åŒ—æµ·é“'],'æ±åŒ—':['é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ'],'é–¢æ±':['æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ'],'åŒ—é™¸':['æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ'],'æ±æµ·':['å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ'],'é–¢è¥¿':['æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ'],'ä¸­å›½':['é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ'],'å››å›½':['å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ'],'ä¹å·':['ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ']};
window.onload=function(){supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);if(localStorage.getItem('salesAdminLoggedIn')==='true')showMainApp();document.querySelectorAll('.nav-item').forEach(function(el){el.onclick=function(){switchPage(this.dataset.page);};});initFilters();document.getElementById('filterRegion').onchange=function(){updatePrefOptions(this.value,'filterPref','å…¨éƒ½é“åºœçœŒ');renderFunerals();};document.getElementById('filterPref').onchange=renderFunerals;document.getElementById('filterTemp').onchange=renderFunerals;document.getElementById('expenseFilter').onchange=renderExpenses;document.getElementById('fRegion').onchange=function(){updatePrefOptions(this.value,'fPref','é¸æŠ');};document.getElementById('adminPass').onkeypress=function(e){if(e.key==='Enter')doLogin();};};
function initFilters(){var h='<option value="">å…¨ã‚¨ãƒªã‚¢</option>';Object.keys(REGIONS).forEach(function(r){h+='<option value="'+r+'">'+r+'</option>';});document.getElementById('filterRegion').innerHTML=h;document.getElementById('fRegion').innerHTML='<option value="">é¸æŠ</option>'+h.replace('å…¨ã‚¨ãƒªã‚¢','é¸æŠ');}
function updatePrefOptions(region,selectId,defaultText){var s=document.getElementById(selectId);var h='<option value="">'+defaultText+'</option>';if(region&&REGIONS[region])REGIONS[region].forEach(function(p){h+='<option value="'+p+'">'+p+'</option>';});s.innerHTML=h;}
function doLogin(){if(document.getElementById('adminPass').value===ADMIN_PASS){localStorage.setItem('salesAdminLoggedIn','true');showMainApp();}else{document.getElementById('loginError').style.display='block';}}
function doLogout(){localStorage.removeItem('salesAdminLoggedIn');document.getElementById('mainApp').style.display='none';document.getElementById('loginScreen').style.display='flex';}
function showMainApp(){document.getElementById('loginScreen').style.display='none';document.getElementById('mainApp').style.display='block';loadData();}
function loadData(){supabase.from('sales_members').select('*').then(function(r){members=r.data||[];renderMembers();updateTodoSelect();updateScheduleMemberFilter();});supabase.from('sales_prospects').select('*').order('created_at',{ascending:false}).then(function(r){prospects=r.data||[];updateStats();renderFunerals();renderGoalStats();});supabase.from('sales_expenses').select('*').order('created_at',{ascending:false}).then(function(r){expenses=r.data||[];updateStats();renderExpenses();renderExpenseHistory();updateExpenseSummary();});supabase.from('sales_todos').select('*').order('created_at',{ascending:false}).then(function(r){todos=r.data||[];renderTodos();});supabase.from('sales_posts').select('*').order('created_at',{ascending:false}).limit(50).then(function(r){posts=r.data||[];renderPosts();});supabase.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r){schedules=r.data||[];renderMemberActivity();renderAdminCalendar();renderScheduleList();});supabase.from('sales_goals').select('*').then(function(r){goals=r.data||[];initGoalMonthFilter();renderGoalStats();});}
function switchPage(page){document.querySelectorAll('.nav-item').forEach(function(el){el.classList.toggle('active',el.dataset.page===page);});document.querySelectorAll('.page').forEach(function(el){el.classList.toggle('active',el.id==='page-'+page);});}
function updateStats(){var pending=expenses.filter(function(e){return e.status==='ç”³è«‹ä¸­';}).length;var nego=prospects.filter(function(p){return p.status==='å•†è«‡ä¸­';}).length;var closed=prospects.filter(function(p){return p.status==='æˆç´„';}).length;var approvedTotal=expenses.filter(function(e){return e.status==='æ‰¿èª';}).reduce(function(sum,e){return sum+(e.amount||0);},0);document.getElementById('statTotal').textContent=prospects.length;document.getElementById('statNego').textContent=nego;document.getElementById('statClosed').textContent=closed;document.getElementById('statPending').textContent=pending;document.getElementById('statExpenseTotal').textContent='Â¥'+approvedTotal.toLocaleString();document.getElementById('funeralCount').textContent=prospects.length;var badge=document.getElementById('expenseBadge');badge.textContent=pending;badge.style.display=pending>0?'inline':'none';var rc={};Object.keys(REGIONS).forEach(function(r){rc[r]=0;});prospects.forEach(function(p){if(p.region&&rc[p.region]!==undefined)rc[p.region]++;});var rh='';Object.keys(rc).forEach(function(r){if(rc[r]>0)rh+='<div class="region-stat"><strong>'+r+'</strong> '+rc[r]+'ç¤¾</div>';});document.getElementById('regionStats').innerHTML=rh||'<span style="color:#8a8a9a;">ãªã—</span>';var mh='';members.forEach(function(m){var mp=prospects.filter(function(p){return p.assigned_to===m.id;});var mn=mp.filter(function(p){return p.status==='å•†è«‡ä¸­';}).length;var mc=mp.filter(function(p){return p.status==='æˆç´„';}).length;mh+='<tr><td>'+esc(m.name)+'</td><td>'+mp.length+'</td><td>'+mn+'</td><td>'+mc+'</td></tr>';});document.getElementById('memberStatsTable').innerHTML=mh||'<tr><td colspan="4" class="empty">ãªã—</td></tr>';}
function updateExpenseSummary(){var pendingAmount=expenses.filter(function(e){return e.status==='ç”³è«‹ä¸­';}).reduce(function(sum,e){return sum+(e.amount||0);},0);var approvedAmount=expenses.filter(function(e){return e.status==='æ‰¿èª';}).reduce(function(sum,e){return sum+(e.amount||0);},0);var rejectedAmount=expenses.filter(function(e){return e.status==='å´ä¸‹';}).reduce(function(sum,e){return sum+(e.amount||0);},0);var totalAmount=expenses.reduce(function(sum,e){return sum+(e.amount||0);},0);document.getElementById('expPending').textContent='Â¥'+pendingAmount.toLocaleString();document.getElementById('expApproved').textContent='Â¥'+approvedAmount.toLocaleString();document.getElementById('expRejected').textContent='Â¥'+rejectedAmount.toLocaleString();document.getElementById('expTotal').textContent='Â¥'+totalAmount.toLocaleString();}
function renderFunerals(){var region=document.getElementById('filterRegion').value,pref=document.getElementById('filterPref').value,temp=document.getElementById('filterTemp').value;var filtered=prospects.filter(function(p){if(region&&p.region!==region)return false;if(pref&&p.area!==pref)return false;if(temp&&p.temperature!==temp)return false;return true;});var tbody=document.getElementById('funeralTable');if(filtered.length===0){tbody.innerHTML='<tr><td colspan="7" class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';return;}var h='';filtered.forEach(function(p){var member=members.find(function(m){return m.id===p.assigned_to;});var tb={'ç†±ã„':'badge-red','æ¸©ã‹ã„':'badge-orange','æ™®é€š':'badge-gray','å†·ãŸã„':'badge-blue'}[p.temperature]||'badge-gray';var sb={'æœªè¨ªå•':'badge-gray','è¨ªå•æ¸ˆã¿':'badge-blue','å•†è«‡ä¸­':'badge-yellow','æˆç´„':'badge-green','è¦‹é€ã‚Š':'badge-red'}[p.status]||'badge-gray';h+='<tr><td><strong>'+esc(p.company_name)+'</strong></td><td>'+esc(p.region||'-')+'</td><td>'+esc(p.area||'-')+'</td><td><span class="badge '+tb+'">'+(p.temperature||'æœªè¨­å®š')+'</span></td><td>'+(member?esc(member.name):'-')+'</td><td><span class="badge '+sb+'">'+(p.status||'æœªè¨ªå•')+'</span></td><td><button class="btn btn-sm btn-secondary" onclick="editFuneral(\''+p.id+'\')">ç·¨é›†</button> <button class="btn btn-sm btn-danger" onclick="deleteFuneral(\''+p.id+'\',\''+esc(p.company_name).replace(/'/g,"\\'")+'\')">å‰Šé™¤</button></td></tr>';});tbody.innerHTML=h;}
function openFuneralModal(){document.getElementById('funeralModalTitle').textContent='è‘¬å„€ç¤¾ã‚’è¿½åŠ ';document.getElementById('funeralId').value='';document.getElementById('fName').value='';document.getElementById('fRegion').value='';document.getElementById('fPref').innerHTML='<option value="">å…ˆã«ã‚¨ãƒªã‚¢ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';document.getElementById('fAddress').value='';document.getElementById('fPhone').value='';document.getElementById('fTemp').value='æœªè¨­å®š';document.getElementById('fNotes').value='';openModal('funeralModal');}
function editFuneral(id){var p=prospects.find(function(x){return x.id===id;});if(!p)return;document.getElementById('funeralModalTitle').textContent='è‘¬å„€ç¤¾ã‚’ç·¨é›†';document.getElementById('funeralId').value=p.id;document.getElementById('fName').value=p.company_name||'';document.getElementById('fRegion').value=p.region||'';updatePrefOptions(p.region,'fPref','é¸æŠ');document.getElementById('fPref').value=p.area||'';document.getElementById('fAddress').value=p.address||'';document.getElementById('fPhone').value=p.phone||'';document.getElementById('fTemp').value=p.temperature||'æœªè¨­å®š';document.getElementById('fNotes').value=p.notes||'';openModal('funeralModal');}
function saveFuneral(){var id=document.getElementById('funeralId').value;var data={company_name:document.getElementById('fName').value.trim(),region:document.getElementById('fRegion').value,area:document.getElementById('fPref').value,address:document.getElementById('fAddress').value.trim(),phone:document.getElementById('fPhone').value.trim(),temperature:document.getElementById('fTemp').value,notes:document.getElementById('fNotes').value.trim(),updated_at:new Date().toISOString()};if(!data.company_name||!data.region||!data.area){alert('è‘¬å„€ç¤¾åã€ã‚¨ãƒªã‚¢ã€éƒ½é“åºœçœŒã‚’å…¥åŠ›');return;}if(id){supabase.from('sales_prospects').update(data).eq('id',id).then(function(){closeModal('funeralModal');loadData();});}else{data.status='æœªè¨ªå•';supabase.from('sales_prospects').insert(data).then(function(){closeModal('funeralModal');loadData();});}}
function deleteFuneral(id,name){if(!confirm('ã€Œ'+name+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;supabase.from('sales_prospects').delete().eq('id',id).then(function(r){if(r.error){alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(r.error);}else{loadData();}});}
function renderExpenses(){var filter=document.getElementById('expenseFilter').value;var filtered=filter?expenses.filter(function(e){return e.status===filter;}):expenses;var c=document.getElementById('expensesList');if(filtered.length===0){c.innerHTML='<div class="empty">ãªã—</div>';return;}var h='';filtered.forEach(function(e){var member=members.find(function(m){return m.id===e.member_id;});var b=e.status==='æ‰¿èª'?'badge-green':(e.status==='å´ä¸‹'?'badge-red':'badge-yellow');h+='<div class="list-item"><div style="flex:1;"><div><strong>'+(member?member.name:'ä¸æ˜')+'</strong> â€¢ '+e.category+' <span class="badge '+b+'">'+e.status+'</span></div><div style="font-size:0.8rem;color:#8a8a9a;">'+formatDate(e.expense_date)+(e.description?' â€¢ '+esc(e.description):'')+'</div></div><div style="font-weight:700;color:#c9a962;">Â¥'+e.amount.toLocaleString()+'</div>';if(e.status==='ç”³è«‹ä¸­'){h+='<div style="display:flex;gap:0.25rem;margin-left:0.5rem;"><button class="btn btn-sm btn-success" onclick="approveExpense(\''+e.id+'\')">æ‰¿èª</button><button class="btn btn-sm btn-danger" onclick="rejectExpense(\''+e.id+'\')">å´ä¸‹</button></div>';}h+='</div>';});c.innerHTML=h;}
function renderExpenseHistory(){var tbody=document.getElementById('expenseHistoryTable');if(expenses.length===0){tbody.innerHTML='<tr><td colspan="8" class="empty">çµŒè²»å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';return;}var h='';expenses.forEach(function(e){var member=members.find(function(m){return m.id===e.member_id;});var b=e.status==='æ‰¿èª'?'badge-green':(e.status==='å´ä¸‹'?'badge-red':'badge-yellow');h+='<tr>';h+='<td>'+formatDate(e.expense_date)+'</td>';h+='<td>'+(member?esc(member.name):'ä¸æ˜')+'</td>';h+='<td>'+esc(e.category||'-')+'</td>';h+='<td>'+esc(e.description||'-')+'</td>';h+='<td style="font-weight:600;color:#c9a962;">Â¥'+e.amount.toLocaleString()+'</td>';h+='<td><span class="badge '+b+'">'+e.status+'</span></td>';h+='<td style="font-size:0.75rem;color:#8a8a9a;">'+formatDateTime(e.created_at)+'</td>';h+='<td><button class="btn btn-sm btn-danger" onclick="deleteExpense(\''+e.id+'\',\''+esc(e.category).replace(/'/g,"\\'")+'\')" style="font-size:0.7rem;padding:0.2rem 0.4rem;">å‰Šé™¤</button></td>';h+='</tr>';});tbody.innerHTML=h;}
function deleteExpense(id,category){if(!confirm('çµŒè²»ã€Œ'+category+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;supabase.from('sales_expenses').delete().eq('id',id).then(function(r){if(r.error){alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(r.error);}else{loadData();}});}
function approveExpense(id){var e=expenses.find(function(x){return x.id===id;});supabase.from('sales_expenses').update({status:'æ‰¿èª'}).eq('id',id).then(function(){supabase.from('sales_notifications').insert({member_id:e.member_id,title:'çµŒè²»ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',content:e.category+' Â¥'+e.amount.toLocaleString(),type:'success'}).then(loadData);});}
function rejectExpense(id){var reason=prompt('å´ä¸‹ç†ç”±ï¼ˆä»»æ„ï¼‰');var e=expenses.find(function(x){return x.id===id;});supabase.from('sales_expenses').update({status:'å´ä¸‹'}).eq('id',id).then(function(){supabase.from('sales_notifications').insert({member_id:e.member_id,title:'çµŒè²»ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸ',content:e.category+(reason?' ç†ç”±:'+reason:''),type:'error'}).then(loadData);});}
function renderMembers(){var c=document.getElementById('membersList');if(members.length===0){c.innerHTML='<div class="empty">ãªã—</div>';return;}var h='';members.forEach(function(m){var mp=prospects.filter(function(p){return p.assigned_to===m.id;});h+='<div class="list-item" onclick="openMemberModal(\''+m.id+'\')"><div style="width:40px;height:40px;border-radius:50%;background:#c9a962;color:#1a1f2e;display:flex;align-items:center;justify-content:center;font-weight:700;">'+m.name.charAt(0)+'</div><div style="flex:1;"><div style="font-weight:600;">'+esc(m.name)+'</div><div style="font-size:0.8rem;color:#8a8a9a;">æ‹…å½“ '+mp.length+'ç¤¾</div></div><span style="color:#8a8a9a;">â†’</span></div>';});c.innerHTML=h;}
function openMemberModal(id){selectedMemberId=id;var m=members.find(function(x){return x.id===id;});document.getElementById('memberModalTitle').textContent=m.name;var mp=prospects.filter(function(p){return p.assigned_to===m.id;});document.getElementById('memberDetail').innerHTML='æ‹…å½“: '+mp.length+'ç¤¾';document.getElementById('memberMessage').value='';openModal('memberModal');}
function sendNotification(){var content=document.getElementById('memberMessage').value.trim();if(!content||!selectedMemberId)return;supabase.from('sales_notifications').insert({member_id:selectedMemberId,title:'ç®¡ç†è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',content:content,type:'info'}).then(function(){alert('é€ä¿¡ã—ã¾ã—ãŸ');document.getElementById('memberMessage').value='';});}
function updateTodoSelect(){var h='<option value="">é¸æŠ</option>';members.forEach(function(m){h+='<option value="'+m.id+'">'+esc(m.name)+'</option>';});document.getElementById('todoMember').innerHTML=h;}
function openTodoModal(){document.getElementById('todoModalTitle').textContent='TODOæŒ‡ç¤º';document.getElementById('todoId').value='';document.getElementById('todoMember').value='';document.getElementById('todoTitle').value='';document.getElementById('todoDesc').value='';document.getElementById('todoDue').value='';document.getElementById('todoStatus').value='æœªç€æ‰‹';document.getElementById('todoStatusGroup').style.display='none';openModal('todoModal');}
function saveTodo(){var memberId=document.getElementById('todoMember').value;var title=document.getElementById('todoTitle').value.trim();var todoId=document.getElementById('todoId')?document.getElementById('todoId').value:'';if(!memberId||!title){alert('æ‹…å½“è€…ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›');return;}var data={member_id:memberId,title:title,description:document.getElementById('todoDesc').value.trim(),due_date:document.getElementById('todoDue').value||null};if(todoId){data.status=document.getElementById('todoStatus').value;supabase.from('sales_todos').update(data).eq('id',todoId).then(function(){supabase.from('sales_notifications').insert({member_id:memberId,title:'TODOãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ',content:title,type:'info'}).then(function(){closeModal('todoModal');loadData();});});}else{data.status='æœªç€æ‰‹';supabase.from('sales_todos').insert(data).then(function(){supabase.from('sales_notifications').insert({member_id:memberId,title:'æ–°ã—ã„TODOãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ',content:title,type:'info'}).then(function(){closeModal('todoModal');loadData();});});}}
function renderTodos(){var c=document.getElementById('todosList');if(todos.length===0){c.innerHTML='<div class="empty">ãªã—</div>';return;}var h='';todos.forEach(function(t){var member=members.find(function(m){return m.id===t.member_id;});var sb={'æœªç€æ‰‹':'badge-gray','ç¢ºèªæ¸ˆã¿':'badge-blue','å–çµ„ä¸­':'badge-yellow','å®Œäº†':'badge-green'}[t.status]||'badge-gray';h+='<div class="list-item" style="flex-direction:column;align-items:stretch;"><div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:0.25rem;"><span class="badge '+sb+'">'+t.status+'</span>'+(t.is_read?'<span style="font-size:0.7rem;color:#28a745;">âœ“æ—¢èª­</span>':'<span style="font-size:0.7rem;color:#dc3545;">â—æœªèª­</span>')+'<div style="margin-left:auto;display:flex;gap:0.25rem;"><button class="btn btn-sm btn-secondary" onclick="editTodo(\''+t.id+'\')">ç·¨é›†</button><button class="btn btn-sm btn-danger" onclick="deleteTodo(\''+t.id+'\',\''+esc(t.title).replace(/'/g,"\\'")+'\')">å‰Šé™¤</button></div></div><div style="font-weight:600;">'+esc(t.title)+'</div><div style="font-size:0.8rem;color:#8a8a9a;">'+(member?member.name:'ä¸æ˜')+(t.due_date?' â€¢ æœŸé™:'+formatDate(t.due_date):'')+(t.estimated_date?' â€¢ å®Œäº†äºˆå®š:'+formatDate(t.estimated_date):'')+'</div>';if(t.description){h+='<div style="margin-top:0.25rem;font-size:0.85rem;color:#c0c0c0;">'+esc(t.description)+'</div>';}if(t.member_reply){h+='<div style="margin-top:0.5rem;padding:0.5rem;background:#2d3548;border-radius:6px;border-left:3px solid #c9a962;font-size:0.85rem;">ğŸ’¬ '+esc(t.member_reply)+'</div>';}h+='</div>';});c.innerHTML=h;}
function editTodo(id){var t=todos.find(function(x){return x.id===id;});if(!t)return;document.getElementById('todoModalTitle').textContent='TODOç·¨é›†';document.getElementById('todoId').value=t.id;document.getElementById('todoMember').value=t.member_id||'';document.getElementById('todoTitle').value=t.title||'';document.getElementById('todoDesc').value=t.description||'';document.getElementById('todoDue').value=t.due_date||'';document.getElementById('todoStatus').value=t.status||'æœªç€æ‰‹';document.getElementById('todoStatusGroup').style.display='block';openModal('todoModal');}
function deleteTodo(id,title){if(!confirm('ã€Œ'+title+'ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚'))return;supabase.from('sales_todos').delete().eq('id',id).then(function(r){if(r.error){alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');console.error(r.error);}else{loadData();}});}
function openPostModal(){document.getElementById('postContent').value='';openModal('postModal');}
function savePost(){var content=document.getElementById('postContent').value.trim();if(!content){alert('å†…å®¹ã‚’å…¥åŠ›');return;}supabase.from('sales_posts').insert({member_id:null,content:'ã€ç®¡ç†è€…ã€‘'+content}).then(function(){closeModal('postModal');loadData();});}
function renderPosts(){var c=document.getElementById('postsList');if(posts.length===0){c.innerHTML='<div class="empty">ãªã—</div>';return;}var h='';posts.forEach(function(p){var member=members.find(function(m){return m.id===p.member_id;});var name=member?member.name:'ç®¡ç†è€…';h+='<div class="list-item" style="flex-direction:column;align-items:stretch;"><div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem;"><div style="width:28px;height:28px;border-radius:50%;background:'+(member?'#c9a962':'#dc3545')+';color:#1a1f2e;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;">'+name.charAt(0)+'</div><span style="font-weight:600;">'+esc(name)+'</span><span style="font-size:0.75rem;color:#8a8a9a;margin-left:auto;">'+formatDateTime(p.created_at)+'</span></div><div style="font-size:0.9rem;">'+esc(p.content)+'</div></div>';});c.innerHTML=h;}
function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';}
function formatDate(s){if(!s)return'-';var d=new Date(s);return(d.getMonth()+1)+'/'+d.getDate();}
function formatDateTime(s){if(!s)return'-';var d=new Date(s);return(d.getMonth()+1)+'/'+d.getDate()+' '+d.getHours()+':'+String(d.getMinutes()).padStart(2,'0');}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é–¢é€£ã®é–¢æ•°
function updateScheduleMemberFilter(){var h='<option value="">å…¨ãƒ¡ãƒ³ãƒãƒ¼</option>';members.forEach(function(m){h+='<option value="'+m.id+'">'+esc(m.name)+'</option>';});document.getElementById('scheduleMemberFilter').innerHTML=h;document.getElementById('scheduleMemberFilter').onchange=renderScheduleList;}

function renderMemberActivity(){var tbody=document.getElementById('memberActivityTable');var now=new Date();var thisMonth=now.getMonth();var thisYear=now.getFullYear();var h='';members.forEach(function(m){var memberSchedules=schedules.filter(function(s){var d=new Date(s.scheduled_date);return s.member_id===m.id&&d.getMonth()===thisMonth&&d.getFullYear()===thisYear;});var done=memberSchedules.filter(function(s){return s.is_done;}).length;var pending=memberSchedules.filter(function(s){return!s.is_done;}).length;var upcoming=schedules.filter(function(s){return s.member_id===m.id&&!s.is_done&&s.scheduled_date>=now.toISOString().split('T')[0];}).sort(function(a,b){return a.scheduled_date.localeCompare(b.scheduled_date);})[0];var lastActivity=schedules.filter(function(s){return s.member_id===m.id&&s.is_done;}).sort(function(a,b){return b.scheduled_date.localeCompare(a.scheduled_date);})[0];var upcomingProspect=upcoming?prospects.find(function(p){return p.id===upcoming.prospect_id;}):null;h+='<tr>';h+='<td><strong>'+esc(m.name)+'</strong></td>';h+='<td>'+memberSchedules.length+'ä»¶</td>';h+='<td style="color:#28a745;">'+done+'</td>';h+='<td style="color:'+(pending>0?'#ffc107':'#8a8a9a')+';">'+pending+'</td>';h+='<td>'+(upcoming?(formatDate(upcoming.scheduled_date)+' '+(upcomingProspect?esc(upcomingProspect.company_name):'')):'<span style="color:#8a8a9a;">-</span>')+'</td>';h+='<td>'+(lastActivity?formatDate(lastActivity.scheduled_date):'<span style="color:#8a8a9a;">-</span>')+'</td>';h+='</tr>';});tbody.innerHTML=h||'<tr><td colspan="6" class="empty">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>';}

function renderAdminCalendar(){var year=adminCalendarDate.getFullYear();var month=adminCalendarDate.getMonth();document.getElementById('adminCalendarTitle').textContent=year+'å¹´'+(month+1)+'æœˆ';var firstDay=new Date(year,month,1);var lastDay=new Date(year,month+1,0);var startDay=firstDay.getDay();var daysInMonth=lastDay.getDate();var today=new Date();var todayStr=today.toISOString().split('T')[0];var scheduleCounts={};schedules.forEach(function(s){if(!scheduleCounts[s.scheduled_date])scheduleCounts[s.scheduled_date]=0;scheduleCounts[s.scheduled_date]++;});var html='';var days=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];for(var d=0;d<7;d++){var cls=d===0?'sun':(d===6?'sat':'');html+='<div class="admin-calendar-header '+cls+'">'+days[d]+'</div>';}var prevMonth=new Date(year,month,0);var prevDays=prevMonth.getDate();for(var d=startDay-1;d>=0;d--){html+='<div class="admin-calendar-day other-month">'+(prevDays-d)+'</div>';}for(var d=1;d<=daysInMonth;d++){var dateStr=year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');var isToday=dateStr===todayStr;var isSelected=adminSelectedDate===dateStr;var count=scheduleCounts[dateStr]||0;var cls='admin-calendar-day';if(isToday)cls+=' today';if(isSelected)cls+=' selected';html+='<div class="'+cls+'" onclick="selectAdminDate(\''+dateStr+'\')">'+d;if(count>0)html+='<span class="schedule-count">'+count+'</span>';html+='</div>';}var totalCells=startDay+daysInMonth;var nextDays=7-(totalCells%7);if(nextDays<7){for(var d=1;d<=nextDays;d++){html+='<div class="admin-calendar-day other-month">'+d+'</div>';}}document.getElementById('adminCalendarGrid').innerHTML=html;if(!adminSelectedDate){selectAdminDate(todayStr);}}

function changeAdminMonth(delta){adminCalendarDate.setMonth(adminCalendarDate.getMonth()+delta);renderAdminCalendar();}

function selectAdminDate(dateStr){adminSelectedDate=dateStr;renderAdminCalendar();renderScheduleList();var d=new Date(dateStr);document.getElementById('adminSelectedDateTitle').textContent=(d.getMonth()+1)+'/'+d.getDate()+'ã®äºˆå®š';}

function renderScheduleList(){var tbody=document.getElementById('scheduleListTable');var memberFilter=document.getElementById('scheduleMemberFilter').value;var filtered=schedules;if(adminSelectedDate){filtered=filtered.filter(function(s){return s.scheduled_date===adminSelectedDate;});}if(memberFilter){filtered=filtered.filter(function(s){return s.member_id===memberFilter;});}if(filtered.length===0){tbody.innerHTML='<tr><td colspan="5" class="empty">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';return;}var h='';filtered.forEach(function(s){var member=members.find(function(m){return m.id===s.member_id;});var prospect=prospects.find(function(p){return p.id===s.prospect_id;});var statusBadge=s.is_done?'badge-green':'badge-yellow';var statusText=s.is_done?'å®Œäº†':'äºˆå®š';h+='<tr>';h+='<td>'+formatDate(s.scheduled_date)+'</td>';h+='<td>'+(member?esc(member.name):'<span style="color:#8a8a9a;">ä¸æ˜</span>')+'</td>';h+='<td>'+(prospect?esc(prospect.company_name):'<span style="color:#8a8a9a;">ãã®ä»–</span>')+'</td>';h+='<td>'+esc(s.memo||'-')+'</td>';h+='<td><span class="badge '+statusBadge+'">'+statusText+'</span></td>';h+='</tr>';});tbody.innerHTML=h;}

// ç›®æ¨™ç®¡ç†é–¢é€£
function initGoalMonthFilter(){var select=document.getElementById('goalMonthFilter');var now=new Date();var h='';for(var i=0;i<6;i++){var d=new Date(now.getFullYear(),now.getMonth()-i,1);var val=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');var label=d.getFullYear()+'å¹´'+(d.getMonth()+1)+'æœˆ';h+='<option value="'+val+'"'+(i===0?' selected':'')+'>'+label+'</option>';}select.innerHTML=h;select.onchange=renderGoalStats;}

function renderGoalStats(){var monthFilter=document.getElementById('goalMonthFilter');if(!monthFilter)return;var selectedMonth=monthFilter.value||new Date().toISOString().slice(0,7);var teamClosed=0,teamProspect=0,teamNego=0,teamAppo=0;var tbody=document.getElementById('goalMemberTable');var cardsHtml='';var tableHtml='';members.forEach(function(m){var mp=prospects.filter(function(p){return p.assigned_to===m.id;});var appo=mp.filter(function(p){return p.status==='è¨ªå•æ¸ˆã¿'||p.status==='å•†è«‡ä¸­'||p.status==='è¦‹è¾¼ã¿'||p.status==='æˆç´„';}).length;var nego=mp.filter(function(p){return p.status==='å•†è«‡ä¸­'||p.status==='è¦‹è¾¼ã¿'||p.status==='æˆç´„';}).length;var prospect=mp.filter(function(p){return p.status==='è¦‹è¾¼ã¿'||p.status==='æˆç´„';}).length;var closed=mp.filter(function(p){return p.status==='æˆç´„';}).length;var goal=goals.find(function(g){return g.member_id===m.id&&g.month===selectedMonth;});var closedTarget=goal?goal.closed_goal:0;var prospectTarget=Math.ceil(closedTarget/0.10);var negoTarget=Math.ceil(prospectTarget/0.50);var appoTarget=Math.ceil(negoTarget/0.70);var rate=closedTarget>0?Math.round((closed/closedTarget)*100):0;var rateColor=rate>=100?'#28a745':(rate>=50?'#ffc107':'#dc3545');teamClosed+=closed;teamProspect+=prospect;teamNego+=nego;teamAppo+=appo;tableHtml+='<tr>';tableHtml+='<td><strong>'+esc(m.name)+'</strong></td>';tableHtml+='<td style="text-align:center;">'+(closedTarget>0?closedTarget+'ç¤¾':'<span style="color:#8a8a9a;">æœªè¨­å®š</span>')+'</td>';tableHtml+='<td style="text-align:center; font-weight:600; color:#28a745;">'+closed+'</td>';tableHtml+='<td style="text-align:center;">'+prospect+' / '+prospectTarget+'</td>';tableHtml+='<td style="text-align:center;">'+nego+' / '+negoTarget+'</td>';tableHtml+='<td style="text-align:center;">'+appo+' / '+appoTarget+'</td>';tableHtml+='<td style="text-align:center;"><span style="color:'+rateColor+'; font-weight:600;">'+(closedTarget>0?rate+'%':'-')+'</span></td>';tableHtml+='<td><button class="btn btn-sm btn-gold" onclick="openGoalEditModal(\''+m.id+'\',\''+esc(m.name).replace(/'/g,"\\'")+'\')">è¨­å®š</button></td>';tableHtml+='</tr>';if(closedTarget>0){var actualBeta=appo>0?Math.round((nego/appo)*100):0;var actualGamma=nego>0?Math.round((prospect/nego)*100):0;var actualDelta=prospect>0?Math.round((closed/prospect)*100):0;cardsHtml+='<div class="card" style="margin-top:1rem;"><div class="card-header"><span class="card-title">'+esc(m.name)+' ã®è©³ç´°</span><span class="badge '+(rate>=100?'badge-green':(rate>=50?'badge-yellow':'badge-red'))+'">é”æˆç‡ '+rate+'%</span></div><div class="card-body">';cardsHtml+='<div style="display:grid; grid-template-columns:repeat(4,1fr); gap:0.5rem; margin-bottom:1rem;">';cardsHtml+='<div style="background:#1a1f2e; padding:0.75rem; border-radius:8px; text-align:center;"><div style="font-size:0.7rem; color:#8a8a9a;">å—æ³¨</div><div style="font-size:1.2rem; font-weight:700; color:#28a745;">'+closed+'<span style="font-size:0.8rem; color:#8a8a9a;">/'+closedTarget+'</span></div></div>';cardsHtml+='<div style="background:#1a1f2e; padding:0.75rem; border-radius:8px; text-align:center;"><div style="font-size:0.7rem; color:#8a8a9a;">è¦‹è¾¼ã¿</div><div style="font-size:1.2rem; font-weight:700;">'+prospect+'<span style="font-size:0.8rem; color:#8a8a9a;">/'+prospectTarget+'</span></div></div>';cardsHtml+='<div style="background:#1a1f2e; padding:0.75rem; border-radius:8px; text-align:center;"><div style="font-size:0.7rem; color:#8a8a9a;">å•†è«‡</div><div style="font-size:1.2rem; font-weight:700;">'+nego+'<span style="font-size:0.8rem; color:#8a8a9a;">/'+negoTarget+'</span></div></div>';cardsHtml+='<div style="background:#1a1f2e; padding:0.75rem; border-radius:8px; text-align:center;"><div style="font-size:0.7rem; color:#8a8a9a;">ã‚¢ãƒ</div><div style="font-size:1.2rem; font-weight:700;">'+appo+'<span style="font-size:0.8rem; color:#8a8a9a;">/'+appoTarget+'</span></div></div>';cardsHtml+='</div>';cardsHtml+='<div style="font-size:0.85rem; color:#8a8a9a;">å®Ÿç¸¾è»¢æ›ç‡: ';cardsHtml+='<span style="color:'+(actualBeta>=70?'#28a745':'#dc3545')+';">Î² '+actualBeta+'%</span> ï½œ ';cardsHtml+='<span style="color:'+(actualGamma>=50?'#28a745':'#dc3545')+';">Î³ '+actualGamma+'%</span> ï½œ ';cardsHtml+='<span style="color:'+(actualDelta>=10?'#28a745':'#dc3545')+';">Î´ '+actualDelta+'%</span>';cardsHtml+='</div></div></div>';}});tbody.innerHTML=tableHtml||'<tr><td colspan="8" class="empty">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</td></tr>';document.getElementById('goalMemberCards').innerHTML=cardsHtml;document.getElementById('goalTeamClosed').textContent=teamClosed;document.getElementById('goalTeamProspect').textContent=teamProspect;document.getElementById('goalTeamNego').textContent=teamNego;document.getElementById('goalTeamAppo').textContent=teamAppo;}

function openGoalEditModal(memberId,memberName){var monthFilter=document.getElementById('goalMonthFilter');var selectedMonth=monthFilter?monthFilter.value:new Date().toISOString().slice(0,7);var goal=goals.find(function(g){return g.member_id===memberId&&g.month===selectedMonth;});document.getElementById('goalEditMemberId').value=memberId;document.getElementById('goalEditId').value=goal?goal.id:'';document.getElementById('goalEditMemberName').textContent=memberName;document.getElementById('goalEditClosed').value=goal?goal.closed_goal:'';calcGoalPreview();openModal('goalEditModal');}

function calcGoalPreview(){var closedGoal=parseInt(document.getElementById('goalEditClosed').value)||0;var preview=document.getElementById('goalEditPreview');if(closedGoal<=0){preview.style.display='none';return;}var prospectNeeded=Math.ceil(closedGoal/0.10);var negoNeeded=Math.ceil(prospectNeeded/0.50);var appoNeeded=Math.ceil(negoNeeded/0.70);var weeklyAppo=Math.ceil(appoNeeded/4);var dailyAppo=Math.ceil(appoNeeded/20);document.getElementById('goalPreviewProspect').textContent=prospectNeeded+'ä»¶';document.getElementById('goalPreviewNego').textContent=negoNeeded+'ä»¶';document.getElementById('goalPreviewAppo').textContent=appoNeeded+'ä»¶';document.getElementById('goalPreviewWeekly').textContent=weeklyAppo+'ä»¶/é€±';document.getElementById('goalPreviewDaily').textContent=dailyAppo+'ä»¶/æ—¥';preview.style.display='block';}

function saveGoalEdit(){var memberId=document.getElementById('goalEditMemberId').value;var goalId=document.getElementById('goalEditId').value;var closedGoal=parseInt(document.getElementById('goalEditClosed').value)||0;var monthFilter=document.getElementById('goalMonthFilter');var selectedMonth=monthFilter?monthFilter.value:new Date().toISOString().slice(0,7);var prospectGoal=Math.ceil(closedGoal/0.10);var negoGoal=Math.ceil(prospectGoal/0.50);var appoGoal=Math.ceil(negoGoal/0.70);var data={member_id:memberId,month:selectedMonth,visit_goal:appoGoal,negotiation_goal:negoGoal,closed_goal:closedGoal};if(goalId){supabase.from('sales_goals').update(data).eq('id',goalId).then(function(){closeModal('goalEditModal');loadData();});}else{supabase.from('sales_goals').insert(data).then(function(){closeModal('goalEditModal');loadData();});}}
</script>
</body>
</html>