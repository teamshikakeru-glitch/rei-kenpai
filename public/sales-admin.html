<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rei ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #1a1f2e; color: #e0e0e0; line-height: 1.5; min-height: 100vh; }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #1a1f2e 0%, #2d3548 100%);
    }
    .login-card {
      background: #252b3d;
      border-radius: 16px;
      padding: 2.5rem;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .login-logo { font-size: 3rem; color: #c9a962; margin-bottom: 1rem; }
    .login-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.5rem; }
    .login-sub { font-size: 0.9rem; color: #8a8a9a; margin-bottom: 1.5rem; }
    .form-input {
      width: 100%;
      padding: 0.9rem 1rem;
      font-size: 1rem;
      border: 2px solid #3d4559;
      border-radius: 8px;
      background: #1a1f2e;
      color: white;
      margin-bottom: 1rem;
    }
    .form-input:focus { outline: none; border-color: #c9a962; }
    .btn {
      display: block;
      width: 100%;
      padding: 0.9rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-gold { background: #c9a962; color: #1a1f2e; }
    .btn-gold:hover { background: #d4b978; }
    .btn-primary { background: #2d5a47; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-secondary { background: #3d4559; color: #e0e0e0; }
    .btn-sm { padding: 0.4rem 0.75rem; font-size: 0.8rem; width: auto; display: inline-block; }
    .error-box { background: #5c2a2a; color: #ff8a8a; padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; }
    .hidden { display: none !important; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª */
    #mainApp { display: none; }
    .header {
      background: #252b3d;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #3d4559;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-logo { font-size: 1.2rem; font-weight: 700; color: #c9a962; }
    .header-logout { background: #3d4559; color: #e0e0e0; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼†ãƒ¡ã‚¤ãƒ³ */
    .layout { display: flex; min-height: calc(100vh - 60px); }
    .sidebar {
      width: 220px;
      background: #252b3d;
      border-right: 1px solid #3d4559;
      padding: 1rem 0;
      flex-shrink: 0;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      color: #8a8a9a;
      text-decoration: none;
      font-size: 0.9rem;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }
    .nav-item:hover { background: #2d3548; color: #e0e0e0; }
    .nav-item.active { background: #3d4559; color: #c9a962; }
    .nav-item-icon { font-size: 1.1rem; }
    .nav-badge {
      margin-left: auto;
      background: #dc3545;
      color: white;
      font-size: 0.7rem;
      padding: 0.15rem 0.5rem;
      border-radius: 100px;
      font-weight: 600;
    }
    
    .main-content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
    }
    .page { display: none; }
    .page.active { display: block; }
    .page-title { font-size: 1.3rem; font-weight: 600; margin-bottom: 1.5rem; color: #c9a962; }

    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: #252b3d;
      border-radius: 12px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .card-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #3d4559;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-title { font-size: 0.95rem; font-weight: 600; }
    .card-body { padding: 1rem 1.25rem; }

    /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: #252b3d;
      border-radius: 12px;
      padding: 1.25rem;
    }
    .stat-card.alert { border-left: 4px solid #dc3545; }
    .stat-card.warning { border-left: 4px solid #ffc107; }
    .stat-card.success { border-left: 4px solid #28a745; }
    .stat-card.info { border-left: 4px solid #17a2b8; }
    .stat-label { font-size: 0.8rem; color: #8a8a9a; margin-bottom: 0.25rem; }
    .stat-value { font-size: 1.75rem; font-weight: 700; }
    .stat-value.alert { color: #dc3545; }
    .stat-value.warning { color: #ffc107; }
    .stat-value.success { color: #28a745; }
    .stat-value.info { color: #17a2b8; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #3d4559; font-size: 0.9rem; }
    th { color: #8a8a9a; font-weight: 600; font-size: 0.8rem; }
    tr:hover td { background: #2d3548; }

    /* ãƒãƒƒã‚¸ */
    .badge { display: inline-block; padding: 0.25rem 0.6rem; border-radius: 100px; font-size: 0.7rem; font-weight: 600; }
    .badge-yellow { background: #ffc107; color: #1a1f2e; }
    .badge-green { background: #28a745; color: white; }
    .badge-red { background: #dc3545; color: white; }
    .badge-gray { background: #6c757d; color: white; }
    .badge-blue { background: #17a2b8; color: white; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-bg.show { display: flex; }
    .modal-box {
      background: #252b3d;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-head {
      padding: 1.25rem;
      border-bottom: 1px solid #3d4559;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-head h3 { font-size: 1.1rem; color: #c9a962; }
    .modal-close { width: 32px; height: 32px; border: none; background: #3d4559; border-radius: 50%; color: white; font-size: 1.2rem; cursor: pointer; }
    .modal-content { padding: 1.25rem; max-height: calc(90vh - 140px); overflow-y: auto; }
    .modal-foot { padding: 1rem 1.25rem; border-top: 1px solid #3d4559; display: flex; gap: 0.75rem; justify-content: flex-end; }
    .modal-foot .btn { width: auto; }

    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.85rem; color: #8a8a9a; margin-bottom: 0.4rem; }
    .form-input-dark {
      width: 100%;
      padding: 0.7rem;
      font-size: 0.95rem;
      border: 1px solid #3d4559;
      border-radius: 8px;
      background: #1a1f2e;
      color: white;
    }
    .form-input-dark:focus { outline: none; border-color: #c9a962; }
    textarea.form-input-dark { resize: vertical; }

    /* ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ */
    .member-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid #3d4559;
      cursor: pointer;
    }
    .member-item:hover { background: #2d3548; }
    .member-item:last-child { border-bottom: none; }
    .member-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #c9a962;
      color: #1a1f2e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
    }
    .member-info { flex: 1; }
    .member-name { font-weight: 600; }
    .member-stats { font-size: 0.8rem; color: #8a8a9a; }

    /* çµŒè²»ã‚¢ã‚¤ãƒ†ãƒ  */
    .expense-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid #3d4559;
    }
    .expense-item:last-child { border-bottom: none; }
    .expense-icon {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #3d4559;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .expense-info { flex: 1; }
    .expense-category { font-weight: 600; }
    .expense-detail { font-size: 0.8rem; color: #8a8a9a; }
    .expense-amount { font-weight: 700; font-size: 1.1rem; color: #c9a962; }
    .expense-actions { display: flex; gap: 0.5rem; }

    /* TODO */
    .todo-item {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid #3d4559;
    }
    .todo-item:last-child { border-bottom: none; }
    .todo-status {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ffc107;
      margin-top: 4px;
      flex-shrink: 0;
    }
    .todo-status.done { background: #28a745; }
    .todo-content { flex: 1; }
    .todo-title { font-weight: 600; }
    .todo-meta { font-size: 0.8rem; color: #8a8a9a; }

    /* ç©º */
    .empty { text-align: center; padding: 2rem; color: #8a8a9a; }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .layout { flex-direction: column; }
    }
  </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">ç¤¼</div>
    <div class="login-title">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <div class="login-sub">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <div id="loginError" class="error-box hidden"></div>
    <input type="password" class="form-input" id="adminPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    <button class="btn btn-gold" onclick="doLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div id="mainApp">
  <header class="header">
    <div class="header-logo">ç¤¼ ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</div>
    <button class="header-logout" onclick="doLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <button class="nav-item active" data-page="dashboard">
        <span class="nav-item-icon">ğŸ“Š</span>
        <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
      </button>
      <button class="nav-item" data-page="expenses">
        <span class="nav-item-icon">ğŸ’°</span>
        <span>çµŒè²»ç”³è«‹</span>
        <span class="nav-badge" id="expenseBadge" style="display:none;">0</span>
      </button>
      <button class="nav-item" data-page="members">
        <span class="nav-item-icon">ğŸ‘¥</span>
        <span>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</span>
      </button>
      <button class="nav-item" data-page="todos">
        <span class="nav-item-icon">ğŸ“‹</span>
        <span>TODOæŒ‡ç¤º</span>
      </button>
      <button class="nav-item" data-page="prospects">
        <span class="nav-item-icon">ğŸ¢</span>
        <span>è¨ªå•å…ˆä¸€è¦§</span>
      </button>
      <button class="nav-item" data-page="posts">
        <span class="nav-item-icon">ğŸ’¬</span>
        <span>æ²ç¤ºæ¿</span>
      </button>
    </aside>

    <main class="main-content">
      <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
      <div class="page active" id="page-dashboard">
        <h1 class="page-title">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
        <div class="stats-grid">
          <div class="stat-card alert">
            <div class="stat-label">çµŒè²»ç”³è«‹ï¼ˆæœªå‡¦ç†ï¼‰</div>
            <div class="stat-value alert" id="statPendingExpense">0</div>
          </div>
          <div class="stat-card warning">
            <div class="stat-label">å•†è«‡ä¸­</div>
            <div class="stat-value warning" id="statNegotiating">0</div>
          </div>
          <div class="stat-card success">
            <div class="stat-label">æˆç´„</div>
            <div class="stat-value success" id="statClosed">0</div>
          </div>
          <div class="stat-card info">
            <div class="stat-label">ãƒ¡ãƒ³ãƒãƒ¼æ•°</div>
            <div class="stat-value info" id="statMembers">0</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">âš ï¸ è¦å¯¾å¿œï¼šæœªå‡¦ç†ã®çµŒè²»ç”³è«‹</span>
          </div>
          <div id="pendingExpensesList"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <span class="card-title">ğŸ“ˆ ãƒ¡ãƒ³ãƒãƒ¼æ´»å‹•çŠ¶æ³</span>
          </div>
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr>
                  <th>åå‰</th>
                  <th>è¨ªå•</th>
                  <th>å•†è«‡ä¸­</th>
                  <th>æˆç´„</th>
                  <th>çµŒè²»</th>
                </tr>
              </thead>
              <tbody id="memberStatsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- çµŒè²»ç”³è«‹ -->
      <div class="page" id="page-expenses">
        <h1 class="page-title">ğŸ’° çµŒè²»ç”³è«‹ç®¡ç†</h1>
        <div class="card">
          <div class="card-header">
            <span class="card-title">ç”³è«‹ä¸€è¦§</span>
            <select class="form-input-dark" id="expenseFilter" style="width:auto; padding:0.4rem 0.75rem; font-size:0.85rem;">
              <option value="ç”³è«‹ä¸­">ç”³è«‹ä¸­ã®ã¿</option>
              <option value="">ã™ã¹ã¦</option>
              <option value="æ‰¿èª">æ‰¿èªæ¸ˆã¿</option>
              <option value="å´ä¸‹">å´ä¸‹</option>
            </select>
          </div>
          <div id="allExpensesList"></div>
        </div>
      </div>

      <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† -->
      <div class="page" id="page-members">
        <h1 class="page-title">ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h1>
        <div class="card">
          <div class="card-header">
            <span class="card-title">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</span>
          </div>
          <div id="membersList"></div>
        </div>
      </div>

      <!-- TODOæŒ‡ç¤º -->
      <div class="page" id="page-todos">
        <h1 class="page-title">ğŸ“‹ TODOæŒ‡ç¤º</h1>
        <div class="card">
          <div class="card-header">
            <span class="card-title">æŒ‡ç¤ºä¸€è¦§</span>
            <button class="btn btn-sm btn-gold" onclick="openTodoModal()">+ æ–°è¦æŒ‡ç¤º</button>
          </div>
          <div id="todosList"></div>
        </div>
      </div>

      <!-- è¨ªå•å…ˆä¸€è¦§ -->
      <div class="page" id="page-prospects">
        <h1 class="page-title">ğŸ¢ è¨ªå•å…ˆä¸€è¦§</h1>
        <div class="card">
          <div class="card-body" style="padding:0;">
            <table>
              <thead>
                <tr>
                  <th>è‘¬å„€ç¤¾å</th>
                  <th>ã‚¨ãƒªã‚¢</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ‹…å½“</th>
                  <th>æ›´æ–°æ—¥</th>
                </tr>
              </thead>
              <tbody id="prospectsTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- æ²ç¤ºæ¿ -->
      <div class="page" id="page-posts">
        <h1 class="page-title">ğŸ’¬ æ²ç¤ºæ¿</h1>
        <div class="card">
          <div class="card-header">
            <span class="card-title">æœ€æ–°ã®æŠ•ç¨¿</span>
            <button class="btn btn-sm btn-gold" onclick="openPostModal()">+ æŠ•ç¨¿ã™ã‚‹</button>
          </div>
          <div id="postsList"></div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="memberModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="memberModalTitle">ãƒ¡ãƒ³ãƒãƒ¼è©³ç´°</h3>
      <button class="modal-close" onclick="closeModal('memberModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div id="memberDetail"></div>
      <hr style="border:none; border-top:1px solid #3d4559; margin:1rem 0;">
      <h4 style="font-size:0.95rem; margin-bottom:0.75rem;">ğŸ“© ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡</h4>
      <div class="form-group">
        <textarea class="form-input-dark" id="memberMessage" rows="3" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
      </div>
      <button class="btn btn-sm btn-primary" onclick="sendNotification()">é€ä¿¡</button>
      <hr style="border:none; border-top:1px solid #3d4559; margin:1rem 0;">
      <h4 style="font-size:0.95rem; margin-bottom:0.75rem;">ğŸ“‹ TODOæŒ‡ç¤ºã‚’è¿½åŠ </h4>
      <div class="form-group">
        <input type="text" class="form-input-dark" id="memberTodoTitle" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
      </div>
      <div class="form-group">
        <textarea class="form-input-dark" id="memberTodoDesc" rows="2" placeholder="è©³ç´°"></textarea>
      </div>
      <div class="form-group">
        <input type="date" class="form-input-dark" id="memberTodoDue">
      </div>
      <button class="btn btn-sm btn-gold" onclick="addTodoFromMember()">TODOè¿½åŠ </button>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('memberModal')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- TODOä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="todoModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>TODOæŒ‡ç¤ºã‚’ä½œæˆ</h3>
      <button class="modal-close" onclick="closeModal('todoModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">æ‹…å½“è€… *</label>
        <select class="form-input-dark" id="todoMember"></select>
      </div>
      <div class="form-group">
        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
        <input type="text" class="form-input-dark" id="todoTitle" placeholder="ä¾‹ï¼šâ—‹â—‹è‘¬å„€ç¤¾ã«å†è¨ªå•">
      </div>
      <div class="form-group">
        <label class="form-label">è©³ç´°</label>
        <textarea class="form-input-dark" id="todoDesc" rows="3" placeholder="è©³ç´°ãªæŒ‡ç¤ºå†…å®¹"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">æœŸé™</label>
        <input type="date" class="form-input-dark" id="todoDue">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('todoModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-gold" onclick="saveTodo()">ä½œæˆ</button>
    </div>
  </div>
</div>

<!-- æŠ•ç¨¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="postModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>ç®¡ç†è€…ã‹ã‚‰æŠ•ç¨¿</h3>
      <button class="modal-close" onclick="closeModal('postModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">æŠ•ç¨¿å†…å®¹ *</label>
        <textarea class="form-input-dark" id="postContent" rows="4" placeholder="å…¨ä½“ã¸ã®é€£çµ¡äº‹é …ãªã©"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('postModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-gold" onclick="savePost()">æŠ•ç¨¿</button>
    </div>
  </div>
</div>

<script>
var supabase;
var members = [];
var prospects = [];
var expenses = [];
var todos = [];
var posts = [];
var selectedMemberId = null;

var ADMIN_PASS = '1123';
var SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';

window.onload = function() {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  if (localStorage.getItem('salesAdminLoggedIn') === 'true') {
    showMainApp();
  }
  
  var navItems = document.querySelectorAll('.nav-item');
  for (var i = 0; i < navItems.length; i++) {
    navItems[i].onclick = function() {
      var page = this.getAttribute('data-page');
      switchPage(page);
    };
  }
  
  document.getElementById('expenseFilter').onchange = renderAllExpenses;
  document.getElementById('adminPass').onkeypress = function(e) {
    if (e.key === 'Enter') doLogin();
  };
};

function doLogin() {
  var pass = document.getElementById('adminPass').value;
  if (pass === ADMIN_PASS) {
    localStorage.setItem('salesAdminLoggedIn', 'true');
    showMainApp();
  } else {
    document.getElementById('loginError').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
    document.getElementById('loginError').classList.remove('hidden');
  }
}

function doLogout() {
  localStorage.removeItem('salesAdminLoggedIn');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  loadData();
}

function loadData() {
  supabase.from('sales_members').select('*').then(function(r) {
    members = r.data || [];
    updateStats();
    renderMembers();
    updateTodoMemberSelect();
  });
  
  supabase.from('sales_prospects').select('*').order('updated_at', { ascending: false }).then(function(r) {
    prospects = r.data || [];
    updateStats();
    renderProspects();
  });
  
  supabase.from('sales_expenses').select('*').order('created_at', { ascending: false }).then(function(r) {
    expenses = r.data || [];
    updateStats();
    renderPendingExpenses();
    renderAllExpenses();
  });
  
  supabase.from('sales_todos').select('*').order('created_at', { ascending: false }).then(function(r) {
    todos = r.data || [];
    renderTodos();
  });
  
  supabase.from('sales_posts').select('*').order('created_at', { ascending: false }).limit(50).then(function(r) {
    posts = r.data || [];
    renderPosts();
  });
}

function switchPage(page) {
  var navItems = document.querySelectorAll('.nav-item');
  var pages = document.querySelectorAll('.page');
  for (var i = 0; i < navItems.length; i++) {
    navItems[i].classList.remove('active');
    if (navItems[i].getAttribute('data-page') === page) navItems[i].classList.add('active');
  }
  for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active');
  document.getElementById('page-' + page).classList.add('active');
}

function updateStats() {
  var pending = expenses.filter(function(e) { return e.status === 'ç”³è«‹ä¸­'; }).length;
  var nego = prospects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
  var closed = prospects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
  
  document.getElementById('statPendingExpense').textContent = pending;
  document.getElementById('statNegotiating').textContent = nego;
  document.getElementById('statClosed').textContent = closed;
  document.getElementById('statMembers').textContent = members.length;
  
  // ãƒãƒƒã‚¸æ›´æ–°
  var badge = document.getElementById('expenseBadge');
  if (pending > 0) {
    badge.textContent = pending;
    badge.style.display = 'inline';
  } else {
    badge.style.display = 'none';
  }
  
  // ãƒ¡ãƒ³ãƒãƒ¼åˆ¥çµ±è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«
  var tbody = document.getElementById('memberStatsTable');
  var html = '';
  for (var i = 0; i < members.length; i++) {
    var m = members[i];
    var mProspects = prospects.filter(function(p) { return p.assigned_to === m.id; });
    var mVisits = mProspects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
    var mNego = mProspects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
    var mClosed = mProspects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
    var mExpense = 0;
    for (var j = 0; j < expenses.length; j++) {
      if (expenses[j].member_id === m.id && expenses[j].status === 'æ‰¿èª') {
        mExpense += expenses[j].amount;
      }
    }
    html += '<tr>';
    html += '<td>' + esc(m.name) + '</td>';
    html += '<td>' + mVisits + '</td>';
    html += '<td>' + mNego + '</td>';
    html += '<td>' + mClosed + '</td>';
    html += '<td>Â¥' + mExpense.toLocaleString() + '</td>';
    html += '</tr>';
  }
  tbody.innerHTML = html || '<tr><td colspan="5" class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
}

function renderPendingExpenses() {
  var pending = expenses.filter(function(e) { return e.status === 'ç”³è«‹ä¸­'; });
  var container = document.getElementById('pendingExpensesList');
  
  if (pending.length === 0) {
    container.innerHTML = '<div class="empty">æœªå‡¦ç†ã®ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < pending.length; i++) {
    var e = pending[i];
    var member = members.find(function(m) { return m.id === e.member_id; });
    var icon = getExpenseIcon(e.category);
    html += '<div class="expense-item">';
    html += '<div class="expense-icon">' + icon + '</div>';
    html += '<div class="expense-info">';
    html += '<div class="expense-category">' + e.category + '</div>';
    html += '<div class="expense-detail">' + (member ? member.name : 'ä¸æ˜') + ' â€¢ ' + formatDate(e.expense_date) + (e.description ? ' â€¢ ' + esc(e.description) : '') + '</div>';
    html += '</div>';
    html += '<div class="expense-amount">Â¥' + e.amount.toLocaleString() + '</div>';
    html += '<div class="expense-actions">';
    html += '<button class="btn btn-sm btn-success" onclick="approveExpense(\'' + e.id + '\')">æ‰¿èª</button>';
    html += '<button class="btn btn-sm btn-danger" onclick="rejectExpense(\'' + e.id + '\')">å´ä¸‹</button>';
    html += '</div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function renderAllExpenses() {
  var filter = document.getElementById('expenseFilter').value;
  var filtered = filter ? expenses.filter(function(e) { return e.status === filter; }) : expenses;
  var container = document.getElementById('allExpensesList');
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty">çµŒè²»ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var e = filtered[i];
    var member = members.find(function(m) { return m.id === e.member_id; });
    var icon = getExpenseIcon(e.category);
    var badge = e.status === 'æ‰¿èª' ? 'badge-green' : (e.status === 'å´ä¸‹' ? 'badge-red' : 'badge-yellow');
    html += '<div class="expense-item">';
    html += '<div class="expense-icon">' + icon + '</div>';
    html += '<div class="expense-info">';
    html += '<div class="expense-category">' + e.category + ' <span class="badge ' + badge + '">' + e.status + '</span></div>';
    html += '<div class="expense-detail">' + (member ? member.name : 'ä¸æ˜') + ' â€¢ ' + formatDate(e.expense_date) + (e.description ? ' â€¢ ' + esc(e.description) : '') + '</div>';
    html += '</div>';
    html += '<div class="expense-amount">Â¥' + e.amount.toLocaleString() + '</div>';
    if (e.status === 'ç”³è«‹ä¸­') {
      html += '<div class="expense-actions">';
      html += '<button class="btn btn-sm btn-success" onclick="approveExpense(\'' + e.id + '\')">æ‰¿èª</button>';
      html += '<button class="btn btn-sm btn-danger" onclick="rejectExpense(\'' + e.id + '\')">å´ä¸‹</button>';
      html += '</div>';
    }
    html += '</div>';
  }
  container.innerHTML = html;
}

function approveExpense(id) {
  var expense = expenses.find(function(e) { return e.id === id; });
  if (!expense) return;
  
  supabase.from('sales_expenses').update({ status: 'æ‰¿èª' }).eq('id', id).then(function() {
    // é€šçŸ¥ã‚’é€ä¿¡
    supabase.from('sales_notifications').insert({
      member_id: expense.member_id,
      title: 'çµŒè²»ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ',
      content: expense.category + ' Â¥' + expense.amount.toLocaleString() + ' ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸã€‚',
      type: 'success'
    }).then(function() {
      loadData();
    });
  });
}

function rejectExpense(id) {
  var reason = prompt('å´ä¸‹ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰');
  var expense = expenses.find(function(e) { return e.id === id; });
  if (!expense) return;
  
  supabase.from('sales_expenses').update({ status: 'å´ä¸‹' }).eq('id', id).then(function() {
    // é€šçŸ¥ã‚’é€ä¿¡
    supabase.from('sales_notifications').insert({
      member_id: expense.member_id,
      title: 'çµŒè²»ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸ',
      content: expense.category + ' Â¥' + expense.amount.toLocaleString() + ' ãŒå´ä¸‹ã•ã‚Œã¾ã—ãŸã€‚' + (reason ? 'ç†ç”±ï¼š' + reason : ''),
      type: 'error'
    }).then(function() {
      loadData();
    });
  });
}

function getExpenseIcon(cat) {
  var map = { 'äº¤é€šè²»': 'ğŸšƒ', 'ã‚¬ã‚½ãƒªãƒ³ä»£': 'â›½', 'é§è»Šå ´ä»£': 'ğŸ…¿ï¸', 'æ¥å¾…è²»': 'ğŸ½ï¸', 'å®¿æ³Šè²»': 'ğŸ¨', 'ãã®ä»–': 'ğŸ“' };
  return map[cat] || 'ğŸ“';
}

function renderMembers() {
  var container = document.getElementById('membersList');
  if (members.length === 0) {
    container.innerHTML = '<div class="empty">ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < members.length; i++) {
    var m = members[i];
    var mProspects = prospects.filter(function(p) { return p.assigned_to === m.id; });
    var mVisits = mProspects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
    html += '<div class="member-item" onclick="openMemberModal(\'' + m.id + '\')">';
    html += '<div class="member-avatar">' + m.name.charAt(0) + '</div>';
    html += '<div class="member-info">';
    html += '<div class="member-name">' + esc(m.name) + '</div>';
    html += '<div class="member-stats">è¨ªå• ' + mVisits + 'ä»¶</div>';
    html += '</div>';
    html += '<span style="color:#8a8a9a;">â†’</span>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function openMemberModal(id) {
  selectedMemberId = id;
  var m = members.find(function(x) { return x.id === id; });
  if (!m) return;
  
  var mProspects = prospects.filter(function(p) { return p.assigned_to === m.id; });
  var mVisits = mProspects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
  var mNego = mProspects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
  var mClosed = mProspects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
  
  document.getElementById('memberModalTitle').textContent = m.name + ' ã•ã‚“';
  document.getElementById('memberDetail').innerHTML = 
    '<div style="display:grid; grid-template-columns:repeat(3,1fr); gap:0.75rem; text-align:center;">' +
    '<div style="background:#3d4559; padding:0.75rem; border-radius:8px;"><div style="font-size:1.25rem; font-weight:700;">' + mVisits + '</div><div style="font-size:0.75rem; color:#8a8a9a;">è¨ªå•</div></div>' +
    '<div style="background:#3d4559; padding:0.75rem; border-radius:8px;"><div style="font-size:1.25rem; font-weight:700;">' + mNego + '</div><div style="font-size:0.75rem; color:#8a8a9a;">å•†è«‡ä¸­</div></div>' +
    '<div style="background:#3d4559; padding:0.75rem; border-radius:8px;"><div style="font-size:1.25rem; font-weight:700;">' + mClosed + '</div><div style="font-size:0.75rem; color:#8a8a9a;">æˆç´„</div></div>' +
    '</div>';
  
  document.getElementById('memberMessage').value = '';
  document.getElementById('memberTodoTitle').value = '';
  document.getElementById('memberTodoDesc').value = '';
  document.getElementById('memberTodoDue').value = '';
  
  openModal('memberModal');
}

function sendNotification() {
  var content = document.getElementById('memberMessage').value.trim();
  if (!content || !selectedMemberId) return;
  
  supabase.from('sales_notifications').insert({
    member_id: selectedMemberId,
    title: 'ç®¡ç†è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸',
    content: content,
    type: 'info'
  }).then(function() {
    alert('é€ä¿¡ã—ã¾ã—ãŸ');
    document.getElementById('memberMessage').value = '';
  });
}

function addTodoFromMember() {
  var title = document.getElementById('memberTodoTitle').value.trim();
  if (!title || !selectedMemberId) {
    alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  supabase.from('sales_todos').insert({
    member_id: selectedMemberId,
    title: title,
    description: document.getElementById('memberTodoDesc').value.trim(),
    due_date: document.getElementById('memberTodoDue').value || null
  }).then(function() {
    // é€šçŸ¥ã‚‚é€ä¿¡
    supabase.from('sales_notifications').insert({
      member_id: selectedMemberId,
      title: 'æ–°ã—ã„TODOãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ',
      content: title,
      type: 'info'
    }).then(function() {
      alert('TODOæŒ‡ç¤ºã‚’è¿½åŠ ã—ã¾ã—ãŸ');
      document.getElementById('memberTodoTitle').value = '';
      document.getElementById('memberTodoDesc').value = '';
      document.getElementById('memberTodoDue').value = '';
      loadData();
    });
  });
}

function updateTodoMemberSelect() {
  var select = document.getElementById('todoMember');
  var html = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  for (var i = 0; i < members.length; i++) {
    html += '<option value="' + members[i].id + '">' + esc(members[i].name) + '</option>';
  }
  select.innerHTML = html;
}

function openTodoModal() {
  document.getElementById('todoMember').value = '';
  document.getElementById('todoTitle').value = '';
  document.getElementById('todoDesc').value = '';
  document.getElementById('todoDue').value = '';
  openModal('todoModal');
}

function saveTodo() {
  var memberId = document.getElementById('todoMember').value;
  var title = document.getElementById('todoTitle').value.trim();
  if (!memberId || !title) {
    alert('æ‹…å½“è€…ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  supabase.from('sales_todos').insert({
    member_id: memberId,
    title: title,
    description: document.getElementById('todoDesc').value.trim(),
    due_date: document.getElementById('todoDue').value || null
  }).then(function() {
    supabase.from('sales_notifications').insert({
      member_id: memberId,
      title: 'æ–°ã—ã„TODOãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸ',
      content: title,
      type: 'info'
    }).then(function() {
      closeModal('todoModal');
      loadData();
    });
  });
}

function renderTodos() {
  var container = document.getElementById('todosList');
  if (todos.length === 0) {
    container.innerHTML = '<div class="empty">TODOæŒ‡ç¤ºãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < todos.length; i++) {
    var t = todos[i];
    var member = members.find(function(m) { return m.id === t.member_id; });
    var statusBadge = getTodoStatusBadge(t.status);
    
    html += '<div class="todo-item" style="flex-direction:column; align-items:stretch;">';
    html += '<div style="display:flex; align-items:flex-start; gap:1rem;">';
    html += '<div class="todo-status ' + (t.status === 'å®Œäº†' ? 'done' : '') + '"></div>';
    html += '<div class="todo-content" style="flex:1;">';
    html += '<div style="display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.25rem;">';
    html += '<span class="badge ' + statusBadge + '">' + t.status + '</span>';
    if (t.is_read) html += '<span style="font-size:0.7rem; color:#28a745;">âœ“æ—¢èª­</span>';
    else html += '<span style="font-size:0.7rem; color:#dc3545;">â—æœªèª­</span>';
    html += '</div>';
    html += '<div class="todo-title">' + esc(t.title) + '</div>';
    html += '<div class="todo-meta">' + (member ? member.name : 'ä¸æ˜');
    if (t.due_date) html += ' â€¢ æœŸé™: ' + formatDate(t.due_date);
    if (t.estimated_date) html += ' â€¢ <span style="color:#c9a962;">å®Œäº†äºˆå®š: ' + formatDate(t.estimated_date) + '</span>';
    html += '</div>';
    if (t.description) html += '<div style="font-size:0.85rem; color:#8a8a9a; margin-top:0.25rem;">' + esc(t.description) + '</div>';
    html += '</div>';
    html += '</div>';
    
    // è¿”ä¿¡ãŒã‚ã‚‹å ´åˆ
    if (t.member_reply) {
      html += '<div style="margin-top:0.75rem; margin-left:1.75rem; padding:0.75rem; background:#2d3548; border-radius:8px; border-left:3px solid #c9a962;">';
      html += '<div style="font-size:0.75rem; color:#8a8a9a; margin-bottom:0.25rem;">ğŸ’¬ ' + (member ? member.name : '') + 'ã‹ã‚‰ã®è¿”ä¿¡ï¼ˆ' + formatDateTime(t.replied_at) + 'ï¼‰</div>';
      html += '<div style="font-size:0.9rem;">' + esc(t.member_reply) + '</div>';
      html += '</div>';
    }
    
    html += '</div>';
  }
  container.innerHTML = html;
}

function getTodoStatusBadge(status) {
  var map = {
    'æœªç€æ‰‹': 'badge-gray',
    'ç¢ºèªæ¸ˆã¿': 'badge-blue',
    'å–çµ„ä¸­': 'badge-yellow',
    'å®Œäº†': 'badge-green'
  };
  return map[status] || 'badge-gray';
}

function renderProspects() {
  var tbody = document.getElementById('prospectsTable');
  if (prospects.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < prospects.length; i++) {
    var p = prospects[i];
    var member = members.find(function(m) { return m.id === p.assigned_to; });
    var badge = getBadge(p.status);
    html += '<tr>';
    html += '<td>' + esc(p.company_name) + '</td>';
    html += '<td>' + esc(p.area || '-') + '</td>';
    html += '<td><span class="badge ' + badge + '">' + p.status + '</span></td>';
    html += '<td>' + (member ? esc(member.name) : '-') + '</td>';
    html += '<td>' + formatDate(p.updated_at) + '</td>';
    html += '</tr>';
  }
  tbody.innerHTML = html;
}

function getBadge(status) {
  var map = { 'æœªè¨ªå•': 'badge-gray', 'è¨ªå•æ¸ˆã¿': 'badge-blue', 'å•†è«‡ä¸­': 'badge-yellow', 'æˆç´„': 'badge-green', 'è¦‹é€ã‚Š': 'badge-red' };
  return map[status] || 'badge-gray';
}

function openPostModal() {
  document.getElementById('postContent').value = '';
  openModal('postModal');
}

function savePost() {
  var content = document.getElementById('postContent').value.trim();
  if (!content) {
    alert('å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  // ç®¡ç†è€…ã¨ã—ã¦æŠ•ç¨¿ï¼ˆmember_idã¯nullï¼‰
  supabase.from('sales_posts').insert({
    member_id: null,
    content: 'ã€ç®¡ç†è€…ã€‘' + content
  }).then(function() {
    closeModal('postModal');
    loadData();
  });
}

function renderPosts() {
  var container = document.getElementById('postsList');
  if (posts.length === 0) {
    container.innerHTML = '<div class="empty">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < posts.length; i++) {
    var p = posts[i];
    var member = members.find(function(m) { return m.id === p.member_id; });
    var name = member ? member.name : 'ç®¡ç†è€…';
    html += '<div style="padding:1rem; border-bottom:1px solid #3d4559;">';
    html += '<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.5rem;">';
    html += '<div style="width:32px; height:32px; border-radius:50%; background:' + (member ? '#c9a962' : '#dc3545') + '; color:#1a1f2e; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem;">' + name.charAt(0) + '</div>';
    html += '<span style="font-weight:600;">' + esc(name) + '</span>';
    html += '<span style="font-size:0.75rem; color:#8a8a9a; margin-left:auto;">' + formatDateTime(p.created_at) + '</span>';
    html += '</div>';
    html += '<div style="font-size:0.9rem;">' + esc(p.content) + '</div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function openModal(id) {
  document.getElementById(id).classList.add('show');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function formatDate(str) {
  if (!str) return '-';
  var d = new Date(str);
  return (d.getMonth() + 1) + '/' + d.getDate();
}

function formatDateTime(str) {
  if (!str) return '-';
  var d = new Date(str);
  return (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
}
</script>

</body>
</html>