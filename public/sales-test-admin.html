<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rei å–¶æ¥­ãƒ†ã‚¹ãƒˆç®¡ç†ç”»é¢</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --color-bg: #f8f9fa;
      --color-white: #ffffff;
      --color-primary: #2d5a47;
      --color-primary-light: #3d7a5f;
      --color-primary-pale: #e8f0ec;
      --color-accent: #c9a962;
      --color-text: #2c2c2c;
      --color-text-light: #5a5a5a;
      --color-text-muted: #8a8a8a;
      --color-border: #e5e2dd;
      --color-error: #dc3545;
      --color-success: #28a745;
      --color-warning: #ffc107;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans JP', sans-serif; background: var(--color-bg); color: var(--color-text); line-height: 1.6; min-height: 100vh; }
    .header { background: var(--color-primary); color: var(--color-white); padding: 1rem 2rem; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo-symbol { font-size: 1.5rem; font-weight: 700; }
    .logo-text { font-size: 1rem; opacity: 0.9; }
    .header-actions { display: flex; gap: 1rem; }
    .btn-header { padding: 0.5rem 1rem; background: rgba(255,255,255,0.15); color: var(--color-white); border: none; border-radius: 8px; font-size: 0.85rem; cursor: pointer; transition: background 0.2s; }
    .btn-header:hover { background: rgba(255,255,255,0.25); }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
    .stat-card { background: var(--color-white); border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-soft); }
    .stat-label { font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--color-primary); }
    .stat-value.success { color: var(--color-success); }
    .stat-value.error { color: var(--color-error); }
    .stat-sub { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 0.25rem; }
    .filters { background: var(--color-white); border-radius: 12px; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: center; box-shadow: var(--shadow-soft); }
    .filter-label { font-size: 0.9rem; font-weight: 500; color: var(--color-text-light); }
    .filter-btn { padding: 0.5rem 1rem; border: 1px solid var(--color-border); background: var(--color-white); border-radius: 100px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
    .filter-btn:hover { border-color: var(--color-primary); }
    .filter-btn.active { background: var(--color-primary); color: var(--color-white); border-color: var(--color-primary); }
    .table-container { background: var(--color-white); border-radius: 12px; box-shadow: var(--shadow-soft); overflow: hidden; }
    .table-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
    .table-title { font-size: 1.1rem; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 1rem 1.5rem; text-align: left; border-bottom: 1px solid var(--color-border); }
    th { background: var(--color-bg); font-weight: 600; font-size: 0.85rem; color: var(--color-text-light); }
    td { font-size: 0.9rem; }
    tr:hover td { background: var(--color-bg); }
    tr:last-child td { border-bottom: none; }
    .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 100px; font-size: 0.75rem; font-weight: 600; }
    .badge-pass { background: #d4edda; color: #155724; }
    .badge-fail { background: #f8d7da; color: #721c24; }
    .btn-detail { padding: 0.4rem 0.8rem; background: var(--color-primary-pale); color: var(--color-primary); border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer; transition: background 0.2s; }
    .btn-detail:hover { background: var(--color-primary); color: var(--color-white); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--color-white); border-radius: 16px; width: 90%; max-width: 800px; max-height: 90vh; overflow: hidden; transform: translateY(20px); transition: transform 0.3s; }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center; }
    .modal-title { font-size: 1.2rem; font-weight: 600; }
    .modal-close { width: 36px; height: 36px; border: none; background: var(--color-bg); border-radius: 50%; font-size: 1.2rem; cursor: pointer; transition: background 0.2s; }
    .modal-close:hover { background: var(--color-border); }
    .modal-body { padding: 1.5rem; max-height: calc(90vh - 140px); overflow-y: auto; }
    .detail-section { margin-bottom: 2rem; }
    .detail-section:last-child { margin-bottom: 0; }
    .detail-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--color-primary); }
    .detail-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .detail-item { background: var(--color-bg); padding: 1rem; border-radius: 8px; }
    .detail-item-label { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 0.25rem; }
    .detail-item-value { font-size: 1rem; font-weight: 500; }
    .answer-item { background: var(--color-bg); border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
    .answer-item.correct { border-left: 3px solid var(--color-success); }
    .answer-item.incorrect { border-left: 3px solid var(--color-error); }
    .answer-question { font-weight: 500; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .answer-content { font-size: 0.85rem; color: var(--color-text-light); }
    .answer-content span { display: block; margin-top: 0.25rem; }
    .answer-feedback { background: var(--color-primary-pale); padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; font-size: 0.85rem; }
    
    /* å›ç­”è©³ç´°ã®æ–°ã‚¹ã‚¿ã‚¤ãƒ« */
    .answer-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
    .answer-number { background: var(--color-primary); color: white; padding: 0.2rem 0.6rem; border-radius: 100px; font-weight: 600; font-size: 0.8rem; }
    .answer-category { background: var(--color-bg); color: var(--color-text-muted); padding: 0.2rem 0.6rem; border-radius: 100px; font-size: 0.75rem; }
    .answer-score { margin-left: auto; font-weight: 600; font-size: 0.85rem; }
    .answer-score.score-correct { color: var(--color-success); }
    .answer-score.score-incorrect { color: var(--color-error); }
    .question-text { font-size: 0.95rem; font-weight: 500; line-height: 1.6; margin-bottom: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 6px; }
    
    /* é¸æŠè‚¢è¡¨ç¤º */
    .answer-options { display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 0.75rem; }
    .answer-option { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: white; border: 1px solid var(--color-border); border-radius: 6px; font-size: 0.85rem; }
    .answer-option.opt-correct { background: #d4edda; border-color: var(--color-success); }
    .answer-option.opt-wrong { background: #f8d7da; border-color: var(--color-error); }
    .opt-letter { width: 20px; height: 20px; background: var(--color-border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; flex-shrink: 0; }
    .answer-option.opt-correct .opt-letter { background: var(--color-success); color: white; }
    .answer-option.opt-wrong .opt-letter { background: var(--color-error); color: white; }
    .opt-text { flex: 1; }
    .opt-badge { padding: 0.1rem 0.4rem; border-radius: 100px; font-size: 0.65rem; font-weight: 600; }
    .user-badge { background: #6c757d; color: white; }
    .correct-badge { background: var(--color-success); color: white; }
    
    /* è¨˜è¿°å¼å›ç­” */
    .text-answer-box { background: white; border: 1px solid var(--color-border); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.75rem; }
    .text-answer-label { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 0.25rem; }
    .text-answer-content { font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; }
    
    .model-answer { background: #e8f4fd; border: 1px solid #b8daff; border-radius: 8px; padding: 1rem; margin-top: 0.75rem; }
    .model-answer-label { font-weight: 600; color: #004085; margin-bottom: 0.5rem; font-size: 0.85rem; }
    .model-answer-text { font-size: 0.9rem; color: #004085; line-height: 1.7; }
    .answer-points { background: #fff8e6; border: 1px solid #ffd966; border-radius: 8px; padding: 1rem; margin-top: 0.75rem; }
    .answer-points-label { font-weight: 600; color: #856404; margin-bottom: 0.5rem; font-size: 0.85rem; }
    .answer-points-list { margin: 0; padding-left: 1.25rem; font-size: 0.85rem; color: #856404; }
    .answer-points-list li { margin-bottom: 0.25rem; }
    .answer-points-list li:last-child { margin-bottom: 0; }
    .feedback-section { background: var(--color-accent); background: linear-gradient(135deg, #f5f0e0 0%, #fff 100%); border: 2px solid var(--color-accent); border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    .feedback-section-title { font-weight: 600; color: var(--color-accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .feedback-text { font-size: 0.9rem; color: var(--color-text); white-space: pre-wrap; }
    .loading { text-align: center; padding: 3rem; }
    .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty-state { text-align: center; padding: 3rem; color: var(--color-text-muted); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    .error-box { background: #fee; border: 1px solid var(--color-error); color: var(--color-error); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
    @media (max-width: 1024px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 768px) { .container { padding: 1rem; } .stats-grid { grid-template-columns: 1fr; } .filters { flex-wrap: wrap; } .table-container { overflow-x: auto; } table { min-width: 600px; } .detail-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <span class="logo-symbol">ç¤¼</span>
        <span class="logo-text">å–¶æ¥­ãƒ†ã‚¹ãƒˆç®¡ç†ç”»é¢</span>
      </div>
      <div class="header-actions">
        <button class="btn-header" id="refreshBtn">ğŸ”„ æ›´æ–°</button>
        <button class="btn-header" id="exportBtn">ğŸ“¥ CSVå‡ºåŠ›</button>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="errorBox" class="error-box" style="display: none;"></div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">ç·å—é¨“è€…æ•°</div>
        <div class="stat-value" id="totalAttempts">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">åˆæ ¼è€…æ•°</div>
        <div class="stat-value success" id="passedCount">0</div>
        <div class="stat-sub" id="passRate">åˆæ ¼ç‡: 0%</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">ä¸åˆæ ¼è€…æ•°</div>
        <div class="stat-value error" id="failedCount">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å¹³å‡ç‚¹</div>
        <div class="stat-value" id="avgScore">0</div>
        <div class="stat-sub">/ 100ç‚¹</div>
      </div>
    </div>

    <div class="filters">
      <span class="filter-label">çµã‚Šè¾¼ã¿:</span>
      <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
      <button class="filter-btn" data-filter="passed">åˆæ ¼ã®ã¿</button>
      <button class="filter-btn" data-filter="failed">ä¸åˆæ ¼ã®ã¿</button>
    </div>

    <div class="table-container">
      <div class="table-header">
        <h2 class="table-title">å—é¨“è€…ä¸€è¦§</h2>
        <span id="tableCount">0ä»¶</span>
      </div>
      <div id="tableBody">
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modalContent">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">è©³ç´°</h3>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <script>
    // Supabaseè¨­å®š
    const SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';
    
    let supabaseClient = null;
    let allAttempts = [];
    let currentFilter = 'all';

    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
      
      // SupabaseåˆæœŸåŒ–
      try {
        if (typeof window.supabase === 'undefined') {
          throw new Error('Supabase ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        }
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('SupabaseåˆæœŸåŒ–æˆåŠŸ');
      } catch (e) {
        console.error('SupabaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
        showError('Supabaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        return;
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      document.getElementById('refreshBtn').addEventListener('click', loadData);
      document.getElementById('exportBtn').addEventListener('click', exportCSV);
      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
      });

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.dataset.filter;
          renderTable();
        });
      });

      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
      loadData();
    });

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const errorBox = document.getElementById('errorBox');
      errorBox.textContent = message;
      errorBox.style.display = 'block';
      
      document.getElementById('tableBody').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">âš ï¸</div>
          <p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
          <p style="font-size: 0.85rem; margin-top: 0.5rem;">${escapeHtml(message)}</p>
        </div>
      `;
    }

    // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    async function loadData() {
      console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
      document.getElementById('errorBox').style.display = 'none';
      
      document.getElementById('tableBody').innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      `;

      try {
        if (!supabaseClient) {
          throw new Error('SupabaseãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        console.log('Supabaseã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­...');
        const { data, error } = await supabaseClient
          .from('sales_test_attempts')
          .select('*')
          .order('created_at', { ascending: false });

        console.log('ã‚¯ã‚¨ãƒªçµæœ:', { data, error });

        if (error) {
          throw new Error(error.message || 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼');
        }

        allAttempts = data || [];
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', allAttempts.length, 'ä»¶');
        
        updateStats();
        renderTable();
      } catch (error) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError(error.message || 'ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // çµ±è¨ˆæ›´æ–°
    function updateStats() {
      const total = allAttempts.length;
      const passed = allAttempts.filter(a => a.passed).length;
      const failed = total - passed;
      const avgScore = total > 0 
        ? Math.round(allAttempts.reduce((sum, a) => sum + (a.total_score || 0), 0) / total)
        : 0;
      const passRate = total > 0 ? Math.round((passed / total) * 100) : 0;

      document.getElementById('totalAttempts').textContent = total;
      document.getElementById('passedCount').textContent = passed;
      document.getElementById('failedCount').textContent = failed;
      document.getElementById('avgScore').textContent = avgScore;
      document.getElementById('passRate').textContent = `åˆæ ¼ç‡: ${passRate}%`;
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
    function renderTable() {
      let filtered = allAttempts;
      
      if (currentFilter === 'passed') {
        filtered = allAttempts.filter(a => a.passed);
      } else if (currentFilter === 'failed') {
        filtered = allAttempts.filter(a => !a.passed);
      }

      document.getElementById('tableCount').textContent = `${filtered.length}ä»¶`;

      if (filtered.length === 0) {
        document.getElementById('tableBody').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <p>ã¾ã å—é¨“è€…ãŒã„ã¾ã›ã‚“</p>
            <p style="font-size: 0.85rem; margin-top: 0.5rem; color: var(--color-text-muted);">å–¶æ¥­ãƒ†ã‚¹ãƒˆã‚’å—é¨“ã™ã‚‹ã¨ã€ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
          </div>
        `;
        return;
      }

      document.getElementById('tableBody').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>å—é¨“æ—¥æ™‚</th>
              <th>åå‰</th>
              <th>åˆè¨ˆç‚¹</th>
              <th>ç¬¬1éƒ¨ï¼ˆé¸æŠï¼‰</th>
              <th>ç¬¬1éƒ¨ï¼ˆè¨˜è¿°ï¼‰</th>
              <th>ç¬¬2éƒ¨</th>
              <th>æ‰€è¦æ™‚é–“</th>
              <th>çµæœ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tableRows"></tbody>
        </table>
      `;

      const tbody = document.getElementById('tableRows');
      filtered.forEach(attempt => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(attempt.created_at)}</td>
          <td><strong>${escapeHtml(attempt.user_name)}</strong></td>
          <td><strong>${attempt.total_score || 0}</strong> / ${attempt.max_score || 100}</td>
          <td>${attempt.section1_select_score || 0} / 30</td>
          <td>${attempt.section1_text_score || 0} / 10</td>
          <td>${attempt.section2_score || 0} / 60</td>
          <td>${attempt.duration_minutes || '-'}åˆ†</td>
          <td>
            <span class="badge ${attempt.passed ? 'badge-pass' : 'badge-fail'}">
              ${attempt.passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}
            </span>
          </td>
          <td>
            <button class="btn-detail" data-id="${attempt.id}">è©³ç´°</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // è©³ç´°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      document.querySelectorAll('.btn-detail').forEach(btn => {
        btn.addEventListener('click', function() {
          showDetail(this.dataset.id);
        });
      });
    }

    // è©³ç´°è¡¨ç¤º
    async function showDetail(attemptId) {
      const attempt = allAttempts.find(a => a.id === attemptId);
      if (!attempt) return;

      document.getElementById('modalTitle').textContent = `${attempt.user_name}ã•ã‚“ã®è©³ç´°`;
      document.getElementById('modalBody').innerHTML = `
        <div class="loading">
          <div class="loading-spinner"></div>
          <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
      `;
      document.getElementById('modalOverlay').classList.add('active');

      try {
        const { data: answers, error } = await supabaseClient
          .from('sales_test_answers')
          .select('*')
          .eq('attempt_id', attemptId)
          .order('question_id', { ascending: true });

        if (error) throw error;

        renderDetail(attempt, answers || []);
      } catch (error) {
        console.error('è©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('modalBody').innerHTML = `
          <div class="empty-state">
            <p>è©³ç´°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
          </div>
        `;
      }
    }

    // å•é¡Œãƒ‡ãƒ¼ã‚¿ï¼ˆå•é¡Œæ–‡ã€é¸æŠè‚¢ã€æ­£è§£ã€æ¨¡ç¯„å›ç­”ï¼‰
    const allQuestions = {
      1: { question: "ReiãŒè§£æ±ºã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹èª²é¡Œã¨ã—ã¦ã€æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["é¦™å…¸ã®é›»å­æ±ºæ¸ˆåŒ–ã«ã‚ˆã‚‹æ¥­å‹™åŠ¹ç‡åŒ–", "è·é›¢ã‚„ä»•äº‹ã®éƒ½åˆã§å‚åˆ—ã§ããªã„äººã®æƒ³ã„ã‚’å±Šã‘ã‚‹æ‰‹æ®µãŒãªã„ã“ã¨", "è‘¬å„€è²»ç”¨ã®å‰Šæ¸›", "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³è‘¬å„€ã®æ™®åŠ"], correct: 1 },
      2: { question: "Reiã®é–‹ç™ºç†å¿µã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["è‘¬å„€ã®ä¾¡å€¤ã¯å‚åˆ—è€…æ•°ã§æ±ºã¾ã‚‹", "è‘¬å„€ã®ä¾¡å€¤ã¯è²»ç”¨ã®å¤§ãã•ã§æ±ºã¾ã‚‹", "è‘¬å„€ã®ä¾¡å€¤ã¯ã€Œã©ã‚Œã ã‘æƒ³ã‚ã‚Œã¦ã„ã‚‹ã‹ã€ã§æ±ºã¾ã‚‹", "è‘¬å„€ã®ä¾¡å€¤ã¯å½¢å¼ã®è±ªè¯ã•ã§æ±ºã¾ã‚‹"], correct: 2 },
      3: { question: "ReiãŒã€ŒçŒ®æ¯ã€ã¨ã„ã†å½¢ã‚’é¸ã‚“ã ç†ç”±ã¨ã—ã¦ã€æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["æ±ºæ¸ˆæ‰‹æ•°æ–™ãŒå®‰ã„ã‹ã‚‰", "æƒ³ã„ãŒä¸€ç•ªã¾ã£ã™ãå±Šãå½¢ã ã‹ã‚‰", "ä»–ç¤¾ãŒã‚„ã£ã¦ã„ãªã„ã‹ã‚‰", "è‘¬å„€ç¤¾ã®è¦æœ›ãŒå¤šã‹ã£ãŸã‹ã‚‰"], correct: 1 },
      4: { question: "ã€Œè‘¬å„€ã®ä¾¡å€¤ã¯ã€ãã“ã«ã„ãŸã‹ã©ã†ã‹ã€ã§ã¯ãªãã€ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ï¼¿ã€ã§æ±ºã¾ã‚‹ã€", type: "text" },
      5: { question: "ReiãŒå¤§åˆ‡ã«ã—ã¦ã„ã‚‹è€ƒãˆæ–¹ã«ã¤ã„ã¦ã€30æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", type: "text" },
      6: { question: "çŒ®æ¯ã®æµã‚Œã¨ã—ã¦æ­£ã—ã„é †ç•ªã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["URLå…±æœ‰ â†’ ãƒšãƒ¼ã‚¸ä½œæˆ â†’ é€é‡‘ â†’ éºæ—ç¢ºèª", "ãƒšãƒ¼ã‚¸ä½œæˆ â†’ URLå…±æœ‰ â†’ é€é‡‘ â†’ éºæ—ç¢ºèª", "é€é‡‘ â†’ ãƒšãƒ¼ã‚¸ä½œæˆ â†’ URLå…±æœ‰ â†’ éºæ—ç¢ºèª", "ãƒšãƒ¼ã‚¸ä½œæˆ â†’ é€é‡‘ â†’ URLå…±æœ‰ â†’ éºæ—ç¢ºèª"], correct: 1 },
      7: { question: "è‘¬å„€ç¤¾ç®¡ç†ç”»é¢ã§ã§ãã‚‹ã“ã¨ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ã€‚", type: "multi", options: ["çŒ®æ¯ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ", "çŒ®æ¯é‡‘é¡ã®ç·é¡ç¢ºèª", "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®š", "ä»–ç¤¾ã®çŒ®æ¯ãƒ‡ãƒ¼ã‚¿ã®é–²è¦§"], correct: [0, 1, 2] },
      8: { question: "ã”éºæ—ãŒãƒãƒ¼ã‚¿ãƒ«ã§ç¢ºèªã§ãã‚‹æƒ…å ±ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ã€‚", type: "multi", options: ["çŒ®æ¯ã®ç·é¡", "çŒ®æ¯è€…ã®ãŠåå‰", "çŒ®æ¯è€…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "ä»–ã®è‘¬å„€ã®çŒ®æ¯æƒ…å ±"], correct: [0, 1, 2] },
      9: { question: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¨ã—ã¦ã€ReiãŒå®Ÿè£…ã—ã¦ã„ã‚‹ä»•çµ„ã¿ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["è‘¬å„€ç¤¾ã”ã¨ã®å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿åˆ†é›¢", "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·", "Aã¨Bã®ä¸¡æ–¹", "ç‰¹åˆ¥ãªå¯¾ç­–ã¯ã—ã¦ã„ãªã„"], correct: 2 },
      10: { question: "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ–¹æ³•ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["èª°ã§ã‚‚è‡ªç”±ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹", "è‘¬å„€ç¤¾ãŒè¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ä¿è­·ã•ã‚Œã¦ã„ã‚‹", "ã”éºæ—ã®é¡”èªè¨¼ãŒå¿…è¦", "è‘¬å„€ç¤¾çµŒç”±ã§ã®ã¿é–²è¦§å¯èƒ½"], correct: 1 },
      11: { question: "çŒ®æ¯ãƒšãƒ¼ã‚¸ã§é€é‡‘è€…ãŒå…¥åŠ›ã™ã‚‹æƒ…å ±ã¨ã—ã¦ã€æ­£ã—ã„ã‚‚ã®ã‚’ã™ã¹ã¦é¸ã‚“ã§ãã ã•ã„ã€‚", type: "multi", options: ["ãŠåå‰", "é‡‘é¡", "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸", "éŠ€è¡Œå£åº§ç•ªå·"], correct: [0, 1, 2] },
      12: { question: "Reiã®ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã«ã¤ã„ã¦ã€50æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", type: "text" },
      13: { question: "ã”éºæ—ã¸ã®é‚„å…ƒç‡ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["70.0%", "80.0%", "88.4%", "95.0%"], correct: 2 },
      14: { question: "è‘¬å„€ç¤¾æ§˜ã®åˆæœŸå°å…¥è²»ç”¨ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["ç„¡æ–™", "100ä¸‡å††", "500ä¸‡å††", "æœˆé¡åˆ¶ã®ã¿"], correct: 2 },
      15: { question: "åˆæœŸå°å…¥å¾Œã®æœˆé¡è²»ç”¨ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["æœˆé¡5ä¸‡å††", "æœˆé¡10ä¸‡å††", "ç„¡æ–™", "çŒ®æ¯ä»¶æ•°ã«å¿œã˜ã¦å¤‰å‹•"], correct: 2 },
      16: { question: "1ä»¶ã®çŒ®æ¯ã‚ãŸã‚Šã®æ‰‹æ•°æ–™ç‡ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["5.0%", "8.0%", "11.6%", "15.0%"], correct: 2 },
      17: { question: "å°å…¥ã¾ã§ã®æœŸé–“ã¨ã—ã¦æ­£ã—ã„ã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["ç”³ã—è¾¼ã¿ã‹ã‚‰1ãƒ¶æœˆå¾Œ", "ç”³ã—è¾¼ã¿ã‹ã‚‰2é€±é–“å¾Œ", "å…¥é‡‘ç¢ºèªå¾Œã€å³æ—¥åˆ©ç”¨å¯èƒ½", "ç ”ä¿®å®Œäº†å¾Œï¼ˆç´„1é€±é–“ï¼‰"], correct: 2 },
      18: { question: "Reiã®å°å…¥ã«ãŠã‘ã‚‹è‘¬å„€ç¤¾æ§˜å´ã®ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€æœ€ã‚‚é‡è¦ãªã‚‚ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ", type: "single", options: ["ã‚¹ã‚¿ãƒƒãƒ•ã®å·¥æ•°ãŒå¢—ãˆãªã„ï¼ˆç°¡å˜ã«é‹ç”¨ã§ãã‚‹ï¼‰", "åºƒå‘Šå®£ä¼ãŒã§ãã‚‹", "è‘¬å„€è²»ç”¨ã‚’å€¤ä¸Šã’ã§ãã‚‹", "ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šæ¸›ã§ãã‚‹"], correct: 0 },
      19: { question: "ã€Œã‚¹ã‚¿ãƒƒãƒ•ã®å·¥æ•°ãŒå¢—ãˆãªã„ã€ã¨ã¯å…·ä½“çš„ã«ã©ã†ã„ã†ã“ã¨ã‹ã€50æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", type: "text" },
      20: { question: "Reiã‚’å°å…¥ã™ã‚‹ã“ã¨ã§è‘¬å„€ç¤¾æ§˜ãŒé¡§å®¢ã«æä¾›ã§ãã‚‹æ–°ã—ã„ä¾¡å€¤ã«ã¤ã„ã¦ã€50æ–‡å­—ä»¥å†…ã§èª¬æ˜ã—ã¦ãã ã•ã„ã€‚", type: "text" },
      21: { question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼šã€Œã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§ãŠé‡‘ã‚’é›†ã‚ã‚‹ã®ã¯ã€ãªã‚“ã ã‹ä¸è¬¹æ…ãªæ°—ãŒã™ã‚‹ã®ã§ã™ãŒâ€¦ã€", type: "essay", modelAnswer: "ãã®ãŠæ°—æŒã¡ã¯ã‚ˆãåˆ†ã‹ã‚Šã¾ã™ã€‚ãŸã ã€Reiã¯ã€ŒãŠé‡‘ã‚’é›†ã‚ã‚‹ã€ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ãªãã€ã€Œå‚åˆ—ã§ããªã„æ–¹ã®æƒ³ã„ã‚’å±Šã‘ã‚‹ã€ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚å¾“æ¥ã®é¦™å…¸ã¨åŒã˜ã‚ˆã†ã«ã€æ•…äººã¸ã®å¼”æ„ã‚’å½¢ã«ã™ã‚‹æ‰‹æ®µã®ä¸€ã¤ã¨ãŠè€ƒãˆãã ã•ã„ã€‚", answerPoints: ["ã¾ãšç›¸æ‰‹ã®æ°—æŒã¡ã«å…±æ„Ÿã™ã‚‹", "ã€ŒãŠé‡‘ã‚’é›†ã‚ã‚‹ã€ã§ã¯ãªãã€Œæƒ³ã„ã‚’å±Šã‘ã‚‹ã€ã¨ã„ã†è¨€ã„æ›ãˆ", "å¾“æ¥ã®é¦™å…¸ã¨ã®é¡ä¼¼æ€§ã‚’èª¬æ˜", "å‚åˆ—ã§ããªã„äººã®ãŸã‚ã®æ‰‹æ®µã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿"] },
      22: { question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼šã€Œé«˜é½¢ã®æ–¹ãŒå¤šã„ã®ã§ã€ã‚¹ãƒãƒ›æ“ä½œãŒã§ãã‚‹ã‹å¿ƒé…ã§ã™ã€", type: "essay", modelAnswer: "ã”å¿ƒé…ã¯ã”ã‚‚ã£ã¨ã‚‚ã§ã™ã€‚ãŸã ã€çŒ®æ¯ã‚’é€ã‚‹å´ã¯é æ–¹ã«ã„ã‚‹ãŠå­«ã•ã‚“ã‚„ãŠä»•äº‹é–¢ä¿‚ã®æ–¹ãªã©ã€æ¯”è¼ƒçš„ã‚¹ãƒãƒ›ã«æ…£ã‚ŒãŸä¸–ä»£ãŒå¤šã„ã§ã™ã€‚æ“ä½œã‚‚3åˆ†ç¨‹åº¦ã§å®Œäº†ã—ã¾ã™ã€‚ã”éºæ—ã¯é–²è¦§ã™ã‚‹ã ã‘ãªã®ã§ã€ã•ã‚‰ã«ç°¡å˜ã§ã™ã€‚", answerPoints: ["é€é‡‘è€…ã¯è‹¥ã„ä¸–ä»£ãŒå¤šã„ã“ã¨ã‚’èª¬æ˜", "æ“ä½œãŒç°¡å˜ï¼ˆ3åˆ†ç¨‹åº¦ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹", "ã”éºæ—ã¯é–²è¦§ã®ã¿ã§ã•ã‚‰ã«ç°¡å˜", "å…·ä½“çš„ãªæ“ä½œå†…å®¹ã‚’èª¬æ˜"] },
      23: { question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼šã€ŒåˆæœŸè²»ç”¨500ä¸‡å††ã¯é«˜ã„ã¨æ„Ÿã˜ã¾ã™ã€‚ãªãœã“ã®é‡‘é¡ãªã®ã§ã™ã‹ï¼Ÿã€", type: "essay", modelAnswer: "åˆæœŸè²»ç”¨ã¯ç¢ºã‹ã«å¤§ããæ„Ÿã˜ã‚‰ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚ãŸã ã€å°å…¥å¾Œã®æœˆé¡è²»ç”¨ã¯ç„¡æ–™ã§ã™ã€‚å¤šãã®ã‚·ã‚¹ãƒ†ãƒ ã¯æœˆé¡5ã€œ10ä¸‡å††ã‹ã‹ã‚Šã¾ã™ãŒã€Reiã¯é•·ãä½¿ã†ã»ã©ã‚³ã‚¹ãƒˆãƒ¡ãƒªãƒƒãƒˆãŒå‡ºã¾ã™ã€‚", answerPoints: ["æœˆé¡è²»ç”¨ãŒç„¡æ–™ã§ã‚ã‚‹ã“ã¨ã‚’å¼·èª¿", "ä»–ã‚·ã‚¹ãƒ†ãƒ ã¨ã®æ¯”è¼ƒï¼ˆæœˆé¡5ã€œ10ä¸‡å††ï¼‰", "é•·æœŸçš„ãªã‚³ã‚¹ãƒˆãƒ¡ãƒªãƒƒãƒˆã‚’èª¬æ˜", "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚„ã‚µãƒãƒ¼ãƒˆã®ä¾¡å€¤ã‚’ä¼ãˆã‚‹"] },
      24: { question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼šã€Œã†ã¡ã¯å¾“æ¥ã®ã‚„ã‚Šæ–¹ã§ååˆ†ã§ã™ã€‚ã‚ã–ã‚ã–æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’å…¥ã‚Œã‚‹å¿…è¦ã¯ãªã„ã®ã§ã¯ï¼Ÿã€", type: "essay", modelAnswer: "ãŠã£ã—ã‚ƒã‚‹é€šã‚Šã€å¾“æ¥ã®ã‚„ã‚Šæ–¹ã¯å¤§åˆ‡ã«ã™ã¹ãã‚‚ã®ã§ã™ã€‚Reiã¯å¾“æ¥ã®ã‚„ã‚Šæ–¹ã‚’å¤‰ãˆã‚‹ã‚‚ã®ã§ã¯ãªãã€ã€Œå‚åˆ—ã§ããªã„æ–¹ã¸ã®æ–°ã—ã„é¸æŠè‚¢ã€ã‚’è¿½åŠ ã™ã‚‹ã‚‚ã®ã§ã™ã€‚", answerPoints: ["å¾“æ¥ã®ã‚„ã‚Šæ–¹ã‚’å¦å®šã—ãªã„", "ã€Œå¤‰ãˆã‚‹ã€ã§ã¯ãªãã€Œé¸æŠè‚¢ã‚’è¿½åŠ ã€ã¨ã„ã†è¡¨ç¾", "å‚åˆ—ã§ããªã„æ–¹ã®ãŸã‚ã®æ–°ã—ã„æ‰‹æ®µ", "ã”éºæ—ã®æº€è¶³åº¦å‘ä¸Šã«ã¤ãªãŒã‚‹"] },
      25: { question: "è‘¬å„€ç¤¾æ§˜ã‹ã‚‰ã®è³ªå•ï¼šã€Œã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯æœ¬å½“ã«å¤§ä¸ˆå¤«ã§ã™ã‹ï¼Ÿå€‹äººæƒ…å ±ã®æ¼æ´©ãŒå¿ƒé…ã§ã™ã€", type: "essay", modelAnswer: "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¯æœ€ã‚‚é‡è¦–ã—ã¦ã„ã‚‹ç‚¹ã§ã™ã€‚è‘¬å„€ç¤¾æ§˜ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«åˆ†é›¢ã•ã‚Œã¦ãŠã‚Šã€ä»–ç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚æ±ºæ¸ˆã¯ä¸–ç•ŒåŸºæº–ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’æŒã¤Stripeã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚", answerPoints: ["è‘¬å„€ç¤¾ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿å®Œå…¨åˆ†é›¢", "ã”éºæ—ãƒãƒ¼ã‚¿ãƒ«ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¿è­·", "Stripeã«ã‚ˆã‚‹ä¸–ç•ŒåŸºæº–ã®æ±ºæ¸ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£", "ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚’ä¿å­˜ã—ãªã„ä»•çµ„ã¿"] }
    };

    function renderDetail(attempt, answers) {
      let feedbackSection = '';
      if (attempt.feedback && attempt.feedback.trim()) {
        feedbackSection = `
          <div class="detail-section">
            <h4 class="detail-section-title">ğŸ’¬ ã‚·ã‚¹ãƒ†ãƒ ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
            <div class="feedback-section">
              <div class="feedback-text">${escapeHtml(attempt.feedback)}</div>
            </div>
          </div>
        `;
      }

      document.getElementById('modalBody').innerHTML = `
        <div class="detail-section">
          <h4 class="detail-section-title">ğŸ“Š ã‚¹ã‚³ã‚¢æ¦‚è¦</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-item-label">å—é¨“æ—¥æ™‚</div>
              <div class="detail-item-value">${formatDate(attempt.created_at)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-item-label">æ‰€è¦æ™‚é–“</div>
              <div class="detail-item-value">${attempt.duration_minutes || '-'}åˆ†</div>
            </div>
            <div class="detail-item">
              <div class="detail-item-label">åˆè¨ˆç‚¹</div>
              <div class="detail-item-value">${attempt.total_score || 0} / ${attempt.max_score || 100}ç‚¹</div>
            </div>
            <div class="detail-item">
              <div class="detail-item-label">çµæœ</div>
              <div class="detail-item-value">
                <span class="badge ${attempt.passed ? 'badge-pass' : 'badge-fail'}">
                  ${attempt.passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼'}
                </span>
              </div>
            </div>
          </div>
        </div>

        ${feedbackSection}

        <div class="detail-section">
          <h4 class="detail-section-title">ğŸ“ å›ç­”è©³ç´°</h4>
          <div id="answerDetails"></div>
        </div>
      `;
      
      // å›ç­”è©³ç´°ã‚’ç”Ÿæˆ
      const container = document.getElementById('answerDetails');
      if (answers.length === 0) {
        container.innerHTML = '<p style="color: var(--color-text-muted);">å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      answers.forEach(a => {
        const qData = allQuestions[a.question_id];
        const div = document.createElement('div');
        div.className = 'answer-item ' + (a.is_correct ? 'correct' : 'incorrect');
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        let html = '<div class="answer-header">';
        html += '<span class="answer-number">å•' + a.question_id + '</span>';
        html += '<span class="answer-category">' + escapeHtml(a.question_category) + '</span>';
        html += '<span class="answer-score ' + (a.is_correct ? 'score-correct' : 'score-incorrect') + '">' + (a.score || 0) + ' / ' + (a.max_score || 0) + 'ç‚¹</span>';
        html += '</div>';
        
        // å•é¡Œæ–‡
        if (qData) {
          html += '<div class="question-text">' + qData.question + '</div>';
        }
        
        // é¸æŠè‚¢ã®è¡¨ç¤ºï¼ˆé¸æŠå¼ãƒ»è¤‡æ•°é¸æŠå¼ã®å ´åˆï¼‰
        if (qData && qData.options) {
          html += '<div class="answer-options">';
          const userAnswer = a.answer;
          qData.options.forEach((opt, idx) => {
            let isUserAnswer = false;
            let isCorrectOption = false;
            
            if (qData.type === 'single') {
              isUserAnswer = userAnswer === String(idx);
              isCorrectOption = qData.correct === idx;
            } else if (qData.type === 'multi') {
              try {
                const parsed = JSON.parse(userAnswer || '[]');
                isUserAnswer = parsed.includes(idx);
              } catch(e) { isUserAnswer = false; }
              isCorrectOption = qData.correct.includes(idx);
            }
            
            let optClass = '';
            if (isCorrectOption) optClass = 'opt-correct';
            else if (isUserAnswer && !isCorrectOption) optClass = 'opt-wrong';
            
            html += '<div class="answer-option ' + optClass + '">';
            html += '<span class="opt-letter">' + String.fromCharCode(65 + idx) + '</span>';
            html += '<span class="opt-text">' + opt + '</span>';
            if (isUserAnswer) html += '<span class="opt-badge user-badge">å›ç­”</span>';
            if (isCorrectOption) html += '<span class="opt-badge correct-badge">æ­£è§£</span>';
            html += '</div>';
          });
          html += '</div>';
        } else {
          // è¨˜è¿°å¼ãƒ»è«–è¿°å¼ã®å ´åˆ
          html += '<div class="text-answer-box">';
          html += '<div class="text-answer-label">å›ç­”:</div>';
          html += '<div class="text-answer-content">' + (escapeHtml(a.answer) || 'ï¼ˆæœªå›ç­”ï¼‰') + '</div>';
          html += '</div>';
        }
        
        // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if (a.ai_feedback) {
          html += '<div class="answer-feedback"><strong>ğŸ’¬ ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯:</strong> ' + escapeHtml(a.ai_feedback) + '</div>';
        }
        
        // æ¨¡ç¯„å›ç­”ã¨ãƒã‚¤ãƒ³ãƒˆï¼ˆè«–è¿°å¼ã®å ´åˆï¼‰
        if (qData && qData.modelAnswer) {
          html += '<div class="model-answer"><div class="model-answer-label">ğŸ“– æ¨¡ç¯„å›ç­”</div><div class="model-answer-text">' + qData.modelAnswer + '</div></div>';
        }
        if (qData && qData.answerPoints) {
          html += '<div class="answer-points"><div class="answer-points-label">âœ… æŠ¼ã•ãˆã¦ã»ã—ã„ãƒã‚¤ãƒ³ãƒˆ</div><ul class="answer-points-list">';
          qData.answerPoints.forEach(p => { html += '<li>' + p + '</li>'; });
          html += '</ul></div>';
        }
        
        div.innerHTML = html;
        container.appendChild(div);
      });
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    // CSVå‡ºåŠ›
    function exportCSV() {
      if (allAttempts.length === 0) {
        alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const headers = ['å—é¨“æ—¥æ™‚', 'åå‰', 'åˆè¨ˆç‚¹', 'ç¬¬1éƒ¨é¸æŠ', 'ç¬¬1éƒ¨è¨˜è¿°', 'ç¬¬2éƒ¨', 'æ‰€è¦æ™‚é–“', 'çµæœ', 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯'];
      const rows = allAttempts.map(a => [
        formatDate(a.created_at),
        a.user_name,
        a.total_score || 0,
        a.section1_select_score || 0,
        a.section1_text_score || 0,
        a.section2_score || 0,
        a.duration_minutes || '',
        a.passed ? 'åˆæ ¼' : 'ä¸åˆæ ¼',
        (a.feedback || '').replace(/"/g, '""')
      ]);

      const csv = [headers, ...rows]
        .map(row => row.map(cell => `"${cell}"`).join(','))
        .join('\n');

      const bom = '\uFEFF';
      const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `rei_sales_test_${formatDateForFile(new Date())}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    function formatDateForFile(d) {
      return `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }
  </script>
</body>
</html>