<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Rei 営業ポータル</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1a1a2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;-webkit-text-size-adjust:100%;}
body{font-family:'Noto Sans JP',-apple-system,BlinkMacSystemFont,sans-serif;background:#f5f6f8;color:#1a1a2e;line-height:1.5;overscroll-behavior:none;}
button{font-family:inherit;cursor:pointer;}
input,select,textarea{font-family:inherit;}
a{color:inherit;text-decoration:none;}

/* Login */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f5f6f8;padding:20px;}
.login-box{width:100%;max-width:340px;text-align:center;}
.login-brand{font-size:38px;font-weight:800;color:#1a1a2e;letter-spacing:6px;}
.login-sub{font-size:13px;color:#aaa;margin:4px 0 28px;}
.login-card{background:#fff;border-radius:20px;padding:28px;box-shadow:0 2px 16px rgba(0,0,0,0.05);}
.login-err{background:#fef2f2;color:#dc2626;font-size:12px;padding:8px 12px;border-radius:10px;margin-bottom:12px;display:none;}
.login-input{width:100%;padding:12px 16px;border-radius:12px;border:1px solid #e5e5ea;font-size:15px;background:#fafafa;outline:none;}
.login-input:focus{border-color:#6366f1;}
.login-btn{width:100%;padding:13px;border-radius:12px;border:none;background:#1a1a2e;color:#fff;font-size:15px;font-weight:700;margin-top:12px;}

/* App shell */
#app{display:none;max-width:430px;margin:0 auto;min-height:100vh;position:relative;background:#f5f6f8;}
.hdr{background:#1a1a2e;padding:12px 18px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
.hdr-logo{font-size:17px;font-weight:800;letter-spacing:3px;color:#c9a962;}
.hdr-user{display:flex;align-items:center;gap:8px;}
.hdr-badge{display:flex;align-items:center;gap:5px;padding:4px 12px 4px 5px;border-radius:100px;font-size:12px;font-weight:600;}
.hdr-avatar{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;}
.hdr-logout{background:none;border:none;color:#666;padding:4px;display:flex;}

/* Pages */
.pg{display:none;padding:18px 18px 90px;}
.pg.active{display:block;}
.pg-title{font-size:19px;font-weight:800;color:#1a1a2e;margin-bottom:16px;}

/* Bottom nav */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:#fff;border-top:1px solid #eee;display:flex;justify-content:space-around;padding:7px 0 env(safe-area-inset-bottom,10px);z-index:100;}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:none;border:none;padding:4px 10px;color:#ccc;transition:color .15s;}
.bnav-btn.active{color:#1a1a2e;}
.bnav-btn svg{width:20px;height:20px;}
.bnav-btn span{font-size:10px;font-weight:400;}
.bnav-btn.active span{font-weight:700;}

/* Utility */
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.toggle-wrap{display:flex;gap:3px;background:#eef0f4;border-radius:100px;padding:3px;}
.toggle-btn{display:flex;align-items:center;gap:4px;padding:6px 14px;border-radius:100px;border:none;font-size:11px;font-weight:600;background:transparent;color:#999;}
.toggle-btn.active{background:#fff;color:#1a1a2e;box-shadow:0 1px 4px rgba(0,0,0,0.08);}
.pill-wrap{display:flex;gap:6px;overflow-x:auto;padding-bottom:2px;margin-bottom:16px;}
.pill{padding:7px 16px;border-radius:100px;border:none;font-size:12px;font-weight:600;white-space:nowrap;background:#eef0f4;color:#777;}
.pill.active{background:#1a1a2e;color:#fff;}
.badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:100px;display:inline-block;}
.empty{text-align:center;padding:28px;color:#bbb;font-size:13px;background:#fff;border-radius:16px;}

/* Stats grid */
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:24px;}
.stat-card{background:#fff;border-radius:16px;padding:18px 12px;text-align:center;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.stat-val{font-size:30px;font-weight:800;line-height:1;}
.stat-lbl{font-size:11px;color:#999;margin-top:6px;font-weight:500;}

/* Calendar */
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
.cal-hdr{font-size:11px;font-weight:600;color:#aaa;padding:6px 0;}
.cal-hdr.sun{color:#ef4444;}
.cal-hdr.sat{color:#3b82f6;}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:12px;font-size:13px;cursor:pointer;position:relative;border:2px solid transparent;}
.cal-day:hover{background:#f5f5ff;}
.cal-day.today{background:#1a1a2e;color:#fff;font-weight:700;}
.cal-day.selected:not(.today){border-color:#6366f1;background:#f0f0ff;}
.cal-dots{position:absolute;bottom:3px;display:flex;gap:2px;}
.cal-dot{width:5px;height:5px;border-radius:50%;}

/* Form elements */
.form-label{font-size:12px;color:#999;margin-bottom:6px;font-weight:500;display:block;}
.form-input{width:100%;padding:11px 14px;border-radius:12px;border:1px solid #e5e5ea;font-size:14px;background:#fafafa;outline:none;box-sizing:border-box;}
.form-input:focus{border-color:#6366f1;}
.form-textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #e5e5ea;font-size:13px;resize:none;height:80px;font-family:inherit;background:#fafafa;box-sizing:border-box;outline:none;}
.form-textarea:focus{border-color:#6366f1;}
.form-group{margin-bottom:14px;}
.btn-primary{width:100%;padding:13px;border-radius:14px;border:none;background:#1a1a2e;color:#fff;font-size:14px;font-weight:700;cursor:pointer;}
.btn-sm-primary{display:flex;align-items:center;gap:6px;padding:8px 18px;border-radius:100px;background:#1a1a2e;color:#fff;border:none;font-size:12px;font-weight:600;}
.result-btns{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;}
.result-btn{padding:9px 0;border-radius:10px;border:1px solid #e5e5ea;background:#fff;color:#555;font-size:12px;font-weight:600;cursor:pointer;}
.result-btn.active{border:2px solid #1a1a2e;background:#1a1a2e;color:#fff;}

/* Schedule item */
.sch-item{background:#fff;border-radius:16px;padding:16px;margin-bottom:8px;box-shadow:0 1px 4px rgba(0,0,0,0.04);display:flex;justify-content:space-between;align-items:center;}

/* Expense item */
.exp-item{background:#fff;border-radius:16px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:14px;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.exp-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* Visit card */
.visit-card{background:#fff;border-radius:16px;padding:16px;margin-bottom:10px;box-shadow:0 1px 4px rgba(0,0,0,0.04);cursor:pointer;}
.visit-detail{margin-top:14px;padding-top:14px;border-top:1px solid #f0f0f5;display:none;}
.visit-detail.open{display:block;}
.visit-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px;}
.visit-memo{font-size:13px;color:#444;line-height:1.7;background:#f8f8fc;padding:12px;border-radius:12px;margin-top:8px;white-space:pre-wrap;}

/* Upcoming */
.upcoming-item{background:#fff;border-radius:16px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:14px;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
.upcoming-date{width:48px;height:48px;border-radius:14px;background:#f5f5ff;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;}
.upcoming-date-d{font-size:15px;font-weight:800;color:#6366f1;line-height:1;}
.upcoming-date-w{font-size:10px;color:#999;}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:200;display:none;align-items:flex-end;justify-content:center;}
.modal-overlay.show{display:flex;}
.modal-sheet{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:430px;max-height:85vh;overflow-y:auto;padding:24px 20px env(safe-area-inset-bottom,20px);}
.modal-handle{width:36px;height:4px;background:#ddd;border-radius:4px;margin:0 auto 16px;}
.modal-title{font-size:16px;font-weight:700;margin-bottom:16px;}

/* Colors per member */
.mc-blue .hdr-badge{background:#dbeafe;color:#2563eb;}
.mc-blue .hdr-avatar{background:#2563eb;}
.mc-green .hdr-badge{background:#dcfce7;color:#16a34a;}
.mc-green .hdr-avatar{background:#16a34a;}
.mc-amber .hdr-badge{background:#fef3c7;color:#d97706;}
.mc-amber .hdr-avatar{background:#d97706;}
.mc-rose .hdr-badge{background:#ffe4e6;color:#e11d48;}
.mc-rose .hdr-avatar{background:#e11d48;}
.mc-purple .hdr-badge{background:#ede9fe;color:#7c3aed;}
.mc-purple .hdr-avatar{background:#7c3aed;}

/* SVG icons inline */
svg{vertical-align:middle;}
</style>
</head>
<body>

<!-- Login -->
<div class="login-wrap" id="loginScreen">
<div class="login-box">
<div class="login-brand">Rei</div>
<div class="login-sub">営業ポータル</div>
<div class="login-card">
<div class="login-err" id="loginError">名前またはパスワードが違います</div>
<input class="login-input" type="text" id="loginName" placeholder="名前" style="margin-bottom:10px;">
<input class="login-input" type="password" id="loginPass" placeholder="パスワード">
<button class="login-btn" onclick="doLogin()">ログイン</button>
</div>
</div>
</div>

<!-- App -->
<div id="app">
<header class="hdr">
<div class="hdr-logo">Rei</div>
<div class="hdr-user">
<div class="hdr-badge" id="hdrBadge">
<div class="hdr-avatar" id="hdrAvatar"></div>
<span id="hdrName"></span>
</div>
<button class="hdr-logout" onclick="doLogout()" title="ログアウト">
<svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M6 2H3a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h3M10 11l3-3-3-3M13 8H6"/></svg>
</button>
</div>
</header>

<!-- Pages -->
<div class="pg active" id="pg-home"></div>
<div class="pg" id="pg-visits"></div>
<div class="pg" id="pg-schedule"></div>
<div class="pg" id="pg-review"></div>
<div class="pg" id="pg-expense"></div>

<!-- Bottom nav -->
<nav class="bnav">
<button class="bnav-btn active" data-tab="home">
<svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L10 3l7 6.5V17a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/><path d="M8 18V12h4v6"/></svg>
<span>ホーム</span>
</button>
<button class="bnav-btn" data-tab="visits">
<svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="16" height="14" rx="2"/><path d="M8 7v6M12 7v6M2 7h16"/></svg>
<span>訪問先</span>
</button>
<button class="bnav-btn" data-tab="schedule">
<svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="16" height="14" rx="2"/><path d="M2 8h16M6 2v4M14 2v4"/></svg>
<span>予定</span>
</button>
<button class="bnav-btn" data-tab="review">
<svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
<span>振り返り</span>
</button>
<button class="bnav-btn" data-tab="expense">
<svg fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
<span>経費</span>
</button>
</nav>
</div>

<!-- Expense modal -->
<div class="modal-overlay" id="expenseModal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-title">経費を申請する</div>
<div class="form-group"><label class="form-label">日付</label><input type="date" class="form-input" id="expDate"></div>
<div class="form-group"><label class="form-label">カテゴリ</label><select class="form-input" id="expCategory"><option value="交通費">交通費</option><option value="宿泊費">宿泊費</option><option value="飲食費">飲食費</option><option value="備品">備品</option><option value="その他">その他</option></select></div>
<div class="form-group"><label class="form-label">金額</label><input type="number" class="form-input" id="expAmount" placeholder="¥"></div>
<div class="form-group"><label class="form-label">内容</label><input type="text" class="form-input" id="expDesc" placeholder="例：福井→金沢 往復"></div>
<button class="btn-primary" onclick="submitExpense()" style="margin-top:8px;">申請する</button>
<button onclick="closeModal('expenseModal')" style="width:100%;padding:12px;border:none;background:none;color:#999;font-size:13px;margin-top:8px;">キャンセル</button>
</div>
</div>

<!-- Review modal (if needed for history detail) -->
<div class="modal-overlay" id="reviewDetailModal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-title">振り返り詳細</div>
<div id="reviewDetailContent"></div>
<button onclick="closeModal('reviewDetailModal')" style="width:100%;padding:12px;border:none;background:none;color:#999;font-size:13px;margin-top:8px;">閉じる</button>
</div>
</div>

<script>
var supabase, currentMember = null;
var members = [], prospects = [], schedules = [], expenses = [], evaluations = [];
var SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';

var MEMBER_COLORS = ['blue','green','amber','rose','purple'];
var COLOR_MAP = {
  blue:  { bg:'#dbeafe', text:'#2563eb', dot:'#2563eb' },
  green: { bg:'#dcfce7', text:'#16a34a', dot:'#16a34a' },
  amber: { bg:'#fef3c7', text:'#d97706', dot:'#d97706' },
  rose:  { bg:'#ffe4e6', text:'#e11d48', dot:'#e11d48' },
  purple:{ bg:'#ede9fe', text:'#7c3aed', dot:'#7c3aed' }
};

var currentTab = 'home';
var calDate = new Date();
var selectedDate = new Date().toISOString().split('T')[0];
var visitScope = 'mine';
var visitFilter = '';
var scheduleScope = 'all';
var reviewResult = '';

function getMemberColor(memberId) {
  var idx = members.findIndex(function(m) { return m.id === memberId; });
  var key = MEMBER_COLORS[idx % MEMBER_COLORS.length] || 'blue';
  return COLOR_MAP[key] || COLOR_MAP.blue;
}
function getMemberColorClass(memberId) {
  var idx = members.findIndex(function(m) { return m.id === memberId; });
  return 'mc-' + (MEMBER_COLORS[idx % MEMBER_COLORS.length] || 'blue');
}
function getMemberName(memberId) {
  var m = members.find(function(x) { return x.id === memberId; });
  return m ? m.name : '';
}
function esc(s) { return s ? String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
function pad(n) { return String(n).padStart(2, '0'); }
function dateStr(y, m, d) { return y + '-' + pad(m) + '-' + pad(d); }
function formatShortDate(s) { if (!s) return '-'; var p = s.split('-'); return parseInt(p[1]) + '/' + parseInt(p[2]); }
function getDow(s) { return ['日','月','火','水','木','金','土'][new Date(s).getDay()]; }

// Init
window.onload = function() {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  var saved = localStorage.getItem('salesPortalMemberId');
  if (saved) { loadMembers(function() { loginAsMember(saved); }); }
  document.getElementById('loginName').onkeypress = function(e) { if (e.key === 'Enter') document.getElementById('loginPass').focus(); };
  document.getElementById('loginPass').onkeypress = function(e) { if (e.key === 'Enter') doLogin(); };
  document.querySelectorAll('.bnav-btn').forEach(function(btn) {
    btn.onclick = function() { switchTab(btn.dataset.tab); };
  });
};

function loadMembers(cb) {
  supabase.from('sales_members').select('*').eq('is_active', true).then(function(r) {
    members = r.data || [];
    if (cb) cb();
  });
}

function doLogin() {
  var name = document.getElementById('loginName').value.trim();
  var pw = document.getElementById('loginPass').value;
  if (!name || !pw) return;
  loadMembers(function() {
    var found = members.find(function(m) { return (m.name === name || m.name.indexOf(name) !== -1 || name.indexOf(m.name) !== -1) && m.password === pw; });
    if (found) {
      localStorage.setItem('salesPortalMemberId', found.id);
      loginAsMember(found.id);
    } else {
      document.getElementById('loginError').style.display = 'block';
    }
  });
}

function loginAsMember(id) {
  currentMember = members.find(function(m) { return m.id === id; });
  if (!currentMember) { localStorage.removeItem('salesPortalMemberId'); return; }
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  // Set header
  var cc = getMemberColorClass(currentMember.id);
  document.getElementById('hdrBadge').className = 'hdr-badge ' + cc;
  document.getElementById('hdrAvatar').className = 'hdr-avatar';
  document.getElementById('hdrAvatar').textContent = currentMember.name.charAt(0);
  document.getElementById('hdrName').textContent = currentMember.name;
  loadAllData();
}

function doLogout() {
  localStorage.removeItem('salesPortalMemberId');
  currentMember = null;
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginName').value = '';
  document.getElementById('loginError').style.display = 'none';
}

function loadAllData() {
  supabase.from('sales_prospects').select('*').order('created_at',{ascending:false}).then(function(r) {
    prospects = r.data || [];
    renderHome(); renderVisits(); renderSchedulePage();
  });
  supabase.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r) {
    schedules = r.data || [];
    renderHome(); renderSchedulePage();
  });
  supabase.from('sales_expenses').select('*').order('created_at',{ascending:false}).then(function(r) {
    expenses = r.data || [];
    renderExpense();
  });
  supabase.from('sales_evaluations').select('*').eq('is_self_eval',true).order('eval_date',{ascending:false}).limit(50).then(function(r) {
    evaluations = r.data || [];
    renderReview();
  });
}

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.bnav-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tab); });
  document.querySelectorAll('.pg').forEach(function(p) { p.classList.toggle('active', p.id === 'pg-' + tab); });
}

// ==================== HOME ====================
function renderHome() {
  if (!currentMember) return;
  var me = currentMember.id;
  var myP = prospects.filter(function(p) { return p.assigned_to === me; });
  var closed = myP.filter(function(p) { return p.status === '成約'; }).length;
  var nego = myP.filter(function(p) { return p.status === '商談中'; }).length;
  var appo = myP.filter(function(p) { return p.status === '訪問済み' || p.status === 'アポ済'; }).length;

  var today = new Date().toISOString().split('T')[0];
  var todayS = schedules.filter(function(s) { return s.scheduled_date === today && s.member_id === me; });
  var upcoming = schedules.filter(function(s) { return s.member_id === me && s.scheduled_date >= today && !s.is_done; }).sort(function(a,b){ return a.scheduled_date.localeCompare(b.scheduled_date); }).slice(0, 5);

  var now = new Date();
  var dayNames = ['日','月','火','水','木','金','土'];
  var dateLabel = (now.getMonth()+1) + '月' + now.getDate() + '日（' + dayNames[now.getDay()] + '）';

  var h = '';
  // Greeting
  h += '<div style="margin-bottom:24px;"><div style="font-size:22px;font-weight:800;">' + esc(currentMember.name) + 'さん</div>';
  h += '<div style="font-size:13px;color:#999;margin-top:2px;">' + dateLabel + '</div></div>';

  // Stats
  h += '<div class="stats">';
  h += '<div class="stat-card"><div class="stat-val" style="color:#10b981;">' + closed + '</div><div class="stat-lbl">成約</div></div>';
  h += '<div class="stat-card"><div class="stat-val" style="color:#f59e0b;">' + nego + '</div><div class="stat-lbl">商談中</div></div>';
  h += '<div class="stat-card"><div class="stat-val" style="color:#6366f1;">' + appo + '</div><div class="stat-lbl">アポ済</div></div>';
  h += '</div>';

  // Today
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">';
  h += '<div style="font-size:15px;font-weight:700;">今日の予定</div>';
  h += '<button onclick="switchTab(\'schedule\')" style="font-size:12px;color:#6366f1;font-weight:600;background:none;border:none;cursor:pointer;">すべて見る →</button></div>';

  if (todayS.length > 0) {
    var mc = getMemberColor(me);
    todayS.forEach(function(s) {
      var prospect = prospects.find(function(p){ return p.id === s.prospect_id; });
      var name = prospect ? prospect.company_name : (s.memo || '予定');
      h += '<div class="card" style="border-left:4px solid ' + mc.dot + ';">';
      h += '<div style="font-weight:700;font-size:14px;">' + esc(name) + '</div>';
      h += '<div style="font-size:12px;color:#999;margin-top:6px;">' + esc(s.memo || '') + '</div></div>';
    });
  } else {
    h += '<div class="empty">今日の予定はありません</div>';
  }

  // Upcoming
  if (upcoming.length > 0) {
    h += '<div style="font-size:15px;font-weight:700;margin:20px 0 12px;">直近の予定</div>';
    upcoming.forEach(function(s) {
      var prospect = prospects.find(function(p){ return p.id === s.prospect_id; });
      var name = prospect ? prospect.company_name : (s.memo || '予定');
      var d = s.scheduled_date.split('-');
      h += '<div class="upcoming-item"><div class="upcoming-date"><div class="upcoming-date-d">' + parseInt(d[2]) + '</div><div class="upcoming-date-w">' + getDow(s.scheduled_date) + '</div></div>';
      h += '<div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(name) + '</div>';
      h += '<div style="font-size:11px;color:#999;margin-top:2px;">' + esc(s.memo || '') + '</div></div>';
      h += '<svg width="16" height="16" fill="none" stroke="#ddd" stroke-width="2"><path d="M6 4l4 4-4 4"/></svg></div>';
    });
  }

  document.getElementById('pg-home').innerHTML = h;
}

// ==================== VISITS ====================
function renderVisits() {
  if (!currentMember) return;
  var h = '';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">';
  h += '<div class="pg-title" style="margin:0;">訪問先</div>';
  h += '<div class="toggle-wrap">';
  h += '<button class="toggle-btn ' + (visitScope==='mine'?'active':'') + '" onclick="setVisitScope(\'mine\')"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"><circle cx="6.5" cy="4" r="2.5"/><path d="M1 12c0-2.5 2.5-4.5 5.5-4.5s5.5 2 5.5 4.5"/></svg> 自分</button>';
  h += '<button class="toggle-btn ' + (visitScope==='all'?'active':'') + '" onclick="setVisitScope(\'all\')"><svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"><circle cx="5" cy="4" r="2"/><circle cx="9" cy="4" r="2"/><path d="M0 12c0-2 2-4 5-4s5 2 5 4"/></svg> 全員</button>';
  h += '</div></div>';

  // Filters
  h += '<div class="pill-wrap">';
  ['','アポ済','商談中','成約','見込み'].forEach(function(f) {
    var label = f || 'すべて';
    h += '<button class="pill ' + (visitFilter===f?'active':'') + '" onclick="setVisitFilter(\'' + f + '\')">' + label + '</button>';
  });
  h += '</div>';

  var filtered = prospects.filter(function(p) {
    if (visitScope === 'mine' && p.assigned_to !== currentMember.id) return false;
    if (visitFilter && p.status !== visitFilter) return false;
    return true;
  });

  if (filtered.length === 0) {
    h += '<div class="empty">該当する訪問先がありません</div>';
  } else {
    filtered.forEach(function(p) {
      var mc = getMemberColor(p.assigned_to);
      var mn = getMemberName(p.assigned_to);
      var statusColors = {
        'アポ済':{ bg:'#ede9fe', c:'#6366f1' }, '訪問済み':{ bg:'#dbeafe', c:'#2563eb' },
        '商談中':{ bg:'#fef3c7', c:'#d97706' }, '見込み':{ bg:'#fef3c7', c:'#d97706' },
        '成約':{ bg:'#d1fae5', c:'#059669' }, '見送り':{ bg:'#fee2e2', c:'#dc2626' }
      };
      var sc = statusColors[p.status] || { bg:'#f3f4f6', c:'#6b7280' };

      h += '<div class="visit-card" onclick="toggleVisitDetail(\'' + p.id + '\')">';
      h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">';
      h += '<div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:14px;line-height:1.4;">' + esc(p.company_name) + '</div>';
      h += '<div style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center;">';
      if (p.area) h += '<span style="font-size:11px;color:#999;">' + esc(p.area) + '</span>';
      if (p.meeting_date) h += '<span style="font-size:11px;color:#6366f1;font-weight:600;">' + esc(p.meeting_date) + '</span>';
      if (visitScope === 'all' && mn) h += '<span style="font-size:10px;font-weight:600;padding:2px 8px;border-radius:100px;background:' + mc.bg + ';color:' + mc.text + ';">' + esc(mn) + '</span>';
      h += '</div></div>';
      h += '<span class="badge" style="background:' + sc.bg + ';color:' + sc.c + ';flex-shrink:0;">' + esc(p.status || '未訪問') + '</span>';
      h += '</div>';

      // Detail (hidden by default)
      h += '<div class="visit-detail" id="vd-' + p.id + '">';
      if (p.contact_person) h += '<div class="visit-row"><span style="color:#999;">担当者</span><span style="font-weight:600;">' + esc(p.contact_person) + '</span></div>';
      if (p.phone) h += '<div class="visit-row"><span style="color:#999;">電話番号</span><a href="tel:' + esc(p.phone) + '" style="font-weight:600;color:#6366f1;">' + esc(p.phone) + '</a></div>';
      if (p.address) h += '<div class="visit-row"><span style="color:#999;">住所</span><a href="https://www.google.com/maps/search/' + encodeURIComponent(p.address) + '" target="_blank" style="font-weight:600;color:#6366f1;font-size:12px;word-break:break-all;">' + esc(p.address) + ' ↗</a></div>';
      if (p.website_url) h += '<div class="visit-row"><span style="color:#999;">HP</span><a href="' + esc(p.website_url) + '" target="_blank" style="font-weight:600;color:#6366f1;font-size:12px;word-break:break-all;">' + esc(p.website_url) + '</a></div>';
      var memo = p.hearing_content || p.notes || '';
      if (memo) {
        h += '<div style="margin-top:6px;"><div style="font-size:11px;color:#999;margin-bottom:4px;font-weight:600;">ヒアリングメモ</div>';
        h += '<div class="visit-memo">' + esc(memo) + '</div></div>';
      }
      h += '</div></div>';
    });
  }
  document.getElementById('pg-visits').innerHTML = h;
}
function setVisitScope(v) { visitScope = v; renderVisits(); }
function setVisitFilter(f) { visitFilter = f; renderVisits(); }
function toggleVisitDetail(id) {
  var el = document.getElementById('vd-' + id);
  if (el) el.classList.toggle('open');
}

// ==================== SCHEDULE ====================
function renderSchedulePage() {
  if (!currentMember) return;
  var year = calDate.getFullYear();
  var month = calDate.getMonth() + 1;
  var today = new Date().toISOString().split('T')[0];

  var h = '';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">';
  h += '<div class="pg-title" style="margin:0;">スケジュール</div>';
  h += '<div class="toggle-wrap">';
  h += '<button class="toggle-btn ' + (scheduleScope==='mine'?'active':'') + '" onclick="setScheduleScope(\'mine\')">自分</button>';
  h += '<button class="toggle-btn ' + (scheduleScope==='all'?'active':'') + '" onclick="setScheduleScope(\'all\')">全員</button>';
  h += '</div></div>';

  // Member legend
  if (scheduleScope === 'all') {
    h += '<div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">';
    members.forEach(function(m) {
      var c = getMemberColor(m.id);
      h += '<div style="display:flex;align-items:center;gap:5px;font-size:11px;color:#666;"><div style="width:10px;height:10px;border-radius:50%;background:' + c.dot + ';"></div>' + esc(m.name) + '</div>';
    });
    h += '</div>';
  }

  // Calendar
  h += '<div class="card" style="padding:16px;">';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">';
  h += '<button onclick="changeCalMonth(-1)" style="border:none;background:#eef0f4;border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;"><svg width="16" height="16" fill="none" stroke="#333" stroke-width="2"><path d="M10 4l-4 4 4 4"/></svg></button>';
  h += '<div style="font-weight:700;font-size:15px;">' + year + '年' + month + '月</div>';
  h += '<button onclick="changeCalMonth(1)" style="border:none;background:#eef0f4;border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;cursor:pointer;"><svg width="16" height="16" fill="none" stroke="#333" stroke-width="2"><path d="M6 4l4 4-4 4"/></svg></button>';
  h += '</div>';

  h += '<div class="cal-grid">';
  ['日','月','火','水','木','金','土'].forEach(function(d, i) {
    var cls = i === 0 ? ' sun' : (i === 6 ? ' sat' : '');
    h += '<div class="cal-hdr' + cls + '">' + d + '</div>';
  });

  var firstDow = new Date(year, month - 1, 1).getDay();
  var daysInMonth = new Date(year, month, 0).getDate();
  for (var i = 0; i < firstDow; i++) h += '<div></div>';

  for (var d = 1; d <= daysInMonth; d++) {
    var ds = dateStr(year, month, d);
    var isToday = ds === today;
    var isSel = ds === selectedDate;
    var dayScheds = schedules.filter(function(s) {
      return s.scheduled_date === ds && (scheduleScope === 'all' || s.member_id === currentMember.id);
    });
    var uniqueMembers = [];
    dayScheds.forEach(function(s) { if (uniqueMembers.indexOf(s.member_id) === -1) uniqueMembers.push(s.member_id); });

    var cls = 'cal-day';
    if (isToday) cls += ' today';
    if (isSel && !isToday) cls += ' selected';

    h += '<div class="' + cls + '" onclick="selectCalDate(\'' + ds + '\')">' + d;
    if (uniqueMembers.length > 0) {
      h += '<div class="cal-dots">';
      uniqueMembers.slice(0, 3).forEach(function(mid) {
        var dotColor = isToday ? '#c9a962' : getMemberColor(mid).dot;
        h += '<div class="cal-dot" style="background:' + dotColor + ';"></div>';
      });
      h += '</div>';
    }
    h += '</div>';
  }
  h += '</div></div>';

  // Selected date schedules
  var selLabel = selectedDate ? (parseInt(selectedDate.split('-')[1]) + '月' + parseInt(selectedDate.split('-')[2]) + '日') : '';
  h += '<div style="font-size:14px;font-weight:700;margin:16px 0 10px;">' + selLabel + 'の予定</div>';

  var selScheds = schedules.filter(function(s) {
    return s.scheduled_date === selectedDate && (scheduleScope === 'all' || s.member_id === currentMember.id);
  });

  if (selScheds.length > 0) {
    selScheds.forEach(function(s) {
      var mc = getMemberColor(s.member_id);
      var mn = getMemberName(s.member_id);
      var prospect = prospects.find(function(p){ return p.id === s.prospect_id; });
      var name = prospect ? prospect.company_name : (s.memo || '予定');
      h += '<div class="sch-item" style="border-left:4px solid ' + mc.dot + ';">';
      h += '<div><div style="font-weight:700;font-size:14px;">' + esc(name) + '</div>';
      h += '<div style="font-size:12px;color:#999;margin-top:4px;">' + esc(s.memo || '') + '</div></div>';
      h += '<span class="badge" style="background:' + mc.bg + ';color:' + mc.text + ';">' + esc(mn) + '</span>';
      h += '</div>';
    });
  } else {
    h += '<div class="empty">予定はありません</div>';
  }

  document.getElementById('pg-schedule').innerHTML = h;
}
function setScheduleScope(v) { scheduleScope = v; renderSchedulePage(); }
function changeCalMonth(delta) { calDate.setMonth(calDate.getMonth() + delta); renderSchedulePage(); }
function selectCalDate(ds) { selectedDate = ds; renderSchedulePage(); }

// ==================== REVIEW ====================
function renderReview() {
  if (!currentMember) return;
  var myP = prospects.filter(function(p) { return p.assigned_to === currentMember.id; });
  var myEvals = evaluations.filter(function(e) { return e.member_id === currentMember.id; });

  var h = '';
  h += '<div class="pg-title">振り返り</div>';

  // Form
  h += '<div class="card" style="padding:20px;">';
  h += '<div style="font-size:14px;font-weight:700;margin-bottom:16px;">商談を記録する</div>';
  h += '<div class="form-group"><label class="form-label">商談先</label><select class="form-input" id="revCompany"><option value="">選択してください</option>';
  myP.forEach(function(p) { h += '<option value="' + esc(p.company_name) + '">' + esc(p.company_name) + '</option>'; });
  h += '</select></div>';

  h += '<div class="form-group"><label class="form-label">結果</label><div class="result-btns">';
  ['受注','見込み','継続','見送り'].forEach(function(r) {
    h += '<button class="result-btn ' + (reviewResult===r?'active':'') + '" onclick="setReviewResult(\'' + r + '\')">' + r + '</button>';
  });
  h += '</div></div>';

  h += '<div class="form-group"><label class="form-label">日付</label><input type="date" class="form-input" id="revDate" value="' + new Date().toISOString().slice(0,10) + '"></div>';
  h += '<div class="form-group"><label class="form-label">メモ</label><textarea class="form-textarea" id="revMemo" placeholder="商談の要点、次のアクション..."></textarea></div>';
  h += '<button class="btn-primary" onclick="submitReview()">記録する</button>';
  h += '</div>';

  // History
  h += '<div style="font-size:14px;font-weight:700;margin:20px 0 10px;">履歴</div>';
  if (myEvals.length === 0) {
    h += '<div class="empty">まだ記録がありません</div>';
  } else {
    myEvals.forEach(function(e) {
      var resultColors = { '受注':'#10b981','見込み':'#f59e0b','継続':'#6366f1','見送り':'#ef4444' };
      var rc = resultColors[e.result] || '#999';
      h += '<div class="card" style="display:flex;justify-content:space-between;align-items:center;">';
      h += '<div><div style="font-weight:600;font-size:13px;">' + esc(e.company_name || '-') + '</div>';
      h += '<div style="font-size:11px;color:#999;margin-top:2px;">' + esc(e.eval_date) + '</div></div>';
      h += '<span class="badge" style="background:' + rc + '22;color:' + rc + ';">' + esc(e.result || '-') + '</span>';
      h += '</div>';
    });
  }

  document.getElementById('pg-review').innerHTML = h;
}
function setReviewResult(r) { reviewResult = r; renderReview(); }
function submitReview() {
  var company = document.getElementById('revCompany').value;
  var evalDate = document.getElementById('revDate').value;
  var memo = document.getElementById('revMemo').value;
  if (!company || !reviewResult) { alert('商談先と結果を選択してください'); return; }

  var data = {
    member_id: currentMember.id,
    company_name: company,
    eval_date: evalDate,
    result: reviewResult,
    comment: memo,
    total_score: 0,
    scores: '{}',
    is_self_eval: true
  };
  supabase.from('sales_evaluations').insert(data).then(function(res) {
    if (res.error) { alert('保存に失敗: ' + res.error.message); return; }
    alert('記録しました');
    reviewResult = '';
    loadAllData();
  });
}

// ==================== EXPENSE ====================
function renderExpense() {
  if (!currentMember) return;
  var myExp = expenses.filter(function(e) { return e.member_id === currentMember.id; });
  var pendingAmt = myExp.filter(function(e) { return e.status === '申請中'; }).reduce(function(s,e){ return s + (e.amount||0); }, 0);
  var approvedAmt = myExp.filter(function(e) { return e.status === '承認'; }).reduce(function(s,e){ return s + (e.amount||0); }, 0);

  var h = '';
  h += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">';
  h += '<div class="pg-title" style="margin:0;">経費</div>';
  h += '<button class="btn-sm-primary" onclick="openModal(\'expenseModal\')"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 2v10M2 7h10"/></svg>申請する</button>';
  h += '</div>';

  h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">';
  h += '<div class="stat-card"><div class="stat-val" style="font-size:22px;color:#f59e0b;">¥' + pendingAmt.toLocaleString() + '</div><div class="stat-lbl">申請中</div></div>';
  h += '<div class="stat-card"><div class="stat-val" style="font-size:22px;color:#10b981;">¥' + approvedAmt.toLocaleString() + '</div><div class="stat-lbl">承認済</div></div>';
  h += '</div>';

  if (myExp.length === 0) {
    h += '<div class="empty">経費申請はありません</div>';
  } else {
    myExp.forEach(function(e) {
      var isPending = e.status === '申請中';
      var iconBg = isPending ? '#fef3c7' : (e.status === '承認' ? '#d1fae5' : '#fee2e2');
      var iconColor = isPending ? '#d97706' : (e.status === '承認' ? '#059669' : '#dc2626');
      var iconPath = isPending ? '<circle cx="10" cy="10" r="7"/><path d="M10 7v3h2"/>' : '<path d="M4 10l4 4 8-8"/>';

      h += '<div class="exp-item">';
      h += '<div class="exp-icon" style="background:' + iconBg + ';"><svg width="18" height="18" fill="none" stroke="' + iconColor + '" stroke-width="2" stroke-linecap="round">' + iconPath + '</svg></div>';
      h += '<div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:13px;">' + esc(e.category) + '<span style="font-weight:400;color:#999;"> ・' + formatShortDate(e.expense_date) + '</span></div>';
      h += '<div style="font-size:12px;color:#999;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + esc(e.description || '') + '</div></div>';
      h += '<div style="font-weight:700;font-size:14px;flex-shrink:0;">¥' + (e.amount||0).toLocaleString() + '</div>';
      h += '</div>';
    });
  }

  document.getElementById('pg-expense').innerHTML = h;
  // Set default date
  var dateInput = document.getElementById('expDate');
  if (dateInput && !dateInput.value) dateInput.value = new Date().toISOString().slice(0,10);
}

function submitExpense() {
  var expDate = document.getElementById('expDate').value;
  var category = document.getElementById('expCategory').value;
  var amount = parseInt(document.getElementById('expAmount').value) || 0;
  var desc = document.getElementById('expDesc').value;
  if (!expDate || !amount) { alert('日付と金額を入力してください'); return; }

  supabase.from('sales_expenses').insert({
    member_id: currentMember.id,
    expense_date: expDate,
    category: category,
    amount: amount,
    description: desc,
    status: '申請中'
  }).then(function(res) {
    if (res.error) { alert('申請に失敗: ' + res.error.message); return; }
    alert('申請しました');
    closeModal('expenseModal');
    document.getElementById('expAmount').value = '';
    document.getElementById('expDesc').value = '';
    loadAllData();
  });
}

function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
</script>
</body>
</html>
