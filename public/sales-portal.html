<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>Rei å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Noto+Sans+JP:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f2f2f7;--card:#fff;--sep:rgba(60,60,67,0.06);
  --label:#1d1d1f;--secondary:#3c3c43;--tertiary:#86868b;--quaternary:#aeaeb2;
  --blue:#007aff;--red:#ff3b30;--green:#34c759;--orange:#ff9500;--wine:#8b2252;--wine-bg:rgba(139,34,82,0.06);--wine-light:rgba(139,34,82,0.12);
  --radius:14px;--card-shadow:0 0.5px 0 rgba(0,0,0,0.04),0 1px 3px rgba(0,0,0,0.04);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height:100%;-webkit-text-size-adjust:100%;}
body{font-family:'Inter','Noto Sans JP',-apple-system,BlinkMacSystemFont,'SF Pro Display','Helvetica Neue',sans-serif;background:#000;color:var(--label);line-height:1.47;overscroll-behavior:none;min-height:100%;letter-spacing:-0.022em;font-feature-settings:'cv11' 1;}
button{font-family:inherit;cursor:pointer;-webkit-appearance:none;border:none;background:none;}
input,select,textarea{font-family:inherit;-webkit-appearance:none;border:none;}
a{color:inherit;text-decoration:none;}
::-webkit-scrollbar{display:none;}
::selection{background:rgba(0,122,255,0.15);}

/* ===== LOGIN ===== */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#000;padding:24px;}
.login-box{width:100%;max-width:340px;text-align:center;}
.login-brand{font-size:44px;font-weight:900;color:#fff;letter-spacing:5px;}
.login-sub{font-size:11px;color:#636366;margin:6px 0 44px;letter-spacing:4px;text-transform:uppercase;font-weight:500;}
.login-card{background:#1c1c1e;border-radius:16px;padding:28px 22px;}
.login-err{background:rgba(255,59,48,0.1);color:#ff6961;font-size:13px;padding:11px 14px;border-radius:10px;margin-bottom:14px;display:none;font-weight:500;}
.login-field{width:100%;padding:14px 16px;border-radius:10px;font-size:16px;background:#2c2c2e;color:#fff;outline:none;transition:all .2s;margin-bottom:8px;}
.login-field::placeholder{color:#636366;}
.login-field:focus{background:#3a3a3c;box-shadow:0 0 0 3px rgba(0,122,255,0.35);}
.login-btn{width:100%;padding:15px;border-radius:12px;background:var(--blue);color:#fff;font-size:16px;font-weight:700;margin-top:10px;transition:all .12s;}
.login-btn:active{transform:scale(0.97);opacity:0.88;}

/* ===== APP ===== */
#app{display:none;max-width:430px;margin:0 auto;min-height:100vh;background:var(--bg);position:relative;}

/* Header - iOS style */
.hdr{background:rgba(242,242,247,0.92);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);padding:11px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;border-bottom:0.33px solid rgba(0,0,0,0.12);}
.hdr-logo{font-size:18px;font-weight:800;letter-spacing:2px;color:var(--label);}
.hdr-right{display:flex;align-items:center;gap:10px;}
.hdr-pill{display:flex;align-items:center;gap:6px;padding:4px 12px 4px 4px;border-radius:100px;font-size:12px;font-weight:600;}
.hdr-av{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;}
.hdr-out{color:var(--quaternary);padding:4px;display:flex;}

/* Pages with transition */
.pg{display:none;padding-bottom:100px;}
.pg.active{display:block;animation:pageIn .28s ease;}
@keyframes pageIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

/* Bottom nav - iOS tab bar */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(242,242,247,0.92);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);border-top:0.33px solid rgba(0,0,0,0.12);display:flex;justify-content:space-around;padding:6px 0 env(safe-area-inset-bottom,8px);z-index:100;}
.nb{display:flex;flex-direction:column;align-items:center;gap:1px;padding:4px 10px;color:var(--quaternary);transition:color .15s;}
.nb.on{color:var(--blue);}
.nb svg{width:24px;height:24px;transition:transform .15s;}
.nb:active svg{transform:scale(0.82);}
.nb span{font-size:10px;font-weight:500;}
.nb.on span{font-weight:600;}

/* ===== TOAST NOTIFICATION ===== */
.toast{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:200;background:rgba(30,30,30,0.92);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);color:#fff;padding:10px 18px 10px 14px;border-radius:100px;display:flex;align-items:center;gap:10px;font-size:13px;font-weight:600;box-shadow:0 4px 20px rgba(0,0,0,0.2);max-width:calc(100% - 48px);animation:toastIn .4s cubic-bezier(.32,.72,0,1);cursor:pointer;transition:opacity .2s;}
.toast:active{opacity:0.85;}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.9);}to{opacity:1;transform:translateX(-50%) translateY(0) scale(1);}}
.toast-dot{width:8px;height:8px;border-radius:50%;background:var(--wine);flex-shrink:0;animation:dotPulse 2s ease-in-out infinite;}
@keyframes dotPulse{0%,100%{opacity:1;}50%{opacity:0.4;}}
.toast-hide{opacity:0;pointer-events:none;transform:translateX(-50%) translateY(-10px);}

/* ===== iOS Grouped List Style ===== */
.group{background:var(--card);border-radius:var(--radius);margin:0 16px 16px;overflow:hidden;box-shadow:var(--card-shadow);}
.group-header{font-size:13px;font-weight:600;color:var(--tertiary);text-transform:uppercase;letter-spacing:0.02em;padding:24px 20px 8px;margin:0 16px;}
.g-row{padding:14px 20px;display:flex;align-items:center;gap:14px;border-bottom:0.33px solid var(--sep);transition:background .1s;}
.g-row:last-child{border-bottom:none;}
.g-row:active{background:rgba(0,0,0,0.03);}

/* ===== HOME ===== */
.home-greeting{padding:20px 20px 4px;font-size:14px;color:var(--tertiary);font-weight:500;}
.home-date{padding:0 20px 20px;font-size:28px;font-weight:800;letter-spacing:-0.5px;color:var(--label);}

/* Appo card - wine red, subtle */
.appo-item{padding:16px 20px;display:flex;align-items:center;gap:16px;border-bottom:0.33px solid var(--sep);transition:background .1s;}
.appo-item:last-child{border-bottom:none;}
.appo-item:active{background:rgba(0,0,0,0.03);}
.appo-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.appo-dot.today{background:var(--wine);}
.appo-dot.tomorrow{background:var(--orange);}
.appo-body{flex:1;min-width:0;}
.appo-co{font-size:15px;font-weight:600;color:var(--label);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.appo-meta{font-size:13px;color:var(--tertiary);margin-top:2px;font-weight:400;}
.appo-tag{font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;flex-shrink:0;letter-spacing:0.3px;}
.appo-tag.today{background:var(--wine-bg);color:var(--wine);}
.appo-tag.tomorrow{background:rgba(255,149,0,0.08);color:var(--orange);}

/* Stats - inline row */
.stats-row{display:flex;gap:10px;padding:0 16px;margin-bottom:16px;}
.stat-box{flex:1;background:var(--card);border-radius:var(--radius);padding:18px 14px;text-align:center;box-shadow:var(--card-shadow);}
.stat-num{font-size:28px;font-weight:900;line-height:1;letter-spacing:-1px;}
.stat-lbl{font-size:11px;color:var(--tertiary);margin-top:5px;font-weight:600;}

/* ===== CALENDAR (Apple Calendar style) ===== */
.cal{background:var(--card);border-radius:var(--radius);margin:0 16px 16px;padding:18px 16px;box-shadow:var(--card-shadow);}
.cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding:0 2px;}
.cal-nav-m{font-weight:700;font-size:16px;letter-spacing:-0.2px;}
.cal-arr{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:var(--blue);transition:all .12s;}
.cal-arr:active{background:rgba(0,122,255,0.08);transform:scale(0.88);}
.cal-g{display:grid;grid-template-columns:repeat(7,1fr);text-align:center;}
.cal-wk{font-size:11px;font-weight:600;color:var(--tertiary);padding:4px 0 8px;}
.cal-wk.sun{color:var(--red);}
.cal-wk.sat{color:var(--blue);}
.cal-d{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:50%;font-size:14px;font-weight:400;cursor:pointer;position:relative;transition:all .12s;color:var(--label);margin:1px;}
.cal-d:active{transform:scale(0.85);}
.cal-d.today{background:var(--blue);color:#fff;font-weight:700;}
.cal-d.sel:not(.today){background:rgba(0,122,255,0.08);color:var(--blue);font-weight:600;}
.cal-d.appo{color:var(--wine);font-weight:700;}
.cal-d.appo.today{background:var(--wine);color:#fff;}
.cal-d.appo.sel:not(.today){background:var(--wine-light);color:var(--wine);}
.cal-d.dim{color:var(--quaternary);}
.cal-d-dot{position:absolute;bottom:3px;width:4px;height:4px;border-radius:50%;background:var(--wine);}
.cal-d.today .cal-d-dot{background:rgba(255,255,255,0.6);}
.cal-sch-dots{position:absolute;bottom:2px;display:flex;gap:2px;}

/* Day detail section */
.day-detail{padding:0 16px;}
.day-hdr{display:flex;justify-content:space-between;align-items:center;padding:8px 4px 12px;}
.day-hdr-t{font-size:17px;font-weight:700;letter-spacing:-0.3px;}
.day-add{color:var(--blue);font-size:14px;font-weight:600;padding:6px 14px;border-radius:100px;transition:all .12s;}
.day-add:active{background:rgba(0,122,255,0.08);transform:scale(0.95);}

/* ===== FILTER BAR ===== */
.fbar{padding:10px 16px;display:flex;flex-direction:column;gap:8px;position:sticky;top:46px;z-index:40;background:rgba(242,242,247,0.92);backdrop-filter:saturate(180%) blur(20px);-webkit-backdrop-filter:saturate(180%) blur(20px);}
.fsearch{position:relative;}
.fsearch input{width:100%;padding:10px 10px 10px 36px;border-radius:10px;font-size:15px;background:rgba(118,118,128,0.12);color:var(--label);outline:none;transition:all .2s;}
.fsearch input:focus{background:var(--card);box-shadow:0 0 0 3px rgba(0,122,255,0.25);}
.fsearch input::placeholder{color:var(--tertiary);}
.fsearch svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--tertiary);}
.fpills{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.fp{padding:7px 14px;border-radius:100px;font-size:12px;font-weight:600;white-space:nowrap;background:rgba(118,118,128,0.12);color:var(--tertiary);transition:all .15s;}
.fp:active{transform:scale(0.94);}
.fp.on{background:var(--blue);color:#fff;}
.fsort{padding:7px 12px;border-radius:100px;font-size:12px;font-weight:600;background:rgba(118,118,128,0.12);color:var(--tertiary);display:flex;align-items:center;gap:4px;white-space:nowrap;transition:all .15s;}
.fsort.on{background:rgba(0,122,255,0.1);color:var(--blue);}

/* ===== VISIT CARD ===== */
.vlist{padding:0 16px;display:flex;flex-direction:column;gap:10px;}
.vc{background:var(--card);border-radius:var(--radius);padding:18px 20px;box-shadow:var(--card-shadow);transition:transform .15s;}
.vc:active{transform:scale(0.985);}
.vc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;}
.vc-name{font-size:16px;font-weight:700;flex:1;margin-right:8px;letter-spacing:-0.2px;}
.vc-rows{display:flex;flex-direction:column;gap:7px;margin-bottom:10px;}
.vc-r{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--secondary);}
.vc-r svg{width:15px;height:15px;flex-shrink:0;color:var(--quaternary);}
.vc-r a{color:var(--blue);font-weight:600;}
.vc-memo{font-size:13px;color:var(--tertiary);line-height:1.6;background:var(--bg);padding:11px 14px;border-radius:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;cursor:pointer;transition:background .12s;}
.vc-memo:active{background:rgba(0,0,0,0.04);}
.vc-foot{display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:13px;border-top:0.33px solid var(--sep);}
.vc-asgn{display:flex;align-items:center;gap:10px;}
.vc-asgn-av{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;}
.vc-asgn-nm{font-size:13px;font-weight:600;}
.vc-asgn-btn{padding:6px 14px;border-radius:100px;border:1.5px dashed var(--quaternary);font-size:11px;font-weight:700;color:var(--tertiary);transition:all .12s;}
.vc-asgn-btn:active{background:rgba(0,122,255,0.06);border-color:var(--blue);color:var(--blue);transform:scale(0.95);}
.vc-det{display:none;margin-top:14px;padding-top:14px;border-top:0.33px solid var(--sep);}
.vc-det.open{display:block;animation:fadeUp .2s ease;}
@keyframes fadeUp{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
.vc-det-r{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px;}
.vc-det-memo{font-size:14px;color:var(--secondary);line-height:1.8;background:var(--bg);padding:16px;border-radius:12px;margin-top:8px;white-space:pre-wrap;}

/* ===== SCHEDULE ===== */
.sch-item{background:var(--card);border-radius:12px;padding:14px 18px;margin:0 16px 6px;display:flex;align-items:center;gap:14px;box-shadow:var(--card-shadow);transition:transform .12s;}
.sch-item:active{transform:scale(0.98);}

/* ===== EXPENSE ===== */
.exp-row{background:var(--card);border-radius:12px;padding:14px 18px;margin:0 16px 6px;display:flex;align-items:center;gap:14px;box-shadow:var(--card-shadow);transition:transform .12s;}
.exp-row:active{transform:scale(0.98);}
.exp-ic{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* ===== FORMS ===== */
.fl{font-size:13px;color:var(--tertiary);margin-bottom:5px;font-weight:600;display:block;}
.fi{width:100%;padding:13px 16px;border-radius:10px;font-size:15px;background:rgba(118,118,128,0.12);outline:none;box-sizing:border-box;transition:all .2s;color:var(--label);}
.fi:focus{background:var(--card);box-shadow:0 0 0 3px rgba(0,122,255,0.25);}
.ft{width:100%;padding:13px 16px;border-radius:10px;font-size:14px;resize:none;height:88px;font-family:inherit;background:rgba(118,118,128,0.12);box-sizing:border-box;outline:none;transition:all .2s;color:var(--label);}
.ft:focus{background:var(--card);box-shadow:0 0 0 3px rgba(0,122,255,0.25);}
.fg{margin-bottom:14px;}
.btn-p{width:100%;padding:15px;border-radius:12px;background:var(--blue);color:#fff;font-size:16px;font-weight:700;transition:all .12s;}
.btn-p:active{transform:scale(0.97);opacity:0.88;}
.btn-s{display:flex;align-items:center;gap:5px;padding:7px 16px;border-radius:100px;background:var(--blue);color:#fff;font-size:13px;font-weight:600;transition:all .12s;}
.btn-s:active{transform:scale(0.93);opacity:0.88;}
.rbtn{padding:11px 0;border-radius:10px;background:rgba(118,118,128,0.12);color:var(--tertiary);font-size:13px;font-weight:600;transition:all .15s;}
.rbtn:active{transform:scale(0.95);}
.rbtn.on{background:var(--blue);color:#fff;box-shadow:0 2px 8px rgba(0,122,255,0.25);}

/* ===== SECTION TITLES ===== */
.st{font-size:22px;font-weight:800;letter-spacing:-0.4px;padding:24px 20px 14px;color:var(--label);}

/* ===== MODAL ===== */
.mo{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.25);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);}
.mo.show{display:flex;}
.ms{background:var(--card);border-radius:16px 16px 0 0;width:100%;max-width:430px;max-height:85vh;overflow-y:auto;padding:24px 22px env(safe-area-inset-bottom,22px);animation:shUp .3s cubic-bezier(.32,.72,0,1);}
@keyframes shUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.ms-h{width:36px;height:5px;background:#c7c7cc;border-radius:3px;margin:0 auto 18px;}
.ms-t{font-size:18px;font-weight:800;margin-bottom:18px;letter-spacing:-0.2px;}

/* Toggle */
.sw{position:relative;display:inline-block;width:51px;height:31px;}
.sw input{opacity:0;width:0;height:0;}
.sw-s{position:absolute;cursor:pointer;inset:0;background:#e9e9eb;border-radius:31px;transition:.3s cubic-bezier(.4,0,.2,1);}
.sw-s:before{position:absolute;content:"";height:27px;width:27px;left:2px;bottom:2px;background:#fff;border-radius:50%;transition:.3s cubic-bezier(.4,0,.2,1);box-shadow:0 1px 3px rgba(0,0,0,0.12);}
.sw input:checked+.sw-s{background:var(--green);}
.sw input:checked+.sw-s:before{transform:translateX(20px);}

/* Member colors */
.mc0{background:rgba(0,122,255,0.1);color:#007aff;}.mc0 .hdr-av{background:#007aff;}
.mc1{background:rgba(52,199,89,0.1);color:#34c759;}.mc1 .hdr-av{background:#34c759;}
.mc2{background:rgba(255,149,0,0.1);color:#ff9500;}.mc2 .hdr-av{background:#ff9500;}
.mc3{background:rgba(255,55,95,0.1);color:#ff375f;}.mc3 .hdr-av{background:#ff375f;}
.mc4{background:rgba(175,82,222,0.1);color:#af52de;}.mc4 .hdr-av{background:#af52de;}
.dot0{background:#007aff;}.dot1{background:#34c759;}.dot2{background:#ff9500;}.dot3{background:#ff375f;}.dot4{background:#af52de;}

.badge{font-size:11px;font-weight:700;padding:4px 10px;border-radius:100px;}
.empty{text-align:center;padding:40px 20px;color:var(--tertiary);font-size:15px;font-weight:500;background:var(--card);border-radius:var(--radius);margin:0 16px;box-shadow:var(--card-shadow);}
svg{vertical-align:middle;}

/* ===== INLINE SCHEDULE INPUT ===== */
.inline-add{background:var(--card);border-radius:12px;margin:0 0 12px;padding:14px 16px;box-shadow:var(--card-shadow);animation:fadeUp .2s ease;display:flex;gap:10px;align-items:flex-end;}
.inline-add .ia-input{flex:1;padding:10px 14px;border-radius:10px;font-size:14px;background:rgba(118,118,128,0.12);outline:none;border:none;color:var(--label);transition:all .2s;font-family:inherit;}
.inline-add .ia-input:focus{background:var(--card);box-shadow:0 0 0 2px rgba(0,122,255,0.3);}
.inline-add .ia-input::placeholder{color:var(--quaternary);}
.inline-add .ia-send{width:36px;height:36px;border-radius:50%;background:var(--blue);color:#fff;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .12s;}
.inline-add .ia-send:active{transform:scale(0.88);opacity:0.85;}
.inline-add .ia-pub{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--tertiary);font-weight:500;white-space:nowrap;cursor:pointer;}
.inline-add .ia-pub input{width:14px;height:14px;accent-color:var(--blue);}

/* ===== SCHEDULE PROSPECT LIST ===== */
.sp-card{background:var(--card);border-radius:12px;margin:0 16px 6px;padding:14px 18px;box-shadow:var(--card-shadow);transition:transform .12s;}
.sp-card:active{transform:scale(0.98);}
.sp-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.sp-name{font-size:15px;font-weight:700;flex:1;margin-right:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sp-rows{display:flex;flex-direction:column;gap:5px;}
.sp-r{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--secondary);}
.sp-r svg{width:13px;height:13px;flex-shrink:0;color:var(--quaternary);}
.sp-r a{color:var(--blue);font-weight:600;}
.sp-memo{font-size:12px;color:var(--tertiary);line-height:1.5;margin-top:4px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
</style>
</head>
<body>
<div class="login-wrap" id="loginScreen"><div class="login-box"><div class="login-brand">Rei</div><div class="login-sub">Sales Portal</div><div class="login-card"><div class="login-err" id="loginError">åå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div><input class="login-field" type="text" id="loginName" placeholder="åå‰"><input class="login-field" type="password" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><button class="login-btn" onclick="doLogin()">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button></div></div></div>
<div id="app">
<header class="hdr"><div class="hdr-logo">Rei</div><div class="hdr-right"><div class="hdr-pill" id="hdrPill"><div class="hdr-av" id="hdrAv"></div><span id="hdrNm"></span></div><button class="hdr-out" onclick="doLogout()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M7 2H3.5A1.5 1.5 0 0 0 2 3.5v11A1.5 1.5 0 0 0 3.5 16H7M11 12l3-3-3-3M14 9H6"/></svg></button></div></header>
<!-- Toast -->
<div class="toast toast-hide" id="toast"><div class="toast-dot"></div><span id="toastText"></span></div>
<div class="pg active" id="pg-home"></div>
<div class="pg" id="pg-visits"></div>
<div class="pg" id="pg-schedule"></div>
<div class="pg" id="pg-review"></div>
<div class="pg" id="pg-expense"></div>
<nav class="bnav">
<button class="nb on" data-t="home"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L10 3l7 6.5V17a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/><path d="M8 17V12h4v5"/></svg><span>ãƒ›ãƒ¼ãƒ </span></button>
<button class="nb" data-t="visits"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="16" height="14" rx="2"/><path d="M8 7v6M12 7v6M2 7h16"/></svg><span>è¨ªå•å…ˆ</span></button>
<button class="nb" data-t="schedule"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="16" height="14" rx="2"/><path d="M2 8h16M6 2v4M14 2v4"/></svg><span>äºˆå®š</span></button>
<button class="nb" data-t="review"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg><span>æŒ¯ã‚Šè¿”ã‚Š</span></button>
<button class="nb" data-t="expense"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span>çµŒè²»</span></button>
</nav>
</div>
<div class="mo" id="schMo"><div class="ms"><div class="ms-h"></div><div class="ms-t">äºˆå®šã‚’è¿½åŠ </div><div class="fg"><label class="fl">æ—¥ä»˜</label><input type="date" class="fi" id="schDate"></div><div class="fg"><label class="fl">å†…å®¹</label><input type="text" class="fi" id="schMemo" placeholder="ä¾‹ï¼šç´«è‹‘ã•ã¾ å•†è«‡"></div><div class="fg" style="display:flex;justify-content:space-between;align-items:center;"><label class="fl" style="margin:0;">å…¨å“¡ã«å…¬é–‹</label><label class="sw"><input type="checkbox" id="schPub" checked><span class="sw-s"></span></label></div><button class="btn-p" onclick="subSch()">è¿½åŠ ã™ã‚‹</button><button onclick="clMo('schMo')" style="width:100%;padding:13px;color:var(--tertiary);font-size:14px;font-weight:600;margin-top:6px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
<div class="mo" id="asMo"><div class="ms"><div class="ms-h"></div><div class="ms-t">æ‹…å½“è€…ã‚’å¤‰æ›´</div><div id="asList"></div><button onclick="clMo('asMo')" style="width:100%;padding:13px;color:var(--tertiary);font-size:14px;font-weight:600;margin-top:6px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
<div class="mo" id="exMo"><div class="ms"><div class="ms-h"></div><div class="ms-t">çµŒè²»ã‚’ç”³è«‹ã™ã‚‹</div><div class="fg"><label class="fl">æ—¥ä»˜</label><input type="date" class="fi" id="exDate"></div><div class="fg"><label class="fl">ã‚«ãƒ†ã‚´ãƒª</label><select class="fi" id="exCat"><option value="äº¤é€šè²»">äº¤é€šè²»</option><option value="å®¿æ³Šè²»">å®¿æ³Šè²»</option><option value="é£²é£Ÿè²»">é£²é£Ÿè²»</option><option value="å‚™å“">å‚™å“</option><option value="ãã®ä»–">ãã®ä»–</option></select></div><div class="fg"><label class="fl">é‡‘é¡</label><input type="number" class="fi" id="exAmt" placeholder="Â¥"></div><div class="fg"><label class="fl">å†…å®¹</label><input type="text" class="fi" id="exDesc" placeholder="ä¾‹ï¼šç¦äº•â†’é‡‘æ²¢ å¾€å¾©"></div><button class="btn-p" onclick="subEx()">ç”³è«‹ã™ã‚‹</button><button onclick="clMo('exMo')" style="width:100%;padding:13px;color:var(--tertiary);font-size:14px;font-weight:600;margin-top:6px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>

<script>
var sb,me=null,M=[],P=[],S=[],E=[],EV=[];
var SU='https://osyysvompcfuadlnuojs.supabase.co';
var SK='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';
var MC=['#007aff','#34c759','#ff9500','#ff375f','#af52de'];
var SC={'ã‚¢ãƒæ¸ˆ':{b:'rgba(175,82,222,0.08)',c:'#af52de'},'è¨ªå•æ¸ˆã¿':{b:'rgba(0,122,255,0.08)',c:'#007aff'},'å•†è«‡ä¸­':{b:'rgba(255,149,0,0.08)',c:'#ff9500'},'è¦‹è¾¼ã¿':{b:'rgba(255,149,0,0.08)',c:'#ff9500'},'æˆç´„':{b:'rgba(52,199,89,0.08)',c:'#34c759'},'è¦‹é€ã‚Š':{b:'rgba(255,59,48,0.08)',c:'#ff3b30'},'æœªè¨ªå•':{b:'rgba(142,142,147,0.08)',c:'#8e8e93'}};
var RG={'åŒ—æµ·é“':['åŒ—æµ·é“'],'æ±åŒ—':['é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ'],'é–¢æ±':['æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ'],'åŒ—é™¸':['æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ'],'æ±æµ·':['å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ'],'é–¢è¥¿':['æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ'],'ä¸­å›½':['é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ'],'å››å›½':['å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ'],'ä¹å·':['ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ']};
var tab='home',cD=new Date(),sD=new Date().toISOString().split('T')[0];
var vQ='',vS='',vR='',vM='',vSrt=false,schSc='all',rR='',aPid=null;
function mi(id){return M.findIndex(function(m){return m.id===id});}
function mcol(id){return MC[mi(id)%MC.length]||MC[0];}
function mci(id){return'mc'+mi(id)%MC.length;}
function mN(id){var m=M.find(function(x){return x.id===id});return m?m.name:'';}
function e(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';}
function p2(n){return String(n).padStart(2,'0');}
function dS(y,m,d){return y+'-'+p2(m)+'-'+p2(d);}
function fD(s){if(!s)return'-';var x=s.split('-');return+x[1]+'/'+parseInt(x[2]);}
function gDw(s){return['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(s).getDay()];}
function gR(a){for(var r in RG){if(RG[r].indexOf(a)!==-1)return r;}return'';}
function pMD(t){if(!t)return null;var iso=/^(\d{4})-(\d{1,2})-(\d{1,2})/.exec(t);if(iso)return iso[1]+'-'+p2(+iso[2])+'-'+p2(+iso[3]);var jp=/(\d{1,2})\s*[æœˆ\/]\s*(\d{1,2})\s*æ—¥?/.exec(t);if(jp){var m=+jp[1],d=+jp[2];if(m>=1&&m<=12&&d>=1&&d<=31){var y=new Date().getFullYear(),n=new Date();if(m<n.getMonth()+1||(m===n.getMonth()+1&&d<n.getDate()))y++;return y+'-'+p2(m)+'-'+p2(d);}}return null;}
function bAM(){var map={};P.forEach(function(p){var d=pMD(p.meeting_date);if(d){if(!map[d])map[d]=[];map[d].push({co:p.company_name,time:p.meeting_time||'',to:p.assigned_to});}});return map;}

window.onload=function(){
  sb=window.supabase.createClient(SU,SK);
  var sv=localStorage.getItem('spMid');if(sv){lM(function(){lAs(sv);});}
  document.getElementById('loginName').onkeypress=function(ev){if(ev.key==='Enter')document.getElementById('loginPass').focus();};
  document.getElementById('loginPass').onkeypress=function(ev){if(ev.key==='Enter')doLogin();};
  document.querySelectorAll('.nb').forEach(function(b){b.onclick=function(){swT(b.dataset.t);};});
};
function lM(cb){sb.from('sales_members').select('*').then(function(r){M=r.data||[];if(cb)cb();});}
function doLogin(){var n=document.getElementById('loginName').value.trim(),pw=document.getElementById('loginPass').value;if(!n||!pw)return;lM(function(){alert('ãƒ¡ãƒ³ãƒãƒ¼æ•°:'+M.length+'\n'+M.map(function(m){return m.name+'/'+m.password+'/'+m.password_hash;}).join('\n'));var f=M.find(function(m){return(m.name===n||m.name.indexOf(n)!==-1||n.indexOf(m.name)!==-1)&&(m.password===pw||m.password_hash===pw);});if(f){localStorage.setItem('spMid',f.id);lAs(f.id);}else{document.getElementById('loginError').style.display='block';}});}
function lAs(id){me=M.find(function(m){return m.id===id;});if(!me){localStorage.removeItem('spMid');return;}document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='block';document.getElementById('hdrPill').className='hdr-pill '+mci(me.id);document.getElementById('hdrAv').textContent=me.name.charAt(0);document.getElementById('hdrAv').style.background=mcol(me.id);document.getElementById('hdrNm').textContent=me.name;lAll();}
function doLogout(){localStorage.removeItem('spMid');me=null;document.getElementById('app').style.display='none';document.getElementById('loginScreen').style.display='flex';document.getElementById('loginPass').value='';document.getElementById('loginName').value='';document.getElementById('loginError').style.display='none';}
function lAll(){
  sb.from('sales_prospects').select('*').order('created_at',{ascending:false}).then(function(r){P=r.data||[];rAll();});
  sb.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r){S=r.data||[];rAll();});
  sb.from('sales_expenses').select('*').order('created_at',{ascending:false}).then(function(r){E=r.data||[];rExp();});
  sb.from('sales_evaluations').select('*').eq('is_self_eval',true).order('eval_date',{ascending:false}).limit(50).then(function(r){EV=r.data||[];rRev();});
}
function rAll(){rHome();rVis();rSch();}
function swT(t){tab=t;document.querySelectorAll('.nb').forEach(function(b){b.classList.toggle('on',b.dataset.t===t);});document.querySelectorAll('.pg').forEach(function(p){p.classList.remove('active');});document.getElementById('pg-'+t).classList.add('active');}

// Toast
function showToast(txt){var t=document.getElementById('toast');document.getElementById('toastText').textContent=txt;t.classList.remove('toast-hide');setTimeout(function(){t.classList.add('toast-hide');},5000);}

// ===== HOME =====
function rHome(){
  if(!me)return;var id=me.id;
  var myP=P.filter(function(p){return p.assigned_to===id;});
  var cl=myP.filter(function(p){return p.status==='æˆç´„';}).length;
  var ng=myP.filter(function(p){return p.status==='å•†è«‡ä¸­';}).length;
  var ap=myP.filter(function(p){return p.status==='è¨ªå•æ¸ˆã¿'||p.status==='ã‚¢ãƒæ¸ˆ';}).length;
  var now=new Date(),dn=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  var td=now.toISOString().split('T')[0],tm=new Date(now.getTime()+864e5).toISOString().split('T')[0];
  var am=bAM(),h='';

  // Toast for today's appointments
  var todayA=am[td]||[];
  if(todayA.length>0){setTimeout(function(){showToast('ğŸ“ ä»Šæ—¥ã®ã‚¢ãƒ '+todayA.length+'ä»¶: '+todayA.map(function(a){return a.co;}).join(', '));},300);}

  // Greeting (smaller)
  h+='<div class="home-greeting">ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€'+e(me.name)+'ã•ã‚“</div>';
  h+='<div class="home-date">'+(now.getMonth()+1)+'æœˆ'+now.getDate()+'æ—¥ '+dn[now.getDay()]+'æ›œæ—¥</div>';

  // Today/Tomorrow appointments (Reminders-style grouped list)
  var hasAppo=todayA.length>0||(am[tm]||[]).length>0;
  if(hasAppo){
    h+='<div class="group">';
    todayA.forEach(function(a){h+='<div class="appo-item"><div class="appo-dot today"></div><div class="appo-body"><div class="appo-co">'+e(a.co)+'</div><div class="appo-meta">'+(a.time||'æ™‚é–“æœªå®š')+(a.to?' ãƒ» '+e(mN(a.to)):'')+'</div></div><div class="appo-tag today">ä»Šæ—¥</div></div>';});
    (am[tm]||[]).forEach(function(a){h+='<div class="appo-item"><div class="appo-dot tomorrow"></div><div class="appo-body"><div class="appo-co">'+e(a.co)+'</div><div class="appo-meta">'+(a.time||'æ™‚é–“æœªå®š')+(a.to?' ãƒ» '+e(mN(a.to)):'')+'</div></div><div class="appo-tag tomorrow">æ˜æ—¥</div></div>';});
    h+='</div>';
  }

  // Stats
  h+='<div class="stats-row"><div class="stat-box"><div class="stat-num" style="color:#34c759;">'+cl+'</div><div class="stat-lbl">æˆç´„</div></div><div class="stat-box"><div class="stat-num" style="color:#ff9500;">'+ng+'</div><div class="stat-lbl">å•†è«‡ä¸­</div></div><div class="stat-box"><div class="stat-num" style="color:#007aff;">'+ap+'</div><div class="stat-lbl">ã‚¢ãƒæ¸ˆ</div></div></div>';

  // Calendar
  h+=bCal(cD,sD,'home',am);

  // Selected date detail
  var sd=sD.split('-');
  h+='<div class="day-detail"><div class="day-hdr"><div class="day-hdr-t">'+parseInt(sd[1])+'æœˆ'+parseInt(sd[2])+'æ—¥</div><button class="day-add" onclick="toggleInline()">ï¼‹ è¿½åŠ </button></div>';

  // Inline input
  h+='<div id="inlineAdd" style="display:none;"><div class="inline-add"><input class="ia-input" type="text" id="iaInput" placeholder="äºˆå®šã‚’å…¥åŠ›..." onkeypress="if(event.key===\'Enter\')subInline()"><label class="ia-pub"><input type="checkbox" id="iaPub" checked>å…¬é–‹</label><button class="ia-send" onclick="subInline()"><svg width="16" height="16" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"><path d="M5 12l7-4-7-4v3l4 1-4 1z"/></svg></button></div></div>';

  var sa=am[sD]||[],ss=S.filter(function(s){return s.scheduled_date===sD&&(s.member_id===id||s.is_public!==false);});
  if(sa.length||ss.length){
    h+='<div class="group">';
    sa.forEach(function(a){h+='<div class="g-row"><div style="width:10px;height:10px;border-radius:50%;background:var(--wine);flex-shrink:0;"></div><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:15px;">'+e(a.co)+'</div><div style="font-size:13px;color:var(--tertiary);margin-top:1px;">'+(a.time||'æ™‚é–“æœªå®š')+'</div></div></div>';});
    ss.forEach(function(s){var pr=P.find(function(p){return p.id===s.prospect_id;});var nm=pr?pr.company_name:(s.memo||'äºˆå®š');h+='<div class="g-row"><div style="width:10px;height:10px;border-radius:50%;background:'+mcol(s.member_id)+';flex-shrink:0;"></div><div style="flex:1;"><div style="font-weight:600;font-size:15px;">'+e(nm)+'</div><div style="font-size:13px;color:var(--tertiary);margin-top:1px;">'+e(mN(s.member_id))+'</div></div>'+(s.is_public===false?'<span style="font-size:10px;color:var(--quaternary);">ğŸ”’</span>':'')+'</div>';});
    h+='</div>';
  }else{h+='<div class="empty" style="margin:0 0 16px;">äºˆå®šãªã—</div>';}
  h+='</div>';

  // Unparsed
  var up=P.filter(function(p){return p.meeting_date&&!pMD(p.meeting_date);});
  if(up.length){h+='<div class="group-header">æ—¥ä»˜æœªç¢ºå®šã®ã‚¢ãƒ</div><div class="group">';up.forEach(function(p){h+='<div class="g-row"><div style="flex:1;"><div style="font-weight:600;font-size:14px;">'+e(p.company_name)+'</div></div><div style="font-size:13px;color:var(--orange);font-weight:600;">'+e(p.meeting_date)+'</div></div>';});h+='</div>';}

  document.getElementById('pg-home').innerHTML=h;
}

function bCal(dt,sel,pfx,am){
  var y=dt.getFullYear(),m=dt.getMonth()+1,td=new Date().toISOString().split('T')[0];am=am||bAM();
  var h='<div class="cal"><div class="cal-nav"><button class="cal-arr" onclick="chM(\''+pfx+'\',-1)"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 3l-4 4 4 4"/></svg></button><div class="cal-nav-m">'+y+'å¹´'+m+'æœˆ</div><button class="cal-arr" onclick="chM(\''+pfx+'\',1)"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 3l4 4-4 4"/></svg></button></div><div class="cal-g">';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(function(d,i){h+='<div class="cal-wk'+(i===0?' sun':'')+(i===6?' sat':'')+'">'+d+'</div>';});
  var fw=new Date(y,m-1,1).getDay(),dm=new Date(y,m,0).getDate();
  for(var i=0;i<fw;i++)h+='<div></div>';
  for(var d=1;d<=dm;d++){var s=dS(y,m,d),it=s===td,is=s===sel,ha=!!am[s];
    var c='cal-d';if(ha)c+=' appo';if(it)c+=' today';if(is&&!it)c+=' sel';
    h+='<div class="'+c+'" onclick="slD(\''+pfx+'\',\''+s+'\')">'+d;
    if(ha&&!it)h+='<div class="cal-d-dot"></div>';
    var dSch=S.filter(function(x){return x.scheduled_date===s;});var uq=[];dSch.forEach(function(x){if(uq.indexOf(x.member_id)===-1)uq.push(x.member_id);});
    if(uq.length&&!ha){h+='<div class="cal-sch-dots">';uq.slice(0,3).forEach(function(mid){h+='<div style="width:4px;height:4px;border-radius:50%;background:'+(it?'rgba(255,255,255,0.5)':mcol(mid))+';"></div>';});h+='</div>';}
    h+='</div>';}
  h+='</div></div>';return h;
}
function chM(p,d){cD.setMonth(cD.getMonth()+d);p==='home'?rHome():rSch();}
function slD(p,d){sD=d;p==='home'?rHome():rSch();}
function toggleInline(){var el=document.getElementById('inlineAdd');if(!el)return;if(el.style.display==='none'){el.style.display='block';setTimeout(function(){document.getElementById('iaInput').focus();},100);}else{el.style.display='none';}}
function subInline(){var txt=document.getElementById('iaInput').value.trim();if(!txt){alert('å†…å®¹ã‚’å…¥åŠ›');return;}var pub=document.getElementById('iaPub').checked;sb.from('sales_schedules').insert({member_id:me.id,scheduled_date:sD,memo:txt,is_public:pub}).then(function(r){if(r.error){alert(r.error.message);return;}sb.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r2){S=r2.data||[];rAll();});});}
function oAS(d){document.getElementById('schDate').value=d||new Date().toISOString().slice(0,10);document.getElementById('schMemo').value='';document.getElementById('schPub').checked=true;opMo('schMo');}
function subSch(){var d=document.getElementById('schDate').value,m=document.getElementById('schMemo').value,p=document.getElementById('schPub').checked;if(!d||!m){alert('æ—¥ä»˜ã¨å†…å®¹ã‚’å…¥åŠ›');return;}sb.from('sales_schedules').insert({member_id:me.id,scheduled_date:d,memo:m,is_public:p}).then(function(r){if(r.error){alert(r.error.message);return;}clMo('schMo');sb.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r2){S=r2.data||[];rAll();});});}

// ===== VISITS =====
function rVis(){
  if(!me)return;var h='<div class="fbar"><div class="fsearch"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7" cy="7" r="4.5"/><path d="M11 11l3.5 3.5"/></svg><input type="text" placeholder="ä¼šç¤¾åã§æ¤œç´¢" value="'+e(vQ)+'" oninput="vQ=this.value;rVis()"></div>';
  h+='<div class="fpills">';['','ã‚¢ãƒæ¸ˆ','å•†è«‡ä¸­','æˆç´„','è¦‹è¾¼ã¿','æœªè¨ªå•'].forEach(function(s){h+='<button class="fp '+(vS===s?'on':'')+'" onclick="vS=vS===\''+s+'\'?\'\':\''+s+'\';rVis()">'+(s||'ã™ã¹ã¦')+'</button>';});
  h+='</div><div class="fpills"><button class="fp '+(vR?'on':'')+'" onclick="cyR()">'+(vR||'ã‚¨ãƒªã‚¢')+'</button>';
  h+='<button class="fp '+(vM?'on':'')+'" onclick="cyM()">'+e(vM?mN(vM):'æ‹…å½“è€…')+'</button>';
  h+='<button class="fsort '+(vSrt?'on':'')+'" onclick="vSrt=!vSrt;rVis()">å•†è«‡æ—¥é †</button></div></div>';
  var fl=P.filter(function(p){if(vQ&&p.company_name.indexOf(vQ)===-1)return false;if(vS&&p.status!==vS)return false;if(vR&&gR(p.area)!==vR)return false;if(vM&&p.assigned_to!==vM)return false;return true;});
  if(vSrt)fl.sort(function(a,b){return(pMD(a.meeting_date)||'9999').localeCompare(pMD(b.meeting_date)||'9999');});
  h+='<div style="padding:2px 20px 10px;font-size:13px;color:var(--tertiary);font-weight:600;">'+fl.length+'ä»¶</div><div class="vlist">';
  if(!fl.length)h+='<div class="empty" style="margin:0;">è©²å½“ãªã—</div>';
  else fl.forEach(function(p){var c=mcol(p.assigned_to),n=mN(p.assigned_to),sc=SC[p.status]||SC['æœªè¨ªå•'],memo=p.hearing_content||p.notes||'';
    h+='<div class="vc"><div class="vc-top"><div class="vc-name">'+e(p.company_name)+'</div><span class="badge" style="background:'+sc.b+';color:'+sc.c+';">'+e(p.status||'æœªè¨ªå•')+'</span></div><div class="vc-rows">';
    if(p.meeting_date)h+='<div class="vc-r"><svg fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="12" height="10" rx="1.5"/><path d="M2 7h12M5 2v3M11 2v3"/></svg><span style="color:var(--wine);font-weight:700;">'+e(p.meeting_date)+(p.meeting_time?' '+e(p.meeting_time):'')+'</span></div>';
    if(p.phone)h+='<div class="vc-r"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M3 1.5h3l1.5 4-2 1.5a11 11 0 0 0 5 5l1.5-2 4 1.5v3a1 1 0 0 1-1 1A14 14 0 0 1 2.5 3a1 1 0 0 1 1-1.5"/></svg><a href="tel:'+e(p.phone)+'">'+e(p.phone)+'</a></div>';
    if(p.address)h+='<div class="vc-r"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M8 1C5 1 2.5 3.5 2.5 6.5S8 15 8 15s5.5-5 5.5-8.5S11 1 8 1z"/><circle cx="8" cy="6.5" r="1.5"/></svg><a href="https://www.google.com/maps/search/'+encodeURIComponent(p.address)+'" target="_blank" style="font-size:12px;">'+e(p.address)+' â†—</a></div>';
    if(p.contact_person)h+='<div class="vc-r"><svg fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="5" r="3"/><path d="M2 15c0-3 3-5 6-5s6 2 6 5"/></svg>'+e(p.contact_person)+'</div>';
    h+='</div>';if(memo)h+='<div class="vc-memo" onclick="tD(\''+p.id+'\')">'+e(memo)+'</div>';
    h+='<div class="vc-foot">';if(p.assigned_to&&n){h+='<div class="vc-asgn"><div class="vc-asgn-av" style="background:'+c+';">'+e(n.charAt(0))+'</div><div class="vc-asgn-nm">'+e(n)+'</div></div><button class="vc-asgn-btn" onclick="oAs(\''+p.id+'\')">å¤‰æ›´</button>';}
    else{h+='<div style="font-size:13px;color:var(--quaternary);">æ‹…å½“æœªå®š</div><button class="vc-asgn-btn" onclick="sA(\''+p.id+'\')" style="border-style:solid;border-color:var(--blue);color:var(--blue);">ğŸ™‹ è¡Œãã¾ã™</button>';}
    h+='</div><div class="vc-det" id="vd-'+p.id+'">';
    if(p.website_url)h+='<div class="vc-det-r"><span style="color:var(--tertiary);">HP</span><a href="'+e(p.website_url)+'" target="_blank" style="color:var(--blue);font-size:13px;">'+e(p.website_url)+'</a></div>';
    if(p.email)h+='<div class="vc-det-r"><span style="color:var(--tertiary);">ãƒ¡ãƒ¼ãƒ«</span><a href="mailto:'+e(p.email)+'" style="color:var(--blue);font-size:13px;">'+e(p.email)+'</a></div>';
    if(p.area)h+='<div class="vc-det-r"><span style="color:var(--tertiary);">ã‚¨ãƒªã‚¢</span><span>'+e(gR(p.area))+' / '+e(p.area)+'</span></div>';
    if(memo)h+='<div class="vc-det-memo">'+e(memo)+'</div>';h+='</div></div>';});
  h+='</div>';document.getElementById('pg-visits').innerHTML=h;
}
function cyR(){var k=Object.keys(RG),i=k.indexOf(vR);vR=i>=k.length-1?'':k[i+1];rVis();}
function cyM(){var ids=M.map(function(m){return m.id;}),i=ids.indexOf(vM);vM=i>=ids.length-1?'':ids[i+1];rVis();}
function tD(id){var x=document.getElementById('vd-'+id);if(x)x.classList.toggle('open');}
function sA(pid){sb.from('sales_prospects').update({assigned_to:me.id}).eq('id',pid).then(function(r){if(r.error){alert(r.error.message);return;}var p=P.find(function(x){return x.id===pid;});if(p)p.assigned_to=me.id;rVis();rHome();});}
function oAs(pid){aPid=pid;var h='';M.forEach(function(m){h+='<div class="g-row" onclick="doAs(\''+m.id+'\')"><div style="width:36px;height:36px;border-radius:50%;background:'+mcol(m.id)+';display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:14px;">'+e(m.name.charAt(0))+'</div><div style="font-weight:600;font-size:15px;">'+e(m.name)+'</div></div>';});
  h+='<div class="g-row" onclick="doAs(null)"><div style="width:36px;height:36px;border-radius:50%;background:var(--bg);display:flex;align-items:center;justify-content:center;color:var(--tertiary);font-size:15px;">âœ•</div><div style="font-weight:600;font-size:15px;color:var(--tertiary);">æ‹…å½“ã‚’å¤–ã™</div></div>';
  document.getElementById('asList').innerHTML=h;opMo('asMo');
}
function doAs(mid){sb.from('sales_prospects').update({assigned_to:mid}).eq('id',aPid).then(function(r){if(r.error){alert(r.error.message);return;}var p=P.find(function(x){return x.id===aPid;});if(p)p.assigned_to=mid;clMo('asMo');rVis();rHome();});}

// ===== SCHEDULE =====
function rSch(){
  if(!me)return;var td=new Date().toISOString().split('T')[0],am=bAM(),h='';
  h+='<div class="st" style="display:flex;justify-content:space-between;align-items:center;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«<div style="display:inline-flex;gap:2px;background:rgba(118,118,128,0.12);border-radius:9px;padding:2px;"><button style="padding:6px 16px;border-radius:7px;border:none;font-size:13px;font-weight:600;background:'+(schSc==='mine'?'#fff':'transparent')+';color:'+(schSc==='mine'?'var(--label)':'var(--tertiary)')+';box-shadow:'+(schSc==='mine'?'0 1px 4px rgba(0,0,0,0.06)':'none')+';transition:all .2s;" onclick="schSc=\'mine\';rSch()">è‡ªåˆ†</button><button style="padding:6px 16px;border-radius:7px;border:none;font-size:13px;font-weight:600;background:'+(schSc==='all'?'#fff':'transparent')+';color:'+(schSc==='all'?'var(--label)':'var(--tertiary)')+';box-shadow:'+(schSc==='all'?'0 1px 4px rgba(0,0,0,0.06)':'none')+';transition:all .2s;" onclick="schSc=\'all\';rSch()">å…¨å“¡</button></div></div>';
  if(schSc==='all'){h+='<div style="display:flex;gap:12px;padding:0 20px 14px;flex-wrap:wrap;">';M.forEach(function(m){h+='<div style="display:flex;align-items:center;gap:6px;font-size:12px;color:var(--secondary);font-weight:500;"><div style="width:8px;height:8px;border-radius:50%;background:'+mcol(m.id)+';"></div>'+e(m.name)+'</div>';});h+='</div>';}

  // Schedule list
  var all=[];for(var d in am){if(d<td)continue;am[d].forEach(function(a){all.push({d:d,t:'a',co:a.co,time:a.time,to:a.to});});}
  S.filter(function(s){if(s.scheduled_date<td)return false;if(schSc==='mine')return s.member_id===me.id;return s.is_public!==false||s.member_id===me.id;}).forEach(function(s){var pr=P.find(function(p){return p.id===s.prospect_id;});all.push({d:s.scheduled_date,t:'s',nm:pr?pr.company_name:(s.memo||'äºˆå®š'),mid:s.member_id,prv:s.is_public===false});});
  all.sort(function(a,b){return a.d.localeCompare(b.d);});
  if(!all.length)h+='<div class="empty">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  else all.slice(0,30).forEach(function(ev){if(ev.t==='a'){h+='<div class="sch-item" style="border-left:3px solid var(--wine);"><div style="font-size:13px;font-weight:700;color:var(--wine);width:48px;text-align:center;">'+fD(ev.d)+'</div><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:14px;">'+e(ev.co)+'</div><div style="font-size:12px;color:var(--tertiary);margin-top:2px;">'+(ev.time||'æ™‚é–“æœªå®š')+' ãƒ» '+e(mN(ev.to))+'</div></div></div>';}else{h+='<div class="sch-item" style="border-left:3px solid '+mcol(ev.mid)+';"><div style="font-size:13px;font-weight:700;color:var(--blue);width:48px;text-align:center;">'+fD(ev.d)+'</div><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:14px;">'+e(ev.nm)+'</div><div style="font-size:12px;color:var(--tertiary);margin-top:2px;">'+e(mN(ev.mid))+'</div></div>'+(ev.prv?'<span style="font-size:10px;color:var(--quaternary);">ğŸ”’</span>':'')+'</div>';}});

  // ===== MY PROSPECTS (æ‹…å½“è‘¬å„€ç¤¾ãƒªã‚¹ãƒˆ) =====
  var myP=P.filter(function(p){return p.assigned_to===me.id;});
  if(schSc==='mine'&&myP.length>0){
    h+='<div class="group-header">æ‹…å½“è‘¬å„€ç¤¾ï¼ˆ'+myP.length+'ä»¶ï¼‰</div>';
    myP.forEach(function(p){
      var sc=SC[p.status]||SC['æœªè¨ªå•'];
      var memo=p.hearing_content||p.notes||'';
      h+='<div class="sp-card">';
      h+='<div class="sp-top"><div class="sp-name">'+e(p.company_name)+'</div><span class="badge" style="background:'+sc.b+';color:'+sc.c+';font-size:10px;">'+e(p.status||'æœªè¨ªå•')+'</span></div>';
      h+='<div class="sp-rows">';
      if(p.meeting_date)h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="12" height="10" rx="1.5"/><path d="M2 7h12M5 2v3M11 2v3"/></svg><span style="color:var(--wine);font-weight:600;">'+e(p.meeting_date)+(p.meeting_time?' '+e(p.meeting_time):'')+'</span></div>';
      if(p.phone)h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M3 1.5h3l1.5 4-2 1.5a11 11 0 0 0 5 5l1.5-2 4 1.5v3a1 1 0 0 1-1 1A14 14 0 0 1 2.5 3a1 1 0 0 1 1-1.5"/></svg><a href="tel:'+e(p.phone)+'">'+e(p.phone)+'</a></div>';
      if(p.address)h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M8 1C5 1 2.5 3.5 2.5 6.5S8 15 8 15s5.5-5 5.5-8.5S11 1 8 1z"/><circle cx="8" cy="6.5" r="1.5"/></svg><a href="https://www.google.com/maps/search/'+encodeURIComponent(p.address)+'" target="_blank">'+e(p.address)+' â†—</a></div>';
      if(p.contact_person)h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="5" r="3"/><path d="M2 15c0-3 3-5 6-5s6 2 6 5"/></svg>'+e(p.contact_person)+'</div>';
      h+='</div>';
      if(memo)h+='<div class="sp-memo">'+e(memo)+'</div>';
      h+='</div>';
    });
  }else if(schSc==='all'){
    // Show all assigned prospects grouped
    var allP=P.filter(function(p){return p.assigned_to;});
    if(allP.length>0){
      h+='<div class="group-header">æ‹…å½“è‘¬å„€ç¤¾ï¼ˆå…¨å“¡ '+allP.length+'ä»¶ï¼‰</div>';
      allP.forEach(function(p){
        var sc=SC[p.status]||SC['æœªè¨ªå•'];
        h+='<div class="sp-card"><div class="sp-top"><div class="sp-name">'+e(p.company_name)+'</div><span class="badge" style="background:'+sc.b+';color:'+sc.c+';font-size:10px;">'+e(p.status||'æœªè¨ªå•')+'</span></div>';
        h+='<div class="sp-rows">';
        if(p.meeting_date)h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="12" height="10" rx="1.5"/><path d="M2 7h12M5 2v3M11 2v3"/></svg><span style="color:var(--wine);font-weight:600;">'+e(p.meeting_date)+(p.meeting_time?' '+e(p.meeting_time):'')+'</span></div>';
        if(p.phone)h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M3 1.5h3l1.5 4-2 1.5a11 11 0 0 0 5 5l1.5-2 4 1.5v3a1 1 0 0 1-1 1A14 14 0 0 1 2.5 3a1 1 0 0 1 1-1.5"/></svg><a href="tel:'+e(p.phone)+'">'+e(p.phone)+'</a></div>';
        h+='<div class="sp-r"><svg fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="5" r="3"/><path d="M2 15c0-3 3-5 6-5s6 2 6 5"/></svg>'+e(mN(p.assigned_to))+'</div>';
        h+='</div></div>';
      });
    }
  }

  document.getElementById('pg-schedule').innerHTML=h;
}

// ===== REVIEW =====
function rRev(){
  if(!me)return;var myP=P.filter(function(p){return p.assigned_to===me.id;}),myE=EV.filter(function(ev){return ev.member_id===me.id;});
  var h='<div class="st">æŒ¯ã‚Šè¿”ã‚Š</div><div class="group" style="padding:20px;">';
  h+='<div style="font-size:16px;font-weight:700;margin-bottom:16px;">å•†è«‡ã‚’è¨˜éŒ²ã™ã‚‹</div>';
  h+='<div class="fg"><label class="fl">å•†è«‡å…ˆï¼ˆè‡ªåˆ†ã®æ‹…å½“ã®ã¿ï¼‰</label><select class="fi" id="revCo"><option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  myP.forEach(function(p){h+='<option value="'+e(p.company_name)+'">'+e(p.company_name)+'</option>';});
  h+='</select></div>';
  h+='<div class="fg"><label class="fl">çµæœ</label><div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;">';
  ['å—æ³¨','è¦‹è¾¼ã¿','ç¶™ç¶š','è¦‹é€ã‚Š'].forEach(function(r){h+='<button class="rbtn '+(rR===r?'on':'')+'" onclick="rR=\''+r+'\';rRev()">'+r+'</button>';});
  h+='</div></div><div class="fg"><label class="fl">æ—¥ä»˜</label><input type="date" class="fi" id="revDt" value="'+new Date().toISOString().slice(0,10)+'"></div>';
  h+='<div class="fg"><label class="fl">ãƒ¡ãƒ¢</label><textarea class="ft" id="revMe" placeholder="å•†è«‡ã®è¦ç‚¹ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³..."></textarea></div>';
  h+='<button class="btn-p" onclick="subRev()">è¨˜éŒ²ã™ã‚‹</button></div>';
  h+='<div class="group-header">å±¥æ­´</div>';
  if(!myE.length)h+='<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  else{h+='<div class="group">';myE.forEach(function(ev){var rc={'å—æ³¨':'#34c759','è¦‹è¾¼ã¿':'#ff9500','ç¶™ç¶š':'#007aff','è¦‹é€ã‚Š':'#ff3b30'};var c=rc[ev.result]||'#8e8e93';h+='<div class="g-row"><div style="flex:1;"><div style="font-weight:600;font-size:15px;">'+e(ev.company_name||'-')+'</div><div style="font-size:12px;color:var(--tertiary);margin-top:2px;">'+e(ev.eval_date)+(ev.comment?' ãƒ» '+e(ev.comment.substring(0,30)):'')+'</div></div><span class="badge" style="background:'+c+'14;color:'+c+';">'+e(ev.result||'-')+'</span></div>';});h+='</div>';}
  document.getElementById('pg-review').innerHTML=h;
}
function subRev(){var co=document.getElementById('revCo').value,dt=document.getElementById('revDt').value,mm=document.getElementById('revMe').value;if(!co||!rR){alert('å•†è«‡å…ˆã¨çµæœã‚’é¸æŠ');return;}sb.from('sales_evaluations').insert({member_id:me.id,company_name:co,eval_date:dt,result:rR,comment:mm,total_score:0,scores:'{}',is_self_eval:true}).then(function(r){if(r.error){alert(r.error.message);return;}alert('è¨˜éŒ²ã—ã¾ã—ãŸ');rR='';lAll();});}

// ===== EXPENSE =====
function rExp(){
  if(!me)return;var my=E.filter(function(ex){return ex.member_id===me.id;});
  var pa=my.filter(function(ex){return ex.status==='ç”³è«‹ä¸­';}).reduce(function(s,ex){return s+(ex.amount||0);},0);
  var aa=my.filter(function(ex){return ex.status==='æ‰¿èª';}).reduce(function(s,ex){return s+(ex.amount||0);},0);
  var h='<div class="st" style="display:flex;justify-content:space-between;align-items:center;">çµŒè²»<button class="btn-s" onclick="document.getElementById(\'exDate\').value=new Date().toISOString().slice(0,10);opMo(\'exMo\')">ï¼‹ ç”³è«‹</button></div>';
  h+='<div class="stats-row"><div class="stat-box"><div class="stat-num" style="font-size:22px;color:#ff9500;">Â¥'+pa.toLocaleString()+'</div><div class="stat-lbl">ç”³è«‹ä¸­</div></div><div class="stat-box"><div class="stat-num" style="font-size:22px;color:#34c759;">Â¥'+aa.toLocaleString()+'</div><div class="stat-lbl">æ‰¿èªæ¸ˆ</div></div></div>';
  if(!my.length)h+='<div class="empty">çµŒè²»ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  else{h+='<div class="group">';my.forEach(function(ex){var ip=ex.status==='ç”³è«‹ä¸­';var ib=ip?'rgba(255,149,0,0.08)':(ex.status==='æ‰¿èª'?'rgba(52,199,89,0.08)':'rgba(255,59,48,0.08)');var ic=ip?'#ff9500':(ex.status==='æ‰¿èª'?'#34c759':'#ff3b30');h+='<div class="g-row"><div class="exp-ic" style="background:'+ib+';"><svg width="18" height="18" fill="none" stroke="'+ic+'" stroke-width="2" stroke-linecap="round">'+(ip?'<circle cx="9" cy="9" r="6"/><path d="M9 6v3h2"/>':'<path d="M4 9l3 3 7-7"/>')+'</svg></div><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:14px;">'+e(ex.category)+'<span style="font-weight:400;color:var(--tertiary);"> ãƒ»'+fD(ex.expense_date)+'</span></div><div style="font-size:13px;color:var(--tertiary);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+e(ex.description||'')+'</div></div><div style="font-weight:800;font-size:15px;flex-shrink:0;">Â¥'+(ex.amount||0).toLocaleString()+'</div></div>';});h+='</div>';}
  document.getElementById('pg-expense').innerHTML=h;
}
function subEx(){var d=document.getElementById('exDate').value,c=document.getElementById('exCat').value,a=parseInt(document.getElementById('exAmt').value)||0,ds=document.getElementById('exDesc').value;if(!d||!a){alert('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›');return;}sb.from('sales_expenses').insert({member_id:me.id,expense_date:d,category:c,amount:a,description:ds,status:'ç”³è«‹ä¸­'}).then(function(r){if(r.error){alert(r.error.message);return;}alert('ç”³è«‹ã—ã¾ã—ãŸ');clMo('exMo');document.getElementById('exAmt').value='';document.getElementById('exDesc').value='';lAll();});}
function opMo(id){document.getElementById(id).classList.add('show');}
function clMo(id){document.getElementById(id).classList.remove('show');}
</script>
</body>
</html>
