<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rei å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #f5f6fa; color: #2c2c2c; line-height: 1.6; }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2d5a47 0%, #3d7a5f 100%);
    }
    .login-card {
      background: white;
      border-radius: 16px;
      padding: 2.5rem;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .login-logo {
      text-align: center;
      margin-bottom: 2rem;
    }
    .login-logo-symbol {
      font-size: 3rem;
      color: #2d5a47;
    }
    .login-logo-text {
      font-size: 1.2rem;
      color: #5a5a5a;
      margin-top: 0.5rem;
    }
    .login-title {
      font-size: 1.3rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .form-group {
      margin-bottom: 1.25rem;
    }
    .form-label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #5a5a5a;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 2px solid #e5e2dd;
      border-radius: 8px;
    }
    .form-input:focus {
      outline: none;
      border-color: #2d5a47;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-primary {
      background: #2d5a47;
      color: white;
    }
    .btn-primary:hover {
      background: #3d7a5f;
    }
    .btn-secondary {
      background: #f5f6fa;
      color: #2c2c2c;
      border: 1px solid #e5e2dd;
    }
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    .login-footer {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.9rem;
      color: #8a8a8a;
    }
    .login-footer a {
      color: #2d5a47;
      text-decoration: none;
      font-weight: 600;
    }
    .error-box {
      background: #fee;
      color: #dc3545;
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    .hidden { display: none !important; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª */
    #mainApp { display: none; }
    .header {
      background: #2d5a47;
      color: white;
      padding: 1rem 1.5rem;
    }
    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-logo {
      font-size: 1.3rem;
      font-weight: 700;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .header-logout {
      background: rgba(255,255,255,0.15);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .nav {
      background: white;
      border-bottom: 1px solid #e5e2dd;
      padding: 0.5rem 1.5rem;
      overflow-x: auto;
    }
    .nav-inner {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      gap: 0.5rem;
    }
    .nav-btn {
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: #5a5a5a;
      background: none;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      white-space: nowrap;
    }
    .nav-btn:hover {
      background: #f5f6fa;
    }
    .nav-btn.active {
      background: #e8f0ec;
      color: #2d5a47;
    }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1.5rem;
    }
    .page { display: none; }
    .page.active { display: block; }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 1.5rem;
    }
    .card-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #e5e2dd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-title {
      font-size: 1rem;
      font-weight: 600;
    }
    .card-body {
      padding: 1.25rem;
    }
    
    /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .stat-label {
      font-size: 0.8rem;
      color: #8a8a8a;
      margin-bottom: 0.5rem;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #2d5a47;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid #e5e2dd;
      font-size: 0.9rem;
    }
    th {
      background: #f5f6fa;
      font-weight: 600;
      font-size: 0.8rem;
      color: #5a5a5a;
    }
    
    /* ãƒãƒƒã‚¸ */
    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .badge-gray { background: #f5f6fa; color: #8a8a8a; }
    .badge-blue { background: #cce5ff; color: #004085; }
    .badge-yellow { background: #fff3cd; color: #856404; }
    .badge-green { background: #d4edda; color: #155724; }
    .badge-red { background: #f8d7da; color: #721c24; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-bg.show { display: flex; }
    .modal-box {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-head {
      padding: 1.25rem;
      border-bottom: 1px solid #e5e2dd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-head h3 { font-size: 1.1rem; }
    .modal-close {
      width: 32px; height: 32px;
      border: none;
      background: #f5f6fa;
      border-radius: 50%;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .modal-content {
      padding: 1.25rem;
      max-height: calc(90vh - 140px);
      overflow-y: auto;
    }
    .modal-foot {
      padding: 1rem 1.25rem;
      border-top: 1px solid #e5e2dd;
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    .modal-foot .btn { width: auto; }
    
    /* ãƒŠãƒ¬ãƒƒã‚¸ã‚«ãƒ¼ãƒ‰ */
    .knowledge-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    .knowledge-card {
      background: white;
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 4px solid #2d5a47;
    }
    .knowledge-card.success { border-left-color: #28a745; }
    .knowledge-card.failure { border-left-color: #dc3545; }
    .knowledge-card.faq { border-left-color: #17a2b8; }
    .knowledge-cat {
      font-size: 0.75rem;
      color: #8a8a8a;
      margin-bottom: 0.5rem;
    }
    .knowledge-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .knowledge-text {
      font-size: 0.9rem;
      color: #5a5a5a;
      line-height: 1.7;
    }
    .knowledge-footer {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e2dd;
      font-size: 0.8rem;
      color: #8a8a8a;
    }
    
    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    .rank-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid #e5e2dd;
    }
    .rank-num {
      width: 32px; height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      background: #f5f6fa;
      color: #8a8a8a;
    }
    .rank-num.gold { background: linear-gradient(135deg, #ffd700, #ffec8b); color: #8b6914; }
    .rank-num.silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #666; }
    .rank-num.bronze { background: linear-gradient(135deg, #cd7f32, #daa06d); color: #5c3d1e; }
    .rank-name { flex: 1; font-weight: 600; }
    .rank-val { font-weight: 700; color: #2d5a47; }
    
    /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
    .filter-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .filter-row select, .filter-row input {
      padding: 0.5rem 1rem;
      border: 1px solid #e5e2dd;
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    /* ç©ºã®çŠ¶æ…‹ */
    .empty {
      text-align: center;
      padding: 3rem;
      color: #8a8a8a;
    }
    
    /* ãƒœã‚¿ãƒ³å° */
    .btn-sm {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
      width: auto;
      display: inline-block;
    }
    
    /* çµŒè²»é–¢é€£ */
    .expense-total {
      background: linear-gradient(135deg, #2d5a47, #3d7a5f);
      color: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .expense-total-label {
      font-size: 0.9rem;
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }
    .expense-total-value {
      font-size: 2.5rem;
      font-weight: 700;
    }
    .expense-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid #e5e2dd;
      gap: 1rem;
    }
    .expense-item:last-child {
      border-bottom: none;
    }
    .expense-date {
      font-size: 0.8rem;
      color: #8a8a8a;
      width: 60px;
    }
    .expense-info {
      flex: 1;
    }
    .expense-cat {
      font-weight: 600;
      font-size: 0.95rem;
    }
    .expense-desc {
      font-size: 0.85rem;
      color: #5a5a5a;
    }
    .expense-amount {
      font-weight: 700;
      font-size: 1.1rem;
      color: #2d5a47;
    }
  </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-symbol">ç¤¼</div>
      <div class="login-logo-text">å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>
    <h2 class="login-title">ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <div id="loginError" class="error-box hidden"></div>
    <div class="form-group">
      <label class="form-label">ãŠåå‰</label>
      <input type="text" class="form-input" id="loginName" placeholder="å±±ç”°å¤ªéƒ">
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" class="form-input" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <button class="btn btn-primary" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div class="login-footer">
      åˆã‚ã¦ã®æ–¹ã¯ <a href="javascript:void(0)" id="showRegisterLink">æ–°è¦ç™»éŒ²</a>
    </div>
  </div>
</div>

<!-- æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="registerModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>æ–°è¦ç™»éŒ²</h3>
      <button class="modal-close" id="closeRegisterBtn">&times;</button>
    </div>
    <div class="modal-content">
      <div id="registerError" class="error-box hidden"></div>
      <div class="form-group">
        <label class="form-label">ãŠåå‰ *</label>
        <input type="text" class="form-input" id="registerName" placeholder="å±±ç”°å¤ªéƒ">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
        <input type="password" class="form-input" id="registerPass" placeholder="4æ–‡å­—ä»¥ä¸Š">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary btn-sm" id="cancelRegisterBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="registerBtn">ç™»éŒ²</button>
    </div>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div id="mainApp">
  <header class="header">
    <div class="header-inner">
      <div class="header-logo">ç¤¼ å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</div>
      <div class="header-user">
        <span id="userName"></span>
        <button class="header-logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </header>

  <nav class="nav">
    <div class="nav-inner">
      <button class="nav-btn active" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
      <button class="nav-btn" data-page="prospects">ğŸ¢ è¨ªå•å…ˆç®¡ç†</button>
      <button class="nav-btn" data-page="knowledge">ğŸ’¬ ãƒŠãƒ¬ãƒƒã‚¸</button>
      <button class="nav-btn" data-page="expenses">ğŸ’° çµŒè²»ç”³è«‹</button>
      <button class="nav-btn" data-page="ranking">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
    </div>
  </nav>

  <main class="main">
    <!-- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ãƒãƒ¼ãƒ è¨ªå•æ•°</div>
          <div class="stat-value" id="statTeamVisits">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å•†è«‡ä¸­</div>
          <div class="stat-value" id="statNegotiating">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æˆç´„</div>
          <div class="stat-value" id="statClosed">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ã‚ãªãŸã®è¨ªå•</div>
          <div class="stat-value" id="statMyVisits">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä»Šæœˆã®çµŒè²»</div>
          <div class="stat-value" id="statMyExpense">Â¥0</div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ“¢ æœ€è¿‘ã®æ´»å‹•</h3>
        </div>
        <div class="card-body" id="recentActivity">
          <div class="empty">ã¾ã æ´»å‹•ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>

    <!-- è¨ªå•å…ˆç®¡ç† -->
    <div class="page" id="page-prospects">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ¢ è¨ªå•å…ˆä¸€è¦§</h3>
          <button class="btn btn-primary btn-sm" id="addProspectBtn">+ æ–°è¦è¿½åŠ </button>
        </div>
        <div class="card-body">
          <div class="filter-row">
            <select id="filterStatus">
              <option value="">ã™ã¹ã¦</option>
              <option value="æœªè¨ªå•">æœªè¨ªå•</option>
              <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
              <option value="å•†è«‡ä¸­">å•†è«‡ä¸­</option>
              <option value="æˆç´„">æˆç´„</option>
              <option value="è¦‹é€ã‚Š">è¦‹é€ã‚Š</option>
            </select>
            <select id="filterArea">
              <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
            </select>
            <input type="text" id="searchText" placeholder="æ¤œç´¢...">
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>è‘¬å„€ç¤¾å</th>
                  <th>ã‚¨ãƒªã‚¢</th>
                  <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                  <th>æ‹…å½“</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="prospectsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸ -->
    <div class="page" id="page-knowledge">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ’¬ ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰</h3>
          <button class="btn btn-primary btn-sm" id="addKnowledgeBtn">+ æŠ•ç¨¿</button>
        </div>
        <div class="card-body">
          <div class="filter-row">
            <select id="filterCategory">
              <option value="">ã™ã¹ã¦</option>
              <option value="æˆåŠŸäº‹ä¾‹">ğŸ“ˆ æˆåŠŸäº‹ä¾‹</option>
              <option value="å¤±æ•—äº‹ä¾‹">ğŸ“‰ å¤±æ•—äº‹ä¾‹</option>
              <option value="FAQ">â“ FAQ</option>
              <option value="Tips">ğŸ’¡ Tips</option>
            </select>
          </div>
        </div>
      </div>
      <div class="knowledge-grid" id="knowledgeList"></div>
    </div>

    <!-- çµŒè²»ç”³è«‹ -->
    <div class="page" id="page-expenses">
      <div class="expense-total">
        <div class="expense-total-label">ä»Šæœˆã®ç”³è«‹åˆè¨ˆ</div>
        <div class="expense-total-value" id="expenseTotal">Â¥0</div>
      </div>
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ’° çµŒè²»ç”³è«‹ä¸€è¦§</h3>
          <button class="btn btn-primary btn-sm" id="addExpenseBtn">+ çµŒè²»ã‚’ç”³è«‹</button>
        </div>
        <div class="card-body" style="padding: 0;">
          <div id="expensesList"></div>
        </div>
      </div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="page" id="page-ranking">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">ğŸ† è¨ªå•æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        </div>
        <div class="card-body" id="rankingList" style="padding:0;">
          <div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- è¨ªå•å…ˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="prospectModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="prospectModalTitle">è¨ªå•å…ˆã‚’è¿½åŠ </h3>
      <button class="modal-close" id="closeProspectBtn">&times;</button>
    </div>
    <div class="modal-content">
      <input type="hidden" id="prospectId">
      <div class="form-group">
        <label class="form-label">è‘¬å„€ç¤¾å *</label>
        <input type="text" class="form-input" id="pName">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚¨ãƒªã‚¢ *</label>
        <select class="form-input" id="pArea">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å¤§é˜ªå¸‚åŒ—åŒº">å¤§é˜ªå¸‚åŒ—åŒº</option>
          <option value="å¤§é˜ªå¸‚ä¸­å¤®åŒº">å¤§é˜ªå¸‚ä¸­å¤®åŒº</option>
          <option value="å¤§é˜ªå¸‚è¥¿åŒº">å¤§é˜ªå¸‚è¥¿åŒº</option>
          <option value="å¤§é˜ªå¸‚å¤©ç‹å¯ºåŒº">å¤§é˜ªå¸‚å¤©ç‹å¯ºåŒº</option>
          <option value="å¤§é˜ªå¸‚æ·€å·åŒº">å¤§é˜ªå¸‚æ·€å·åŒº</option>
          <option value="å¤§é˜ªå¸‚æ±æ·€å·åŒº">å¤§é˜ªå¸‚æ±æ·€å·åŒº</option>
          <option value="å¤§é˜ªå¸‚åŸæ±åŒº">å¤§é˜ªå¸‚åŸæ±åŒº</option>
          <option value="å¤§é˜ªå¸‚é¶´è¦‹åŒº">å¤§é˜ªå¸‚é¶´è¦‹åŒº</option>
          <option value="å¤§é˜ªå¸‚å¹³é‡åŒº">å¤§é˜ªå¸‚å¹³é‡åŒº</option>
          <option value="å¤§é˜ªå¸‚ä½å‰åŒº">å¤§é˜ªå¸‚ä½å‰åŒº</option>
          <option value="å¤§é˜ªå¸‚é˜¿å€é‡åŒº">å¤§é˜ªå¸‚é˜¿å€é‡åŒº</option>
          <option value="å ºå¸‚">å ºå¸‚</option>
          <option value="æ±å¤§é˜ªå¸‚">æ±å¤§é˜ªå¸‚</option>
          <option value="æšæ–¹å¸‚">æšæ–¹å¸‚</option>
          <option value="è±Šä¸­å¸‚">è±Šä¸­å¸‚</option>
          <option value="å¹ç”°å¸‚">å¹ç”°å¸‚</option>
          <option value="é«˜æ§»å¸‚">é«˜æ§»å¸‚</option>
          <option value="èŒ¨æœ¨å¸‚">èŒ¨æœ¨å¸‚</option>
          <option value="å…«å°¾å¸‚">å…«å°¾å¸‚</option>
          <option value="å¯å±‹å·å¸‚">å¯å±‹å·å¸‚</option>
          <option value="å²¸å’Œç”°å¸‚">å²¸å’Œç”°å¸‚</option>
          <option value="å’Œæ³‰å¸‚">å’Œæ³‰å¸‚</option>
          <option value="ç¥æˆ¸å¸‚">ç¥æˆ¸å¸‚</option>
          <option value="äº¬éƒ½å¸‚">äº¬éƒ½å¸‚</option>
          <option value="å¥ˆè‰¯å¸‚">å¥ˆè‰¯å¸‚</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±ç•ªå·</label>
        <input type="text" class="form-input" id="pPhone">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select class="form-input" id="pStatus">
          <option value="æœªè¨ªå•">æœªè¨ªå•</option>
          <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
          <option value="å•†è«‡ä¸­">å•†è«‡ä¸­</option>
          <option value="æˆç´„">æˆç´„</option>
          <option value="è¦‹é€ã‚Š">è¦‹é€ã‚Š</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢</label>
        <textarea class="form-input" id="pNotes" rows="3"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary btn-sm" id="cancelProspectBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="saveProspectBtn">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒŠãƒ¬ãƒƒã‚¸è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="knowledgeModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>ãƒŠãƒ¬ãƒƒã‚¸ã‚’æŠ•ç¨¿</h3>
      <button class="modal-close" id="closeKnowledgeBtn">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-input" id="kCategory">
          <option value="æˆåŠŸäº‹ä¾‹">ğŸ“ˆ æˆåŠŸäº‹ä¾‹</option>
          <option value="å¤±æ•—äº‹ä¾‹">ğŸ“‰ å¤±æ•—äº‹ä¾‹</option>
          <option value="FAQ">â“ FAQ</option>
          <option value="Tips">ğŸ’¡ Tips</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
        <input type="text" class="form-input" id="kTitle">
      </div>
      <div class="form-group">
        <label class="form-label">å†…å®¹ *</label>
        <textarea class="form-input" id="kContent" rows="5"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary btn-sm" id="cancelKnowledgeBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="saveKnowledgeBtn">æŠ•ç¨¿</button>
    </div>
  </div>
</div>

<!-- çµŒè²»ç”³è«‹ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="expenseModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>çµŒè²»ã‚’ç”³è«‹</h3>
      <button class="modal-close" id="closeExpenseBtn">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">æ—¥ä»˜ *</label>
        <input type="date" class="form-input" id="eDate">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-input" id="eCategory">
          <option value="äº¤é€šè²»">ğŸšƒ äº¤é€šè²»</option>
          <option value="ã‚¬ã‚½ãƒªãƒ³ä»£">â›½ ã‚¬ã‚½ãƒªãƒ³ä»£</option>
          <option value="é§è»Šå ´ä»£">ğŸ…¿ï¸ é§è»Šå ´ä»£</option>
          <option value="æ¥å¾…è²»">ğŸ½ï¸ æ¥å¾…è²»</option>
          <option value="å®¿æ³Šè²»">ğŸ¨ å®¿æ³Šè²»</option>
          <option value="æ¶ˆè€—å“">ğŸ“¦ æ¶ˆè€—å“</option>
          <option value="ãã®ä»–">ğŸ“ ãã®ä»–</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">é‡‘é¡ *</label>
        <input type="number" class="form-input" id="eAmount" placeholder="1000">
      </div>
      <div class="form-group">
        <label class="form-label">å†…å®¹ãƒ»ãƒ¡ãƒ¢</label>
        <input type="text" class="form-input" id="eDescription" placeholder="ä¾‹ï¼šâ—‹â—‹è‘¬å„€ç¤¾ã¸ã®è¨ªå•">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary btn-sm" id="cancelExpenseBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary btn-sm" id="saveExpenseBtn">ç”³è«‹</button>
    </div>
  </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
var supabase;
var currentUser = null;
var prospects = [];
var members = [];
var knowledge = [];
var expenses = [];

// ã‚¨ãƒªã‚¢ãƒªã‚¹ãƒˆ
var areaList = [
  'å¤§é˜ªå¸‚åŒ—åŒº', 'å¤§é˜ªå¸‚ä¸­å¤®åŒº', 'å¤§é˜ªå¸‚è¥¿åŒº', 'å¤§é˜ªå¸‚å¤©ç‹å¯ºåŒº', 'å¤§é˜ªå¸‚æ·€å·åŒº',
  'å¤§é˜ªå¸‚æ±æ·€å·åŒº', 'å¤§é˜ªå¸‚åŸæ±åŒº', 'å¤§é˜ªå¸‚é¶´è¦‹åŒº', 'å¤§é˜ªå¸‚å¹³é‡åŒº', 'å¤§é˜ªå¸‚ä½å‰åŒº',
  'å¤§é˜ªå¸‚é˜¿å€é‡åŒº', 'å ºå¸‚', 'æ±å¤§é˜ªå¸‚', 'æšæ–¹å¸‚', 'è±Šä¸­å¸‚', 'å¹ç”°å¸‚', 'é«˜æ§»å¸‚',
  'èŒ¨æœ¨å¸‚', 'å…«å°¾å¸‚', 'å¯å±‹å·å¸‚', 'å²¸å’Œç”°å¸‚', 'å’Œæ³‰å¸‚', 'ç¥æˆ¸å¸‚', 'äº¬éƒ½å¸‚', 'å¥ˆè‰¯å¸‚', 'ãã®ä»–'
];

// Supabaseè¨­å®š
var SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚
window.onload = function() {
  // SupabaseåˆæœŸåŒ–
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ
  var saved = localStorage.getItem('salesUser');
  if (saved) {
    currentUser = JSON.parse(saved);
    showMainApp();
  }
  
  // ã‚¨ãƒªã‚¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–
  var filterArea = document.getElementById('filterArea');
  for (var i = 0; i < areaList.length; i++) {
    var opt = document.createElement('option');
    opt.value = areaList[i];
    opt.textContent = areaList[i];
    filterArea.appendChild(opt);
  }
  
  // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
  document.getElementById('eDate').value = new Date().toISOString().split('T')[0];
  
  // ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
  setupEvents();
};

function setupEvents() {
  // ãƒ­ã‚°ã‚¤ãƒ³
  document.getElementById('loginBtn').onclick = doLogin;
  document.getElementById('showRegisterLink').onclick = function() {
    document.getElementById('registerModal').classList.add('show');
  };
  
  // æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('closeRegisterBtn').onclick = closeRegisterModal;
  document.getElementById('cancelRegisterBtn').onclick = closeRegisterModal;
  document.getElementById('registerBtn').onclick = doRegister;
  
  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
  document.getElementById('logoutBtn').onclick = doLogout;
  
  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  var navBtns = document.querySelectorAll('.nav-btn');
  for (var i = 0; i < navBtns.length; i++) {
    navBtns[i].onclick = function() {
      var page = this.getAttribute('data-page');
      switchPage(page);
    };
  }
  
  // è¨ªå•å…ˆãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('addProspectBtn').onclick = openAddProspect;
  document.getElementById('closeProspectBtn').onclick = closeProspectModal;
  document.getElementById('cancelProspectBtn').onclick = closeProspectModal;
  document.getElementById('saveProspectBtn').onclick = saveProspect;
  
  // ãƒŠãƒ¬ãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('addKnowledgeBtn').onclick = function() {
    document.getElementById('knowledgeModal').classList.add('show');
  };
  document.getElementById('closeKnowledgeBtn').onclick = closeKnowledgeModal;
  document.getElementById('cancelKnowledgeBtn').onclick = closeKnowledgeModal;
  document.getElementById('saveKnowledgeBtn').onclick = saveKnowledge;
  
  // çµŒè²»ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('addExpenseBtn').onclick = function() {
    document.getElementById('eDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('eCategory').value = 'äº¤é€šè²»';
    document.getElementById('eAmount').value = '';
    document.getElementById('eDescription').value = '';
    document.getElementById('expenseModal').classList.add('show');
  };
  document.getElementById('closeExpenseBtn').onclick = closeExpenseModal;
  document.getElementById('cancelExpenseBtn').onclick = closeExpenseModal;
  document.getElementById('saveExpenseBtn').onclick = saveExpense;
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  document.getElementById('filterStatus').onchange = renderProspects;
  document.getElementById('filterArea').onchange = renderProspects;
  document.getElementById('searchText').oninput = renderProspects;
  document.getElementById('filterCategory').onchange = renderKnowledge;
}

function closeRegisterModal() {
  document.getElementById('registerModal').classList.remove('show');
}

function closeProspectModal() {
  document.getElementById('prospectModal').classList.remove('show');
}

function closeKnowledgeModal() {
  document.getElementById('knowledgeModal').classList.remove('show');
}

function closeExpenseModal() {
  document.getElementById('expenseModal').classList.remove('show');
}

// ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
function doLogin() {
  var name = document.getElementById('loginName').value.trim();
  var pass = document.getElementById('loginPass').value;
  
  if (!name || !pass) {
    showLoginError('åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  supabase
    .from('sales_members')
    .select('*')
    .eq('name', name)
    .eq('password_hash', pass)
    .single()
    .then(function(result) {
      if (result.error || !result.data) {
        showLoginError('åå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
        return;
      }
      currentUser = result.data;
      localStorage.setItem('salesUser', JSON.stringify(currentUser));
      showMainApp();
    });
}

function showLoginError(msg) {
  var el = document.getElementById('loginError');
  el.textContent = msg;
  el.classList.remove('hidden');
}

// æ–°è¦ç™»éŒ²å‡¦ç†
function doRegister() {
  var name = document.getElementById('registerName').value.trim();
  var pass = document.getElementById('registerPass').value;
  
  if (!name || !pass) {
    showRegisterError('åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  if (pass.length < 4) {
    showRegisterError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Š');
    return;
  }
  
  supabase
    .from('sales_members')
    .insert({ name: name, password_hash: pass })
    .select()
    .single()
    .then(function(result) {
      if (result.error) {
        showRegisterError('ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      currentUser = result.data;
      localStorage.setItem('salesUser', JSON.stringify(currentUser));
      closeRegisterModal();
      showMainApp();
    });
}

function showRegisterError(msg) {
  var el = document.getElementById('registerError');
  el.textContent = msg;
  el.classList.remove('hidden');
}

// ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
function doLogout() {
  currentUser = null;
  localStorage.removeItem('salesUser');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

// ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªè¡¨ç¤º
function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('userName').textContent = currentUser.name + 'ã•ã‚“';
  loadData();
}

// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
function loadData() {
  // ãƒ¡ãƒ³ãƒãƒ¼
  supabase.from('sales_members').select('*').then(function(r) {
    members = r.data || [];
    updateStats();
    renderRanking();
  });
  
  // è¨ªå•å…ˆ
  supabase.from('sales_prospects').select('*').order('created_at', { ascending: false }).then(function(r) {
    prospects = r.data || [];
    updateStats();
    renderProspects();
  });
  
  // ãƒŠãƒ¬ãƒƒã‚¸
  supabase.from('sales_knowledge').select('*').order('created_at', { ascending: false }).then(function(r) {
    knowledge = r.data || [];
    renderKnowledge();
  });
  
  // çµŒè²»
  supabase.from('sales_expenses').select('*').eq('member_id', currentUser.id).order('expense_date', { ascending: false }).then(function(r) {
    expenses = r.data || [];
    updateStats();
    renderExpenses();
  });
}

// çµ±è¨ˆæ›´æ–°
function updateStats() {
  var teamVisits = prospects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
  var negotiating = prospects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
  var closed = prospects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
  var myVisits = prospects.filter(function(p) { 
    return p.assigned_to === currentUser.id && p.status !== 'æœªè¨ªå•'; 
  }).length;
  
  // ä»Šæœˆã®çµŒè²»åˆè¨ˆ
  var now = new Date();
  var thisMonth = now.getMonth();
  var thisYear = now.getFullYear();
  var monthlyExpense = 0;
  for (var i = 0; i < expenses.length; i++) {
    var d = new Date(expenses[i].expense_date);
    if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
      monthlyExpense += expenses[i].amount;
    }
  }
  
  document.getElementById('statTeamVisits').textContent = teamVisits;
  document.getElementById('statNegotiating').textContent = negotiating;
  document.getElementById('statClosed').textContent = closed;
  document.getElementById('statMyVisits').textContent = myVisits;
  document.getElementById('statMyExpense').textContent = 'Â¥' + monthlyExpense.toLocaleString();
}

// ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ
function switchPage(page) {
  var navBtns = document.querySelectorAll('.nav-btn');
  var pages = document.querySelectorAll('.page');
  
  for (var i = 0; i < navBtns.length; i++) {
    navBtns[i].classList.remove('active');
    if (navBtns[i].getAttribute('data-page') === page) {
      navBtns[i].classList.add('active');
    }
  }
  
  for (var i = 0; i < pages.length; i++) {
    pages[i].classList.remove('active');
  }
  document.getElementById('page-' + page).classList.add('active');
}

// è¨ªå•å…ˆä¸€è¦§è¡¨ç¤º
function renderProspects() {
  var status = document.getElementById('filterStatus').value;
  var area = document.getElementById('filterArea').value;
  var search = document.getElementById('searchText').value.toLowerCase();
  
  var filtered = prospects.filter(function(p) {
    if (status && p.status !== status) return false;
    if (area && p.area !== area) return false;
    if (search && p.company_name.toLowerCase().indexOf(search) === -1) return false;
    return true;
  });
  
  var tbody = document.getElementById('prospectsBody');
  
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var p = filtered[i];
    var member = members.find(function(m) { return m.id === p.assigned_to; });
    var badgeClass = getBadgeClass(p.status);
    
    html += '<tr>';
    html += '<td><strong>' + esc(p.company_name) + '</strong></td>';
    html += '<td>' + esc(p.area || '-') + '</td>';
    html += '<td><span class="badge ' + badgeClass + '">' + p.status + '</span></td>';
    html += '<td>' + (member ? esc(member.name) : '-') + '</td>';
    html += '<td><button class="btn btn-secondary btn-sm" onclick="editProspect(\'' + p.id + '\')">ç·¨é›†</button></td>';
    html += '</tr>';
  }
  tbody.innerHTML = html;
}

function getBadgeClass(status) {
  var map = {
    'æœªè¨ªå•': 'badge-gray',
    'è¨ªå•æ¸ˆã¿': 'badge-blue',
    'å•†è«‡ä¸­': 'badge-yellow',
    'æˆç´„': 'badge-green',
    'è¦‹é€ã‚Š': 'badge-red'
  };
  return map[status] || 'badge-gray';
}

// è¨ªå•å…ˆè¿½åŠ 
function openAddProspect() {
  document.getElementById('prospectModalTitle').textContent = 'è¨ªå•å…ˆã‚’è¿½åŠ ';
  document.getElementById('prospectId').value = '';
  document.getElementById('pName').value = '';
  document.getElementById('pArea').value = '';
  document.getElementById('pPhone').value = '';
  document.getElementById('pStatus').value = 'æœªè¨ªå•';
  document.getElementById('pNotes').value = '';
  document.getElementById('prospectModal').classList.add('show');
}

function editProspect(id) {
  var p = prospects.find(function(x) { return x.id === id; });
  if (!p) return;
  
  document.getElementById('prospectModalTitle').textContent = 'è¨ªå•å…ˆã‚’ç·¨é›†';
  document.getElementById('prospectId').value = p.id;
  document.getElementById('pName').value = p.company_name || '';
  document.getElementById('pArea').value = p.area || '';
  document.getElementById('pPhone').value = p.phone || '';
  document.getElementById('pStatus').value = p.status || 'æœªè¨ªå•';
  document.getElementById('pNotes').value = p.notes || '';
  document.getElementById('prospectModal').classList.add('show');
}

function saveProspect() {
  var id = document.getElementById('prospectId').value;
  var data = {
    company_name: document.getElementById('pName').value.trim(),
    area: document.getElementById('pArea').value,
    phone: document.getElementById('pPhone').value.trim(),
    status: document.getElementById('pStatus').value,
    notes: document.getElementById('pNotes').value.trim(),
    updated_at: new Date().toISOString()
  };
  
  if (!data.company_name) {
    alert('è‘¬å„€ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  if (id) {
    supabase.from('sales_prospects').update(data).eq('id', id).then(function() {
      closeProspectModal();
      loadData();
    });
  } else {
    data.assigned_to = currentUser.id;
    supabase.from('sales_prospects').insert(data).then(function() {
      closeProspectModal();
      loadData();
    });
  }
}

// ãƒŠãƒ¬ãƒƒã‚¸è¡¨ç¤º
function renderKnowledge() {
  var category = document.getElementById('filterCategory').value;
  
  var filtered = knowledge.filter(function(k) {
    if (category && k.category !== category) return false;
    return true;
  });
  
  var container = document.getElementById('knowledgeList');
  
  if (filtered.length === 0) {
    container.innerHTML = '<div class="empty" style="grid-column:1/-1;">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < filtered.length; i++) {
    var k = filtered[i];
    var member = members.find(function(m) { return m.id === k.member_id; });
    var cardClass = getKnowledgeClass(k.category);
    var icon = getKnowledgeIcon(k.category);
    
    html += '<div class="knowledge-card ' + cardClass + '">';
    html += '<div class="knowledge-cat">' + icon + ' ' + k.category + '</div>';
    html += '<div class="knowledge-title">' + esc(k.title) + '</div>';
    html += '<div class="knowledge-text">' + esc(k.content) + '</div>';
    html += '<div class="knowledge-footer">';
    html += '<span>' + (member ? esc(member.name) : 'åŒ¿å') + '</span>';
    html += '<span>' + formatDate(k.created_at) + '</span>';
    html += '</div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function getKnowledgeClass(cat) {
  var map = { 'æˆåŠŸäº‹ä¾‹': 'success', 'å¤±æ•—äº‹ä¾‹': 'failure', 'FAQ': 'faq' };
  return map[cat] || '';
}

function getKnowledgeIcon(cat) {
  var map = { 'æˆåŠŸäº‹ä¾‹': 'ğŸ“ˆ', 'å¤±æ•—äº‹ä¾‹': 'ğŸ“‰', 'FAQ': 'â“', 'Tips': 'ğŸ’¡' };
  return map[cat] || 'ğŸ“';
}

function saveKnowledge() {
  var data = {
    member_id: currentUser.id,
    category: document.getElementById('kCategory').value,
    title: document.getElementById('kTitle').value.trim(),
    content: document.getElementById('kContent').value.trim()
  };
  
  if (!data.title || !data.content) {
    alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  supabase.from('sales_knowledge').insert(data).then(function() {
    closeKnowledgeModal();
    document.getElementById('kTitle').value = '';
    document.getElementById('kContent').value = '';
    loadData();
  });
}

// çµŒè²»è¡¨ç¤º
function renderExpenses() {
  var container = document.getElementById('expensesList');
  
  // ä»Šæœˆã®åˆè¨ˆ
  var now = new Date();
  var thisMonth = now.getMonth();
  var thisYear = now.getFullYear();
  var monthlyTotal = 0;
  for (var i = 0; i < expenses.length; i++) {
    var d = new Date(expenses[i].expense_date);
    if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
      monthlyTotal += expenses[i].amount;
    }
  }
  document.getElementById('expenseTotal').textContent = 'Â¥' + monthlyTotal.toLocaleString();
  
  if (expenses.length === 0) {
    container.innerHTML = '<div class="empty">çµŒè²»ç”³è«‹ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < expenses.length; i++) {
    var e = expenses[i];
    var icon = getExpenseIcon(e.category);
    var badgeClass = getExpenseBadgeClass(e.status);
    
    html += '<div class="expense-item">';
    html += '<div class="expense-date">' + formatDate(e.expense_date) + '</div>';
    html += '<div class="expense-info">';
    html += '<div class="expense-cat">' + icon + ' ' + e.category + '</div>';
    if (e.description) {
      html += '<div class="expense-desc">' + esc(e.description) + '</div>';
    }
    html += '</div>';
    html += '<div class="expense-amount">Â¥' + e.amount.toLocaleString() + '</div>';
    html += '<span class="badge ' + badgeClass + '">' + e.status + '</span>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function getExpenseIcon(cat) {
  var map = {
    'äº¤é€šè²»': 'ğŸšƒ',
    'ã‚¬ã‚½ãƒªãƒ³ä»£': 'â›½',
    'é§è»Šå ´ä»£': 'ğŸ…¿ï¸',
    'æ¥å¾…è²»': 'ğŸ½ï¸',
    'å®¿æ³Šè²»': 'ğŸ¨',
    'æ¶ˆè€—å“': 'ğŸ“¦',
    'ãã®ä»–': 'ğŸ“'
  };
  return map[cat] || 'ğŸ“';
}

function getExpenseBadgeClass(status) {
  var map = {
    'ç”³è«‹ä¸­': 'badge-yellow',
    'æ‰¿èª': 'badge-green',
    'å´ä¸‹': 'badge-red'
  };
  return map[status] || 'badge-gray';
}

function saveExpense() {
  var data = {
    member_id: currentUser.id,
    expense_date: document.getElementById('eDate').value,
    category: document.getElementById('eCategory').value,
    amount: parseInt(document.getElementById('eAmount').value) || 0,
    description: document.getElementById('eDescription').value.trim(),
    status: 'ç”³è«‹ä¸­'
  };
  
  if (!data.expense_date || !data.amount) {
    alert('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  
  supabase.from('sales_expenses').insert(data).then(function() {
    closeExpenseModal();
    loadData();
  });
}

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
function renderRanking() {
  var counts = {};
  for (var i = 0; i < members.length; i++) {
    counts[members[i].id] = { name: members[i].name, count: 0 };
  }
  for (var i = 0; i < prospects.length; i++) {
    var p = prospects[i];
    if (p.assigned_to && counts[p.assigned_to] && p.status !== 'æœªè¨ªå•') {
      counts[p.assigned_to].count++;
    }
  }
  
  var arr = [];
  for (var id in counts) {
    arr.push(counts[id]);
  }
  arr.sort(function(a, b) { return b.count - a.count; });
  
  var container = document.getElementById('rankingList');
  
  if (arr.length === 0) {
    container.innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '';
  for (var i = 0; i < arr.length; i++) {
    var rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : ''));
    html += '<div class="rank-item">';
    html += '<div class="rank-num ' + rankClass + '">' + (i + 1) + '</div>';
    html += '<div class="rank-name">' + esc(arr[i].name) + '</div>';
    html += '<div class="rank-val">' + arr[i].count + 'ä»¶</div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function formatDate(str) {
  if (!str) return '-';
  var d = new Date(str);
  return (d.getMonth() + 1) + '/' + d.getDate();
}
</script>

</body>
</html>