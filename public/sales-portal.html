<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Rei å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; 
      background: #f5f6fa; 
      color: #2c2c2c; 
      line-height: 1.5;
      font-size: 14px;
      padding-bottom: 70px;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    #loginScreen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #2d5a47 0%, #3d7a5f 100%);
      padding: 1rem;
    }
    .login-card {
      background: white;
      border-radius: 16px;
      padding: 2rem;
      width: 100%;
      max-width: 360px;
    }
    .login-logo {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .login-logo-symbol {
      font-size: 2.5rem;
      color: #2d5a47;
    }
    .login-logo-text {
      font-size: 1rem;
      color: #5a5a5a;
      margin-top: 0.25rem;
    }
    .login-title {
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1.25rem;
    }
    .form-group { margin-bottom: 1rem; }
    .form-label {
      display: block;
      font-size: 0.8rem;
      font-weight: 500;
      margin-bottom: 0.4rem;
      color: #5a5a5a;
    }
    .form-input {
      width: 100%;
      padding: 0.7rem 0.9rem;
      font-size: 16px;
      border: 2px solid #e5e2dd;
      border-radius: 8px;
      appearance: none; -webkit-appearance: none;
    }
    .form-input:focus {
      outline: none;
      border-color: #2d5a47;
    }
    .form-input.error {
      border-color: #dc3545;
    }
    .form-hint {
      font-size: 0.75rem;
      color: #8a8a8a;
      margin-top: 0.3rem;
    }
    .form-hint.error {
      color: #dc3545;
    }
    .btn {
      display: block;
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .btn-primary { background: #2d5a47; color: white; }
    .btn-primary:active { background: #3d7a5f; }
    .btn-secondary { background: #f5f6fa; color: #2c2c2c; border: 1px solid #e5e2dd; }
    .btn-sm { padding: 0.5rem 0.75rem; font-size: 0.85rem; width: auto; }
    .login-footer {
      text-align: center;
      margin-top: 1.25rem;
      font-size: 0.85rem;
      color: #8a8a8a;
    }
    .login-footer a { color: #2d5a47; text-decoration: none; font-weight: 600; }
    .error-box {
      background: #fee;
      color: #dc3545;
      padding: 0.6rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.8rem;
    }
    .hidden { display: none !important; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª */
    #mainApp { display: none; }
    .header {
      background: #2d5a47;
      color: white;
      padding: 0.75rem 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-logo { font-size: 1.1rem; font-weight: 700; }
    .header-user { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; }
    .header-logout {
      background: rgba(255,255,255,0.15);
      color: white;
      border: none;
      padding: 0.4rem 0.7rem;
      border-radius: 6px;
      font-size: 0.75rem;
    }
    
    /* ä¸‹éƒ¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e2dd;
      display: flex;
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-btn {
      flex: 1;
      padding: 0.5rem 0.25rem;
      font-size: 0.65rem;
      color: #8a8a8a;
      background: none;
      border: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.2rem;
    }
    .nav-btn-icon { font-size: 1.25rem; }
    .nav-btn.active { color: #2d5a47; }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main { padding: 1rem; }
    .page { display: none; }
    .page.active { display: block; }
    
    /* ã‚«ãƒ¼ãƒ‰ */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
      overflow: hidden;
    }
    .card-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #e5e2dd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .card-title { font-size: 0.9rem; font-weight: 600; }
    .card-body { padding: 1rem; }
    
    /* çµ±è¨ˆã‚°ãƒªãƒƒãƒ‰ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .stat-label { font-size: 0.7rem; color: #8a8a8a; margin-bottom: 0.25rem; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #2d5a47; }
    .stat-sub { font-size: 0.7rem; color: #8a8a8a; }
    
    /* ç›®æ¨™é€²æ—ãƒãƒ¼ */
    .goal-section { margin-bottom: 1rem; }
    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .goal-title { font-size: 0.8rem; font-weight: 600; }
    .goal-numbers { font-size: 0.75rem; color: #5a5a5a; }
    .goal-bar {
      height: 8px;
      background: #e5e2dd;
      border-radius: 4px;
      overflow: hidden;
    }
    .goal-fill {
      height: 100%;
      background: linear-gradient(90deg, #2d5a47, #3d7a5f);
      border-radius: 4px;
      transition: width 0.3s;
    }
    .goal-fill.over { background: linear-gradient(90deg, #28a745, #5cb85c); }
    
    /* ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ  */
    .list-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .list-item:last-child { border-bottom: none; }
    .list-item-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #e8f0ec;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      flex-shrink: 0;
    }
    .list-item-content { flex: 1; min-width: 0; }
    .list-item-title {
      font-weight: 600;
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .list-item-sub { font-size: 0.75rem; color: #8a8a8a; }
    .list-item-right { text-align: right; flex-shrink: 0; }
    
    /* ãƒãƒƒã‚¸ */
    .badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 100px;
      font-size: 0.65rem;
      font-weight: 600;
    }
    .badge-gray { background: #f5f6fa; color: #8a8a8a; }
    .badge-blue { background: #cce5ff; color: #004085; }
    .badge-yellow { background: #fff3cd; color: #856404; }
    .badge-green { background: #d4edda; color: #155724; }
    .badge-red { background: #f8d7da; color: #721c24; }
    
    /* ã‚¢ãƒ©ãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
    .alert-card {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .alert-card-title {
      font-weight: 600;
      font-size: 0.85rem;
      color: #856404;
      margin-bottom: 0.5rem;
    }
    .alert-card-item {
      font-size: 0.8rem;
      color: #856404;
      padding: 0.25rem 0;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 1000;
    }
    .modal-bg.show { display: flex; }
    .modal-box {
      background: white;
      border-radius: 16px 16px 0 0;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-head {
      padding: 1rem;
      border-bottom: 1px solid #e5e2dd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .modal-head h3 { font-size: 1rem; }
    .modal-close {
      width: 28px; height: 28px;
      border: none;
      background: #f5f6fa;
      border-radius: 50%;
      font-size: 1rem;
    }
    .modal-content {
      padding: 1rem;
      max-height: calc(90vh - 130px);
      overflow-y: auto;
    }
    .modal-foot {
      padding: 0.75rem 1rem;
      border-top: 1px solid #e5e2dd;
      display: flex;
      gap: 0.5rem;
    }
    .modal-foot .btn { flex: 1; }
    
    /* æ²ç¤ºæ¿ */
    .post-item {
      padding: 0.75rem;
      border-bottom: 1px solid #f0f0f0;
    }
    .post-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .post-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #2d5a47;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .post-name { font-weight: 600; font-size: 0.85rem; }
    .post-time { font-size: 0.7rem; color: #8a8a8a; margin-left: auto; }
    .post-content { font-size: 0.9rem; line-height: 1.5; }
    
    /* æŠ•ç¨¿å…¥åŠ› */
    .post-input-area {
      padding: 0.75rem;
      background: white;
      border-top: 1px solid #e5e2dd;
      display: flex;
      gap: 0.5rem;
    }
    .post-input {
      flex: 1;
      padding: 0.6rem;
      border: 1px solid #e5e2dd;
      border-radius: 20px;
      font-size: 14px;
      appearance: none; -webkit-appearance: none;
    }
    .post-send {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #2d5a47;
      color: white;
      border: none;
      font-size: 1rem;
    }
    
    /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« */
    .schedule-date {
      font-weight: 600;
      font-size: 0.85rem;
      padding: 0.5rem 1rem;
      background: #f5f6fa;
      color: #5a5a5a;
    }
    .schedule-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .schedule-check {
      width: 22px;
      height: 22px;
      border: 2px solid #e5e2dd;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .schedule-check.done {
      background: #2d5a47;
      border-color: #2d5a47;
    }
    .schedule-check.done::after {
      content: 'âœ“';
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
    }
    .schedule-info { flex: 1; }
    .schedule-company { font-weight: 600; font-size: 0.9rem; }
    .schedule-memo { font-size: 0.75rem; color: #8a8a8a; }
    
    /* çµŒè²» */
    .expense-total {
      background: linear-gradient(135deg, #2d5a47, #3d7a5f);
      color: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    .expense-total-label { font-size: 0.8rem; opacity: 0.9; }
    .expense-total-value { font-size: 2rem; font-weight: 700; }
    
    /* é€±å ± */
    .report-section { margin-bottom: 1rem; }
    .report-title {
      font-size: 0.8rem;
      font-weight: 600;
      color: #5a5a5a;
      margin-bottom: 0.5rem;
    }
    .report-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    .report-item {
      background: #f5f6fa;
      border-radius: 8px;
      padding: 0.75rem;
      text-align: center;
    }
    .report-value { font-size: 1.25rem; font-weight: 700; color: #2d5a47; }
    .report-label { font-size: 0.7rem; color: #8a8a8a; }
    
    /* FAB */
    .fab {
      position: fixed;
      bottom: 80px;
      right: 16px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #2d5a47;
      color: white;
      border: none;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 90;
    }
    
    /* ç©º */
    .empty {
      text-align: center;
      padding: 2rem;
      color: #8a8a8a;
      font-size: 0.85rem;
    }
    
    /* é€šçŸ¥ãƒãƒƒã‚¸ */
    .notif-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #dc3545;
      color: white;
      font-size: 0.6rem;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
    }
    .nav-btn { position: relative; }
    
    /* é€šçŸ¥ãƒªã‚¹ãƒˆ */
    .notif-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }
    .notif-item.unread { background: #e8f4fd; }
    .notif-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    .notif-icon.success { background: #d4edda; }
    .notif-icon.error { background: #f8d7da; }
    .notif-icon.info { background: #cce5ff; }
    .notif-content { flex: 1; }
    .notif-title { font-weight: 600; font-size: 0.85rem; }
    .notif-text { font-size: 0.8rem; color: #5a5a5a; }
    .notif-time { font-size: 0.7rem; color: #8a8a8a; }
    
    /* TODOãƒªã‚¹ãƒˆ */
    .my-todo-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      gap: 0.75rem;
      align-items: flex-start;
    }
    .my-todo-check {
      width: 20px;
      height: 20px;
      border: 2px solid #e5e2dd;
      border-radius: 50%;
      flex-shrink: 0;
      cursor: pointer;
    }
    .my-todo-check.done {
      background: #2d5a47;
      border-color: #2d5a47;
    }
    .my-todo-content { flex: 1; }
    .my-todo-title { font-weight: 600; font-size: 0.9rem; }
    .my-todo-meta { font-size: 0.75rem; color: #8a8a8a; }
    
    /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
    .rank-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #f0f0f0;
    }
    .rank-num {
      width: 28px; height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      background: #f5f6fa;
      color: #8a8a8a;
    }
    .rank-num.gold { background: linear-gradient(135deg, #ffd700, #ffec8b); color: #8b6914; }
    .rank-num.silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #666; }
    .rank-num.bronze { background: linear-gradient(135deg, #cd7f32, #daa06d); color: #5c3d1e; }
    .rank-name { flex: 1; font-weight: 600; font-size: 0.9rem; }
    .rank-val { font-weight: 700; color: #2d5a47; }

    /* ã‚¿ãƒ– */
    .tabs {
      display: flex;
      border-bottom: 1px solid #e5e2dd;
      background: white;
      margin: -1rem -1rem 1rem -1rem;
    }
    .tab-btn {
      flex: 1;
      padding: 0.75rem;
      font-size: 0.85rem;
      font-weight: 500;
      color: #8a8a8a;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
    }
    .tab-btn.active {
      color: #2d5a47;
      border-bottom-color: #2d5a47;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .calendar-header {
      text-align: center;
      font-size: 0.7rem;
      font-weight: 600;
      color: #8a8a8a;
      padding: 0.5rem 0;
    }
    .calendar-header.sun { color: #dc3545; }
    .calendar-header.sat { color: #17a2b8; }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      border-radius: 8px;
      cursor: pointer;
      position: relative;
      background: #f5f6fa;
    }
    .calendar-day:hover { background: #e8f0ec; }
    .calendar-day.other-month { color: #ccc; background: transparent; }
    .calendar-day.today { background: #2d5a47; color: white; font-weight: 700; }
    .calendar-day.selected { border: 2px solid #c9a962; }
    .calendar-day.has-schedule::after {
      content: '';
      position: absolute;
      bottom: 4px;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #c9a962;
    }
    .calendar-day.today.has-schedule::after { background: white; }

    /* ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .faq-item {
      border-bottom: 1px solid #f0f0f0;
    }
    .faq-question {
      padding: 1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .faq-question:hover {
      background: #f8f8f8;
    }
    .faq-icon {
      font-size: 1.2rem;
    }
    .faq-arrow {
      margin-left: auto;
      color: #8a8a8a;
      transition: transform 0.3s;
    }
    .faq-item.open .faq-arrow {
      transform: rotate(180deg);
    }
    .faq-answer {
      display: none;
      padding: 0 1rem 1rem 3rem;
      font-size: 0.9rem;
      color: #5a5a5a;
      line-height: 1.8;
    }
    .faq-item.open .faq-answer {
      display: block;
    }
    .talk-box {
      background: #e8f0ec;
      border-radius: 12px;
      padding: 1rem;
      margin: 0.75rem 0;
      font-size: 0.9rem;
    }
    .talk-label {
      font-size: 0.75rem;
      color: #2d5a47;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

<!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-symbol">ç¤¼</div>
      <div class="login-logo-text">å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</div>
    </div>
    <h2 class="login-title">ãƒ­ã‚°ã‚¤ãƒ³</h2>
    <div id="loginError" class="error-box hidden"></div>
    <div class="form-group">
      <label class="form-label">ãŠåå‰</label>
      <input type="text" class="form-input" id="loginName" placeholder="å±±ç”°å¤ªéƒ">
    </div>
    <div class="form-group">
      <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" class="form-input" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <button class="btn btn-primary" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div class="login-footer">
      åˆã‚ã¦ã®æ–¹ã¯ <a href="javascript:void(0)" id="showRegisterLink">æ–°è¦ç™»éŒ²</a>
    </div>
  </div>
</div>

<!-- æ–°è¦ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="registerModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>æ–°è¦ç™»éŒ²</h3>
      <button class="modal-close" onclick="closeModal('registerModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div id="registerError" class="error-box hidden"></div>
      <div class="form-group">
        <label class="form-label">ãŠåå‰ *</label>
        <input type="text" class="form-input" id="registerName">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
        <input type="password" class="form-input" id="registerPass" placeholder="4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›" oninput="validatePassword()">
        <div class="form-hint" id="registerPassHint">â€» 4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('registerModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" id="registerBtn">ç™»éŒ²</button>
    </div>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
<div id="mainApp">
  <header class="header">
    <div class="header-inner">
      <div class="header-logo">ç¤¼ å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</div>
      <div class="header-user">
        <span id="userName"></span>
        <button class="header-logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- ãƒ›ãƒ¼ãƒ  -->
    <div class="page active" id="page-home">
      <div class="card" id="newNotifCard" style="display:none; background:linear-gradient(135deg, #ff6b6b, #ee5a5a); color:white;">
        <div class="card-body" onclick="switchPage('notifications')" style="cursor:pointer;">
          <div style="display:flex; align-items:center; gap:0.75rem;">
            <div style="font-size:1.5rem;">ğŸ””</div>
            <div style="flex:1;">
              <div style="font-weight:600;" id="newNotifTitle">æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™</div>
              <div style="font-size:0.8rem; opacity:0.9;" id="newNotifPreview"></div>
            </div>
            <div style="font-size:1.2rem;">â†’</div>
          </div>
        </div>
      </div>

      <div class="card" id="newTodoCard" style="display:none; background:linear-gradient(135deg, #ffc107, #e0a800); color:#1a1f2e;">
        <div class="card-body" onclick="switchPage('mytodos')" style="cursor:pointer;">
          <div style="display:flex; align-items:center; gap:0.75rem;">
            <div style="font-size:1.5rem;">ğŸ“‹</div>
            <div style="flex:1;">
              <div style="font-weight:600;" id="newTodoTitle">æœªå®Œäº†ã®TODOãŒã‚ã‚Šã¾ã™</div>
              <div style="font-size:0.8rem; opacity:0.9;" id="newTodoPreview"></div>
            </div>
            <div style="font-size:1.2rem;">â†’</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ¯ ä»Šæœˆã®ç›®æ¨™</span>
          <button class="btn btn-sm btn-secondary" onclick="openGoalModal()">è¨­å®š</button>
        </div>
        <div class="card-body">
          <div class="goal-section">
            <div class="goal-header">
              <span class="goal-title">è¨ªå•</span>
              <span class="goal-numbers"><span id="goalVisitCurrent">0</span> / <span id="goalVisitTarget">0</span></span>
            </div>
            <div class="goal-bar"><div class="goal-fill" id="goalVisitBar" style="width:0%"></div></div>
          </div>
          <div class="goal-section">
            <div class="goal-header">
              <span class="goal-title">å•†è«‡</span>
              <span class="goal-numbers"><span id="goalNegoCurrent">0</span> / <span id="goalNegoTarget">0</span></span>
            </div>
            <div class="goal-bar"><div class="goal-fill" id="goalNegoBar" style="width:0%"></div></div>
          </div>
          <div class="goal-section" style="margin-bottom:0">
            <div class="goal-header">
              <span class="goal-title">æˆç´„</span>
              <span class="goal-numbers"><span id="goalClosedCurrent">0</span> / <span id="goalClosedTarget">0</span></span>
            </div>
            <div class="goal-bar"><div class="goal-fill" id="goalClosedBar" style="width:0%"></div></div>
          </div>
        </div>
      </div>

      <div class="alert-card" id="followupAlert" style="display:none;">
        <div class="alert-card-title">âš ï¸ ãƒ•ã‚©ãƒ­ãƒ¼ãŒå¿…è¦ãªæ¡ˆä»¶</div>
        <div id="followupList"></div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">ä»Šæœˆã®è¨ªå•</div>
          <div class="stat-value" id="statMyVisits">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å•†è«‡ä¸­</div>
          <div class="stat-value" id="statNegotiating">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">æˆç´„</div>
          <div class="stat-value" id="statClosed">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä»Šæœˆã®çµŒè²»</div>
          <div class="stat-value" id="statExpense">Â¥0</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“… ä»Šæ—¥ã®äºˆå®š</span>
        </div>
        <div id="todaySchedule"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“‹ TODOï¼ˆæŒ‡ç¤ºï¼‰</span>
          <button class="btn btn-sm btn-secondary" onclick="switchPage('mytodos')">ã™ã¹ã¦è¦‹ã‚‹</button>
        </div>
        <div id="homeTodoList"></div>
      </div>
    </div>

    <!-- è¨ªå•å…ˆ -->
    <div class="page" id="page-prospects">
      <div class="card" style="background: linear-gradient(135deg, #2d5a47, #3d7a5f); color: white;">
        <div class="card-body" style="text-align:center;">
          <div style="font-size:0.85rem; opacity:0.9;">ç™»éŒ²è‘¬å„€ç¤¾</div>
          <div style="font-size:2rem; font-weight:700;" id="totalProspectsCount">0</div>
          <div style="font-size:0.8rem; opacity:0.8;" id="myProspectsCount">ã‚ãªãŸã®æ‹…å½“: 0ç¤¾</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“ ã‚¨ãƒªã‚¢ã‹ã‚‰é¸ã¶</span>
        </div>
        <div class="card-body" style="padding:0;">
          <div id="regionList"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-body" style="padding: 0.75rem;">
          <div style="display:flex; gap:0.5rem; flex-wrap:wrap;">
            <select class="form-input" id="filterRegion" style="flex:1; min-width:80px; padding:0.5rem;">
              <option value="">å…¨ã‚¨ãƒªã‚¢</option>
            </select>
            <select class="form-input" id="filterPref" style="flex:1; min-width:80px; padding:0.5rem;">
              <option value="">å…¨éƒ½é“åºœçœŒ</option>
            </select>
            <select class="form-input" id="filterStatus" style="flex:1; min-width:80px; padding:0.5rem;">
              <option value="">å…¨çŠ¶æ…‹</option>
              <option value="æœªè¨ªå•">æœªè¨ªå•</option>
              <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
              <option value="å•†è«‡ä¸­">å•†è«‡ä¸­</option>
              <option value="æˆç´„">æˆç´„</option>
            </select>
          </div>
        </div>
      </div>

      <div id="prospectsList"></div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <div class="page" id="page-schedule">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('scheduleTab', 'upcoming')">äºˆå®š</button>
        <button class="tab-btn" onclick="switchTab('scheduleTab', 'done')">å®Œäº†</button>
      </div>
      <div class="tab-content active" id="scheduleTab-upcoming">
        <div id="upcomingSchedules"></div>
      </div>
      <div class="tab-content" id="scheduleTab-done">
        <div id="doneSchedules"></div>
      </div>
      <button class="fab" onclick="openScheduleModal()">+</button>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <div class="page" id="page-calendar">
      <div class="card">
        <div class="card-header">
          <button class="btn btn-sm btn-secondary" onclick="changeMonth(-1)">â—€</button>
          <span class="card-title" id="calendarTitle">2026å¹´1æœˆ</span>
          <button class="btn btn-sm btn-secondary" onclick="changeMonth(1)">â–¶</button>
        </div>
        <div class="card-body" style="padding:0.5rem;">
          <div id="calendarGrid"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title" id="selectedDateTitle">äºˆå®š</span>
          <button class="btn btn-sm btn-primary" onclick="openScheduleModal()">+ è¿½åŠ </button>
        </div>
        <div id="selectedDateSchedules"></div>
      </div>
    </div>

    <!-- æ²ç¤ºæ¿ -->
    <div class="page" id="page-board">
      <div class="card" style="margin-bottom:60px;">
        <div id="postsList" style="max-height: calc(100vh - 220px); overflow-y: auto;"></div>
      </div>
      <div class="post-input-area" style="position:fixed; bottom:56px; left:0; right:0;">
        <input type="text" class="post-input" id="postInput" placeholder="æŠ•ç¨¿ã‚’å…¥åŠ›...">
        <button class="post-send" onclick="sendPost()">â†‘</button>
      </div>
    </div>

    <!-- ãã®ä»– -->
    <div class="page" id="page-more">
      <div class="card">
        <div class="list-item" onclick="switchPage('notifications')">
          <div class="list-item-icon">ğŸ””</div>
          <div class="list-item-content">
            <div class="list-item-title">é€šçŸ¥</div>
            <div class="list-item-sub" id="notifCount">0ä»¶ã®æœªèª­</div>
          </div>
          <div class="list-item-right">â†’</div>
        </div>
        <div class="list-item" onclick="switchPage('mytodos')">
          <div class="list-item-icon">ğŸ“‹</div>
          <div class="list-item-content">
            <div class="list-item-title">TODOï¼ˆæŒ‡ç¤ºï¼‰</div>
            <div class="list-item-sub" id="todoCount">0ä»¶ã®æœªå®Œäº†</div>
          </div>
          <div class="list-item-right">â†’</div>
        </div>
        <div class="list-item" onclick="switchPage('board')">
          <div class="list-item-icon">ğŸ’¬</div>
          <div class="list-item-content">
            <div class="list-item-title">æ²ç¤ºæ¿</div>
          </div>
          <div class="list-item-right">â†’</div>
        </div>
        <div class="list-item" onclick="switchPage('knowledge')">
          <div class="list-item-icon">ğŸ“š</div>
          <div class="list-item-content">
            <div class="list-item-title">ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰</div>
          </div>
          <div class="list-item-right">â†’</div>
        </div>
        <div class="list-item" onclick="switchPage('report')">
          <div class="list-item-icon">ğŸ“Š</div>
          <div class="list-item-content">
            <div class="list-item-title">é€±å ±ãƒ»æœˆå ±</div>
          </div>
          <div class="list-item-right">â†’</div>
        </div>
        <div class="list-item" onclick="switchPage('manual')">
          <div class="list-item-icon">ğŸ“–</div>
          <div class="list-item-content">
            <div class="list-item-title">å–¶æ¥­ãƒãƒ‹ãƒ¥ã‚¢ãƒ« / FAQ</div>
            <div class="list-item-sub">ã‚ˆãã‚ã‚‹è³ªå•ãƒ»å–¶æ¥­ãƒˆãƒ¼ã‚¯é›†</div>
          </div>
          <div class="list-item-right">â†’</div>
        </div>
      </div>
    </div>

    <!-- é€šçŸ¥ -->
    <div class="page" id="page-notifications">
      <button class="btn btn-secondary btn-sm" onclick="switchPage('more')" style="margin-bottom:1rem;">â† æˆ»ã‚‹</button>
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ”” é€šçŸ¥</span>
          <button class="btn btn-sm btn-secondary" onclick="markAllRead()">å…¨ã¦æ—¢èª­</button>
        </div>
        <div id="notificationsList"></div>
      </div>
    </div>

    <!-- TODO -->
    <div class="page" id="page-mytodos">
      <button class="btn btn-secondary btn-sm" onclick="switchPage('more')" style="margin-bottom:1rem;">â† æˆ»ã‚‹</button>
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“‹ TODOï¼ˆæŒ‡ç¤ºï¼‰</span>
        </div>
        <div id="myTodosList"></div>
      </div>
    </div>

    <!-- çµŒè²» -->
    <div class="page" id="page-expenses">
      <div class="expense-total">
        <div class="expense-total-label">ä»Šæœˆã®ç”³è«‹åˆè¨ˆ</div>
        <div class="expense-total-value" id="expenseTotal">Â¥0</div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">çµŒè²»ä¸€è¦§</span>
          <button class="btn btn-sm btn-primary" onclick="openExpenseModal()">+ ç”³è«‹</button>
        </div>
        <div id="expensesList"></div>
      </div>
    </div>

    <!-- ãƒŠãƒ¬ãƒƒã‚¸ -->
    <div class="page" id="page-knowledge">
      <button class="btn btn-secondary btn-sm" onclick="switchPage('more')" style="margin-bottom:1rem;">â† æˆ»ã‚‹</button>
      <div class="card">
        <div class="card-header">
          <span class="card-title">ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰</span>
          <button class="btn btn-sm btn-primary" onclick="openKnowledgeModal()">+ æŠ•ç¨¿</button>
        </div>
      </div>
      <div id="knowledgeList"></div>
    </div>

    <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="page" id="page-ranking">
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ† è¨ªå•æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
        </div>
        <div id="rankingList"></div>
      </div>
    </div>

    <!-- é€±å ±ãƒ»æœˆå ± -->
    <div class="page" id="page-report">
      <button class="btn btn-secondary btn-sm" onclick="switchPage('more')" style="margin-bottom:1rem;">â† æˆ»ã‚‹</button>
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“Š ä»Šæœˆã®ãƒ¬ãƒãƒ¼ãƒˆ</span>
        </div>
        <div class="card-body">
          <div class="report-section">
            <div class="report-title">å–¶æ¥­æ´»å‹•</div>
            <div class="report-grid">
              <div class="report-item">
                <div class="report-value" id="reportVisits">0</div>
                <div class="report-label">è¨ªå•</div>
              </div>
              <div class="report-item">
                <div class="report-value" id="reportNego">0</div>
                <div class="report-label">å•†è«‡</div>
              </div>
              <div class="report-item">
                <div class="report-value" id="reportClosed">0</div>
                <div class="report-label">æˆç´„</div>
              </div>
            </div>
          </div>
          <div class="report-section">
            <div class="report-title">çµŒè²»</div>
            <div class="report-grid">
              <div class="report-item">
                <div class="report-value" id="reportExpense">Â¥0</div>
                <div class="report-label">åˆè¨ˆ</div>
              </div>
              <div class="report-item">
                <div class="report-value" id="reportExpenseCount">0</div>
                <div class="report-label">ä»¶æ•°</div>
              </div>
              <div class="report-item">
                <div class="report-value" id="reportTransport">Â¥0</div>
                <div class="report-label">äº¤é€šè²»</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- å–¶æ¥­ãƒãƒ‹ãƒ¥ã‚¢ãƒ« / FAQï¼ˆæ–°è¦è¿½åŠ ï¼‰ -->
    <div class="page" id="page-manual">
      <button class="btn btn-secondary btn-sm" onclick="switchPage('more')" style="margin-bottom:1rem;">â† æˆ»ã‚‹</button>
      
      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“š åŸºç¤çŸ¥è­˜</span>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">â“</span>
            <span>ã€ŒçŒ®æ¯ã€ã¨ã€Œé¦™å…¸ã€ã®é•ã„ã¯ï¼Ÿ</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>é¦™å…¸ï¼ˆã“ã†ã§ã‚“ï¼‰</strong></p>
            <p>ãƒ»è‘¬å„€ã«å‚åˆ—ã™ã‚‹éš›ã«æŒå‚ã™ã‚‹é‡‘éŠ­</p>
            <p>ãƒ»å°ç­’ã«å…¥ã‚Œã¦ç›´æ¥æ‰‹æ¸¡ã—</p>
            <p>ãƒ»ç¾é‡‘ã®ã¿</p>
            <br>
            <p><strong>çŒ®æ¯ï¼ˆã‘ã‚“ã±ã„ï¼‰</strong></p>
            <p>ãƒ»é æ–¹ãªã©ã§å‚åˆ—ã§ããªã„æ–¹ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§é€ã‚‹å¼”æ„</p>
            <p>ãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆ</p>
            <p>ãƒ»ã‚¹ãƒãƒ›ã‹ã‚‰24æ™‚é–“ã„ã¤ã§ã‚‚å¯èƒ½</p>
            <p>ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚æ·»ãˆã‚‰ã‚Œã‚‹</p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œé¦™å…¸ã¯å‚åˆ—ã•ã‚Œã‚‹æ–¹ã‹ã‚‰ã„ãŸã ãã¾ã™ãŒã€é æ–¹ã§ã©ã†ã—ã¦ã‚‚æ¥ã‚‰ã‚Œãªã„æ–¹ã‚‚ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã‚ˆã­ã€‚ãã†ã„ã£ãŸæ–¹ãŒ"æ°—æŒã¡ã ã‘ã§ã‚‚å±Šã‘ãŸã„"ã¨ã„ã†æ™‚ã«ä½¿ãˆã‚‹ã®ãŒã€çŒ®æ¯ã€ã§ã™ã€‚é¦™å…¸ã®ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ç‰ˆã¨ãŠè€ƒãˆãã ã•ã„ã€‚ã€
            </div>
          </div>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸ’°</span>
            <span>æ‰‹æ•°æ–™ã¨æ”¯æ‰•ã„æ–¹æ³•ã¯ï¼Ÿ</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>æ‰‹æ•°æ–™</strong></p>
            <p>ãƒ»çŒ®æ¯1ä»¶ã«ã¤ã <strong>11.6%</strong></p>
            <p>ã€€- Stripeæ±ºæ¸ˆæ‰‹æ•°æ–™: 3.6%</p>
            <p>ã€€- ã‚·ã‚¹ãƒ†ãƒ åˆ©ç”¨æ–™: 8%</p>
            <p>ãƒ»éºæ—ã¸ã®æ”¯æ‰•ã„: <strong>88.4%</strong></p>
            <br>
            <p><strong>è«‹æ±‚ãƒ»æ”¯æ‰•ã„æ–¹æ³•</strong></p>
            <p>ãƒ»<strong>æœˆæœ«ç· ã‚</strong>ã§é›†è¨ˆ</p>
            <p>ãƒ»ç¿Œæœˆã«è«‹æ±‚æ›¸ã‚’ç™ºè¡Œ</p>
            <p>ãƒ»è‘¬å„€ç¤¾æ§˜ã‹ã‚‰å¼Šç¤¾ã¸ãŠæ”¯æ‰•ã„</p>
            <br>
            <p><strong>éºæ—ã¸ã®æ”¯æ‰•ã„</strong></p>
            <p>ãƒ»è‘¬å„€ç¤¾æ§˜ã‹ã‚‰éºæ—æ§˜ã¸ç›´æ¥ãŠæ¸¡ã—</p>
            <p>ãƒ»ã¾ãŸã¯æŒ¯è¾¼ï¼ˆè‘¬å„€ç¤¾æ§˜ã«ãŠä»»ã›ï¼‰</p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œæ‰‹æ•°æ–™ã¯11.6%ã§ã€éºæ—æ§˜ã«ã¯88.4%ãŒå±Šãã¾ã™ã€‚æœˆæœ«ç· ã‚ã§ç¿Œæœˆã«è«‹æ±‚æ›¸ã‚’ãŠé€ã‚Šã—ã¾ã™ã®ã§ã€ã¾ã¨ã‚ã¦ãŠæ”¯æ‰•ã„ã„ãŸã ã‘ã¾ã™ã€‚ã€
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</span>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸ›¡ï¸</span>
            <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã¯å®‰å…¨ï¼Ÿ</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>Stripeã‚’ä½¿ç”¨</strong></p>
            <p>ãƒ»ä¸–ç•Œæœ€å¤§ç´šã®æ±ºæ¸ˆãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </p>
            <p>ãƒ»Amazonã€Googleã€Shopifyãªã©ã‚‚æ¡ç”¨</p>
            <p>ãƒ»PCI DSS Level 1èªè¨¼å–å¾—ï¼ˆæœ€é«˜ãƒ¬ãƒ™ãƒ«ï¼‰</p>
            <br>
            <p><strong>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</strong></p>
            <p>ãƒ»ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯å¼Šç¤¾ã‚µãƒ¼ãƒãƒ¼ã‚’é€šéã—ãªã„</p>
            <p>ãƒ»SSL/TLSæš—å·åŒ–é€šä¿¡</p>
            <p>ãƒ»ä¸æ­£åˆ©ç”¨æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ </p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œæ±ºæ¸ˆã¯Stripeã¨ã„ã†ä¸–ç•Œæœ€å¤§ã®æ±ºæ¸ˆä¼šç¤¾ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚Amazonã‚„Googleã‚‚ä½¿ã£ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã€ã‚«ãƒ¼ãƒ‰æƒ…å ±ã¯ç§ãŸã¡ã®ã‚µãƒ¼ãƒãƒ¼ã«ã¯ä¸€åˆ‡æ®‹ã‚Šã¾ã›ã‚“ã€‚éŠ€è¡Œã®ATMã¨åŒã˜ãã‚‰ã„å®‰å…¨ã¨ãŠè€ƒãˆãã ã•ã„ã€‚ã€
            </div>
          </div>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸ‘¤</span>
            <span>å€‹äººæƒ…å ±ã®å–ã‚Šæ‰±ã„ã¯ï¼Ÿ</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>åé›†ã™ã‚‹æƒ…å ±</strong></p>
            <p>ãƒ»çŒ®æ¯è€…ã®æ°åï¼ˆåŒ¿åã‚‚å¯ï¼‰</p>
            <p>ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆä»»æ„ï¼‰</p>
            <p>ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ï¼ˆä»»æ„ãƒ»ãŠè¿”ã—ç”¨ï¼‰</p>
            <br>
            <p><strong>åˆ©ç”¨ç›®çš„</strong></p>
            <p>ãƒ»çŒ®æ¯ã®å‡¦ç†ã®ã¿ã«ä½¿ç”¨</p>
            <p>ãƒ»éºæ—ã¸ã®æƒ…å ±æä¾›</p>
            <p>ãƒ»ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç­‰ã«ã¯ä½¿ç”¨ã—ãªã„</p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œå€‹äººæƒ…å ±ã¯çŒ®æ¯ã®å‡¦ç†ã¨éºæ—æ§˜ã¸ã®ãŠçŸ¥ã‚‰ã›ä»¥å¤–ã«ã¯ä½¿ã„ã¾ã›ã‚“ã€‚åºƒå‘Šã‚„DMã«ä½¿ã†ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã®ã§ã”å®‰å¿ƒãã ã•ã„ã€‚ã€
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ¯ å–¶æ¥­ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ</span>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸš€</span>
            <span>æœ€åˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>ã‚¹ãƒ†ãƒƒãƒ—1: èª²é¡Œã®ç¢ºèª</strong></p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œæœ€è¿‘ã€é æ–¹ã‹ã‚‰ã®å‚åˆ—ãŒé›£ã—ã„ã¨ã„ã†å£°ã¯å¢—ãˆã¦ã„ã¾ã™ã‹ï¼Ÿã€<br>
              ã€Œã‚³ãƒ­ãƒŠä»¥é™ã€å®¶æ—è‘¬ãŒå¢—ãˆã¦ã€é¦™å…¸ã‚’æ¸¡ã›ãªã‹ã£ãŸæ–¹ã‹ã‚‰ã®å•ã„åˆã‚ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã€
            </div>
            <br>
            <p><strong>ã‚¹ãƒ†ãƒƒãƒ—2: è§£æ±ºç­–ã®æç¤º</strong></p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œå®Ÿã¯ã€ãã†ã„ã£ãŸæ–¹å‘ã‘ã«"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§é¦™å…¸ã‚’é€ã‚Œã‚‹"ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ã‚“ã§ã™ã€‚éºæ—æ§˜ã«ã¨ã£ã¦ã‚‚ã€å‚åˆ—ã§ããªã„æ–¹ã‹ã‚‰ã®ãŠæ°—æŒã¡ã‚’å—ã‘å–ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚ã€
            </div>
            <br>
            <p><strong>ã‚¹ãƒ†ãƒƒãƒ—3: å°å…¥ãƒ¡ãƒªãƒƒãƒˆ</strong></p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å–¶æ¥­ãƒˆãƒ¼ã‚¯ä¾‹</div>
              ã€Œå¾¡ç¤¾ã¨ã—ã¦ã‚‚ã€éºæ—æ§˜ã¸ã®ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã«ãªã‚Šã¾ã™ã—ã€åˆæœŸè²»ç”¨ã‚„æœˆé¡è²»ç”¨ã¯ã‹ã‹ã‚Šã¾ã›ã‚“ã€‚çŒ®æ¯ãŒã‚ã£ãŸæ™‚ã ã‘æ‰‹æ•°æ–™ãŒç™ºç”Ÿã™ã‚‹å½¢ã§ã™ã€‚ã€
            </div>
          </div>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸ¤”</span>
            <span>ã‚ˆãã‚ã‚‹åè«–ã¸ã®å¯¾å¿œ</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>ã€Œã†ã¡ã¯å¿…è¦ãªã„ã€</strong></p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å¯¾å¿œä¾‹</div>
              ã€ŒãŠã£ã—ã‚ƒã‚‹é€šã‚Šã€å…¨ã¦ã®è‘¬å„€ã§ä½¿ã‚ã‚Œã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãŸã ã€ã„ã–"é æ–¹ã®æ–¹ãŒå‚åˆ—ã§ããªã„"ã¨ãªã£ãŸæ™‚ã«ã€ã”æ¡ˆå†…ã§ãã‚‹é¸æŠè‚¢ãŒã‚ã‚‹ã¨éºæ—æ§˜ã«å–œã°ã‚Œã¾ã™ã€‚å°å…¥ã—ã¦ãŠã„ã¦æã¯ãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚ã€
            </div>
            <br>
            <p><strong>ã€Œé«˜é½¢è€…ã¯ãƒãƒƒãƒˆã‚’ä½¿ãˆãªã„ã€</strong></p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å¯¾å¿œä¾‹</div>
              ã€ŒçŒ®æ¯ã‚’é€ã‚‹ã®ã¯å‚åˆ—ã§ããªã„æ–¹ã€ã¤ã¾ã‚Šé æ–¹ã®è¦ªæˆšã‚„å‹äººã§ã™ã€‚æ¯”è¼ƒçš„è‹¥ã„ä¸–ä»£ã‚‚å¤šã„ã§ã™ã—ã€ãŠå­ã•ã‚“ã‚„ãŠå­«ã•ã‚“ãŒä»£ã‚ã‚Šã«æ“ä½œã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ã‚‚å¤šã„ã§ã™ã€‚ã€
            </div>
            <br>
            <p><strong>ã€Œæ‰‹æ•°æ–™ãŒé«˜ã„ã€</strong></p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å¯¾å¿œä¾‹</div>
              ã€Œ11.6%ã®ã†ã¡3.6%ã¯ã‚«ãƒ¼ãƒ‰ä¼šç¤¾ã¸ã®æ‰‹æ•°æ–™ã§ã™ã®ã§ã€å®Ÿè³ª8%ã§ã™ã€‚åˆæœŸè²»ç”¨ã‚„æœˆé¡è²»ç”¨ãŒãªã„ã®ã§ã€ä½¿ã£ãŸåˆ†ã ã‘ã®ãŠæ”¯æ‰•ã„ã§ã™ã€‚ã€
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ğŸ“ å•ã„åˆã‚ã›å¯¾å¿œ</span>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">âŒ</span>
            <span>çŒ®æ¯ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã„</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>åŸºæœ¬æ–¹é‡</strong></p>
            <p>ãƒ»æ±ºæ¸ˆå®Œäº†å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯åŸå‰‡ä¸å¯</p>
            <p>ãƒ»æ±ºæ¸ˆå‰ï¼ˆStripeç”»é¢ã§ã‚„ã‚ãŸå ´åˆï¼‰ã¯å•é¡Œãªã—</p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å¯¾å¿œä¾‹</div>
              ã€Œç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ãŒã€çŒ®æ¯ã¯æ±ºæ¸ˆå®Œäº†å¾Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯æ‰¿ã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚é¦™å…¸ã¨åŒæ§˜ã€ä¸€åº¦ãŠæ¸¡ã—ã—ãŸã‚‚ã®ã¯ãŠè¿”ã—ã§ããªã„ã¨ãŠè€ƒãˆãã ã•ã„ã€‚ã€
            </div>
            <p style="margin-top:0.5rem; font-size:0.8rem; color:#8a8a8a;">â€»ç‰¹åˆ¥ãªäº‹æƒ…ãŒã‚ã‚‹å ´åˆã¯ç®¡ç†è€…ã«ç›¸è«‡</p>
          </div>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸ“§</span>
            <span>é ˜åæ›¸ãŒã»ã—ã„</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>å¯¾å¿œæ–¹æ³•</strong></p>
            <p>ãƒ»Stripeã‹ã‚‰è‡ªå‹•ã§é ˜åæ›¸ãƒ¡ãƒ¼ãƒ«ãŒå±Šã</p>
            <p>ãƒ»å±Šã„ã¦ã„ãªã„å ´åˆã¯è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèª</p>
            <div class="talk-box">
              <div class="talk-label">ğŸ’¬ å¯¾å¿œä¾‹</div>
              ã€Œæ±ºæ¸ˆå®Œäº†æ™‚ã«ã”ç™»éŒ²ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«é ˜åæ›¸ãŒå±Šã„ã¦ãŠã‚Šã¾ã™ã€‚ã‚‚ã—å±Šã„ã¦ã„ãªã„å ´åˆã¯ã€è¿·æƒ‘ãƒ¡ãƒ¼ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ã€
            </div>
          </div>
        </div>
        <div class="faq-item" onclick="toggleFaq(this)">
          <div class="faq-question">
            <span class="faq-icon">ğŸ”§</span>
            <span>ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œãªã„</span>
            <span class="faq-arrow">â–¼</span>
          </div>
          <div class="faq-answer">
            <p><strong>ç¢ºèªãƒã‚¤ãƒ³ãƒˆ</strong></p>
            <p>1. URLãŒæ­£ã—ã„ã‹ç¢ºèª</p>
            <p>2. ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢</p>
            <p>3. åˆ¥ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§è©¦ã™</p>
            <p>4. Wi-Fi / ãƒ¢ãƒã‚¤ãƒ«å›ç·šã‚’åˆ‡ã‚Šæ›¿ãˆ</p>
            <p style="margin-top:0.5rem; font-size:0.8rem; color:#8a8a8a;">â€»ä¸Šè¨˜ã§è§£æ±ºã—ãªã„å ´åˆã¯ç®¡ç†è€…ã«é€£çµ¡</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ä¸‹éƒ¨ãƒŠãƒ“ -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-page="home">
      <span class="nav-btn-icon">ğŸ </span>
      <span>ãƒ›ãƒ¼ãƒ </span>
    </button>
    <button class="nav-btn" data-page="prospects">
      <span class="nav-btn-icon">ğŸ¢</span>
      <span>è¨ªå•å…ˆ</span>
    </button>
    <button class="nav-btn" data-page="calendar">
      <span class="nav-btn-icon">ğŸ“…</span>
      <span>äºˆå®š</span>
    </button>
    <button class="nav-btn" data-page="ranking">
      <span class="nav-btn-icon">ğŸ†</span>
      <span>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</span>
    </button>
    <button class="nav-btn" data-page="expenses">
      <span class="nav-btn-icon">ğŸ’°</span>
      <span>çµŒè²»</span>
    </button>
    <button class="nav-btn" data-page="more">
      <span class="nav-btn-icon">â‰¡</span>
      <span>ãã®ä»–</span>
    </button>
  </nav>
</div>

<!-- è‘¬å„€ç¤¾è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="prospectDetailModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>è‘¬å„€ç¤¾è©³ç´°</h3>
      <button class="modal-close" onclick="closeModal('prospectDetailModal')">&times;</button>
    </div>
    <div class="modal-content">
      <input type="hidden" id="selectedProspectId">
      <div id="prospectDetailContent"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('prospectDetailModal')">é–‰ã˜ã‚‹</button>
      <button class="btn btn-secondary" id="unassignBtn" onclick="unassignProspect()" style="display:none;">æ‹…å½“è§£é™¤</button>
      <button class="btn btn-primary" id="assignBtn" onclick="assignProspect()">æ‹…å½“ã™ã‚‹</button>
      <button class="btn btn-primary" onclick="updateProspectStatus()">æ›´æ–°</button>
    </div>
  </div>
</div>

<!-- è¨ªå•å…ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="prospectModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3 id="prospectModalTitle">è¨ªå•å…ˆã‚’è¿½åŠ </h3>
      <button class="modal-close" onclick="closeModal('prospectModal')">&times;</button>
    </div>
    <div class="modal-content">
      <input type="hidden" id="prospectId">
      <div class="form-group">
        <label class="form-label">è‘¬å„€ç¤¾å *</label>
        <input type="text" class="form-input" id="pName">
      </div>
      <div class="form-group">
        <label class="form-label">éƒ½é“åºœçœŒ *</label>
        <input type="text" class="form-input" id="pArea" placeholder="ä¾‹ï¼šå¤§é˜ªåºœ">
      </div>
      <div class="form-group">
        <label class="form-label">é›»è©±ç•ªå·</label>
        <input type="tel" class="form-input" id="pPhone">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select class="form-input" id="pStatus">
          <option value="æœªè¨ªå•">æœªè¨ªå•</option>
          <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
          <option value="å•†è«‡ä¸­">å•†è«‡ä¸­</option>
          <option value="æˆç´„">æˆç´„</option>
          <option value="è¦‹é€ã‚Š">è¦‹é€ã‚Š</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢</label>
        <textarea class="form-input" id="pNotes" rows="2"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('prospectModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveProspect()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="scheduleModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>äºˆå®šã‚’è¿½åŠ </h3>
      <button class="modal-close" onclick="closeModal('scheduleModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">è¨ªå•å…ˆ *</label>
        <select class="form-input" id="sProspect"></select>
      </div>
      <div class="form-group">
        <label class="form-label">è¨ªå•äºˆå®šæ—¥ *</label>
        <input type="date" class="form-input" id="sDate">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ¡ãƒ¢</label>
        <input type="text" class="form-input" id="sMemo">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('scheduleModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveSchedule()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ç›®æ¨™ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="goalModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>ä»Šæœˆã®ç›®æ¨™ã‚’è¨­å®š</h3>
      <button class="modal-close" onclick="closeModal('goalModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">è¨ªå•ç›®æ¨™ï¼ˆä»¶ï¼‰</label>
        <input type="number" class="form-input" id="gVisit" placeholder="ä¾‹ï¼š20">
      </div>
      <div class="form-group">
        <label class="form-label">å•†è«‡ç›®æ¨™ï¼ˆä»¶ï¼‰</label>
        <input type="number" class="form-input" id="gNego" placeholder="ä¾‹ï¼š5">
      </div>
      <div class="form-group">
        <label class="form-label">æˆç´„ç›®æ¨™ï¼ˆä»¶ï¼‰</label>
        <input type="number" class="form-input" id="gClosed" placeholder="ä¾‹ï¼š1">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('goalModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveGoal()">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- çµŒè²»ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="expenseModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>çµŒè²»ã‚’ç”³è«‹</h3>
      <button class="modal-close" onclick="closeModal('expenseModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">æ—¥ä»˜ *</label>
        <input type="date" class="form-input" id="eDate">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-input" id="eCategory">
          <option value="äº¤é€šè²»">ğŸšƒ äº¤é€šè²»</option>
          <option value="ã‚¬ã‚½ãƒªãƒ³ä»£">â›½ ã‚¬ã‚½ãƒªãƒ³ä»£</option>
          <option value="é§è»Šå ´ä»£">ğŸ…¿ï¸ é§è»Šå ´ä»£</option>
          <option value="æ¥å¾…è²»">ğŸ½ï¸ æ¥å¾…è²»</option>
          <option value="å®¿æ³Šè²»">ğŸ¨ å®¿æ³Šè²»</option>
          <option value="ãã®ä»–">ğŸ“ ãã®ä»–</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">é‡‘é¡ *</label>
        <input type="number" class="form-input" id="eAmount" placeholder="1000">
      </div>
      <div class="form-group">
        <label class="form-label">å†…å®¹</label>
        <input type="text" class="form-input" id="eDescription">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('expenseModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveExpense()">ç”³è«‹</button>
    </div>
  </div>
</div>

<!-- ãƒŠãƒ¬ãƒƒã‚¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="knowledgeModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>ãƒŠãƒ¬ãƒƒã‚¸ã‚’æŠ•ç¨¿</h3>
      <button class="modal-close" onclick="closeModal('knowledgeModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
        <select class="form-input" id="kCategory">
          <option value="æˆåŠŸäº‹ä¾‹">ğŸ“ˆ æˆåŠŸäº‹ä¾‹</option>
          <option value="å¤±æ•—äº‹ä¾‹">ğŸ“‰ å¤±æ•—äº‹ä¾‹</option>
          <option value="FAQ">â“ FAQ</option>
          <option value="Tips">ğŸ’¡ Tips</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
        <input type="text" class="form-input" id="kTitle">
      </div>
      <div class="form-group">
        <label class="form-label">å†…å®¹ *</label>
        <textarea class="form-input" id="kContent" rows="4"></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('knowledgeModal')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-primary" onclick="saveKnowledge()">æŠ•ç¨¿</button>
    </div>
  </div>
</div>

<!-- TODOè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-bg" id="todoDetailModal">
  <div class="modal-box">
    <div class="modal-head">
      <h3>ğŸ“‹ TODOè©³ç´°</h3>
      <button class="modal-close" onclick="closeModal('todoDetailModal')">&times;</button>
    </div>
    <div class="modal-content">
      <div id="todoDetailContent"></div>
      <hr style="border:none; border-top:1px solid #e5e2dd; margin:1rem 0;">
      <div class="form-group">
        <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
        <select class="form-input" id="todoStatus">
          <option value="æœªç€æ‰‹">æœªç€æ‰‹</option>
          <option value="ç¢ºèªæ¸ˆã¿">ç¢ºèªæ¸ˆã¿</option>
          <option value="å–çµ„ä¸­">å–çµ„ä¸­</option>
          <option value="å®Œäº†">å®Œäº†</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">å®Œäº†äºˆå®šæ—¥</label>
        <input type="date" class="form-input" id="todoEstimatedDate">
      </div>
      <div class="form-group">
        <label class="form-label">è¿”ä¿¡ãƒ»ã‚³ãƒ¡ãƒ³ãƒˆ</label>
        <textarea class="form-input" id="todoReply" rows="3" placeholder="é€²æ—ã‚„è³ªå•ãªã©..."></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeModal('todoDetailModal')">é–‰ã˜ã‚‹</button>
      <button class="btn btn-primary" onclick="updateTodoStatus()">æ›´æ–°</button>
    </div>
  </div>
</div>

<script>
var supabase;
var currentUser = null;
var prospects = [];
var members = [];
var schedules = [];
var expenses = [];
var knowledge = [];
var posts = [];
var myGoal = null;
var notifications = [];
var myTodos = [];
var selectedTodoId = null;
var currentCalendarDate = new Date();
var selectedDate = null;

var REGIONS = ['åŒ—æµ·é“', 'æ±åŒ—', 'é–¢æ±', 'åŒ—é™¸', 'æ±æµ·', 'é–¢è¥¿', 'ä¸­å›½', 'å››å›½', 'ä¹å·'];
var PREFECTURES = {
  'åŒ—æµ·é“': ['åŒ—æµ·é“'],
  'æ±åŒ—': ['é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ'],
  'é–¢æ±': ['æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ'],
  'åŒ—é™¸': ['æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ'],
  'æ±æµ·': ['å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ'],
  'é–¢è¥¿': ['æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ'],
  'ä¸­å›½': ['é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ'],
  'å››å›½': ['å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ'],
  'ä¹å·': ['ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ']
};

var SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';

window.onload = function() {
  supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  var saved = localStorage.getItem('salesUser');
  if (saved) {
    currentUser = JSON.parse(saved);
    showMainApp();
  }
  document.getElementById('eDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('sDate').value = new Date().toISOString().split('T')[0];
  setupEvents();
};

function validatePassword() {
  var pass = document.getElementById('registerPass').value;
  var hint = document.getElementById('registerPassHint');
  var input = document.getElementById('registerPass');
  
  if (pass.length === 0) {
    hint.textContent = 'â€» 4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„';
    hint.classList.remove('error');
    hint.style.color = '#8a8a8a';
    input.classList.remove('error');
  } else if (pass.length < 4) {
    hint.textContent = 'âš ï¸ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šå¿…è¦ã§ã™ï¼ˆç¾åœ¨' + pass.length + 'æ–‡å­—ï¼‰';
    hint.classList.add('error');
    hint.style.color = '#dc3545';
    input.classList.add('error');
  } else {
    hint.textContent = 'âœ“ OK';
    hint.classList.remove('error');
    hint.style.color = '#28a745';
    input.classList.remove('error');
  }
}

function toggleFaq(el) {
  el.classList.toggle('open');
}

function setupEvents() {
  document.getElementById('loginBtn').onclick = doLogin;
  document.getElementById('showRegisterLink').onclick = function() {
    document.getElementById('registerModal').classList.add('show');
  };
  document.getElementById('registerBtn').onclick = doRegister;
  document.getElementById('logoutBtn').onclick = doLogout;
  
  var navBtns = document.querySelectorAll('.bottom-nav .nav-btn');
  for (var i = 0; i < navBtns.length; i++) {
    navBtns[i].onclick = function() {
      switchPage(this.getAttribute('data-page'));
    };
  }
  
  document.getElementById('filterStatus').onchange = renderProspects;
  document.getElementById('filterRegion').onchange = function() {
    updatePrefectureFilter();
    renderProspects();
  };
  document.getElementById('filterPref').onchange = renderProspects;
}

function closeModal(id) { document.getElementById(id).classList.remove('show'); }
function openModal(id) { document.getElementById(id).classList.add('show'); }

function doLogin() {
  var name = document.getElementById('loginName').value.trim();
  var pass = document.getElementById('loginPass').value;
  if (!name || !pass) { showError('loginError', 'åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  supabase.from('sales_members').select('*').eq('name', name).eq('password_hash', pass).single()
    .then(function(r) {
      if (r.error || !r.data) { showError('loginError', 'åå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™'); return; }
      currentUser = r.data;
      localStorage.setItem('salesUser', JSON.stringify(currentUser));
      showMainApp();
    });
}

function doRegister() {
  var name = document.getElementById('registerName').value.trim();
  var pass = document.getElementById('registerPass').value;
  if (!name || !pass) { showError('registerError', 'åå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (pass.length < 4) {
    showError('registerError', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
    document.getElementById('registerPass').classList.add('error');
    return;
  }
  supabase.from('sales_members').insert({ name: name, password_hash: pass }).select().single()
    .then(function(r) {
      if (r.error) { showError('registerError', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
      currentUser = r.data;
      localStorage.setItem('salesUser', JSON.stringify(currentUser));
      closeModal('registerModal');
      showMainApp();
    });
}

function doLogout() {
  currentUser = null;
  localStorage.removeItem('salesUser');
  document.getElementById('mainApp').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function showError(id, msg) {
  var el = document.getElementById(id);
  el.textContent = msg;
  el.classList.remove('hidden');
}

function showMainApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('userName').textContent = currentUser.name;
  loadData();
}

function loadData() {
  supabase.from('sales_members').select('*').then(function(r) { members = r.data || []; renderRanking(); });
  supabase.from('sales_prospects').select('*').order('created_at', { ascending: false }).then(function(r) { 
    prospects = r.data || []; 
    updateStats(); 
    renderProspects(); 
    updateFollowups();
    updateScheduleProspects();
  });
  supabase.from('sales_schedules').select('*').eq('member_id', currentUser.id).order('scheduled_date', { ascending: true }).then(function(r) { 
    schedules = r.data || []; 
    renderSchedules(); 
    renderTodaySchedule();
    renderCalendar();
  });
  supabase.from('sales_expenses').select('*').eq('member_id', currentUser.id).order('expense_date', { ascending: false }).then(function(r) { 
    expenses = r.data || []; 
    updateStats(); 
    renderExpenses(); 
    updateReport();
  });
  supabase.from('sales_knowledge').select('*').order('created_at', { ascending: false }).then(function(r) { knowledge = r.data || []; renderKnowledge(); });
  supabase.from('sales_posts').select('*').order('created_at', { ascending: false }).limit(50).then(function(r) { posts = r.data || []; renderPosts(); });
  supabase.from('sales_notifications').select('*').eq('member_id', currentUser.id).order('created_at', { ascending: false }).then(function(r) {
    notifications = r.data || [];
    renderNotifications();
  });
  supabase.from('sales_todos').select('*').eq('member_id', currentUser.id).order('created_at', { ascending: false }).then(function(r) {
    myTodos = r.data || [];
    renderMyTodos();
  });
  var month = new Date().toISOString().slice(0, 7);
  supabase.from('sales_goals').select('*').eq('member_id', currentUser.id).eq('month', month).single().then(function(r) {
    myGoal = r.data || null;
    updateGoalDisplay();
  });
}

function switchPage(page) {
  var navBtns = document.querySelectorAll('.bottom-nav .nav-btn');
  var pages = document.querySelectorAll('.page');
  for (var i = 0; i < navBtns.length; i++) {
    navBtns[i].classList.remove('active');
    if (navBtns[i].getAttribute('data-page') === page) navBtns[i].classList.add('active');
  }
  for (var i = 0; i < pages.length; i++) pages[i].classList.remove('active');
  document.getElementById('page-' + page).classList.add('active');
}

function switchTab(prefix, tab) {
  var btns = document.querySelectorAll('.tab-btn');
  var contents = document.querySelectorAll('.tab-content');
  for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
  for (var i = 0; i < contents.length; i++) contents[i].classList.remove('active');
  event.target.classList.add('active');
  document.getElementById(prefix + '-' + tab).classList.add('active');
}

function updateStats() {
  var myProspects = prospects.filter(function(p) { return p.assigned_to === currentUser.id; });
  var visits = myProspects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
  var nego = myProspects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
  var closed = myProspects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
  var now = new Date();
  var thisMonth = now.getMonth();
  var thisYear = now.getFullYear();
  var monthExp = 0;
  for (var i = 0; i < expenses.length; i++) {
    var d = new Date(expenses[i].expense_date);
    if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) monthExp += expenses[i].amount;
  }
  document.getElementById('statMyVisits').textContent = visits;
  document.getElementById('statNegotiating').textContent = nego;
  document.getElementById('statClosed').textContent = closed;
  document.getElementById('statExpense').textContent = 'Â¥' + monthExp.toLocaleString();
}

function updateGoalDisplay() {
  var myProspects = prospects.filter(function(p) { return p.assigned_to === currentUser.id; });
  var visits = myProspects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
  var nego = myProspects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
  var closed = myProspects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
  var vTarget = myGoal ? myGoal.visit_goal : 0;
  var nTarget = myGoal ? myGoal.negotiation_goal : 0;
  var cTarget = myGoal ? myGoal.closed_goal : 0;
  document.getElementById('goalVisitCurrent').textContent = visits;
  document.getElementById('goalVisitTarget').textContent = vTarget;
  document.getElementById('goalNegoCurrent').textContent = nego;
  document.getElementById('goalNegoTarget').textContent = nTarget;
  document.getElementById('goalClosedCurrent').textContent = closed;
  document.getElementById('goalClosedTarget').textContent = cTarget;
  var vPct = vTarget > 0 ? Math.min(100, (visits / vTarget) * 100) : 0;
  var nPct = nTarget > 0 ? Math.min(100, (nego / nTarget) * 100) : 0;
  var cPct = cTarget > 0 ? Math.min(100, (closed / cTarget) * 100) : 0;
  document.getElementById('goalVisitBar').style.width = vPct + '%';
  document.getElementById('goalNegoBar').style.width = nPct + '%';
  document.getElementById('goalClosedBar').style.width = cPct + '%';
  if (visits >= vTarget && vTarget > 0) document.getElementById('goalVisitBar').classList.add('over');
  if (nego >= nTarget && nTarget > 0) document.getElementById('goalNegoBar').classList.add('over');
  if (closed >= cTarget && cTarget > 0) document.getElementById('goalClosedBar').classList.add('over');
}

function updateFollowups() {
  var now = new Date();
  var sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
  var followups = prospects.filter(function(p) {
    if (p.assigned_to !== currentUser.id) return false;
    if (p.status === 'æˆç´„' || p.status === 'è¦‹é€ã‚Š') return false;
    var updated = new Date(p.updated_at);
    return updated < sevenDaysAgo;
  });
  var container = document.getElementById('followupList');
  var alert = document.getElementById('followupAlert');
  var html = '';
  for (var i = 0; i < Math.min(3, followups.length); i++) {
    html += '<div class="alert-card-item">ãƒ»' + esc(followups[i].company_name) + '</div>';
  }
  if (followups.length > 3) html += '<div class="alert-card-item">ä»– ' + (followups.length - 3) + 'ä»¶</div>';
  container.innerHTML = html;
}

function renderProspects() {
  var region = document.getElementById('filterRegion').value;
  var pref = document.getElementById('filterPref').value;
  var status = document.getElementById('filterStatus').value;
  var filtered = prospects.filter(function(p) {
    if (region && p.region !== region) return false;
    if (pref && p.area !== pref) return false;
    if (status && p.status !== status) return false;
    return true;
  });
  document.getElementById('totalProspectsCount').textContent = prospects.length;
  var myCount = prospects.filter(function(p) { return p.assigned_to === currentUser.id; }).length;
  document.getElementById('myProspectsCount').textContent = 'ã‚ãªãŸã®æ‹…å½“: ' + myCount + 'ç¤¾';
  renderRegionList();
  updateRegionFilter();
  var container = document.getElementById('prospectsList');
  if (filtered.length === 0) {
    container.innerHTML = '<div class="card"><div class="empty">è©²å½“ã™ã‚‹è‘¬å„€ç¤¾ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
    return;
  }
  var html = '<div class="card">';
  html += '<div class="card-header"><span class="card-title">è‘¬å„€ç¤¾ä¸€è¦§ï¼ˆ' + filtered.length + 'ç¤¾ï¼‰</span></div>';
  for (var i = 0; i < filtered.length; i++) {
    var p = filtered[i];
    var member = members.find(function(m) { return m.id === p.assigned_to; });
    var badge = getBadge(p.status);
    var isMyProspect = p.assigned_to === currentUser.id;
    html += '<div class="list-item" onclick="openProspectDetail(\'' + p.id + '\')" style="' + (isMyProspect ? 'background:#e8f0ec;' : '') + '">';
    html += '<div class="list-item-content">';
    html += '<div class="list-item-title">' + esc(p.company_name);
    if (member) html += ' <span style="font-size:0.75rem; color:#2d5a47; font-weight:600;">ã€' + member.name.charAt(0) + 'ã€‘</span>';
    html += '</div>';
    html += '<div class="list-item-sub">' + esc(p.area || '') + (p.temperature && p.temperature !== 'æœªè¨­å®š' ? ' â€¢ ' + getTempEmoji(p.temperature) : '') + '</div>';
    html += '</div>';
    html += '<span class="badge ' + badge + '">' + (p.status || 'æœªè¨ªå•') + '</span>';
    html += '</div>';
  }
  html += '</div>';
  container.innerHTML = html;
}

function renderRegionList() {
  var regionCounts = {};
  for (var i = 0; i < REGIONS.length; i++) regionCounts[REGIONS[i]] = 0;
  for (var i = 0; i < prospects.length; i++) {
    var r = prospects[i].region;
    if (r && regionCounts[r] !== undefined) regionCounts[r]++;
  }
  var html = '';
  for (var i = 0; i < REGIONS.length; i++) {
    var r = REGIONS[i];
    var count = regionCounts[r];
    html += '<div class="list-item" onclick="filterByRegion(\'' + r + '\')" style="padding:0.75rem 1rem;">';
    html += '<div class="list-item-content"><div class="list-item-title" style="font-size:0.9rem;">' + r + '</div></div>';
    html += '<span style="font-weight:600; color:' + (count > 0 ? '#2d5a47' : '#ccc') + ';">' + count + 'ç¤¾</span></div>';
  }
  document.getElementById('regionList').innerHTML = html;
}

function filterByRegion(region) {
  document.getElementById('filterRegion').value = region;
  updatePrefectureFilter();
  renderProspects();
}

function updateRegionFilter() {
  var select = document.getElementById('filterRegion');
  var currentVal = select.value;
  var html = '<option value="">å…¨ã‚¨ãƒªã‚¢</option>';
  for (var i = 0; i < REGIONS.length; i++) html += '<option value="' + REGIONS[i] + '">' + REGIONS[i] + '</option>';
  select.innerHTML = html;
  select.value = currentVal;
}

function updatePrefectureFilter() {
  var region = document.getElementById('filterRegion').value;
  var select = document.getElementById('filterPref');
  var prefs = region ? (PREFECTURES[region] || []) : [];
  var html = '<option value="">å…¨éƒ½é“åºœçœŒ</option>';
  if (region) {
    for (var i = 0; i < prefs.length; i++) {
      var count = prospects.filter(function(p) { return p.area === prefs[i]; }).length;
      html += '<option value="' + prefs[i] + '">' + prefs[i] + ' (' + count + ')</option>';
    }
  }
  select.innerHTML = html;
}

function getTempEmoji(temp) {
  var map = { 'ç†±ã„': 'ğŸ”¥', 'æ¸©ã‹ã„': 'â˜€ï¸', 'æ™®é€š': 'ğŸ˜', 'å†·ãŸã„': 'â„ï¸' };
  return map[temp] || '';
}

function getBadge(status) {
  var map = { 'æœªè¨ªå•': 'badge-gray', 'è¨ªå•æ¸ˆã¿': 'badge-blue', 'å•†è«‡ä¸­': 'badge-yellow', 'æˆç´„': 'badge-green', 'è¦‹é€ã‚Š': 'badge-red' };
  return map[status] || 'badge-gray';
}

function openProspectDetail(id) {
  var p = prospects.find(function(x) { return x.id === id; });
  if (!p) return;
  var member = members.find(function(m) { return m.id === p.assigned_to; });
  var isMyProspect = p.assigned_to === currentUser.id;
  var isUnassigned = !p.assigned_to;
  var html = '<div style="margin-bottom:1rem;">';
  html += '<div style="font-size:1.2rem; font-weight:700; margin-bottom:0.5rem;">' + esc(p.company_name) + '</div>';
  html += '<div style="font-size:0.9rem; color:#5a5a5a;">';
  html += 'ğŸ“ ' + esc(p.region || '') + ' / ' + esc(p.area || '') + '<br>';
  if (p.address) html += 'ğŸ  ' + esc(p.address) + '<br>';
  if (p.phone) html += 'ğŸ“ ' + esc(p.phone) + '<br>';
  if (p.temperature && p.temperature !== 'æœªè¨­å®š') html += 'ğŸŒ¡ï¸ æ„Ÿåº¦: ' + p.temperature + '<br>';
  if (p.notes) html += 'ğŸ“ ' + esc(p.notes) + '<br>';
  html += '</div></div>';
  if (member) {
    html += '<div style="background:#e8f0ec; padding:0.75rem; border-radius:8px; margin-bottom:1rem;">';
    html += '<div style="font-size:0.85rem;"><strong>' + esc(member.name) + '</strong> ã•ã‚“ãŒæ‹…å½“ä¸­</div></div>';
  }
  html += '<div style="font-weight:600; margin-bottom:0.5rem;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>';
  html += '<select class="form-input" id="prospectStatus" style="margin-bottom:1rem;">';
  html += '<option value="æœªè¨ªå•"' + (p.status === 'æœªè¨ªå•' ? ' selected' : '') + '>æœªè¨ªå•</option>';
  html += '<option value="è¨ªå•æ¸ˆã¿"' + (p.status === 'è¨ªå•æ¸ˆã¿' ? ' selected' : '') + '>è¨ªå•æ¸ˆã¿</option>';
  html += '<option value="å•†è«‡ä¸­"' + (p.status === 'å•†è«‡ä¸­' ? ' selected' : '') + '>å•†è«‡ä¸­</option>';
  html += '<option value="æˆç´„"' + (p.status === 'æˆç´„' ? ' selected' : '') + '>æˆç´„</option>';
  html += '<option value="è¦‹é€ã‚Š"' + (p.status === 'è¦‹é€ã‚Š' ? ' selected' : '') + '>è¦‹é€ã‚Š</option>';
  html += '</select>';
  document.getElementById('prospectDetailContent').innerHTML = html;
  var assignBtn = document.getElementById('assignBtn');
  var unassignBtn = document.getElementById('unassignBtn');
  if (isUnassigned) { assignBtn.style.display = 'block'; assignBtn.textContent = 'æ‹…å½“ã™ã‚‹'; unassignBtn.style.display = 'none'; }
  else if (isMyProspect) { assignBtn.style.display = 'none'; unassignBtn.style.display = 'block'; }
  else { assignBtn.style.display = 'none'; unassignBtn.style.display = 'none'; }
  document.getElementById('selectedProspectId').value = id;
  openModal('prospectDetailModal');
}

function assignProspect() {
  var id = document.getElementById('selectedProspectId').value;
  if (!id) return;
  supabase.from('sales_prospects').update({ assigned_to: currentUser.id, updated_at: new Date().toISOString() }).eq('id', id).then(function() { closeModal('prospectDetailModal'); loadData(); });
}

function unassignProspect() {
  var id = document.getElementById('selectedProspectId').value;
  if (!id) return;
  if (!confirm('æ‹…å½“ã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  supabase.from('sales_prospects').update({ assigned_to: null, updated_at: new Date().toISOString() }).eq('id', id).then(function() { closeModal('prospectDetailModal'); loadData(); });
}

function updateProspectStatus() {
  var id = document.getElementById('selectedProspectId').value;
  var status = document.getElementById('prospectStatus').value;
  if (!id) return;
  supabase.from('sales_prospects').update({ status: status, assigned_to: currentUser.id, updated_at: new Date().toISOString() }).eq('id', id).then(function() { closeModal('prospectDetailModal'); loadData(); });
}

function saveProspect() {
  var id = document.getElementById('prospectId').value;
  var data = {
    company_name: document.getElementById('pName').value.trim(),
    area: document.getElementById('pArea').value.trim(),
    phone: document.getElementById('pPhone').value.trim(),
    status: document.getElementById('pStatus').value,
    notes: document.getElementById('pNotes').value.trim(),
    updated_at: new Date().toISOString()
  };
  if (!data.company_name) { alert('è‘¬å„€ç¤¾åã‚’å…¥åŠ›'); return; }
  if (id) {
    supabase.from('sales_prospects').update(data).eq('id', id).then(function() { closeModal('prospectModal'); loadData(); });
  } else {
    data.assigned_to = currentUser.id;
    supabase.from('sales_prospects').insert(data).then(function() { closeModal('prospectModal'); loadData(); });
  }
}

function updateScheduleProspects() {
  var select = document.getElementById('sProspect');
  var html = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  for (var i = 0; i < prospects.length; i++) html += '<option value="' + prospects[i].id + '">' + esc(prospects[i].company_name) + '</option>';
  select.innerHTML = html;
}

function openScheduleModal() {
  document.getElementById('sProspect').value = '';
  document.getElementById('sDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('sMemo').value = '';
  openModal('scheduleModal');
}

function saveSchedule() {
  var data = {
    member_id: currentUser.id,
    prospect_id: document.getElementById('sProspect').value || null,
    scheduled_date: document.getElementById('sDate').value,
    memo: document.getElementById('sMemo').value.trim()
  };
  if (!data.scheduled_date) { alert('æ—¥ä»˜ã‚’å…¥åŠ›'); return; }
  supabase.from('sales_schedules').insert(data).then(function() { closeModal('scheduleModal'); loadData(); });
}

function renderSchedules() {
  var upcoming = schedules.filter(function(s) { return !s.is_done; });
  var done = schedules.filter(function(s) { return s.is_done; });
  document.getElementById('upcomingSchedules').innerHTML = renderScheduleList(upcoming);
  document.getElementById('doneSchedules').innerHTML = renderScheduleList(done);
}

function renderScheduleList(list) {
  if (list.length === 0) return '<div class="card"><div class="empty">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div></div>';
  var html = '<div class="card">';
  for (var i = 0; i < list.length; i++) {
    var s = list[i];
    var p = prospects.find(function(x) { return x.id === s.prospect_id; });
    html += '<div class="schedule-item" onclick="toggleSchedule(\'' + s.id + '\', ' + !s.is_done + ')">';
    html += '<div class="schedule-check ' + (s.is_done ? 'done' : '') + '"></div>';
    html += '<div class="schedule-info">';
    html += '<div class="schedule-company">' + (p ? esc(p.company_name) : 'ãã®ä»–') + '</div>';
    html += '<div class="schedule-memo">' + formatDate(s.scheduled_date) + (s.memo ? ' â€¢ ' + esc(s.memo) : '') + '</div>';
    html += '</div></div>';
  }
  html += '</div>';
  return html;
}

function toggleSchedule(id, done) {
  supabase.from('sales_schedules').update({ is_done: done }).eq('id', id).then(function() { loadData(); });
}

function openGoalModal() {
  document.getElementById('gVisit').value = myGoal ? myGoal.visit_goal : '';
  document.getElementById('gNego').value = myGoal ? myGoal.negotiation_goal : '';
  document.getElementById('gClosed').value = myGoal ? myGoal.closed_goal : '';
  openModal('goalModal');
}

function saveGoal() {
  var month = new Date().toISOString().slice(0, 7);
  var data = {
    member_id: currentUser.id,
    month: month,
    visit_goal: parseInt(document.getElementById('gVisit').value) || 0,
    negotiation_goal: parseInt(document.getElementById('gNego').value) || 0,
    closed_goal: parseInt(document.getElementById('gClosed').value) || 0
  };
  if (myGoal) {
    supabase.from('sales_goals').update(data).eq('id', myGoal.id).then(function() { closeModal('goalModal'); loadData(); });
  } else {
    supabase.from('sales_goals').insert(data).then(function() { closeModal('goalModal'); loadData(); });
  }
}

function renderTodaySchedule() {
  var today = new Date().toISOString().split('T')[0];
  var todayList = schedules.filter(function(s) { return s.scheduled_date === today && !s.is_done; });
  var container = document.getElementById('todaySchedule');
  if (todayList.length === 0) {
    container.innerHTML = '<div class="empty" style="padding:1rem;">ä»Šæ—¥ã®äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  var html = '';
  for (var i = 0; i < todayList.length; i++) {
    var s = todayList[i];
    var p = prospects.find(function(x) { return x.id === s.prospect_id; });
    html += '<div class="list-item">';
    html += '<div class="list-item-icon">ğŸ“</div>';
    html += '<div class="list-item-content">';
    html += '<div class="list-item-title">' + (p ? esc(p.company_name) : 'ãã®ä»–') + '</div>';
    if (s.memo) html += '<div class="list-item-sub">' + esc(s.memo) + '</div>';
    html += '</div></div>';
  }
  container.innerHTML = html;
}

function renderPosts() {
  var container = document.getElementById('postsList');
  if (posts.length === 0) { container.innerHTML = '<div class="empty">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = '';
  for (var i = 0; i < posts.length; i++) {
    var p = posts[i];
    var member = members.find(function(m) { return m.id === p.member_id; });
    var name = member ? member.name : 'åŒ¿å';
    html += '<div class="post-item">';
    html += '<div class="post-header">';
    html += '<div class="post-avatar">' + name.charAt(0) + '</div>';
    html += '<span class="post-name">' + esc(name) + '</span>';
    html += '<span class="post-time">' + formatDateTime(p.created_at) + '</span>';
    html += '</div>';
    html += '<div class="post-content">' + esc(p.content) + '</div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function sendPost() {
  var content = document.getElementById('postInput').value.trim();
  if (!content) return;
  supabase.from('sales_posts').insert({ member_id: currentUser.id, content: content }).then(function() {
    document.getElementById('postInput').value = '';
    loadData();
  });
}

function openExpenseModal() {
  document.getElementById('eDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('eCategory').value = 'äº¤é€šè²»';
  document.getElementById('eAmount').value = '';
  document.getElementById('eDescription').value = '';
  openModal('expenseModal');
}

function saveExpense() {
  var data = {
    member_id: currentUser.id,
    expense_date: document.getElementById('eDate').value,
    category: document.getElementById('eCategory').value,
    amount: parseInt(document.getElementById('eAmount').value) || 0,
    description: document.getElementById('eDescription').value.trim(),
    status: 'ç”³è«‹ä¸­'
  };
  if (!data.expense_date || !data.amount) { alert('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›'); return; }
  supabase.from('sales_expenses').insert(data).then(function() { closeModal('expenseModal'); loadData(); });
}

function renderExpenses() {
  var now = new Date();
  var thisMonth = now.getMonth();
  var thisYear = now.getFullYear();
  var total = 0;
  for (var i = 0; i < expenses.length; i++) {
    var d = new Date(expenses[i].expense_date);
    if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) total += expenses[i].amount;
  }
  document.getElementById('expenseTotal').textContent = 'Â¥' + total.toLocaleString();
  var container = document.getElementById('expensesList');
  if (expenses.length === 0) { container.innerHTML = '<div class="empty">çµŒè²»ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = '';
  for (var i = 0; i < expenses.length; i++) {
    var e = expenses[i];
    var icon = getExpenseIcon(e.category);
    html += '<div class="list-item">';
    html += '<div class="list-item-icon">' + icon + '</div>';
    html += '<div class="list-item-content">';
    html += '<div class="list-item-title">' + e.category + '</div>';
    html += '<div class="list-item-sub">' + formatDate(e.expense_date) + (e.description ? ' â€¢ ' + esc(e.description) : '') + '</div>';
    html += '</div>';
    html += '<div class="list-item-right"><strong>Â¥' + e.amount.toLocaleString() + '</strong></div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function getExpenseIcon(cat) {
  var map = { 'äº¤é€šè²»': 'ğŸšƒ', 'ã‚¬ã‚½ãƒªãƒ³ä»£': 'â›½', 'é§è»Šå ´ä»£': 'ğŸ…¿ï¸', 'æ¥å¾…è²»': 'ğŸ½ï¸', 'å®¿æ³Šè²»': 'ğŸ¨', 'ãã®ä»–': 'ğŸ“' };
  return map[cat] || 'ğŸ“';
}

function openKnowledgeModal() {
  document.getElementById('kCategory').value = 'æˆåŠŸäº‹ä¾‹';
  document.getElementById('kTitle').value = '';
  document.getElementById('kContent').value = '';
  openModal('knowledgeModal');
}

function saveKnowledge() {
  var data = {
    member_id: currentUser.id,
    category: document.getElementById('kCategory').value,
    title: document.getElementById('kTitle').value.trim(),
    content: document.getElementById('kContent').value.trim()
  };
  if (!data.title || !data.content) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›'); return; }
  supabase.from('sales_knowledge').insert(data).then(function() { closeModal('knowledgeModal'); loadData(); });
}

function renderKnowledge() {
  var container = document.getElementById('knowledgeList');
  if (knowledge.length === 0) { container.innerHTML = '<div class="card"><div class="empty">ãƒŠãƒ¬ãƒƒã‚¸ãŒã‚ã‚Šã¾ã›ã‚“</div></div>'; return; }
  var html = '';
  for (var i = 0; i < knowledge.length; i++) {
    var k = knowledge[i];
    var member = members.find(function(m) { return m.id === k.member_id; });
    var icon = { 'æˆåŠŸäº‹ä¾‹': 'ğŸ“ˆ', 'å¤±æ•—äº‹ä¾‹': 'ğŸ“‰', 'FAQ': 'â“', 'Tips': 'ğŸ’¡' }[k.category] || 'ğŸ“';
    html += '<div class="card" style="margin-bottom:0.75rem;">';
    html += '<div class="card-body">';
    html += '<div style="font-size:0.75rem;color:#8a8a8a;margin-bottom:0.25rem;">' + icon + ' ' + k.category + '</div>';
    html += '<div style="font-weight:600;margin-bottom:0.5rem;">' + esc(k.title) + '</div>';
    html += '<div style="font-size:0.9rem;color:#5a5a5a;">' + esc(k.content) + '</div>';
    html += '<div style="font-size:0.75rem;color:#8a8a8a;margin-top:0.5rem;">' + (member ? member.name : 'åŒ¿å') + ' â€¢ ' + formatDate(k.created_at) + '</div>';
    html += '</div></div>';
  }
  container.innerHTML = html;
}

function renderRanking() {
  var counts = {};
  for (var i = 0; i < members.length; i++) counts[members[i].id] = { name: members[i].name, count: 0 };
  for (var i = 0; i < prospects.length; i++) {
    var p = prospects[i];
    if (p.assigned_to && counts[p.assigned_to] && p.status !== 'æœªè¨ªå•') counts[p.assigned_to].count++;
  }
  var arr = [];
  for (var id in counts) arr.push(counts[id]);
  arr.sort(function(a, b) { return b.count - a.count; });
  var container = document.getElementById('rankingList');
  if (arr.length === 0) { container.innerHTML = '<div class="empty">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = '';
  for (var i = 0; i < arr.length; i++) {
    var r = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : ''));
    html += '<div class="rank-item">';
    html += '<div class="rank-num ' + r + '">' + (i + 1) + '</div>';
    html += '<div class="rank-name">' + esc(arr[i].name) + '</div>';
    html += '<div class="rank-val">' + arr[i].count + 'ä»¶</div>';
    html += '</div>';
  }
  container.innerHTML = html;
}

function updateReport() {
  var myProspects = prospects.filter(function(p) { return p.assigned_to === currentUser.id; });
  var visits = myProspects.filter(function(p) { return p.status !== 'æœªè¨ªå•'; }).length;
  var nego = myProspects.filter(function(p) { return p.status === 'å•†è«‡ä¸­'; }).length;
  var closed = myProspects.filter(function(p) { return p.status === 'æˆç´„'; }).length;
  var now = new Date();
  var thisMonth = now.getMonth();
  var thisYear = now.getFullYear();
  var monthExp = 0, expCount = 0, transport = 0;
  for (var i = 0; i < expenses.length; i++) {
    var e = expenses[i];
    var d = new Date(e.expense_date);
    if (d.getMonth() === thisMonth && d.getFullYear() === thisYear) {
      monthExp += e.amount;
      expCount++;
      if (e.category === 'äº¤é€šè²»' || e.category === 'ã‚¬ã‚½ãƒªãƒ³ä»£') transport += e.amount;
    }
  }
  document.getElementById('reportVisits').textContent = visits;
  document.getElementById('reportNego').textContent = nego;
  document.getElementById('reportClosed').textContent = closed;
  document.getElementById('reportExpense').textContent = 'Â¥' + monthExp.toLocaleString();
  document.getElementById('reportExpenseCount').textContent = expCount;
  document.getElementById('reportTransport').textContent = 'Â¥' + transport.toLocaleString();
}

function renderNotifications() {
  var unreadCount = notifications.filter(function(n) { return !n.is_read; }).length;
  document.getElementById('notifCount').textContent = unreadCount + 'ä»¶ã®æœªèª­';
  var container = document.getElementById('notificationsList');
  if (notifications.length === 0) { container.innerHTML = '<div class="empty">é€šçŸ¥ãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = '';
  for (var i = 0; i < notifications.length; i++) {
    var n = notifications[i];
    var iconClass = n.type === 'success' ? 'success' : (n.type === 'error' ? 'error' : 'info');
    var icon = n.type === 'success' ? 'âœ“' : (n.type === 'error' ? 'âœ•' : 'â„¹');
    html += '<div class="notif-item ' + (n.is_read ? '' : 'unread') + '" onclick="markRead(\'' + n.id + '\')">';
    html += '<div class="notif-icon ' + iconClass + '">' + icon + '</div>';
    html += '<div class="notif-content">';
    html += '<div class="notif-title">' + esc(n.title) + '</div>';
    if (n.content) html += '<div class="notif-text">' + esc(n.content) + '</div>';
    html += '<div class="notif-time">' + formatDateTime(n.created_at) + '</div>';
    html += '</div></div>';
  }
  container.innerHTML = html;
  updateHomeAlerts();
}

function markRead(id) {
  supabase.from('sales_notifications').update({ is_read: true }).eq('id', id).then(function() { loadData(); });
}

function markAllRead() {
  supabase.from('sales_notifications').update({ is_read: true }).eq('member_id', currentUser.id).then(function() { loadData(); });
}

function renderMyTodos() {
  var pendingCount = myTodos.filter(function(t) { return t.status !== 'å®Œäº†'; }).length;
  var unreadCount = myTodos.filter(function(t) { return !t.is_read; }).length;
  document.getElementById('todoCount').textContent = pendingCount + 'ä»¶ã®æœªå®Œäº†' + (unreadCount > 0 ? 'ï¼ˆ' + unreadCount + 'ä»¶æœªèª­ï¼‰' : '');
  var container = document.getElementById('myTodosList');
  if (myTodos.length === 0) { container.innerHTML = '<div class="empty">TODOãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = '';
  for (var i = 0; i < myTodos.length; i++) {
    var t = myTodos[i];
    var isDone = t.status === 'å®Œäº†';
    var isUnread = !t.is_read;
    var statusBadge = getTodoStatusBadge(t.status);
    html += '<div class="my-todo-item" style="' + (isUnread ? 'background:#fff8e1;' : '') + '" onclick="openTodoDetail(\'' + t.id + '\')">';
    html += '<div style="flex:1;">';
    html += '<div style="display:flex; align-items:center; gap:0.5rem; margin-bottom:0.25rem;">';
    if (isUnread) html += '<span style="background:#dc3545; color:white; font-size:0.6rem; padding:0.1rem 0.4rem; border-radius:4px;">NEW</span>';
    html += '<span class="badge ' + statusBadge + '">' + t.status + '</span></div>';
    html += '<div class="my-todo-title" style="' + (isDone ? 'text-decoration:line-through; color:#8a8a8a;' : '') + '">' + esc(t.title) + '</div>';
    html += '<div class="my-todo-meta">';
    if (t.due_date) html += 'æœŸé™: ' + formatDate(t.due_date) + ' ';
    if (t.estimated_date) html += 'â†’ å®Œäº†äºˆå®š: ' + formatDate(t.estimated_date);
    html += '</div>';
    if (t.description) html += '<div style="font-size:0.8rem; color:#5a5a5a; margin-top:0.25rem;">' + esc(t.description) + '</div>';
    if (t.member_reply) html += '<div style="font-size:0.8rem; color:#2d5a47; margin-top:0.25rem; background:#e8f0ec; padding:0.4rem; border-radius:4px;">ğŸ’¬ ' + esc(t.member_reply) + '</div>';
    html += '</div>';
    html += '<div style="color:#8a8a8a;">â†’</div></div>';
  }
  container.innerHTML = html;
  updateHomeAlerts();
  renderHomeTodos();
}

function renderHomeTodos() {
  var container = document.getElementById('homeTodoList');
  var pendingTodos = myTodos.filter(function(t) { return t.status !== 'å®Œäº†'; });
  if (pendingTodos.length === 0) { container.innerHTML = '<div class="empty" style="padding:1rem;">æœªå®Œäº†ã®TODOã¯ã‚ã‚Šã¾ã›ã‚“ ğŸ‰</div>'; return; }
  var html = '';
  var showCount = Math.min(3, pendingTodos.length);
  for (var i = 0; i < showCount; i++) {
    var t = pendingTodos[i];
    var isUnread = !t.is_read;
    var statusBadge = getTodoStatusBadge(t.status);
    html += '<div class="list-item" style="' + (isUnread ? 'background:#fff8e1;' : '') + '" onclick="openTodoDetail(\'' + t.id + '\')">';
    html += '<div class="list-item-icon" style="background:' + (isUnread ? '#ffc107' : '#e8f0ec') + ';">' + (isUnread ? 'ğŸ†•' : 'ğŸ“‹') + '</div>';
    html += '<div class="list-item-content">';
    html += '<div style="display:flex; align-items:center; gap:0.5rem;">';
    html += '<span class="badge ' + statusBadge + '" style="font-size:0.6rem;">' + t.status + '</span>';
    html += '<span class="list-item-title" style="font-size:0.85rem;">' + esc(t.title) + '</span></div>';
    if (t.due_date) html += '<div class="list-item-sub">æœŸé™: ' + formatDate(t.due_date) + '</div>';
    html += '</div>';
    html += '<div class="list-item-right">â†’</div></div>';
  }
  if (pendingTodos.length > 3) html += '<div style="text-align:center; padding:0.5rem; font-size:0.8rem; color:#8a8a8a;">ä»– ' + (pendingTodos.length - 3) + 'ä»¶</div>';
  container.innerHTML = html;
}

function getTodoStatusBadge(status) {
  var map = { 'æœªç€æ‰‹': 'badge-gray', 'ç¢ºèªæ¸ˆã¿': 'badge-blue', 'å–çµ„ä¸­': 'badge-yellow', 'å®Œäº†': 'badge-green' };
  return map[status] || 'badge-gray';
}

function openTodoDetail(id) {
  selectedTodoId = id;
  var t = myTodos.find(function(x) { return x.id === id; });
  if (!t) return;
  if (!t.is_read) {
    supabase.from('sales_todos').update({ is_read: true, read_at: new Date().toISOString() }).eq('id', id).then(function() {
      t.is_read = true;
      renderMyTodos();
    });
  }
  var html = '';
  html += '<div style="font-size:1.1rem; font-weight:600; margin-bottom:0.5rem;">' + esc(t.title) + '</div>';
  if (t.description) html += '<div style="color:#5a5a5a; margin-bottom:0.5rem;">' + esc(t.description) + '</div>';
  html += '<div style="font-size:0.8rem; color:#8a8a8a;">';
  if (t.due_date) html += 'ğŸ“… æœŸé™: ' + formatDate(t.due_date) + '<br>';
  html += 'ğŸ“† ä½œæˆæ—¥: ' + formatDateTime(t.created_at) + '</div>';
  document.getElementById('todoDetailContent').innerHTML = html;
  document.getElementById('todoStatus').value = t.status || 'æœªç€æ‰‹';
  document.getElementById('todoEstimatedDate').value = t.estimated_date || '';
  document.getElementById('todoReply').value = t.member_reply || '';
  openModal('todoDetailModal');
}

function updateTodoStatus() {
  if (!selectedTodoId) return;
  var data = {
    status: document.getElementById('todoStatus').value,
    estimated_date: document.getElementById('todoEstimatedDate').value || null,
    member_reply: document.getElementById('todoReply').value.trim(),
    replied_at: new Date().toISOString()
  };
  supabase.from('sales_todos').update(data).eq('id', selectedTodoId).then(function() { closeModal('todoDetailModal'); loadData(); });
}

function updateHomeAlerts() {
  var unreadNotifs = notifications.filter(function(n) { return !n.is_read; });
  var notifCard = document.getElementById('newNotifCard');
  if (unreadNotifs.length > 0) {
    notifCard.style.display = 'block';
    document.getElementById('newNotifTitle').textContent = unreadNotifs.length + 'ä»¶ã®æ–°ã—ã„é€šçŸ¥';
    document.getElementById('newNotifPreview').textContent = unreadNotifs[0].title;
  } else { notifCard.style.display = 'none'; }
  var pendingTodos = myTodos.filter(function(t) { return t.status !== 'å®Œäº†'; });
  var todoCard = document.getElementById('newTodoCard');
  if (pendingTodos.length > 0) {
    todoCard.style.display = 'block';
    document.getElementById('newTodoTitle').textContent = pendingTodos.length + 'ä»¶ã®æœªå®Œäº†TODO';
    document.getElementById('newTodoPreview').textContent = pendingTodos[0].title;
  } else { todoCard.style.display = 'none'; }
}

function renderCalendar() {
  var year = currentCalendarDate.getFullYear();
  var month = currentCalendarDate.getMonth();
  document.getElementById('calendarTitle').textContent = year + 'å¹´' + (month + 1) + 'æœˆ';
  var firstDay = new Date(year, month, 1);
  var lastDay = new Date(year, month + 1, 0);
  var startDay = firstDay.getDay();
  var daysInMonth = lastDay.getDate();
  var today = new Date();
  var todayStr = today.toISOString().split('T')[0];
  var scheduleDates = {};
  for (var i = 0; i < schedules.length; i++) scheduleDates[schedules[i].scheduled_date] = true;
  var html = '<div class="calendar-grid">';
  var days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
  for (var d = 0; d < 7; d++) {
    var cls = d === 0 ? 'sun' : (d === 6 ? 'sat' : '');
    html += '<div class="calendar-header ' + cls + '">' + days[d] + '</div>';
  }
  var prevMonth = new Date(year, month, 0);
  var prevDays = prevMonth.getDate();
  for (var d = startDay - 1; d >= 0; d--) html += '<div class="calendar-day other-month">' + (prevDays - d) + '</div>';
  for (var d = 1; d <= daysInMonth; d++) {
    var dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    var isToday = dateStr === todayStr;
    var isSelected = selectedDate === dateStr;
    var hasSchedule = scheduleDates[dateStr];
    var cls = 'calendar-day';
    if (isToday) cls += ' today';
    if (isSelected) cls += ' selected';
    if (hasSchedule) cls += ' has-schedule';
    html += '<div class="' + cls + '" onclick="selectDate(\'' + dateStr + '\')">' + d + '</div>';
  }
  var totalCells = startDay + daysInMonth;
  var nextDays = 7 - (totalCells % 7);
  if (nextDays < 7) {
    for (var d = 1; d <= nextDays; d++) html += '<div class="calendar-day other-month">' + d + '</div>';
  }
  html += '</div>';
  document.getElementById('calendarGrid').innerHTML = html;
  if (!selectedDate) selectDate(todayStr);
  else renderSelectedDateSchedules();
}

function changeMonth(delta) {
  currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
  renderCalendar();
}

function selectDate(dateStr) {
  selectedDate = dateStr;
  document.getElementById('sDate').value = dateStr;
  renderCalendar();
  renderSelectedDateSchedules();
}

function renderSelectedDateSchedules() {
  var d = new Date(selectedDate);
  document.getElementById('selectedDateTitle').textContent = (d.getMonth() + 1) + '/' + d.getDate() + 'ã®äºˆå®š';
  var daySchedules = schedules.filter(function(s) { return s.scheduled_date === selectedDate; });
  var container = document.getElementById('selectedDateSchedules');
  if (daySchedules.length === 0) { container.innerHTML = '<div class="empty">äºˆå®šãŒã‚ã‚Šã¾ã›ã‚“</div>'; return; }
  var html = '';
  for (var i = 0; i < daySchedules.length; i++) {
    var s = daySchedules[i];
    var p = prospects.find(function(x) { return x.id === s.prospect_id; });
    html += '<div class="list-item" onclick="toggleSchedule(\'' + s.id + '\', ' + !s.is_done + ')">';
    html += '<div class="list-item-icon" style="background:' + (s.is_done ? '#d4edda' : '#fff3cd') + ';">' + (s.is_done ? 'âœ“' : 'ğŸ“') + '</div>';
    html += '<div class="list-item-content">';
    html += '<div class="list-item-title" style="' + (s.is_done ? 'text-decoration:line-through; color:#8a8a8a;' : '') + '">' + (p ? esc(p.company_name) : 'ãã®ä»–') + '</div>';
    if (s.memo) html += '<div class="list-item-sub">' + esc(s.memo) + '</div>';
    html += '</div></div>';
  }
  container.innerHTML = html;
}

function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function formatDate(str) {
  if (!str) return '-';
  var d = new Date(str);
  return (d.getMonth() + 1) + '/' + d.getDate();
}

function formatDateTime(str) {
  if (!str) return '-';
  var d = new Date(str);
  return (d.getMonth() + 1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + String(d.getMinutes()).padStart(2, '0');
}
</script>

</body>
</html>