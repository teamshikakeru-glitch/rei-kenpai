<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rei å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --color-bg: #f5f6fa;
      --color-white: #ffffff;
      --color-primary: #2d5a47;
      --color-primary-light: #3d7a5f;
      --color-primary-pale: #e8f0ec;
      --color-accent: #c9a962;
      --color-accent-light: #f5f0e0;
      --color-text: #2c2c2c;
      --color-text-light: #5a5a5a;
      --color-text-muted: #8a8a8a;
      --color-border: #e5e2dd;
      --color-error: #dc3545;
      --color-success: #28a745;
      --color-warning: #ffc107;
      --color-info: #17a2b8;
      --shadow-soft: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-medium: 0 4px 16px rgba(0,0,0,0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans JP', sans-serif; background: var(--color-bg); color: var(--color-text); line-height: 1.6; min-height: 100vh; }
    
    /* Login Screen */
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%); }
    .login-card { background: var(--color-white); border-radius: 16px; padding: 2.5rem; width: 90%; max-width: 400px; box-shadow: var(--shadow-medium); }
    .login-logo { text-align: center; margin-bottom: 2rem; }
    .login-logo-symbol { font-size: 3rem; color: var(--color-primary); }
    .login-logo-text { font-size: 1.2rem; color: var(--color-text-light); margin-top: 0.5rem; }
    .login-title { font-size: 1.3rem; font-weight: 600; text-align: center; margin-bottom: 1.5rem; }
    .form-group { margin-bottom: 1.25rem; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 500; margin-bottom: 0.5rem; color: var(--color-text-light); }
    .form-input { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; border: 2px solid var(--color-border); border-radius: 8px; transition: border-color 0.2s; }
    .form-input:focus { outline: none; border-color: var(--color-primary); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--color-primary); color: white; width: 100%; }
    .btn-primary:hover { background: var(--color-primary-light); }
    .btn-secondary { background: var(--color-bg); color: var(--color-text); border: 1px solid var(--color-border); }
    .btn-secondary:hover { background: var(--color-border); }
    .btn-accent { background: var(--color-accent); color: white; }
    .btn-accent:hover { opacity: 0.9; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
    .login-footer { text-align: center; margin-top: 1.5rem; font-size: 0.85rem; color: var(--color-text-muted); }
    .login-footer a { color: var(--color-primary); text-decoration: none; }
    .error-msg { background: #fee; color: var(--color-error); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.85rem; display: none; }
    
    /* Main Layout */
    .app { display: none; }
    .header { background: var(--color-primary); color: white; padding: 1rem 1.5rem; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .header-logo { display: flex; align-items: center; gap: 0.75rem; }
    .header-logo-symbol { font-size: 1.5rem; font-weight: 700; }
    .header-logo-text { font-size: 0.9rem; opacity: 0.9; }
    .header-user { display: flex; align-items: center; gap: 1rem; }
    .header-user-name { font-size: 0.9rem; }
    .header-logout { background: rgba(255,255,255,0.15); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer; }
    .header-logout:hover { background: rgba(255,255,255,0.25); }
    
    /* Navigation */
    .nav { background: var(--color-white); border-bottom: 1px solid var(--color-border); overflow-x: auto; }
    .nav-inner { max-width: 1400px; margin: 0 auto; display: flex; gap: 0.5rem; padding: 0.5rem 1.5rem; }
    .nav-item { padding: 0.75rem 1.25rem; font-size: 0.9rem; font-weight: 500; color: var(--color-text-light); background: none; border: none; border-radius: 8px; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
    .nav-item:hover { background: var(--color-bg); color: var(--color-text); }
    .nav-item.active { background: var(--color-primary-pale); color: var(--color-primary); }
    
    /* Main Content */
    .main { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
    .page { display: none; }
    .page.active { display: block; }
    
    /* Cards */
    .card { background: var(--color-white); border-radius: 12px; box-shadow: var(--shadow-soft); overflow: hidden; }
    .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; }
    .card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .card-body { padding: 1.25rem; }
    
    /* Dashboard Grid */
    .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: var(--color-white); border-radius: 12px; padding: 1.25rem; box-shadow: var(--shadow-soft); }
    .stat-label { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 0.5rem; }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--color-primary); }
    .stat-value.success { color: var(--color-success); }
    .stat-value.warning { color: var(--color-warning); }
    .stat-sub { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem; }
    
    /* Announcements */
    .announcement-item { padding: 1rem; border-bottom: 1px solid var(--color-border); display: flex; gap: 1rem; align-items: flex-start; }
    .announcement-item:last-child { border-bottom: none; }
    .announcement-icon { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
    .announcement-icon.important { background: #fee; color: var(--color-error); }
    .announcement-icon.info { background: #e8f4fd; color: var(--color-info); }
    .announcement-icon.normal { background: var(--color-bg); color: var(--color-text-muted); }
    .announcement-content { flex: 1; }
    .announcement-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem; }
    .announcement-date { font-size: 0.75rem; color: var(--color-text-muted); }
    
    /* Prospects Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--color-border); font-size: 0.9rem; }
    th { background: var(--color-bg); font-weight: 600; font-size: 0.8rem; color: var(--color-text-light); }
    tr:hover td { background: var(--color-bg); }
    
    /* Status Badges */
    .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 100px; font-size: 0.75rem; font-weight: 600; }
    .badge-pending { background: #fff3cd; color: #856404; }
    .badge-visiting { background: #cce5ff; color: #004085; }
    .badge-negotiating { background: #d4edda; color: #155724; }
    .badge-closed { background: var(--color-primary); color: white; }
    .badge-rejected { background: #f8d7da; color: #721c24; }
    .badge-unvisited { background: var(--color-bg); color: var(--color-text-muted); }
    
    /* Knowledge Cards */
    .knowledge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
    .knowledge-card { background: var(--color-white); border-radius: 12px; padding: 1.25rem; box-shadow: var(--shadow-soft); border-left: 4px solid var(--color-primary); }
    .knowledge-card.success { border-left-color: var(--color-success); }
    .knowledge-card.failure { border-left-color: var(--color-error); }
    .knowledge-card.faq { border-left-color: var(--color-info); }
    .knowledge-category { font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 0.5rem; }
    .knowledge-title { font-weight: 600; margin-bottom: 0.5rem; }
    .knowledge-content { font-size: 0.9rem; color: var(--color-text-light); line-height: 1.7; }
    .knowledge-footer { display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--color-border); font-size: 0.8rem; color: var(--color-text-muted); }
    
    /* Ranking */
    .ranking-list { }
    .ranking-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--color-border); }
    .ranking-item:last-child { border-bottom: none; }
    .ranking-rank { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; }
    .ranking-rank.gold { background: linear-gradient(135deg, #ffd700, #ffec8b); color: #8b6914; }
    .ranking-rank.silver { background: linear-gradient(135deg, #c0c0c0, #e8e8e8); color: #666; }
    .ranking-rank.bronze { background: linear-gradient(135deg, #cd7f32, #daa06d); color: #5c3d1e; }
    .ranking-rank.normal { background: var(--color-bg); color: var(--color-text-muted); }
    .ranking-info { flex: 1; }
    .ranking-name { font-weight: 600; }
    .ranking-stats { font-size: 0.85rem; color: var(--color-text-muted); }
    .ranking-value { font-weight: 700; color: var(--color-primary); }
    
    /* Documents */
    .doc-list { }
    .doc-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-bottom: 1px solid var(--color-border); }
    .doc-item:last-child { border-bottom: none; }
    .doc-icon { width: 44px; height: 44px; background: var(--color-error); color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; }
    .doc-icon.pdf { background: #dc3545; }
    .doc-icon.ppt { background: #fd7e14; }
    .doc-icon.doc { background: #007bff; }
    .doc-info { flex: 1; }
    .doc-title { font-weight: 600; font-size: 0.95rem; }
    .doc-desc { font-size: 0.8rem; color: var(--color-text-muted); }
    .doc-download { padding: 0.5rem 1rem; background: var(--color-primary-pale); color: var(--color-primary); border: none; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; }
    .doc-download:hover { background: var(--color-primary); color: white; }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s; }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal { background: var(--color-white); border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow: hidden; transform: translateY(20px); transition: transform 0.3s; }
    .modal-overlay.active .modal { transform: translateY(0); }
    .modal-header { padding: 1.25rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.1rem; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; border: none; background: var(--color-bg); border-radius: 50%; font-size: 1.2rem; cursor: pointer; }
    .modal-body { padding: 1.25rem; max-height: calc(90vh - 140px); overflow-y: auto; }
    .modal-footer { padding: 1rem 1.25rem; border-top: 1px solid var(--color-border); display: flex; gap: 0.75rem; justify-content: flex-end; }
    
    /* Filter Bar */
    .filter-bar { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
    .filter-bar select, .filter-bar input { padding: 0.5rem 1rem; border: 1px solid var(--color-border); border-radius: 6px; font-size: 0.9rem; }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 3rem; color: var(--color-text-muted); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    
    /* Grid Layout */
    .grid-2 { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; }
    
    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid { grid-template-columns: repeat(2, 1fr); }
      .grid-2 { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .dashboard-grid { grid-template-columns: 1fr; }
      .nav-inner { padding: 0.5rem 1rem; }
      .main { padding: 1rem; }
      .header-user-name { display: none; }
    }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">
        <div class="login-logo-symbol">ç¤¼</div>
        <div class="login-logo-text">å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</div>
      </div>
      <h2 class="login-title">ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <div class="error-msg" id="loginError"></div>
      <div class="form-group">
        <label class="form-label">ãŠåå‰</label>
        <input type="text" class="form-input" id="loginName" placeholder="å±±ç”°å¤ªéƒ">
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" class="form-input" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
      </div>
      <button class="btn btn-primary" id="loginBtn">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <div class="login-footer">
        åˆã‚ã¦ã®æ–¹ã¯ <a href="#" id="showRegister">æ–°è¦ç™»éŒ²</a>
      </div>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal-overlay" id="registerModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">æ–°è¦ç™»éŒ²</h3>
        <button class="modal-close" id="closeRegister">&times;</button>
      </div>
      <div class="modal-body">
        <div class="error-msg" id="registerError"></div>
        <div class="form-group">
          <label class="form-label">ãŠåå‰</label>
          <input type="text" class="form-input" id="registerName" placeholder="å±±ç”°å¤ªéƒ">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
          <input type="email" class="form-input" id="registerEmail" placeholder="example@email.com">
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" class="form-input" id="registerPassword" placeholder="4æ–‡å­—ä»¥ä¸Š">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelRegister">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="registerBtn">ç™»éŒ²</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div class="app" id="app">
    <header class="header">
      <div class="header-inner">
        <div class="header-logo">
          <span class="header-logo-symbol">ç¤¼</span>
          <span class="header-logo-text">å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</span>
        </div>
        <div class="header-user">
          <span class="header-user-name" id="currentUserName"></span>
          <button class="header-logout" id="logoutBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </header>

    <nav class="nav">
      <div class="nav-inner">
        <button class="nav-item active" data-page="dashboard">ğŸ“Š ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</button>
        <button class="nav-item" data-page="prospects">ğŸ¢ è¨ªå•å…ˆç®¡ç†</button>
        <button class="nav-item" data-page="knowledge">ğŸ’¬ ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰</button>
        <button class="nav-item" data-page="documents">ğŸ“ è³‡æ–™</button>
        <button class="nav-item" data-page="ranking">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      </div>
    </nav>

    <main class="main">
      <!-- Dashboard Page -->
      <div class="page active" id="page-dashboard">
        <div class="dashboard-grid">
          <div class="stat-card">
            <div class="stat-label">ä»Šæœˆã®è¨ªå•æ•°ï¼ˆãƒãƒ¼ãƒ ï¼‰</div>
            <div class="stat-value" id="statVisits">0</div>
            <div class="stat-sub">ä»¶</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å•†è«‡ä¸­</div>
            <div class="stat-value warning" id="statNegotiating">0</div>
            <div class="stat-sub">ä»¶</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">æˆç´„æ•°</div>
            <div class="stat-value success" id="statClosed">0</div>
            <div class="stat-sub">ä»¶</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">ã‚ãªãŸã®è¨ªå•æ•°</div>
            <div class="stat-value" id="statMyVisits">0</div>
            <div class="stat-sub">ä»¶</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“¢ ãŠçŸ¥ã‚‰ã›</h3>
            </div>
            <div class="card-body" id="announcementsList" style="padding: 0;">
              <div class="empty-state">
                <p>ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</p>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ† ä»Šæœˆã®ãƒˆãƒƒãƒ—</h3>
            </div>
            <div class="card-body" id="topRanking" style="padding: 0;">
              <div class="empty-state">
                <p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Prospects Page -->
      <div class="page" id="page-prospects">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ¢ è¨ªå•å…ˆä¸€è¦§</h3>
            <button class="btn btn-primary btn-sm" id="addProspectBtn">+ æ–°è¦è¿½åŠ </button>
          </div>
          <div class="card-body">
            <div class="filter-bar">
              <select id="filterStatus">
                <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                <option value="æœªè¨ªå•">æœªè¨ªå•</option>
                <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
                <option value="å•†è«‡ä¸­">å•†è«‡ä¸­</option>
                <option value="æˆç´„">æˆç´„</option>
                <option value="è¦‹é€ã‚Š">è¦‹é€ã‚Š</option>
              </select>
              <select id="filterArea">
                <option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>
              </select>
              <input type="text" id="searchProspect" placeholder="ğŸ” è‘¬å„€ç¤¾åã§æ¤œç´¢">
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>è‘¬å„€ç¤¾å</th>
                    <th>ã‚¨ãƒªã‚¢</th>
                    <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                    <th>æ‹…å½“</th>
                    <th>æœ€çµ‚è¨ªå•</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="prospectsTable">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Knowledge Page -->
      <div class="page" id="page-knowledge">
        <div class="card" style="margin-bottom: 1.5rem;">
          <div class="card-header">
            <h3 class="card-title">ğŸ’¬ ãƒŠãƒ¬ãƒƒã‚¸å…±æœ‰</h3>
            <button class="btn btn-primary btn-sm" id="addKnowledgeBtn">+ æŠ•ç¨¿ã™ã‚‹</button>
          </div>
          <div class="card-body">
            <div class="filter-bar">
              <select id="filterKnowledgeCategory">
                <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
                <option value="æˆåŠŸäº‹ä¾‹">ğŸ“ˆ æˆåŠŸäº‹ä¾‹</option>
                <option value="å¤±æ•—äº‹ä¾‹">ğŸ“‰ å¤±æ•—äº‹ä¾‹</option>
                <option value="FAQ">â“ ã‚ˆãã‚ã‚‹è³ªå•</option>
                <option value="Tips">ğŸ’¡ Tips</option>
              </select>
            </div>
          </div>
        </div>
        <div class="knowledge-grid" id="knowledgeGrid">
        </div>
      </div>

      <!-- Documents Page -->
      <div class="page" id="page-documents">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“ å–¶æ¥­è³‡æ–™</h3>
          </div>
          <div class="card-body" style="padding: 0;">
            <div class="doc-list" id="documentsList">
            </div>
          </div>
        </div>
      </div>

      <!-- Ranking Page -->
      <div class="page" id="page-ranking">
        <div class="grid-2">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ† è¨ªå•æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä»Šæœˆï¼‰</h3>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="ranking-list" id="visitRanking">
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ¯ æˆç´„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆç´¯è¨ˆï¼‰</h3>
            </div>
            <div class="card-body" style="padding: 0;">
              <div class="ranking-list" id="closedRanking">
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add Prospect Modal -->
  <div class="modal-overlay" id="prospectModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="prospectModalTitle">è¨ªå•å…ˆã‚’è¿½åŠ </h3>
        <button class="modal-close" id="closeProspectModal">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="prospectId">
        <div class="form-group">
          <label class="form-label">è‘¬å„€ç¤¾å *</label>
          <input type="text" class="form-input" id="prospectName" placeholder="â—‹â—‹è‘¬å„€ç¤¾">
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¨ãƒªã‚¢</label>
          <input type="text" class="form-input" id="prospectArea" placeholder="å¤§é˜ªå¸‚åŒ—åŒº">
        </div>
        <div class="form-group">
          <label class="form-label">ä½æ‰€</label>
          <input type="text" class="form-input" id="prospectAddress" placeholder="å¤§é˜ªå¸‚åŒ—åŒºâ—‹â—‹1-2-3">
        </div>
        <div class="form-group">
          <label class="form-label">é›»è©±ç•ªå·</label>
          <input type="text" class="form-input" id="prospectPhone" placeholder="06-1234-5678">
        </div>
        <div class="form-group">
          <label class="form-label">æ‹…å½“è€…å</label>
          <input type="text" class="form-input" id="prospectContact" placeholder="ç”°ä¸­æ§˜">
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select class="form-input" id="prospectStatus">
            <option value="æœªè¨ªå•">æœªè¨ªå•</option>
            <option value="è¨ªå•æ¸ˆã¿">è¨ªå•æ¸ˆã¿</option>
            <option value="å•†è«‡ä¸­">å•†è«‡ä¸­</option>
            <option value="æˆç´„">æˆç´„</option>
            <option value="è¦‹é€ã‚Š">è¦‹é€ã‚Š</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ¡ãƒ¢</label>
          <textarea class="form-input" id="prospectNotes" rows="3" placeholder="å‚™è€ƒã‚„ãƒ¡ãƒ¢"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelProspect">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="saveProspect">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Add Knowledge Modal -->
  <div class="modal-overlay" id="knowledgeModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">ãƒŠãƒ¬ãƒƒã‚¸ã‚’æŠ•ç¨¿</h3>
        <button class="modal-close" id="closeKnowledgeModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">ã‚«ãƒ†ã‚´ãƒª *</label>
          <select class="form-input" id="knowledgeCategory">
            <option value="æˆåŠŸäº‹ä¾‹">ğŸ“ˆ æˆåŠŸäº‹ä¾‹</option>
            <option value="å¤±æ•—äº‹ä¾‹">ğŸ“‰ å¤±æ•—äº‹ä¾‹</option>
            <option value="FAQ">â“ ã‚ˆãã‚ã‚‹è³ªå•</option>
            <option value="Tips">ğŸ’¡ Tips</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« *</label>
          <input type="text" class="form-input" id="knowledgeTitle" placeholder="ä¾‹ï¼šåˆæœŸè²»ç”¨ã®èª¬æ˜ã§æˆç´„ã«ã¤ãªãŒã£ãŸ">
        </div>
        <div class="form-group">
          <label class="form-label">å†…å®¹ *</label>
          <textarea class="form-input" id="knowledgeContent" rows="6" placeholder="å…·ä½“çš„ãªå†…å®¹ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="cancelKnowledge">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" id="saveKnowledge">æŠ•ç¨¿</button>
      </div>
    </div>
  </div>

  <script>
    // Supabaseè¨­å®š
    const SUPABASE_URL = 'https://osyysvompcfuadlnuojs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let currentUser = null;
    let allProspects = [];
    let allMembers = [];
    let allKnowledge = [];

    // DOM Ready
    document.addEventListener('DOMContentLoaded', function() {
      // Check saved session
      const savedUser = localStorage.getItem('salesPortalUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
      }

      // Login events
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('loginPassword').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
      document.getElementById('showRegister').addEventListener('click', e => { e.preventDefault(); showModal('registerModal'); });
      document.getElementById('closeRegister').addEventListener('click', () => hideModal('registerModal'));
      document.getElementById('cancelRegister').addEventListener('click', () => hideModal('registerModal'));
      document.getElementById('registerBtn').addEventListener('click', handleRegister);
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);

      // Navigation
      document.querySelectorAll('.nav-item').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById('page-' + btn.dataset.page).classList.add('active');
        });
      });

      // Prospect Modal
      document.getElementById('addProspectBtn').addEventListener('click', () => {
        document.getElementById('prospectModalTitle').textContent = 'è¨ªå•å…ˆã‚’è¿½åŠ ';
        document.getElementById('prospectId').value = '';
        document.getElementById('prospectName').value = '';
        document.getElementById('prospectArea').value = '';
        document.getElementById('prospectAddress').value = '';
        document.getElementById('prospectPhone').value = '';
        document.getElementById('prospectContact').value = '';
        document.getElementById('prospectStatus').value = 'æœªè¨ªå•';
        document.getElementById('prospectNotes').value = '';
        showModal('prospectModal');
      });
      document.getElementById('closeProspectModal').addEventListener('click', () => hideModal('prospectModal'));
      document.getElementById('cancelProspect').addEventListener('click', () => hideModal('prospectModal'));
      document.getElementById('saveProspect').addEventListener('click', saveProspect);

      // Knowledge Modal
      document.getElementById('addKnowledgeBtn').addEventListener('click', () => showModal('knowledgeModal'));
      document.getElementById('closeKnowledgeModal').addEventListener('click', () => hideModal('knowledgeModal'));
      document.getElementById('cancelKnowledge').addEventListener('click', () => hideModal('knowledgeModal'));
      document.getElementById('saveKnowledge').addEventListener('click', saveKnowledge);

      // Filters
      document.getElementById('filterStatus').addEventListener('change', renderProspects);
      document.getElementById('filterArea').addEventListener('change', renderProspects);
      document.getElementById('searchProspect').addEventListener('input', renderProspects);
      document.getElementById('filterKnowledgeCategory').addEventListener('change', renderKnowledge);
    });

    // Auth Functions
    async function handleLogin() {
      const name = document.getElementById('loginName').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!name || !password) {
        showError('loginError', 'ãŠåå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('sales_members')
          .select('*')
          .eq('name', name)
          .eq('password_hash', password)
          .single();

        if (error || !data) {
          showError('loginError', 'ãŠåå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
          return;
        }

        currentUser = data;
        localStorage.setItem('salesPortalUser', JSON.stringify(data));
        showApp();
      } catch (e) {
        showError('loginError', 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function handleRegister() {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;

      if (!name || !password) {
        showError('registerError', 'ãŠåå‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…é ˆã§ã™');
        return;
      }
      if (password.length < 4) {
        showError('registerError', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('sales_members')
          .insert({ name, email: email || null, password_hash: password })
          .select()
          .single();

        if (error) {
          if (error.message.includes('duplicate')) {
            showError('registerError', 'ã“ã®ãŠåå‰ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™');
          } else {
            showError('registerError', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
          return;
        }

        currentUser = data;
        localStorage.setItem('salesPortalUser', JSON.stringify(data));
        hideModal('registerModal');
        showApp();
      } catch (e) {
        showError('registerError', 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function handleLogout() {
      currentUser = null;
      localStorage.removeItem('salesPortalUser');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('app').style.display = 'none';
      document.getElementById('loginName').value = '';
      document.getElementById('loginPassword').value = '';
    }

    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('currentUserName').textContent = currentUser.name + 'ã•ã‚“';
      loadAllData();
    }

    // Data Loading
    async function loadAllData() {
      await Promise.all([
        loadMembers(),
        loadProspects(),
        loadKnowledge(),
        loadAnnouncements(),
        loadDocuments()
      ]);
      updateDashboard();
      renderProspects();
      renderKnowledge();
      renderRankings();
    }

    async function loadMembers() {
      const { data } = await supabase.from('sales_members').select('*');
      allMembers = data || [];
    }

    async function loadProspects() {
      const { data } = await supabase.from('sales_prospects').select('*').order('updated_at', { ascending: false });
      allProspects = data || [];
      
      // Update area filter
      const areas = [...new Set(allProspects.map(p => p.area).filter(Boolean))];
      const areaSelect = document.getElementById('filterArea');
      areaSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚¨ãƒªã‚¢</option>' + areas.map(a => `<option value="${a}">${a}</option>`).join('');
    }

    async function loadKnowledge() {
      const { data } = await supabase.from('sales_knowledge').select('*').order('created_at', { ascending: false });
      allKnowledge = data || [];
    }

    async function loadAnnouncements() {
      const { data } = await supabase.from('sales_announcements').select('*').order('created_at', { ascending: false }).limit(5);
      const container = document.getElementById('announcementsList');
      
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }

      container.innerHTML = data.map(a => {
        const iconClass = a.priority === 'important' ? 'important' : (a.priority === 'info' ? 'info' : 'normal');
        const icon = a.priority === 'important' ? 'ğŸ””' : (a.priority === 'info' ? 'ğŸ“Œ' : 'ğŸ“¢');
        return `
          <div class="announcement-item">
            <div class="announcement-icon ${iconClass}">${icon}</div>
            <div class="announcement-content">
              <div class="announcement-title">${escapeHtml(a.title)}</div>
              <div class="announcement-date">${formatDate(a.created_at)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function loadDocuments() {
      const { data } = await supabase.from('sales_documents').select('*').order('created_at', { ascending: false });
      const container = document.getElementById('documentsList');
      
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>è³‡æ–™ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }

      container.innerHTML = data.map(d => {
        const ext = (d.file_type || 'pdf').toLowerCase();
        return `
          <div class="doc-item">
            <div class="doc-icon ${ext}">${ext.toUpperCase()}</div>
            <div class="doc-info">
              <div class="doc-title">${escapeHtml(d.title)}</div>
              <div class="doc-desc">${escapeHtml(d.description || '')}</div>
            </div>
            <a href="${d.file_url}" target="_blank" class="doc-download">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
          </div>
        `;
      }).join('');
    }

    // Dashboard
    function updateDashboard() {
      const now = new Date();
      const thisMonth = now.getMonth();
      const thisYear = now.getFullYear();

      // Count visits this month (based on updated_at for simplicity)
      const visitsThisMonth = allProspects.filter(p => {
        const d = new Date(p.updated_at);
        return d.getMonth() === thisMonth && d.getFullYear() === thisYear && p.status !== 'æœªè¨ªå•';
      }).length;

      const negotiating = allProspects.filter(p => p.status === 'å•†è«‡ä¸­').length;
      const closed = allProspects.filter(p => p.status === 'æˆç´„').length;
      const myVisits = allProspects.filter(p => p.assigned_to === currentUser.id && p.status !== 'æœªè¨ªå•').length;

      document.getElementById('statVisits').textContent = visitsThisMonth;
      document.getElementById('statNegotiating').textContent = negotiating;
      document.getElementById('statClosed').textContent = closed;
      document.getElementById('statMyVisits').textContent = myVisits;

      // Top ranking preview
      renderTopRanking();
    }

    function renderTopRanking() {
      const memberVisits = {};
      allMembers.forEach(m => { memberVisits[m.id] = { name: m.name, count: 0 }; });
      allProspects.forEach(p => {
        if (p.assigned_to && memberVisits[p.assigned_to] && p.status !== 'æœªè¨ªå•') {
          memberVisits[p.assigned_to].count++;
        }
      });

      const sorted = Object.values(memberVisits).sort((a, b) => b.count - a.count).slice(0, 3);
      const container = document.getElementById('topRanking');

      if (sorted.length === 0 || sorted[0].count === 0) {
        container.innerHTML = '<div class="empty-state"><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
        return;
      }

      container.innerHTML = sorted.map((m, i) => {
        const rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : 'bronze');
        return `
          <div class="ranking-item">
            <div class="ranking-rank ${rankClass}">${i + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${escapeHtml(m.name)}</div>
            </div>
            <div class="ranking-value">${m.count}ä»¶</div>
          </div>
        `;
      }).join('');
    }

    // Prospects
    function renderProspects() {
      const status = document.getElementById('filterStatus').value;
      const area = document.getElementById('filterArea').value;
      const search = document.getElementById('searchProspect').value.toLowerCase();

      let filtered = allProspects;
      if (status) filtered = filtered.filter(p => p.status === status);
      if (area) filtered = filtered.filter(p => p.area === area);
      if (search) filtered = filtered.filter(p => p.company_name.toLowerCase().includes(search));

      const tbody = document.getElementById('prospectsTable');
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--color-text-muted); padding: 2rem;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      tbody.innerHTML = filtered.map(p => {
        const member = allMembers.find(m => m.id === p.assigned_to);
        const statusClass = {
          'æœªè¨ªå•': 'badge-unvisited',
          'è¨ªå•æ¸ˆã¿': 'badge-visiting',
          'å•†è«‡ä¸­': 'badge-negotiating',
          'æˆç´„': 'badge-closed',
          'è¦‹é€ã‚Š': 'badge-rejected'
        }[p.status] || 'badge-unvisited';

        return `
          <tr>
            <td><strong>${escapeHtml(p.company_name)}</strong></td>
            <td>${escapeHtml(p.area || '-')}</td>
            <td><span class="badge ${statusClass}">${p.status}</span></td>
            <td>${member ? escapeHtml(member.name) : '-'}</td>
            <td>${formatDate(p.updated_at)}</td>
            <td>
              <button class="btn btn-secondary btn-sm" onclick="editProspect('${p.id}')">ç·¨é›†</button>
              <button class="btn btn-accent btn-sm" onclick="assignToMe('${p.id}')">æ‹…å½“ã™ã‚‹</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function saveProspect() {
      const id = document.getElementById('prospectId').value;
      const data = {
        company_name: document.getElementById('prospectName').value.trim(),
        area: document.getElementById('prospectArea').value.trim(),
        address: document.getElementById('prospectAddress').value.trim(),
        phone: document.getElementById('prospectPhone').value.trim(),
        contact_person: document.getElementById('prospectContact').value.trim(),
        status: document.getElementById('prospectStatus').value,
        notes: document.getElementById('prospectNotes').value.trim(),
        updated_at: new Date().toISOString()
      };

      if (!data.company_name) {
        alert('è‘¬å„€ç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        if (id) {
          await supabase.from('sales_prospects').update(data).eq('id', id);
        } else {
          data.assigned_to = currentUser.id;
          await supabase.from('sales_prospects').insert(data);
        }
        hideModal('prospectModal');
        await loadProspects();
        renderProspects();
        updateDashboard();
      } catch (e) {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function editProspect(id) {
      const p = allProspects.find(x => x.id === id);
      if (!p) return;

      document.getElementById('prospectModalTitle').textContent = 'è¨ªå•å…ˆã‚’ç·¨é›†';
      document.getElementById('prospectId').value = p.id;
      document.getElementById('prospectName').value = p.company_name || '';
      document.getElementById('prospectArea').value = p.area || '';
      document.getElementById('prospectAddress').value = p.address || '';
      document.getElementById('prospectPhone').value = p.phone || '';
      document.getElementById('prospectContact').value = p.contact_person || '';
      document.getElementById('prospectStatus').value = p.status || 'æœªè¨ªå•';
      document.getElementById('prospectNotes').value = p.notes || '';
      showModal('prospectModal');
    }

    async function assignToMe(id) {
      try {
        await supabase.from('sales_prospects').update({ 
          assigned_to: currentUser.id,
          updated_at: new Date().toISOString()
        }).eq('id', id);
        await loadProspects();
        renderProspects();
        updateDashboard();
      } catch (e) {
        alert('æ‹…å½“è¨­å®šã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // Knowledge
    function renderKnowledge() {
      const category = document.getElementById('filterKnowledgeCategory').value;
      let filtered = allKnowledge;
      if (category) filtered = filtered.filter(k => k.category === category);

      const container = document.getElementById('knowledgeGrid');
      
      if (filtered.length === 0) {
        container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">ğŸ’¬</div><p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p><p style="font-size: 0.85rem; margin-top: 0.5rem;">ã€Œ+ æŠ•ç¨¿ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å…±æœ‰ã—ã¾ã—ã‚‡ã†ï¼</p></div>';
        return;
      }

      container.innerHTML = filtered.map(k => {
        const member = allMembers.find(m => m.id === k.member_id);
        const cardClass = {
          'æˆåŠŸäº‹ä¾‹': 'success',
          'å¤±æ•—äº‹ä¾‹': 'failure',
          'FAQ': 'faq',
          'Tips': ''
        }[k.category] || '';
        const icon = {
          'æˆåŠŸäº‹ä¾‹': 'ğŸ“ˆ',
          'å¤±æ•—äº‹ä¾‹': 'ğŸ“‰',
          'FAQ': 'â“',
          'Tips': 'ğŸ’¡'
        }[k.category] || 'ğŸ“';

        return `
          <div class="knowledge-card ${cardClass}">
            <div class="knowledge-category">${icon} ${k.category}</div>
            <div class="knowledge-title">${escapeHtml(k.title)}</div>
            <div class="knowledge-content">${escapeHtml(k.content)}</div>
            <div class="knowledge-footer">
              <span>${member ? escapeHtml(member.name) : 'åŒ¿å'}</span>
              <span>${formatDate(k.created_at)}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    async function saveKnowledge() {
      const data = {
        member_id: currentUser.id,
        category: document.getElementById('knowledgeCategory').value,
        title: document.getElementById('knowledgeTitle').value.trim(),
        content: document.getElementById('knowledgeContent').value.trim()
      };

      if (!data.title || !data.content) {
        alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        await supabase.from('sales_knowledge').insert(data);
        hideModal('knowledgeModal');
        document.getElementById('knowledgeTitle').value = '';
        document.getElementById('knowledgeContent').value = '';
        await loadKnowledge();
        renderKnowledge();
      } catch (e) {
        alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // Rankings
    function renderRankings() {
      // Visit Ranking
      const memberVisits = {};
      allMembers.forEach(m => { memberVisits[m.id] = { name: m.name, count: 0 }; });
      allProspects.forEach(p => {
        if (p.assigned_to && memberVisits[p.assigned_to] && p.status !== 'æœªè¨ªå•') {
          memberVisits[p.assigned_to].count++;
        }
      });

      const visitSorted = Object.values(memberVisits).sort((a, b) => b.count - a.count);
      const visitContainer = document.getElementById('visitRanking');
      visitContainer.innerHTML = visitSorted.map((m, i) => {
        const rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : 'normal'));
        return `
          <div class="ranking-item">
            <div class="ranking-rank ${rankClass}">${i + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${escapeHtml(m.name)}</div>
            </div>
            <div class="ranking-value">${m.count}ä»¶</div>
          </div>
        `;
      }).join('') || '<div class="empty-state"><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';

      // Closed Ranking
      const memberClosed = {};
      allMembers.forEach(m => { memberClosed[m.id] = { name: m.name, count: 0 }; });
      allProspects.forEach(p => {
        if (p.assigned_to && memberClosed[p.assigned_to] && p.status === 'æˆç´„') {
          memberClosed[p.assigned_to].count++;
        }
      });

      const closedSorted = Object.values(memberClosed).sort((a, b) => b.count - a.count);
      const closedContainer = document.getElementById('closedRanking');
      closedContainer.innerHTML = closedSorted.map((m, i) => {
        const rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : (i === 2 ? 'bronze' : 'normal'));
        return `
          <div class="ranking-item">
            <div class="ranking-rank ${rankClass}">${i + 1}</div>
            <div class="ranking-info">
              <div class="ranking-name">${escapeHtml(m.name)}</div>
            </div>
            <div class="ranking-value">${m.count}ä»¶</div>
          </div>
        `;
      }).join('') || '<div class="empty-state"><p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
    }

    // Utilities
    function showModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function hideModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showError(id, message) {
      const el = document.getElementById(id);
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return `${d.getMonth() + 1}/${d.getDate()}`;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }
  </script>
</body>
</html>