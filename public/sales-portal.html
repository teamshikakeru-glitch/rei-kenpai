<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
<title>Rei å–¶æ¥­ãƒãƒ¼ã‚¿ãƒ«</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#000000">
<meta name="apple-mobile-web-app-capable" content="yes">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+JP:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height:100%;-webkit-text-size-adjust:100%;}
body{font-family:'Inter','Noto Sans JP',-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;background:#000;color:#1d1d1f;line-height:1.47;overscroll-behavior:none;min-height:100%;letter-spacing:-0.01em;}
button{font-family:inherit;cursor:pointer;-webkit-appearance:none;}
input,select,textarea{font-family:inherit;-webkit-appearance:none;}
a{color:inherit;text-decoration:none;}
::-webkit-scrollbar{display:none;}

/* ===== LOGIN ===== */
.login-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#000;padding:20px;}
.login-box{width:100%;max-width:360px;text-align:center;}
.login-brand{font-size:48px;font-weight:900;color:#fff;letter-spacing:6px;margin-bottom:4px;}
.login-sub{font-size:11px;color:#86868b;margin-bottom:40px;letter-spacing:3px;text-transform:uppercase;}
.login-card{background:#1c1c1e;border-radius:20px;padding:32px 24px;border:1px solid rgba(255,255,255,0.06);}
.login-err{background:rgba(255,59,48,0.12);color:#ff453a;font-size:13px;padding:12px 16px;border-radius:12px;margin-bottom:16px;display:none;font-weight:500;}
.login-input{width:100%;padding:15px 18px;border-radius:12px;border:none;font-size:16px;background:#2c2c2e;color:#fff;outline:none;transition:all .2s;margin-bottom:10px;}
.login-input::placeholder{color:#636366;}
.login-input:focus{background:#3a3a3c;box-shadow:0 0 0 2px rgba(10,132,255,0.5);}
.login-btn{width:100%;padding:16px;border-radius:14px;border:none;background:#0a84ff;color:#fff;font-size:16px;font-weight:700;margin-top:8px;transition:all .15s;letter-spacing:0.3px;}
.login-btn:active{transform:scale(0.97);opacity:0.9;}

/* ===== APP ===== */
#app{display:none;max-width:430px;margin:0 auto;min-height:100vh;position:relative;background:#f2f2f7;}
.hdr{background:rgba(249,249,249,0.94);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;border-bottom:0.5px solid rgba(0,0,0,0.1);}
.hdr-logo{font-size:20px;font-weight:900;letter-spacing:3px;color:#1d1d1f;}
.hdr-user{display:flex;align-items:center;gap:10px;}
.hdr-badge{display:flex;align-items:center;gap:7px;padding:5px 14px 5px 5px;border-radius:100px;font-size:13px;font-weight:600;}
.hdr-avatar{width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;}
.hdr-logout{background:none;border:none;color:#86868b;padding:6px;display:flex;transition:color .2s;}

/* ===== PAGES ===== */
.pg{display:none;padding:0 0 100px;opacity:0;transform:translateY(8px);transition:opacity .3s ease,transform .3s ease;}
.pg.active{display:block;opacity:1;transform:translateY(0);}

/* ===== BOTTOM NAV ===== */
.bnav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:430px;background:rgba(249,249,249,0.94);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:0.5px solid rgba(0,0,0,0.1);display:flex;justify-content:space-around;padding:8px 0 env(safe-area-inset-bottom,10px);z-index:100;}
.bnav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;background:none;border:none;padding:6px 12px;color:#86868b;transition:all .2s;}
.bnav-btn.active{color:#0a84ff;}
.bnav-btn svg{width:24px;height:24px;transition:transform .2s;}
.bnav-btn:active svg{transform:scale(0.85);}
.bnav-btn span{font-size:10px;font-weight:500;}
.bnav-btn.active span{font-weight:600;}

/* ===== UTILITY ===== */
.s-title{font-size:28px;font-weight:800;color:#1d1d1f;padding:24px 20px 16px;letter-spacing:-0.5px;}
.card{background:#fff;border-radius:16px;margin:0 16px 12px;padding:16px 18px;box-shadow:0 1px 3px rgba(0,0,0,0.04),0 4px 12px rgba(0,0,0,0.04);transition:transform .2s,box-shadow .2s;}
.card:active{transform:scale(0.985);box-shadow:0 1px 2px rgba(0,0,0,0.06);}
.toggle-wrap{display:inline-flex;gap:2px;background:rgba(118,118,128,0.12);border-radius:9px;padding:2px;}
.toggle-btn{padding:7px 18px;border-radius:7px;border:none;font-size:13px;font-weight:600;background:transparent;color:#86868b;transition:all .25s ease;}
.toggle-btn.active{background:#fff;color:#1d1d1f;box-shadow:0 1px 4px rgba(0,0,0,0.08),0 0 1px rgba(0,0,0,0.04);}
.badge{font-size:11px;font-weight:700;padding:4px 10px;border-radius:100px;display:inline-block;}
.empty{text-align:center;padding:40px 20px;color:#86868b;font-size:15px;font-weight:500;background:#fff;border-radius:16px;margin:0 16px;}

/* ===== ALERT BANNER ===== */
.alert-banner{margin:16px 16px 0;padding:16px 20px;border-radius:16px;background:linear-gradient(135deg,#ff453a 0%,#d70015 100%);color:#fff;display:flex;align-items:flex-start;gap:14px;box-shadow:0 4px 20px rgba(255,69,58,0.3);animation:alertPulse 2.5s ease-in-out infinite;}
@keyframes alertPulse{0%,100%{box-shadow:0 4px 20px rgba(255,69,58,0.3);}50%{box-shadow:0 6px 28px rgba(255,69,58,0.5);}}
.alert-icon{width:42px;height:42px;border-radius:12px;background:rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:22px;}
.alert-body{flex:1;}
.alert-title{font-size:15px;font-weight:800;margin-bottom:3px;letter-spacing:-0.2px;}
.alert-sub{font-size:12px;opacity:0.92;line-height:1.5;font-weight:500;}

/* ===== APPO CARD ===== */
.appo-card{margin:12px 16px 0;padding:18px 20px;border-radius:16px;background:#fff;border-left:4px solid #ff453a;display:flex;align-items:center;gap:16px;box-shadow:0 2px 8px rgba(0,0,0,0.06);position:relative;}
.appo-card.tomorrow{border-left-color:#ff9f0a;}
.appo-chip{width:52px;height:52px;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;font-weight:800;}
.appo-chip.td{background:rgba(255,69,58,0.08);color:#ff453a;}
.appo-chip.tm{background:rgba(255,159,10,0.08);color:#ff9f0a;}
.appo-chip-d{font-size:22px;line-height:1;}
.appo-chip-w{font-size:10px;font-weight:700;margin-top:1px;}
.appo-info{flex:1;min-width:0;}
.appo-company{font-size:16px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-0.3px;}
.appo-time{font-size:14px;font-weight:700;margin-top:3px;}
.appo-card .appo-time{color:#ff453a;}
.appo-card.tomorrow .appo-time{color:#ff9f0a;}
.appo-label{position:absolute;top:10px;right:14px;font-size:10px;font-weight:800;padding:3px 8px;border-radius:6px;letter-spacing:0.5px;}
.appo-label.td{background:rgba(255,69,58,0.1);color:#ff453a;}
.appo-label.tm{background:rgba(255,159,10,0.1);color:#ff9f0a;}

/* ===== STATS ===== */
.stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;padding:0 16px;margin-bottom:4px;}
.stat-card{background:#fff;border-radius:16px;padding:22px 14px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,0.04),0 4px 12px rgba(0,0,0,0.04);}
.stat-val{font-size:34px;font-weight:900;line-height:1;letter-spacing:-1px;}
.stat-lbl{font-size:12px;color:#86868b;margin-top:6px;font-weight:600;}

/* ===== CALENDAR ===== */
.cal-wrap{background:#fff;border-radius:16px;margin:16px 16px 0;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.04),0 4px 12px rgba(0,0,0,0.04);}
.cal-nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
.cal-nav-btn{border:none;background:rgba(118,118,128,0.12);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;transition:all .15s;color:#1d1d1f;}
.cal-nav-btn:active{background:rgba(118,118,128,0.2);transform:scale(0.9);}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
.cal-hdr{font-size:11px;font-weight:600;color:#86868b;padding:6px 0;}
.cal-hdr.sun{color:#ff453a;}
.cal-hdr.sat{color:#0a84ff;}
.cal-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:50%;font-size:14px;cursor:pointer;position:relative;border:2px solid transparent;transition:all .2s;font-weight:500;}
.cal-day:active{transform:scale(0.88);}
.cal-day.today{background:#0a84ff;color:#fff;font-weight:800;}
.cal-day.selected:not(.today){border-color:#0a84ff;background:rgba(10,132,255,0.08);}
.cal-day.has-appo{background:rgba(255,69,58,0.1);color:#ff453a;font-weight:800;}
.cal-day.has-appo.today{background:#ff453a;color:#fff;}
.cal-day.has-appo.selected:not(.today){border-color:#ff453a;background:rgba(255,69,58,0.12);}
.cal-dots{position:absolute;bottom:1px;display:flex;gap:2px;}
.cal-dot{width:4px;height:4px;border-radius:50%;}
.cal-appo-mark{position:absolute;top:2px;right:2px;width:6px;height:6px;border-radius:50%;background:#ff453a;}

/* ===== FILTER BAR ===== */
.filter-bar{padding:12px 16px;display:flex;flex-direction:column;gap:10px;position:sticky;top:49px;z-index:40;background:rgba(242,242,247,0.92);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);}
.filter-search{position:relative;}
.filter-search input{width:100%;padding:11px 12px 11px 38px;border-radius:12px;border:none;font-size:15px;background:rgba(118,118,128,0.12);color:#1d1d1f;outline:none;transition:all .2s;font-weight:400;}
.filter-search input:focus{background:#fff;box-shadow:0 0 0 2px rgba(10,132,255,0.4);}
.filter-search input::placeholder{color:#86868b;}
.filter-search svg{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#86868b;}
.filter-pills{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;}
.fpill{padding:8px 16px;border-radius:100px;border:none;font-size:13px;font-weight:600;white-space:nowrap;background:rgba(118,118,128,0.12);color:#86868b;transition:all .2s;}
.fpill:active{transform:scale(0.95);}
.fpill.active{background:#0a84ff;color:#fff;}
.sort-btn{padding:8px 14px;border-radius:100px;border:none;font-size:13px;font-weight:600;background:rgba(118,118,128,0.12);color:#86868b;display:flex;align-items:center;gap:4px;white-space:nowrap;transition:all .2s;}
.sort-btn.active{background:rgba(10,132,255,0.12);color:#0a84ff;}

/* ===== VISIT CARD ===== */
.visit-grid{padding:0 16px;display:flex;flex-direction:column;gap:12px;}
.vcard{background:#fff;border-radius:16px;padding:18px 20px;box-shadow:0 1px 3px rgba(0,0,0,0.04),0 4px 12px rgba(0,0,0,0.04);transition:transform .2s,box-shadow .2s;}
.vcard:active{transform:scale(0.985);}
.vcard-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;}
.vcard-name{font-size:17px;font-weight:800;line-height:1.3;flex:1;margin-right:10px;letter-spacing:-0.3px;}
.vcard-info{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;}
.vcard-row{display:flex;align-items:center;gap:10px;font-size:13px;color:#3c3c43;}
.vcard-row svg{width:16px;height:16px;flex-shrink:0;color:#86868b;}
.vcard-row a{color:#0a84ff;font-weight:600;}
.vcard-memo{font-size:13px;color:#86868b;line-height:1.6;background:#f2f2f7;padding:12px 14px;border-radius:12px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;cursor:pointer;transition:background .15s;}
.vcard-memo:active{background:#e8e8ed;}
.vcard-footer{display:flex;justify-content:space-between;align-items:center;margin-top:14px;padding-top:14px;border-top:0.5px solid rgba(0,0,0,0.06);}
.vcard-assign{display:flex;align-items:center;gap:10px;}
.vcard-assign-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;}
.vcard-assign-name{font-size:13px;font-weight:600;color:#1d1d1f;}
.assign-btn{padding:7px 16px;border-radius:100px;border:1.5px dashed #c7c7cc;font-size:12px;font-weight:700;background:#fff;color:#86868b;transition:all .2s;}
.assign-btn:active{background:#f2f2f7;transform:scale(0.95);}
.vcard-detail{display:none;margin-top:14px;padding-top:14px;border-top:0.5px solid rgba(0,0,0,0.06);}
.vcard-detail.open{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(-4px);}to{opacity:1;transform:translateY(0);}}
.vcard-detail-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:14px;}
.vcard-full-memo{font-size:14px;color:#3c3c43;line-height:1.8;background:#f2f2f7;padding:16px;border-radius:14px;margin-top:10px;white-space:pre-wrap;}

/* ===== SCHEDULE ===== */
.sch-card{background:#fff;border-radius:14px;padding:16px 18px;margin:0 16px 8px;display:flex;align-items:center;gap:14px;box-shadow:0 1px 3px rgba(0,0,0,0.04);transition:transform .2s;}
.sch-card:active{transform:scale(0.98);}
.sch-time{font-size:14px;font-weight:700;color:#0a84ff;width:50px;flex-shrink:0;text-align:center;}

/* ===== EXPENSE ===== */
.exp-item{background:#fff;border-radius:14px;padding:16px 18px;margin:0 16px 8px;display:flex;align-items:center;gap:14px;box-shadow:0 1px 3px rgba(0,0,0,0.04);transition:transform .2s;}
.exp-item:active{transform:scale(0.98);}
.exp-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

/* ===== FORM ===== */
.form-label{font-size:13px;color:#86868b;margin-bottom:6px;font-weight:600;display:block;}
.form-input{width:100%;padding:14px 16px;border-radius:12px;border:none;font-size:15px;background:rgba(118,118,128,0.12);outline:none;box-sizing:border-box;transition:all .2s;color:#1d1d1f;}
.form-input:focus{background:#fff;box-shadow:0 0 0 2px rgba(10,132,255,0.4);}
.form-textarea{width:100%;padding:14px 16px;border-radius:12px;border:none;font-size:14px;resize:none;height:90px;font-family:inherit;background:rgba(118,118,128,0.12);box-sizing:border-box;outline:none;transition:all .2s;color:#1d1d1f;}
.form-textarea:focus{background:#fff;box-shadow:0 0 0 2px rgba(10,132,255,0.4);}
.form-group{margin-bottom:16px;}
.btn-primary{width:100%;padding:16px;border-radius:14px;border:none;background:#0a84ff;color:#fff;font-size:16px;font-weight:700;transition:all .15s;letter-spacing:0.2px;}
.btn-primary:active{transform:scale(0.97);opacity:0.9;}
.btn-sm{display:flex;align-items:center;gap:6px;padding:8px 18px;border-radius:100px;background:#0a84ff;color:#fff;border:none;font-size:13px;font-weight:600;transition:all .15s;}
.btn-sm:active{transform:scale(0.93);opacity:0.9;}
.result-btns{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;}
.result-btn{padding:12px 0;border-radius:12px;border:none;background:rgba(118,118,128,0.12);color:#86868b;font-size:13px;font-weight:600;transition:all .2s;}
.result-btn:active{transform:scale(0.95);}
.result-btn.active{background:#0a84ff;color:#fff;box-shadow:0 2px 8px rgba(10,132,255,0.3);}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.3);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);}
.modal-overlay.show{display:flex;}
.modal-sheet{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:430px;max-height:85vh;overflow-y:auto;padding:28px 24px env(safe-area-inset-bottom,24px);animation:sheetUp .3s cubic-bezier(.32,.72,0,1);}
@keyframes sheetUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:36px;height:5px;background:#c7c7cc;border-radius:3px;margin:0 auto 20px;}
.modal-title{font-size:20px;font-weight:800;margin-bottom:20px;letter-spacing:-0.3px;}

/* ===== SWITCH ===== */
.switch{position:relative;display:inline-block;width:51px;height:31px;}
.switch input{opacity:0;width:0;height:0;}
.switch-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#e9e9eb;border-radius:31px;transition:.3s cubic-bezier(.4,0,.2,1);}
.switch-slider:before{position:absolute;content:"";height:27px;width:27px;left:2px;bottom:2px;background-color:white;border-radius:50%;transition:.3s cubic-bezier(.4,0,.2,1);box-shadow:0 1px 3px rgba(0,0,0,0.1);}
.switch input:checked+.switch-slider{background-color:#34c759;}
.switch input:checked+.switch-slider:before{transform:translateX(20px);}

/* ===== MEMBER COLORS ===== */
.mc-blue .hdr-badge{background:rgba(10,132,255,0.12);color:#0a84ff;}.mc-blue .hdr-avatar{background:#0a84ff;}
.mc-green .hdr-badge{background:rgba(52,199,89,0.12);color:#34c759;}.mc-green .hdr-avatar{background:#34c759;}
.mc-amber .hdr-badge{background:rgba(255,159,10,0.12);color:#ff9f0a;}.mc-amber .hdr-avatar{background:#ff9f0a;}
.mc-rose .hdr-badge{background:rgba(255,55,95,0.12);color:#ff375f;}.mc-rose .hdr-avatar{background:#ff375f;}
.mc-purple .hdr-badge{background:rgba(175,82,222,0.12);color:#af52de;}.mc-purple .hdr-avatar{background:#af52de;}
svg{vertical-align:middle;}
</style>
</head>
<body>
<div class="login-wrap" id="loginScreen"><div class="login-box"><div class="login-brand">Rei</div><div class="login-sub">Sales Portal</div><div class="login-card"><div class="login-err" id="loginError">åå‰ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</div><input class="login-input" type="text" id="loginName" placeholder="åå‰"><input class="login-input" type="password" id="loginPass" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"><button class="login-btn" onclick="doLogin()">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button></div></div></div>

<div id="app">
<header class="hdr"><div class="hdr-logo">Rei</div><div class="hdr-user"><div class="hdr-badge" id="hdrBadge"><div class="hdr-avatar" id="hdrAvatar"></div><span id="hdrName"></span></div><button class="hdr-logout" onclick="doLogout()"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M7 2H3.5A1.5 1.5 0 0 0 2 3.5v11A1.5 1.5 0 0 0 3.5 16H7M11 12l3-3-3-3M14 9H6"/></svg></button></div></header>
<div class="pg active" id="pg-home"></div>
<div class="pg" id="pg-visits"></div>
<div class="pg" id="pg-schedule"></div>
<div class="pg" id="pg-review"></div>
<div class="pg" id="pg-expense"></div>
<nav class="bnav">
<button class="bnav-btn active" data-tab="home"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5L10 3l7 6.5V17a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9.5z"/><path d="M8 17V12h4v5"/></svg><span>ãƒ›ãƒ¼ãƒ </span></button>
<button class="bnav-btn" data-tab="visits"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="16" height="14" rx="2"/><path d="M8 7v6M12 7v6M2 7h16"/></svg><span>è¨ªå•å…ˆ</span></button>
<button class="bnav-btn" data-tab="schedule"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="16" height="14" rx="2"/><path d="M2 8h16M6 2v4M14 2v4"/></svg><span>äºˆå®š</span></button>
<button class="bnav-btn" data-tab="review"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg><span>æŒ¯ã‚Šè¿”ã‚Š</span></button>
<button class="bnav-btn" data-tab="expense"><svg fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span>çµŒè²»</span></button>
</nav>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="scheduleModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-title">äºˆå®šã‚’è¿½åŠ </div><div class="form-group"><label class="form-label">æ—¥ä»˜</label><input type="date" class="form-input" id="schDate"></div><div class="form-group"><label class="form-label">å†…å®¹</label><input type="text" class="form-input" id="schMemo" placeholder="ä¾‹ï¼šç´«è‹‘ã•ã¾å•†è«‡"></div><div class="form-group" style="display:flex;justify-content:space-between;align-items:center;"><label class="form-label" style="margin:0;">å…¨å“¡ã«å…¬é–‹</label><label class="switch"><input type="checkbox" id="schPublic" checked><span class="switch-slider"></span></label></div><button class="btn-primary" onclick="submitSchedule()">è¿½åŠ ã™ã‚‹</button><button onclick="closeModal('scheduleModal')" style="width:100%;padding:14px;border:none;background:none;color:#86868b;font-size:14px;font-weight:600;margin-top:8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
<div class="modal-overlay" id="assignModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-title">æ‹…å½“è€…ã‚’å¤‰æ›´</div><div id="assignMemberList"></div><button onclick="closeModal('assignModal')" style="width:100%;padding:14px;border:none;background:none;color:#86868b;font-size:14px;font-weight:600;margin-top:8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>
<div class="modal-overlay" id="expenseModal"><div class="modal-sheet"><div class="modal-handle"></div><div class="modal-title">çµŒè²»ã‚’ç”³è«‹ã™ã‚‹</div><div class="form-group"><label class="form-label">æ—¥ä»˜</label><input type="date" class="form-input" id="expDate"></div><div class="form-group"><label class="form-label">ã‚«ãƒ†ã‚´ãƒª</label><select class="form-input" id="expCategory"><option value="äº¤é€šè²»">äº¤é€šè²»</option><option value="å®¿æ³Šè²»">å®¿æ³Šè²»</option><option value="é£²é£Ÿè²»">é£²é£Ÿè²»</option><option value="å‚™å“">å‚™å“</option><option value="ãã®ä»–">ãã®ä»–</option></select></div><div class="form-group"><label class="form-label">é‡‘é¡</label><input type="number" class="form-input" id="expAmount" placeholder="Â¥"></div><div class="form-group"><label class="form-label">å†…å®¹</label><input type="text" class="form-input" id="expDesc" placeholder="ä¾‹ï¼šç¦äº•â†’é‡‘æ²¢ å¾€å¾©"></div><button class="btn-primary" onclick="submitExpense()">ç”³è«‹ã™ã‚‹</button><button onclick="closeModal('expenseModal')" style="width:100%;padding:14px;border:none;background:none;color:#86868b;font-size:14px;font-weight:600;margin-top:8px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button></div></div>

<script>
var supabase,currentMember=null,members=[],prospects=[],schedules=[],expenses=[],evaluations=[];
var SUPABASE_URL='https://osyysvompcfuadlnuojs.supabase.co';
var SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9zeXlzdm9tcGNmdWFkbG51b2pzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjYzODQsImV4cCI6MjA4MzY0MjM4NH0.6GkJnnULLFH0Ep2q7IzkV5O4XNlpy8vDEB2GNM7b0w4';
var MEMBER_COLORS=['blue','green','amber','rose','purple'];
var COLOR_MAP={blue:{bg:'rgba(10,132,255,0.1)',text:'#0a84ff',dot:'#0a84ff'},green:{bg:'rgba(52,199,89,0.1)',text:'#34c759',dot:'#34c759'},amber:{bg:'rgba(255,159,10,0.1)',text:'#ff9f0a',dot:'#ff9f0a'},rose:{bg:'rgba(255,55,95,0.1)',text:'#ff375f',dot:'#ff375f'},purple:{bg:'rgba(175,82,222,0.1)',text:'#af52de',dot:'#af52de'}};
var STATUS_COLORS={'ã‚¢ãƒæ¸ˆ':{bg:'rgba(175,82,222,0.1)',c:'#af52de'},'è¨ªå•æ¸ˆã¿':{bg:'rgba(10,132,255,0.1)',c:'#0a84ff'},'å•†è«‡ä¸­':{bg:'rgba(255,159,10,0.1)',c:'#ff9f0a'},'è¦‹è¾¼ã¿':{bg:'rgba(255,159,10,0.1)',c:'#ff9f0a'},'æˆç´„':{bg:'rgba(52,199,89,0.1)',c:'#34c759'},'è¦‹é€ã‚Š':{bg:'rgba(255,69,58,0.1)',c:'#ff453a'},'æœªè¨ªå•':{bg:'rgba(142,142,147,0.1)',c:'#8e8e93'}};
var REGIONS={'åŒ—æµ·é“':['åŒ—æµ·é“'],'æ±åŒ—':['é’æ£®çœŒ','å²©æ‰‹çœŒ','å®®åŸçœŒ','ç§‹ç”°çœŒ','å±±å½¢çœŒ','ç¦å³¶çœŒ'],'é–¢æ±':['æ±äº¬éƒ½','ç¥å¥ˆå·çœŒ','åŸ¼ç‰çœŒ','åƒè‘‰çœŒ','èŒ¨åŸçœŒ','æ ƒæœ¨çœŒ','ç¾¤é¦¬çœŒ'],'åŒ—é™¸':['æ–°æ½ŸçœŒ','å¯Œå±±çœŒ','çŸ³å·çœŒ','ç¦äº•çœŒ'],'æ±æµ·':['å±±æ¢¨çœŒ','é•·é‡çœŒ','å²é˜œçœŒ','é™å²¡çœŒ','æ„›çŸ¥çœŒ','ä¸‰é‡çœŒ'],'é–¢è¥¿':['æ»‹è³€çœŒ','äº¬éƒ½åºœ','å¤§é˜ªåºœ','å…µåº«çœŒ','å¥ˆè‰¯çœŒ','å’Œæ­Œå±±çœŒ'],'ä¸­å›½':['é³¥å–çœŒ','å³¶æ ¹çœŒ','å²¡å±±çœŒ','åºƒå³¶çœŒ','å±±å£çœŒ'],'å››å›½':['å¾³å³¶çœŒ','é¦™å·çœŒ','æ„›åª›çœŒ','é«˜çŸ¥çœŒ'],'ä¹å·':['ç¦å²¡çœŒ','ä½è³€çœŒ','é•·å´çœŒ','ç†Šæœ¬çœŒ','å¤§åˆ†çœŒ','å®®å´çœŒ','é¹¿å…å³¶çœŒ','æ²–ç¸„çœŒ']};
var currentTab='home',calDate=new Date(),selectedDate=new Date().toISOString().split('T')[0];
var visitSearch='',visitFilterStatus='',visitFilterRegion='',visitFilterMember='',visitSortDate=false;
var scheduleScope='all',reviewResult='',assignProspectId=null;

function mc(mid){var i=members.findIndex(function(m){return m.id===mid});return COLOR_MAP[MEMBER_COLORS[i%MEMBER_COLORS.length]]||COLOR_MAP.blue;}
function mcc(mid){var i=members.findIndex(function(m){return m.id===mid});return'mc-'+(MEMBER_COLORS[i%MEMBER_COLORS.length]||'blue');}
function mn(mid){var m=members.find(function(x){return x.id===mid});return m?m.name:'';}
function esc(s){return s?String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'):'';}
function pad(n){return String(n).padStart(2,'0');}
function ds(y,m,d){return y+'-'+pad(m)+'-'+pad(d);}
function fd(s){if(!s)return'-';var p=s.split('-');return parseInt(p[1])+'/'+parseInt(p[2]);}
function gd(s){return['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][new Date(s).getDay()];}
function gr(a){for(var r in REGIONS){if(REGIONS[r].indexOf(a)!==-1)return r;}return'';}

function parseMD(t){
  if(!t)return null;
  var iso=/^(\d{4})-(\d{1,2})-(\d{1,2})/.exec(t);if(iso)return iso[1]+'-'+pad(+iso[2])+'-'+pad(+iso[3]);
  var jp=/(\d{1,2})\s*[æœˆ\/]\s*(\d{1,2})\s*æ—¥?/.exec(t);
  if(jp){var m=+jp[1],d=+jp[2];if(m>=1&&m<=12&&d>=1&&d<=31){var y=new Date().getFullYear();var now=new Date();if(m<now.getMonth()+1||(m===now.getMonth()+1&&d<now.getDate()))y++;return y+'-'+pad(m)+'-'+pad(d);}}
  var sl=/^(\d{1,2})\/(\d{1,2})$/.exec(t.trim());if(sl){var m2=+sl[1],d2=+sl[2];if(m2>=1&&m2<=12&&d2>=1&&d2<=31)return new Date().getFullYear()+'-'+pad(m2)+'-'+pad(d2);}
  return null;
}
function buildAM(){var map={};prospects.forEach(function(p){var d=parseMD(p.meeting_date);if(d){if(!map[d])map[d]=[];map[d].push({co:p.company_name,time:p.meeting_time||'',to:p.assigned_to,id:p.id});}});return map;}

window.onload=function(){
  supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
  var saved=localStorage.getItem('salesPortalMemberId');
  if(saved){loadMembers(function(){loginAs(saved);});}
  document.getElementById('loginName').onkeypress=function(e){if(e.key==='Enter')document.getElementById('loginPass').focus();};
  document.getElementById('loginPass').onkeypress=function(e){if(e.key==='Enter')doLogin();};
  document.querySelectorAll('.bnav-btn').forEach(function(b){b.onclick=function(){switchTab(b.dataset.tab);};});
};
function loadMembers(cb){supabase.from('sales_members').select('*').then(function(r){if(r.error)alert('DB: '+r.error.message);members=r.data||[];if(cb)cb();});}
function doLogin(){
  var name=document.getElementById('loginName').value.trim(),pw=document.getElementById('loginPass').value;if(!name||!pw)return;
  loadMembers(function(){
    alert('ãƒ¡ãƒ³ãƒãƒ¼æ•°:'+members.length+'\n'+members.map(function(m){return m.name+'/'+m.password+'/'+m.password_hash;}).join('\n'));
    var f=members.find(function(m){return(m.name===name||m.name.indexOf(name)!==-1||name.indexOf(m.name)!==-1)&&(m.password===pw||m.password_hash===pw);});
    if(f){localStorage.setItem('salesPortalMemberId',f.id);loginAs(f.id);}else{document.getElementById('loginError').style.display='block';}
  });
}
function loginAs(id){
  currentMember=members.find(function(m){return m.id===id;});if(!currentMember){localStorage.removeItem('salesPortalMemberId');return;}
  document.getElementById('loginScreen').style.display='none';document.getElementById('app').style.display='block';
  document.getElementById('hdrBadge').className='hdr-badge '+mcc(currentMember.id);
  document.getElementById('hdrAvatar').textContent=currentMember.name.charAt(0);document.getElementById('hdrName').textContent=currentMember.name;loadAllData();
}
function doLogout(){localStorage.removeItem('salesPortalMemberId');currentMember=null;document.getElementById('app').style.display='none';document.getElementById('loginScreen').style.display='flex';document.getElementById('loginPass').value='';document.getElementById('loginName').value='';document.getElementById('loginError').style.display='none';}
function loadAllData(){
  supabase.from('sales_prospects').select('*').order('created_at',{ascending:false}).then(function(r){prospects=r.data||[];renderAll();});
  supabase.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r){schedules=r.data||[];renderAll();});
  supabase.from('sales_expenses').select('*').order('created_at',{ascending:false}).then(function(r){expenses=r.data||[];renderExpense();});
  supabase.from('sales_evaluations').select('*').eq('is_self_eval',true).order('eval_date',{ascending:false}).limit(50).then(function(r){evaluations=r.data||[];renderReview();});
}
function renderAll(){renderHome();renderVisits();renderSchedule();}
function switchTab(t){currentTab=t;document.querySelectorAll('.bnav-btn').forEach(function(b){b.classList.toggle('active',b.dataset.tab===t);});document.querySelectorAll('.pg').forEach(function(p){p.classList.remove('active');});var el=document.getElementById('pg-'+t);if(el){el.style.opacity='0';el.style.transform='translateY(8px)';el.classList.add('active');requestAnimationFrame(function(){el.style.opacity='1';el.style.transform='translateY(0)';});}}

// ===== HOME =====
function renderHome(){
  if(!currentMember)return;var me=currentMember.id;
  var myP=prospects.filter(function(p){return p.assigned_to===me;});
  var closed=myP.filter(function(p){return p.status==='æˆç´„';}).length;
  var nego=myP.filter(function(p){return p.status==='å•†è«‡ä¸­';}).length;
  var appo=myP.filter(function(p){return p.status==='è¨ªå•æ¸ˆã¿'||p.status==='ã‚¢ãƒæ¸ˆ';}).length;
  var now=new Date(),dn=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
  var dl=(now.getMonth()+1)+'æœˆ'+now.getDate()+'æ—¥ï¼ˆ'+dn[now.getDay()]+'ï¼‰';
  var today=now.toISOString().split('T')[0],tmrw=new Date(now.getTime()+864e5).toISOString().split('T')[0];
  var am=buildAM(),h='';
  h+='<div style="padding:24px 20px 8px;"><div style="font-size:28px;font-weight:900;letter-spacing:-0.5px;">'+esc(currentMember.name)+'ã•ã‚“</div>';
  h+='<div style="font-size:14px;color:#86868b;margin-top:3px;font-weight:500;">'+dl+'</div></div>';
  // Alert
  var u3=[];for(var i=0;i<3;i++){var dd=new Date(now.getTime()+i*864e5).toISOString().split('T')[0];if(am[dd])am[dd].forEach(function(a){u3.push({d:dd,i:i,co:a.co,time:a.time});});}
  if(u3.length>0){var uc=u3.filter(function(a){return a.i===0;}).length;h+='<div class="alert-banner"><div class="alert-icon">ğŸ””</div><div class="alert-body"><div class="alert-title">'+(uc>0?'ğŸ”´ ä»Šæ—¥ã®ã‚¢ãƒ '+uc+'ä»¶':'âš ï¸ ç›´è¿‘ã®ã‚¢ãƒ '+u3.length+'ä»¶')+'</div><div class="alert-sub">'+u3.map(function(a){return(a.i===0?'ã€ä»Šæ—¥ã€‘':a.i===1?'ã€æ˜æ—¥ã€‘':'ã€'+fd(a.d)+'ã€‘')+a.co+(a.time?' '+a.time:'');}).join('ã€€')+'</div></div></div>';}
  // Appo cards
  (am[today]||[]).forEach(function(a){var dd=today.split('-');h+='<div class="appo-card"><span class="appo-label td">TODAY</span><div class="appo-chip td"><div class="appo-chip-d">'+parseInt(dd[2])+'</div><div class="appo-chip-w">'+gd(today)+'</div></div><div class="appo-info"><div class="appo-company">'+esc(a.co)+'</div><div class="appo-time">'+(a.time||'æ™‚é–“æœªå®š')+'</div></div></div>';});
  (am[tmrw]||[]).forEach(function(a){var dd=tmrw.split('-');h+='<div class="appo-card tomorrow"><span class="appo-label tm">æ˜æ—¥</span><div class="appo-chip tm"><div class="appo-chip-d">'+parseInt(dd[2])+'</div><div class="appo-chip-w">'+gd(tmrw)+'</div></div><div class="appo-info"><div class="appo-company">'+esc(a.co)+'</div><div class="appo-time">'+(a.time||'æ™‚é–“æœªå®š')+'</div></div></div>';});
  // Stats
  h+='<div style="padding-top:20px;"><div class="stats"><div class="stat-card"><div class="stat-val" style="color:#34c759;">'+closed+'</div><div class="stat-lbl">æˆç´„</div></div><div class="stat-card"><div class="stat-val" style="color:#ff9f0a;">'+nego+'</div><div class="stat-lbl">å•†è«‡ä¸­</div></div><div class="stat-card"><div class="stat-val" style="color:#0a84ff;">'+appo+'</div><div class="stat-lbl">ã‚¢ãƒæ¸ˆ</div></div></div></div>';
  // Cal
  h+=buildCal(calDate,selectedDate,'home',am);
  // Sel date
  var sd=selectedDate.split('-');h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px 10px;"><div style="font-size:17px;font-weight:700;letter-spacing:-0.3px;">'+parseInt(sd[1])+'æœˆ'+parseInt(sd[2])+'æ—¥</div><button class="btn-sm" onclick="openAddSch(\''+selectedDate+'\')"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 2v10M2 7h10"/></svg>è¿½åŠ </button></div>';
  var sa=am[selectedDate]||[];sa.forEach(function(a){h+='<div style="margin:0 16px 8px;padding:16px 18px;background:#fff;border-radius:14px;border-left:4px solid #ff453a;display:flex;align-items:center;gap:14px;box-shadow:0 1px 3px rgba(0,0,0,0.04);"><div style="font-size:14px;font-weight:800;color:#ff453a;width:50px;text-align:center;">'+(a.time||'--:--')+'</div><div style="flex:1;"><div style="font-weight:700;font-size:15px;">'+esc(a.co)+'</div>'+(a.to?'<div style="font-size:12px;color:#86868b;margin-top:2px;">'+esc(mn(a.to))+'</div>':'')+'</div></div>';});
  var ss=schedules.filter(function(s){return s.scheduled_date===selectedDate&&(s.member_id===me||s.is_public!==false);});
  ss.forEach(function(s){var c=mc(s.member_id);var pr=prospects.find(function(p){return p.id===s.prospect_id;});var nm=pr?pr.company_name:(s.memo||'äºˆå®š');h+='<div class="sch-card" style="border-left:4px solid '+c.dot+';"><div style="flex:1;"><div style="font-weight:700;font-size:14px;">'+esc(nm)+'</div><div style="font-size:12px;color:#86868b;margin-top:3px;">'+esc(mn(s.member_id))+'</div></div>'+(s.is_public===false?'<span style="font-size:10px;color:#c7c7cc;">ğŸ”’</span>':'')+'</div>';});
  if(!sa.length&&!ss.length)h+='<div class="empty">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  // Unparsed
  var up=prospects.filter(function(p){return p.meeting_date&&!parseMD(p.meeting_date);});
  if(up.length)h+='<div style="margin:16px;padding:16px;background:rgba(255,204,0,0.08);border-radius:14px;border:1px solid rgba(255,204,0,0.2);"><div style="font-size:13px;font-weight:700;color:#ff9f0a;margin-bottom:6px;">ğŸ“Œ æ—¥ä»˜æœªç¢ºå®šã®ã‚¢ãƒ</div>'+up.map(function(p){return'<div style="font-size:13px;color:#3c3c43;padding:3px 0;">'+esc(p.company_name)+' â€” <b>'+esc(p.meeting_date)+'</b></div>';}).join('')+'</div>';
  document.getElementById('pg-home').innerHTML=h;
}
function buildCal(dt,sel,pfx,am){
  var y=dt.getFullYear(),m=dt.getMonth()+1,today=new Date().toISOString().split('T')[0];am=am||buildAM();
  var h='<div class="cal-wrap"><div class="cal-nav"><button class="cal-nav-btn" onclick="chMo(\''+pfx+'\',-1)"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 3l-4 4 4 4"/></svg></button><div style="font-weight:700;font-size:16px;">'+y+'å¹´'+m+'æœˆ</div><button class="cal-nav-btn" onclick="chMo(\''+pfx+'\',1)"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M5 3l4 4-4 4"/></svg></button></div><div class="cal-grid">';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(function(d,i){h+='<div class="cal-hdr'+(i===0?' sun':'')+(i===6?' sat':'')+'">'+d+'</div>';});
  var fw=new Date(y,m-1,1).getDay(),dm=new Date(y,m,0).getDate();
  for(var i=0;i<fw;i++)h+='<div></div>';
  for(var d=1;d<=dm;d++){var s=ds(y,m,d),it=s===today,is=s===sel,ha=!!am[s];
    var cl='cal-day';if(ha)cl+=' has-appo';if(it)cl+=' today';if(is&&!it)cl+=' selected';
    h+='<div class="'+cl+'" onclick="selD(\''+pfx+'\',\''+s+'\')">';if(ha&&!it)h+='<div class="cal-appo-mark"></div>';h+=d;
    var dS=schedules.filter(function(x){return x.scheduled_date===s;});var uq=[];dS.forEach(function(x){if(uq.indexOf(x.member_id)===-1)uq.push(x.member_id);});
    if(uq.length&&!ha){h+='<div class="cal-dots">';uq.slice(0,3).forEach(function(mid){h+='<div class="cal-dot" style="background:'+(it?'rgba(255,255,255,0.6)':mc(mid).dot)+';"></div>';});h+='</div>';}
    h+='</div>';}
  h+='</div></div>';return h;
}
function chMo(p,d){calDate.setMonth(calDate.getMonth()+d);p==='home'?renderHome():renderSchedule();}
function selD(p,d){selectedDate=d;p==='home'?renderHome():renderSchedule();}
function openAddSch(d){document.getElementById('schDate').value=d||new Date().toISOString().slice(0,10);document.getElementById('schMemo').value='';document.getElementById('schPublic').checked=true;openModal('scheduleModal');}
function submitSchedule(){var d=document.getElementById('schDate').value,m=document.getElementById('schMemo').value,p=document.getElementById('schPublic').checked;if(!d||!m){alert('æ—¥ä»˜ã¨å†…å®¹ã‚’å…¥åŠ›');return;}supabase.from('sales_schedules').insert({member_id:currentMember.id,scheduled_date:d,memo:m,is_public:p}).then(function(r){if(r.error){alert(r.error.message);return;}closeModal('scheduleModal');supabase.from('sales_schedules').select('*').order('scheduled_date',{ascending:true}).then(function(r2){schedules=r2.data||[];renderAll();});});}

// ===== VISITS =====
function renderVisits(){
  if(!currentMember)return;var h='<div class="filter-bar"><div class="filter-search"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"><circle cx="7" cy="7" r="4.5"/><path d="M11 11l3.5 3.5"/></svg><input type="text" placeholder="ä¼šç¤¾åã§æ¤œç´¢" value="'+esc(visitSearch)+'" oninput="visitSearch=this.value;renderVisits()"></div>';
  h+='<div class="filter-pills">';['','ã‚¢ãƒæ¸ˆ','å•†è«‡ä¸­','æˆç´„','è¦‹è¾¼ã¿','æœªè¨ªå•'].forEach(function(s){h+='<button class="fpill '+(visitFilterStatus===s?'active':'')+'" onclick="setVF(\''+s+'\')">'+(s||'ã™ã¹ã¦')+'</button>';});
  h+='</div><div class="filter-pills"><button class="fpill '+(visitFilterRegion?'active':'')+'" onclick="cycR()">'+(visitFilterRegion||'ã‚¨ãƒªã‚¢')+'</button>';
  h+='<button class="fpill '+(visitFilterMember?'active':'')+'" onclick="cycM()">'+esc(visitFilterMember?mn(visitFilterMember):'æ‹…å½“è€…')+'</button>';
  h+='<button class="sort-btn '+(visitSortDate?'active':'')+'" onclick="visitSortDate=!visitSortDate;renderVisits()">å•†è«‡æ—¥é †</button></div></div>';
  var fl=prospects.filter(function(p){if(visitSearch&&p.company_name.indexOf(visitSearch)===-1)return false;if(visitFilterStatus&&p.status!==visitFilterStatus)return false;if(visitFilterRegion&&gr(p.area)!==visitFilterRegion)return false;if(visitFilterMember&&p.assigned_to!==visitFilterMember)return false;return true;});
  if(visitSortDate)fl.sort(function(a,b){return(parseMD(a.meeting_date)||'9999').localeCompare(parseMD(b.meeting_date)||'9999');});
  h+='<div style="padding:2px 20px 10px;font-size:13px;color:#86868b;font-weight:600;">'+fl.length+'ä»¶</div><div class="visit-grid">';
  if(!fl.length)h+='<div class="empty" style="margin:0;">è©²å½“ãªã—</div>';
  else fl.forEach(function(p){var c=mc(p.assigned_to),n=mn(p.assigned_to),sc=STATUS_COLORS[p.status]||STATUS_COLORS['æœªè¨ªå•'],memo=p.hearing_content||p.notes||'';
    h+='<div class="vcard"><div class="vcard-top"><div class="vcard-name">'+esc(p.company_name)+'</div><span class="badge" style="background:'+sc.bg+';color:'+sc.c+';">'+esc(p.status||'æœªè¨ªå•')+'</span></div><div class="vcard-info">';
    if(p.meeting_date)h+='<div class="vcard-row"><svg fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="12" height="10" rx="1.5"/><path d="M2 7h12M5 2v3M11 2v3"/></svg><span style="color:#ff453a;font-weight:700;">'+esc(p.meeting_date)+(p.meeting_time?' '+esc(p.meeting_time):'')+'</span></div>';
    if(p.phone)h+='<div class="vcard-row"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M3 1.5h3l1.5 4-2 1.5a11 11 0 0 0 5 5l1.5-2 4 1.5v3a1 1 0 0 1-1 1A14 14 0 0 1 2.5 3a1 1 0 0 1 1-1.5"/></svg><a href="tel:'+esc(p.phone)+'">'+esc(p.phone)+'</a></div>';
    if(p.address)h+='<div class="vcard-row"><svg fill="none" stroke="currentColor" stroke-width="2"><path d="M8 1C5 1 2.5 3.5 2.5 6.5S8 15 8 15s5.5-5 5.5-8.5S11 1 8 1z"/><circle cx="8" cy="6.5" r="1.5"/></svg><a href="https://www.google.com/maps/search/'+encodeURIComponent(p.address)+'" target="_blank" style="font-size:12px;">'+esc(p.address)+' â†—</a></div>';
    if(p.contact_person)h+='<div class="vcard-row"><svg fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="5" r="3"/><path d="M2 15c0-3 3-5 6-5s6 2 6 5"/></svg>'+esc(p.contact_person)+'</div>';
    h+='</div>';if(memo)h+='<div class="vcard-memo" onclick="tVD(\''+p.id+'\')">'+esc(memo)+'</div>';
    h+='<div class="vcard-footer">';if(p.assigned_to&&n){h+='<div class="vcard-assign"><div class="vcard-assign-avatar" style="background:'+c.dot+';">'+esc(n.charAt(0))+'</div><div class="vcard-assign-name">'+esc(n)+'</div></div><button class="assign-btn" onclick="openAssign(\''+p.id+'\')">å¤‰æ›´</button>';}
    else{h+='<div style="font-size:13px;color:#c7c7cc;">æ‹…å½“æœªå®š</div><button class="assign-btn" onclick="selfA(\''+p.id+'\')" style="border-style:solid;border-color:#0a84ff;color:#0a84ff;">ğŸ™‹ è¡Œãã¾ã™</button>';}
    h+='</div><div class="vcard-detail" id="vd-'+p.id+'">';
    if(p.website_url)h+='<div class="vcard-detail-row"><span style="color:#86868b;">HP</span><a href="'+esc(p.website_url)+'" target="_blank" style="color:#0a84ff;font-size:13px;">'+esc(p.website_url)+'</a></div>';
    if(p.email)h+='<div class="vcard-detail-row"><span style="color:#86868b;">ãƒ¡ãƒ¼ãƒ«</span><a href="mailto:'+esc(p.email)+'" style="color:#0a84ff;font-size:13px;">'+esc(p.email)+'</a></div>';
    if(p.area)h+='<div class="vcard-detail-row"><span style="color:#86868b;">ã‚¨ãƒªã‚¢</span><span>'+esc(gr(p.area))+' / '+esc(p.area)+'</span></div>';
    if(memo)h+='<div class="vcard-full-memo">'+esc(memo)+'</div>';
    h+='</div></div>';});
  h+='</div>';document.getElementById('pg-visits').innerHTML=h;
}
function setVF(v){visitFilterStatus=visitFilterStatus===v?'':v;renderVisits();}
function cycR(){var k=Object.keys(REGIONS),i=k.indexOf(visitFilterRegion);visitFilterRegion=i>=k.length-1?'':k[i+1];renderVisits();}
function cycM(){var ids=members.map(function(m){return m.id;}),i=ids.indexOf(visitFilterMember);visitFilterMember=i>=ids.length-1?'':ids[i+1];renderVisits();}
function tVD(id){var e=document.getElementById('vd-'+id);if(e)e.classList.toggle('open');}
function selfA(pid){supabase.from('sales_prospects').update({assigned_to:currentMember.id}).eq('id',pid).then(function(r){if(r.error){alert(r.error.message);return;}var p=prospects.find(function(x){return x.id===pid;});if(p)p.assigned_to=currentMember.id;renderVisits();renderHome();});}
function openAssign(pid){assignProspectId=pid;var h='';members.forEach(function(m){var c=mc(m.id);h+='<div style="display:flex;align-items:center;gap:14px;padding:16px 0;border-bottom:0.5px solid rgba(0,0,0,0.06);cursor:pointer;" onclick="doA(\''+m.id+'\')"><div style="width:38px;height:38px;border-radius:50%;background:'+c.dot+';display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:15px;">'+esc(m.name.charAt(0))+'</div><div style="font-weight:600;font-size:16px;">'+esc(m.name)+'</div></div>';});
  h+='<div style="display:flex;align-items:center;gap:14px;padding:16px 0;cursor:pointer;" onclick="doA(null)"><div style="width:38px;height:38px;border-radius:50%;background:#f2f2f7;display:flex;align-items:center;justify-content:center;color:#86868b;font-size:16px;">âœ•</div><div style="font-weight:600;font-size:16px;color:#86868b;">æ‹…å½“ã‚’å¤–ã™</div></div>';
  document.getElementById('assignMemberList').innerHTML=h;openModal('assignModal');
}
function doA(mid){supabase.from('sales_prospects').update({assigned_to:mid}).eq('id',assignProspectId).then(function(r){if(r.error){alert(r.error.message);return;}var p=prospects.find(function(x){return x.id===assignProspectId;});if(p)p.assigned_to=mid;closeModal('assignModal');renderVisits();renderHome();});}

// ===== SCHEDULE =====
function renderSchedule(){
  if(!currentMember)return;var today=new Date().toISOString().split('T')[0],am=buildAM(),h='';
  h+='<div class="s-title" style="display:flex;justify-content:space-between;align-items:center;">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«<div class="toggle-wrap"><button class="toggle-btn '+(scheduleScope==='mine'?'active':'')+'" onclick="scheduleScope=\'mine\';renderSchedule()">è‡ªåˆ†</button><button class="toggle-btn '+(scheduleScope==='all'?'active':'')+'" onclick="scheduleScope=\'all\';renderSchedule()">å…¨å“¡</button></div></div>';
  if(scheduleScope==='all'){h+='<div style="display:flex;gap:12px;padding:0 20px 14px;flex-wrap:wrap;">';members.forEach(function(m){var c=mc(m.id);h+='<div style="display:flex;align-items:center;gap:6px;font-size:12px;color:#3c3c43;font-weight:500;"><div style="width:10px;height:10px;border-radius:50%;background:'+c.dot+';"></div>'+esc(m.name)+'</div>';});h+='</div>';}
  var all=[];for(var d in am){if(d<today)continue;am[d].forEach(function(a){all.push({d:d,type:'a',co:a.co,time:a.time,to:a.to});});}
  schedules.filter(function(s){if(s.scheduled_date<today)return false;if(scheduleScope==='mine')return s.member_id===currentMember.id;return s.is_public!==false||s.member_id===currentMember.id;}).forEach(function(s){var pr=prospects.find(function(p){return p.id===s.prospect_id;});all.push({d:s.scheduled_date,type:'s',nm:pr?pr.company_name:(s.memo||'äºˆå®š'),mid:s.member_id,priv:s.is_public===false});});
  all.sort(function(a,b){return a.d.localeCompare(b.d);});
  if(!all.length)h+='<div class="empty">äºˆå®šã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  else all.slice(0,30).forEach(function(e){if(e.type==='a'){h+='<div class="sch-card" style="border-left:4px solid #ff453a;"><div class="sch-time" style="color:#ff453a;">'+fd(e.d)+'</div><div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:14px;">'+esc(e.co)+'</div><div style="font-size:12px;color:#86868b;margin-top:2px;">'+(e.time||'æ™‚é–“æœªå®š')+' ãƒ» '+esc(mn(e.to))+'</div></div></div>';}else{var c=mc(e.mid);h+='<div class="sch-card" style="border-left:4px solid '+c.dot+';"><div class="sch-time">'+fd(e.d)+'</div><div style="flex:1;min-width:0;"><div style="font-weight:700;font-size:14px;">'+esc(e.nm)+'</div><div style="font-size:12px;color:#86868b;margin-top:2px;">'+esc(mn(e.mid))+'</div></div>'+(e.priv?'<span style="font-size:10px;color:#c7c7cc;">ğŸ”’</span>':'')+'</div>';}});
  document.getElementById('pg-schedule').innerHTML=h;
}

// ===== REVIEW (filtered to own prospects only) =====
function renderReview(){
  if(!currentMember)return;
  var myP=prospects.filter(function(p){return p.assigned_to===currentMember.id;});
  var myE=evaluations.filter(function(e){return e.member_id===currentMember.id;});
  var h='<div class="s-title">æŒ¯ã‚Šè¿”ã‚Š</div><div class="card"><div style="font-size:16px;font-weight:700;margin-bottom:18px;">å•†è«‡ã‚’è¨˜éŒ²ã™ã‚‹</div>';
  h+='<div class="form-group"><label class="form-label">å•†è«‡å…ˆï¼ˆè‡ªåˆ†ã®æ‹…å½“ã®ã¿ï¼‰</label><select class="form-input" id="revCompany"><option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
  myP.forEach(function(p){h+='<option value="'+esc(p.company_name)+'">'+esc(p.company_name)+'</option>';});
  h+='</select></div>';
  h+='<div class="form-group"><label class="form-label">çµæœ</label><div class="result-btns">';
  ['å—æ³¨','è¦‹è¾¼ã¿','ç¶™ç¶š','è¦‹é€ã‚Š'].forEach(function(r){h+='<button class="result-btn '+(reviewResult===r?'active':'')+'" onclick="reviewResult=\''+r+'\';renderReview()">'+r+'</button>';});
  h+='</div></div><div class="form-group"><label class="form-label">æ—¥ä»˜</label><input type="date" class="form-input" id="revDate" value="'+new Date().toISOString().slice(0,10)+'"></div>';
  h+='<div class="form-group"><label class="form-label">ãƒ¡ãƒ¢</label><textarea class="form-textarea" id="revMemo" placeholder="å•†è«‡ã®è¦ç‚¹ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³..."></textarea></div>';
  h+='<button class="btn-primary" onclick="submitReview()">è¨˜éŒ²ã™ã‚‹</button></div>';
  h+='<div class="s-title" style="font-size:20px;">å±¥æ­´</div>';
  if(!myE.length)h+='<div class="empty">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>';
  else myE.forEach(function(e){var rc={'å—æ³¨':'#34c759','è¦‹è¾¼ã¿':'#ff9f0a','ç¶™ç¶š':'#0a84ff','è¦‹é€ã‚Š':'#ff453a'};var c=rc[e.result]||'#8e8e93';h+='<div class="card" style="display:flex;justify-content:space-between;align-items:center;"><div><div style="font-weight:700;font-size:15px;">'+esc(e.company_name||'-')+'</div><div style="font-size:12px;color:#86868b;margin-top:3px;">'+esc(e.eval_date)+(e.comment?' ãƒ» '+esc(e.comment.substring(0,30)):'')+'</div></div><span class="badge" style="background:'+c+'18;color:'+c+';">'+esc(e.result||'-')+'</span></div>';});
  document.getElementById('pg-review').innerHTML=h;
}
function submitReview(){var co=document.getElementById('revCompany').value,dt=document.getElementById('revDate').value,me=document.getElementById('revMemo').value;if(!co||!reviewResult){alert('å•†è«‡å…ˆã¨çµæœã‚’é¸æŠ');return;}supabase.from('sales_evaluations').insert({member_id:currentMember.id,company_name:co,eval_date:dt,result:reviewResult,comment:me,total_score:0,scores:'{}',is_self_eval:true}).then(function(r){if(r.error){alert(r.error.message);return;}alert('è¨˜éŒ²ã—ã¾ã—ãŸ');reviewResult='';loadAllData();});}

// ===== EXPENSE =====
function renderExpense(){
  if(!currentMember)return;var my=expenses.filter(function(e){return e.member_id===currentMember.id;});
  var pa=my.filter(function(e){return e.status==='ç”³è«‹ä¸­';}).reduce(function(s,e){return s+(e.amount||0);},0);
  var aa=my.filter(function(e){return e.status==='æ‰¿èª';}).reduce(function(s,e){return s+(e.amount||0);},0);
  var h='<div class="s-title" style="display:flex;justify-content:space-between;align-items:center;">çµŒè²»<button class="btn-sm" onclick="document.getElementById(\'expDate\').value=new Date().toISOString().slice(0,10);openModal(\'expenseModal\')"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 2v10M2 7h10"/></svg>ç”³è«‹</button></div>';
  h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 16px;margin-bottom:16px;"><div class="stat-card"><div class="stat-val" style="font-size:24px;color:#ff9f0a;">Â¥'+pa.toLocaleString()+'</div><div class="stat-lbl">ç”³è«‹ä¸­</div></div><div class="stat-card"><div class="stat-val" style="font-size:24px;color:#34c759;">Â¥'+aa.toLocaleString()+'</div><div class="stat-lbl">æ‰¿èªæ¸ˆ</div></div></div>';
  if(!my.length)h+='<div class="empty">çµŒè²»ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
  else my.forEach(function(e){var ip=e.status==='ç”³è«‹ä¸­';var ib=ip?'rgba(255,159,10,0.1)':(e.status==='æ‰¿èª'?'rgba(52,199,89,0.1)':'rgba(255,69,58,0.1)');var ic=ip?'#ff9f0a':(e.status==='æ‰¿èª'?'#34c759':'#ff453a');h+='<div class="exp-item"><div class="exp-icon" style="background:'+ib+';"><svg width="18" height="18" fill="none" stroke="'+ic+'" stroke-width="2" stroke-linecap="round">'+(ip?'<circle cx="9" cy="9" r="6"/><path d="M9 6v3h2"/>':'<path d="M4 9l3 3 7-7"/>')+'</svg></div><div style="flex:1;min-width:0;"><div style="font-weight:600;font-size:14px;">'+esc(e.category)+'<span style="font-weight:400;color:#86868b;"> ãƒ»'+fd(e.expense_date)+'</span></div><div style="font-size:13px;color:#86868b;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+esc(e.description||'')+'</div></div><div style="font-weight:800;font-size:15px;flex-shrink:0;">Â¥'+(e.amount||0).toLocaleString()+'</div></div>';});
  document.getElementById('pg-expense').innerHTML=h;
}
function submitExpense(){var d=document.getElementById('expDate').value,c=document.getElementById('expCategory').value,a=parseInt(document.getElementById('expAmount').value)||0,desc=document.getElementById('expDesc').value;if(!d||!a){alert('æ—¥ä»˜ã¨é‡‘é¡ã‚’å…¥åŠ›');return;}supabase.from('sales_expenses').insert({member_id:currentMember.id,expense_date:d,category:c,amount:a,description:desc,status:'ç”³è«‹ä¸­'}).then(function(r){if(r.error){alert(r.error.message);return;}alert('ç”³è«‹ã—ã¾ã—ãŸ');closeModal('expenseModal');document.getElementById('expAmount').value='';document.getElementById('expDesc').value='';loadAllData();});}
function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}
</script>
</body>
</html>
